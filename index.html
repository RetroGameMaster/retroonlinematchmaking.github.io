<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetroOnlineMatchmaking</title>
  <!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* --- Base Styling --- */
body, html {
  margin:0; padding:0; font-family:"Orbitron", Arial, sans-serif;
  background:#000; color:#fff; overflow-x:hidden; cursor:none;
}

/* --- Splash Screen --- */
#splash {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:3000; color:#0ff; transition: opacity 0.45s ease, transform 0.45s ease;
}
#splash.fade {
  opacity:0; transform:scale(1.02); pointer-events:none;
}
#splash h1 {
  font-size:clamp(28px,6vw,48px); animation:flicker 1s infinite; margin:0; text-align:center;
  text-shadow: 0 0 12px rgba(0,255,255,0.12);
}
#splash p {
  font-size:clamp(12px,2.4vw,18px); margin:0.5rem 0; animation:flicker 1.5s infinite; text-align:center;
  color: #ff33cc;
}
@keyframes flicker { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* --- Progress --- */
#progressContainer {
  width:70%; max-width:560px; height:12px; background:rgba(0,255,255,0.04); border:2px solid rgba(0,255,255,0.08);
  border-radius:10px; margin-top:18px; overflow:hidden; display:block;
  box-shadow: inset 0 0 18px rgba(0,255,255,0.02);
}
#progressBar { width:0%; height:100%; background:linear-gradient(90deg,#00e0ff,#ff33cc); transition:width 0.12s linear; }

/* --- Starfield container fallback --- */
.stars { position:fixed; width:100%; height:100%; background:transparent; z-index:0; overflow:hidden; pointer-events:none; }

/* --- CRT & overlays --- */
.crt-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  pointer-events:none;
  background-image: repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 3px);
  mix-blend-mode: overlay;
  opacity:0.12; z-index:2000;
}

/* --- CRT Scanline --- */
.crt-scanline {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(to bottom, 
    transparent 0%, 
    rgba(0, 255, 255, 0.15) 50%, 
    transparent 100%);
  animation: scanline 3.5s linear infinite;
  pointer-events: none;
  z-index: 2001;
  mix-blend-mode: overlay;
  opacity: 0.7;
}

@keyframes scanline {
  0% { transform: translateY(-100vh); }
  100% { transform: translateY(100vh); }
}

/* --- Header / layout --- */
header{
  position:relative; z-index:20; padding:clamp(12px,3vw,28px);
  max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding-left:4vw; padding-right:4vw;
}
.brand { display:flex; gap:12px; align-items:center }
.brand .logo { width:48px; height:48px; border-radius:8px; background:linear-gradient(135deg,#00e0ff,#ff33cc);
  display:flex; align-items:center; justify-content:center; font-weight:700; color:#010101; font-size:18px;
  box-shadow:0 0 18px rgba(0,224,255,0.12);
}
.brand h1{ margin:0; font-size:clamp(16px,2.6vw,22px); color:#0ff; text-shadow:0 0 12px rgba(0,224,255,0.12); }
.brand p{ margin:0; font-size:12px; color:#bfeefc; opacity:0.9; }

/* Buttons */
.button {
  display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px;
  background:linear-gradient(180deg,#00d7ff,#00a8bf); color:#001; font-weight:700; border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 6px 20px rgba(0,224,255,0.06);
  text-decoration:none; cursor:pointer; user-select:none;
  transition: transform 0.1s ease;
}
.button.muted{ background:linear-gradient(180deg,#ff33cc,#cc0099); color:#fff; }
.button:hover { transform: translateY(-1px); }

/* --- Theme Switcher - MOVED TO BOTTOM --- */
.theme-switcher {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  gap: 8px;
  background: rgba(0, 20, 40, 0.9);
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #00ffff;
  backdrop-filter: blur(10px);
}

.theme-btn {
  padding: 8px 12px;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.theme-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateY(-2px);
}

.theme-btn.active {
  background: #00ffff;
  color: #000;
  font-weight: bold;
}

/* --- Search System --- */
.search-container {
  max-width: 700px;
  margin: 20px auto;
  padding: 0 4vw;
}

.search-bar {
  width: 100%;
  padding: 12px 20px;
  background: rgba(0, 20, 40, 0.8);
  border: 2px solid #00ffff;
  border-radius: 10px;
  color: #00ffff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 1rem;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
  backdrop-filter: blur(5px);
  transition: all 0.3s ease;
}

.search-bar:focus {
  outline: none;
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
  border-color: #00e0ff;
}

.search-bar::placeholder {
  color: rgba(0, 255, 255, 0.6);
}

.search-results {
  text-align: center;
  color: #00ffff;
  margin: 10px 0;
  font-family: 'Share Tech Mono', monospace;
  min-height: 20px;
}

.no-results {
  color: #ff3366;
  text-align: center;
  padding: 20px;
  font-style: italic;
}

/* Copy Button Styles */
.copy-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 4px;
  color: #00ffff;
  padding: 4px 8px;
  margin-left: 8px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'Share Tech Mono', monospace;
}

.copy-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateY(-1px);
}

.copy-btn.copied {
  background: #00ff00;
  color: #000;
  border-color: #00ff00;
}

.copyable {
  background: rgba(0, 255, 255, 0.05);
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid rgba(0, 255, 255, 0.2);
  font-family: 'Courier New', monospace;
}

/* Server Status Indicators */
.server-status {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}

.status-online {
  background: #00ff00;
  box-shadow: 0 0 8px #00ff00;
}

.status-offline {
  background: #ff3333;
  box-shadow: 0 0 8px #ff3333;
}

.status-checking {
  background: #ffff00;
  box-shadow: 0 0 8px #ffff00;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Easter Egg Elements */
.flying-sprite {
  position: fixed;
  font-size: 24px;
  z-index: 9999;
  pointer-events: none;
  animation: flyAcross 3s linear forwards;
}

@keyframes flyAcross {
  0% {
    transform: translateX(-100px) translateY(0px) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateX(calc(100vw + 100px)) translateY(calc(var(--random-y) * 100px)) rotate(360deg);
    opacity: 0;
  }
}

.secret-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.9);
  color: #00ff00;
  padding: 20px 40px;
  border: 3px solid #00ff00;
  border-radius: 10px;
  font-family: 'Press Start 2P', cursive;
  font-size: 1.2rem;
  text-align: center;
  z-index: 10000;
  animation: messagePulse 2s ease-in-out;
  box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
}

@keyframes messagePulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.1); }
}

/* --- Main Content --- */
#mainContent { display:none; min-height:100vh; position:relative; z-index:10; padding-bottom:4rem; }

/* --- Section top caption --- */
.platform-caption{
  text-align:center; color:#00ffff; font-weight:800; margin:1.2rem 0; font-size:1rem; text-shadow:0 0 8px rgba(0,255,255,0.08);
}

/* --- Collapsible --- */
.collapsible {
  background: rgba(0,0,0,0.6);
  color:#0ff;
  cursor:pointer;
  padding: 1rem;
  width: 90%;
  max-width:1100px;
  border: 2px solid #0ff;
  margin: 1rem auto;
  text-align:left;
  font-weight:800;
  border-radius:10px;
  position:relative;
  transition:0.25s;
}
.collapsible::after{
  content: '\25B6';
  font-size:1.1rem;
  position:absolute; right:20px; top:50%; transform:translateY(-50%);
  transition:0.25s;
}
.collapsible.active::after{ transform:translateY(-50%) rotate(90deg); }
.content { 
  max-height:0; 
  overflow:hidden; 
  transition:max-height .35s ease; 
  padding: 0 1rem;
  background: rgba(0, 20, 40, 0.3);
  border-radius: 0 0 10px 10px;
  margin-top: -2px;
}

/* Hide sections when searching */
.collapsible.hidden, .card.hidden {
  display: none !important;
}

/* Highlight search terms */
.highlight {
  background: rgba(0, 255, 255, 0.3);
  padding: 0 2px;
  border-radius: 2px;
}

/* --- Cards --- */
.card {
  background: rgba(0, 30, 60, 0.7); 
  border:1px solid rgba(0,224,255,0.1); 
  border-radius:8px;
  margin:0.8rem auto; 
  padding:1rem; 
  text-align:left; 
  max-width:1100px;
  box-shadow:0 12px 30px rgba(0,0,0,0.6), 0 0 10px rgba(0,224,255,0.02);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.15);
}
.card h3 { color:#ff33cc; margin:0 0 6px 0; font-size:1.05rem; }
.card p { color:#cfeff6; margin:0.2rem 0; font-size:.95rem; }
.card a { color:#00e0ff; text-decoration:underline; font-weight:700; }

/* --- Supporter Hall of Fame --- */
.supporter-section {
  margin: 2rem auto;
  padding: 18px;
  max-width: 760px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(0,255,255,0.02), rgba(0,0,0,0.18));
  border: 1px solid rgba(0,255,255,0.06);
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  text-align: center;
}

.supporter-section h2 {
  margin: 0 0 8px 0;
  color: #00ffff;
  font-size: 1.3rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.supporter-section p {
  margin: 0 0 12px 0;
  color: #cfeff6;
}

.supporter-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}

.supporter-card {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  min-width: 150px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease;
}

.supporter-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.supporter-name {
  color: #ff33cc;
  font-weight: bold;
  font-size: 1.1rem;
}

/* --- Submit section --- */
#submitMethodSection{
  margin:2rem auto; padding:18px; max-width:760px; border-radius:12px;
  background:linear-gradient(180deg, rgba(0,255,255,0.02), rgba(0,0,0,0.18));
  border:1px solid rgba(0,255,255,0.06);
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  text-align:center;
}
#submitMethodSection h2{ margin:0 0 8px 0; color:#00ffff; font-size:1.3rem; text-shadow:0 0 8px rgba(0,255,255,0.08); }
#submitMethodSection p{ margin:0 0 12px 0; color:#cfeff6; }

/* --- Modal --- */
.modal {
  display:none;
  position:fixed; left:0; top:0; width:100%; height:100%; z-index:4000;
  background:rgba(0,0,0,0.95); justify-content:center; align-items:center; padding:1rem;
}
.modal iframe{ width:90%; max-width:720px; height:85vh; border:none; border-radius:12px; box-shadow:0 0 25px rgba(0,255,255,0.08); }
.close-btn{ position:absolute; top:14px; right:18px; font-size:28px; color:#0ff; cursor:pointer }

/* --- Footer --- */
footer.site-footer { text-align:center; padding:18px 4vw; color:#a8dfe8; font-size:13px; border-top:1px solid rgba(0,224,255,0.04); margin-top:2.2rem }

/* --- Cursor (fixed for correct tracking) --- */
#customCursor{
  position:fixed; width:40px; height:40px; pointer-events:none; z-index:5000; transform:translate(-50%,-50%);
  filter: drop-shadow(0 6px 18px rgba(0,224,255,0.08));
}

/* --- Canvas BG --- */
canvas#retroCanvas{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; }

/* --- Status Bar --- */
.status-bar {
  display: flex;
  justify-content: center;
  gap: 25px;
  margin: 15px auto;
  padding: 10px 20px;
  background: rgba(0, 20, 40, 0.8);
  border: 2px solid #00ffff;
  border-radius: 8px;
  max-width: 700px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.85rem;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
  backdrop-filter: blur(5px);
}

.status-indicator {
  color: #00ffff;
  font-weight: bold;
  white-space: nowrap;
}

/* Ping color states - REMOVED */
/* .ping-excellent { color: #00ff00 !important; text-shadow: 0 0 8px rgba(0, 255, 0, 0.6) !important; }
.ping-good { color: #aaff00 !important; text-shadow: 0 0 8px rgba(170, 255, 0, 0.4) !important; }
.ping-fair { color: #ffff00 !important; text-shadow: 0 0 8px rgba(255, 255, 0, 0.4) !important; }
.ping-poor { color: #ff6600 !important; text-shadow: 0 0 8px rgba(255, 102, 0, 0.4) !important; }
.ping-bad { color: #ff3333 !important; text-shadow: 0 0 8px rgba(255, 51, 51, 0.4) !important; } */

/* --- ACCOUNT SYSTEM STYLES --- */

/* User Section Styles */
.user-section {
  position: relative;
  display: flex;
  align-items: center;
}

.user-menu {
  position: relative;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
}

.user-menu:hover .user-dropdown {
  display: block;
}

.user-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: rgba(0, 30, 60, 0.95);
  border: 1px solid #00ffff;
  border-radius: 6px;
  padding: 8px;
  min-width: 150px;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.user-dropdown button {
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  color: #00ffff;
  text-align: left;
  cursor: pointer;
  border-radius: 4px;
}

.user-dropdown button:hover {
  background: rgba(0, 255, 255, 0.2);
}

.login-tabs {
  display: flex;
  margin-bottom: 1rem;
  border-bottom: 1px solid #00ffff;
}

.tab-btn {
  flex: 1;
  padding: 10px;
  background: none;
  border: none;
  color: #00ffff;
  cursor: pointer;
  border-bottom: 2px solid transparent;
}

.tab-btn.active {
  border-bottom: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.1);
}

.auth-form {
  transition: all 0.3s ease;
}

/* Profile Badge */
.profile-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 4px 8px;
  background: rgba(0, 255, 255, 0.1);
  border-radius: 20px;
  font-size: 0.8rem;
}

.user-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

/* Message System */
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* Social Hub Styles */
.social-hub-content {
  position: relative;
  backdrop-filter: blur(20px);
  border: 1px solid #00ffff;
  box-shadow: 0 0 40px rgba(0, 255, 255, 0.2);
  /* ADDED: Ensure proper scrolling on desktop */
  overflow: hidden;
}

/* ADDED: Desktop scrolling for social hub */
@media (min-width: 769px) {
  .social-hub-content {
    height: 90vh;
  }
  
  .social-main {
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  .profile-content {
    overflow-y: auto;
    max-height: calc(90vh - 200px);
  }
  
  .wall-posts {
    max-height: 300px;
    overflow-y: auto;
  }
}

.social-nav-btn {
  width: 100%;
  padding: 12px 15px;
  margin: 5px 0;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
  color: #00ffff;
  text-align: left;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', Arial, sans-serif;
}

.social-nav-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateX(5px);
}

.social-nav-btn.active {
  background: rgba(0, 255, 255, 0.3);
  border-color: #00ffff;
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

.social-tab {
  display: none;
  flex: 1;
  flex-direction: column;
}

.social-tab.active {
  display: flex;
}

/* Chat Styles */
.chat-messages {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
}

.chat-message {
  padding: 10px 15px;
  border-radius: 8px;
  max-width: 80%;
  word-wrap: break-word;
}

.message-own {
  align-self: flex-end;
  background: rgba(0, 255, 255, 0.2);
  border: 1px solid rgba(0, 255, 255, 0.4);
}

.message-other {
  align-self: flex-start;
  background: rgba(255, 51, 204, 0.2);
  border: 1px solid rgba(255, 51, 204, 0.4);
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 0.8rem;
}

.message-username {
  font-weight: bold;
  color: #00ffff;
}

.message-time {
  color: #a8dfe8;
  opacity: 0.7;
}

.message-text {
  color: #ffffff;
}

/* Wall Post Styles */
.wall-post {
  background: rgba(0, 30, 60, 0.6);
  border: 1px solid rgba(0, 255, 255, 0.2);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.wall-post-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 0.9rem;
}

.wall-post-author {
  color: #00ffff;
  font-weight: bold;
}

.wall-post-time {
  color: #a8dfe8;
  opacity: 0.7;
}

.wall-post-content {
  color: #ffffff;
  line-height: 1.4;
}

/* Online Users */
.online-user {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.online-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff00;
  box-shadow: 0 0 8px #00ff00;
}

/* Status indicators for cards */
.status-pulse {
  width: 8px;
  height: 8px;
  background: #ffff00;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
  display: inline-block;
  margin-right: 5px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
}

.status-dot.online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
.status-dot.offline { background: #ff3333; box-shadow: 0 0 8px #ff3333; }
/* ADDED: Enhanced Lobby Styles */
.lobby-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}

.lobby-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
}

.close-lobby-btn {
  padding: 8px 12px;
  background: rgba(255, 51, 102, 0.2);
  border: 1px solid rgba(255, 51, 102, 0.4);
  border-radius: 6px;
  color: #ff3366;
  cursor: pointer;
  transition: all 0.2s ease;
}

.close-lobby-btn:hover {
  background: rgba(255, 51, 102, 0.3);
  transform: scale(1.05);
}

.lobby-players-list {
  border-top: 1px solid rgba(0, 255, 255, 0.2);
  padding-top: 8px;
  margin-top: 8px;
}
/* Music Player */
.music-player {
  position: fixed;
  bottom: 80px;
  left: 20px;
  background: rgba(0, 20, 40, 0.9);
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #00ffff;
  backdrop-filter: blur(10px);
  z-index: 1000;
}

.music-station {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #00ffff;
  font-size: 0.8rem;
}

.music-controls {
  display: flex;
  gap: 5px;
}

.music-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 4px;
  color: #00ffff;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.7rem;
}

.music-btn:hover {
  background: rgba(0, 255, 255, 0.2);
}

/* NEW: Enhanced animations */
@keyframes pulse-glow {
  0% { box-shadow: 0 0 5px rgba(0,255,255,0.5); }
  50% { box-shadow: 0 0 20px rgba(0,255,255,0.8); }
  100% { box-shadow: 0 0 5px rgba(0,255,255,0.5); }
}

.new-content {
  animation: pulse-glow 2s ease-in-out;
}

@keyframes slideUp {
  from { transform: translateX(-50%) translateY(20px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* NEW: Live Player Count Styles */
.live-players {
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-count-animation {
  display: inline-block;
  animation: countPulse 2s infinite;
}

@keyframes countPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* NEW: Engagement Features */
.featured-games {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.featured-games h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.game-carousel {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding: 10px 0;
  scrollbar-width: thin;
  scrollbar-color: #00ffff #000;
}

.game-carousel::-webkit-scrollbar {
  height: 8px;
}

.game-carousel::-webkit-scrollbar-track {
  background: #000;
  border-radius: 4px;
}

.game-carousel::-webkit-scrollbar-thumb {
  background: #00ffff;
  border-radius: 4px;
}

.game-card {
  min-width: 250px;
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  transition: transform 0.3s ease;
}

.game-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.game-card h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.game-card p {
  color: #cfeff6;
  margin: 0 0 15px 0;
  font-size: 0.9rem;
}

/* NEW: Community Events */
.community-events {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.community-events h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.event-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.event-card {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  transition: transform 0.3s ease;
}

.event-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.event-card h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.event-card p {
  color: #cfeff6;
  margin: 0 0 10px 0;
  font-size: 0.9rem;
}

.event-date {
  color: #00ffff;
  font-weight: bold;
  font-size: 0.8rem;
}
/* --- Clip of the Week Section --- */
.clip-of-week {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.clip-of-week h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.video-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  margin-bottom: 1rem;
  border: 2px solid #00ffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
}

.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.clip-info {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  margin-top: 1rem;
}

.clip-info h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.clip-info p {
  color: #cfeff6;
  margin: 0;
  font-size: 0.95rem;
}

.clip-meta {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 0.8rem;
  color: #a8dfe8;
}

/* NEW: User Customization Styles */
.profile-customization {
  margin: 20px 0;
  padding: 15px;
  background: rgba(0, 30, 60, 0.6);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.profile-pic-container {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.profile-pic-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid #00ffff;
  overflow: hidden;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  font-weight: bold;
}

.profile-pic-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.signature-input {
  width: 100%;
  min-height: 60px;
  padding: 10px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
  resize: vertical;
}

.signature-input:focus {
  outline: none;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.status-selector {
  width: 100%;
  padding: 8px 12px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  margin-bottom: 10px;
}

.storage-warning {
  background: rgba(255, 100, 100, 0.2);
  border: 1px solid #ff3333;
  border-radius: 6px;
  padding: 10px;
  margin: 10px 0;
  color: #ff9999;
  font-size: 0.8rem;
}

.storage-info {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 6px;
  padding: 8px;
  margin: 5px 0;
  color: #a8dfe8;
  font-size: 0.8rem;
}

.user-card {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.user-signature {
  font-size: 0.8em;
  color: #a8dfe8;
  font-style: italic;
  margin-top: 5px;
  border-top: 1px solid rgba(0,255,255,0.3);
  padding-top: 5px;
}

.data-management {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid rgba(0, 255, 255, 0.2);
}

/* Stat Card Styles */
.stat-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 1px solid rgba(0, 255, 255, 0.1);
  position: relative;
  cursor: help;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
  border-color: rgba(0, 255, 255, 0.3);
}

/* Tooltip styles */
.stat-card::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 30, 60, 0.95);
  color: #a8dfe8;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  border: 1px solid #00ffff;
  z-index: 1000;
}

.stat-card:hover::after {
  opacity: 1;
}

/* Responsive */
@media (max-width: 768px) {
  .social-hub-content {
    flex-direction: column;
    height: 95vh;
  }
  
  .social-sidebar {
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid #00ffff;
  }
  
  .social-nav {
    display: flex;
    overflow-x: auto;
    gap: 10px;
  }
  
  .social-nav-btn {
    white-space: nowrap;
    min-width: 120px;
  }

  /* User section mobile */
  .user-dropdown {
    right: -10px;
  }

  /* Theme switcher mobile */
  .theme-switcher {
    bottom: 10px;
    right: 10px;
    flex-wrap: wrap;
    max-width: 200px;
  }

  .music-player {
    bottom: 70px;
    left: 10px;
    max-width: 180px;
  }

  /* Status bar mobile */
  .status-bar {
    flex-direction: column;
    gap: 10px;
    padding: 12px 15px;
  }

  .profile-pic-container {
    flex-direction: column;
    text-align: center;
  }

  /* Mobile login fixes */
  .login-modal .modal-content {
    width: 90% !important;
    margin: 10% auto !important;
    padding: 20px !important;
  }
  
  .auth-form input {
    font-size: 16px !important;
    padding: 14px !important;
  }
  
  .tab-btn {
    padding: 12px 8px !important;
    font-size: 14px !important;
  }

  /* Social hub mobile fixes */
  .social-hub-content {
    flex-direction: column !important;
    height: 95vh !important;
  }
  
  .social-sidebar {
    width: 100% !important;
    height: auto !important;
    max-height: 40vh !important;
    overflow-y: auto !important;
  }
  
  .social-main {
    height: 60vh !important;
    overflow-y: auto !important;
  }
  
  .chat-messages {
    max-height: 45vh !important;
  }
  
  /* Profile content mobile scrolling */
  .profile-content {
    overflow-y: auto !important;
    max-height: 50vh !important;
  }
  
  /* Wall posts mobile */
  .wall-posts {
    max-height: 40vh !important;
    overflow-y: auto !important;
  }
}

/* --- Theme Styles --- */

/* Matrix Theme */
body.matrix-theme {
  --primary-color: #00ff00;
  --secondary-color: #003300;
  --accent-color: #00cc00;
}

body.matrix-theme .brand h1,
body.matrix-theme .platform-caption,
body.matrix-theme .collapsible,
body.matrix-theme .status-indicator {
  color: #00ff00 !important;
  text-shadow: 0 0 10px rgba(0, 255, 0, 0.7) !important;
}

body.matrix-theme .brand .logo {
  background: linear-gradient(135deg, #00ff00, #003300);
}

body.matrix-theme .button {
  background: linear-gradient(180deg, #00ff00, #006600);
  color: #000;
}

body.matrix-theme .status-bar,
body.matrix-theme .theme-switcher {
  border-color: #00ff00;
  background: rgba(0, 30, 0, 0.8);
}

body.matrix-theme .card h3 {
  color: #00ff00;
}

body.matrix-theme .card a {
  color: #00ff00;
}

body.matrix-theme .crt-scanline {
  background: linear-gradient(to bottom, transparent 0%, rgba(0, 255, 0, 0.15) 50%, transparent 100%);
}

/* Windows 95 Theme */
body.windows95-theme {
  --primary-color: #c0c0c0;
  --secondary-color: #000080;
  --accent-color: #808080;
  background: #008080 !important;
}

body.windows95-theme .brand h1,
body.windows95-theme .platform-caption,
body.windows95-theme .collapsible,
body.windows95-theme .status-indicator {
  color: #000080 !important;
  text-shadow: none !important;
}

body.windows95-theme .brand .logo {
  background: linear-gradient(135deg, #c0c0c0, #808080);
  color: #000;
  box-shadow: inset -2px -2px 0px #000, inset 2px 2px 0px #fff;
}

body.windows95-theme .button {
  background: #c0c0c0;
  color: #000;
  border: 2px outset #c0c0c0;
  box-shadow: none;
}

body.windows95-theme .button:hover {
  background: #d0d0d0;
}

body.windows95-theme .status-bar,
body.windows95-theme .theme-switcher {
  border: 2px outset #c0c0c0;
  background: #c0c0c0;
  color: #000;
}

body.windows95-theme .status-indicator {
  color: #000 !important;
}

body.windows95-theme .collapsible {
  background: #c0c0c0;
  color: #000;
  border: 2px outset #c0c0c0;
}

body.windows95-theme .card {
  background: #c0c0c0;
  border: 2px inset #c0c0c0;
  color: #000;
}

body.windows95-theme .card h3 {
  color: #000080;
}

body.windows95-theme .card a {
  color: #000080;
}

body.windows95-theme .crt-scanline,
body.windows95-theme .crt-overlay {
  display: none;
}

/* Sega Saturn Theme - Completely reworked with grey, blue, and black */
body.sega-theme {
  --primary-color: #3a6ea5;
  --secondary-color: #1a1a1a;
  --accent-color: #d4d4d4;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%) !important;
  background-attachment: fixed !important;
}

body.sega-theme .brand h1,
body.sega-theme .platform-caption,
body.sega-theme .collapsible,
body.sega-theme .status-indicator {
  color: #d4d4d4 !important;
  text-shadow: 1px 1px 0 #3a6ea5, 2px 2px 0 #1a1a1a !important;
}

body.sega-theme .brand .logo {
  background: linear-gradient(135deg, #3a6ea5, #d4d4d4, #1a1a1a);
  color: #1a1a1a;
  border: 2px solid #d4d4d4;
}

body.sega-theme .button {
  background: linear-gradient(180deg, #3a6ea5, #2a4e75);
  color: #d4d4d4;
  border: 2px solid #d4d4d4;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .button:hover {
  background: linear-gradient(180deg, #4a7eb5, #3a5e85);
}

body.sega-theme .status-bar,
body.sega-theme .theme-switcher {
  border: 2px solid #d4d4d4;
  background: rgba(26, 26, 26, 0.9);
  box-shadow: 2px 2px 0 #1a1a1a;
  color: #d4d4d4;
}

body.sega-theme .status-indicator {
  color: #d4d4d4 !important;
}

body.sega-theme .collapsible {
  background: rgba(58, 110, 165, 0.8);
  color: #d4d4d4;
  border: 2px solid #d4d4d4;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .card {
  background: rgba(212, 212, 212, 0.95);
  border: 2px solid #3a6ea5;
  color: #1a1a1a;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .card h3 {
  color: #3a6ea5;
  text-shadow: 1px 1px 0 #d4d4d4;
}

body.sega-theme .card p {
  color: #1a1a1a;
}

body.sega-theme .card a {
  color: #3a6ea5;
  font-weight: bold;
}

body.sega-theme .crt-scanline {
  background: linear-gradient(to bottom, transparent 0%, rgba(212, 212, 212, 0.1) 50%, transparent 100%);
}

body.sega-theme .crt-overlay {
  opacity: 0.05;
}

body.sega-theme .search-bar {
  border-color: #3a6ea5;
  background: rgba(26, 26, 26, 0.8);
  color: #d4d4d4;
}

body.sega-theme .search-bar::placeholder {
  color: rgba(212, 212, 212, 0.6);
}

body.sega-theme .copy-btn {
  border-color: #3a6ea5;
  background: rgba(58, 110, 165, 0.1);
  color: #3a6ea5;
}

body.sega-theme .copy-btn:hover {
  background: rgba(58, 110, 165, 0.2);
}

body.sega-theme .copyable {
  background: rgba(58, 110, 165, 0.05);
  border: 1px solid rgba(58, 110, 165, 0.2);
}

body.sega-theme .music-player {
  background: rgba(26, 26, 26, 0.9);
  border: 1px solid #3a6ea5;
}

body.sega-theme .music-station {
  color: #3a6ea5;
}

body.sega-theme .music-btn {
  border-color: #3a6ea5;
  background: rgba(58, 110, 165, 0.1);
  color: #3a6ea5;
}

body.sega-theme .music-btn:hover {
  background: rgba(58, 110, 165, 0.2);
}

/* --- Mobile Optimizations --- */
@media (max-width: 768px) {
  /* Header fixes */
  header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
    padding: 15px 4vw;
  }
  
  .site-nav {
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }
  
  .button {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: auto;
  }
  
  /* Search bar mobile */
  .search-container {
    padding: 0 4vw;
  }
  
  .search-bar {
    font-size: 0.9rem;
    padding: 10px 16px;
  }
  
  /* Status bar fixes */
  .status-bar {
    flex-direction: column;
    gap: 8px;
    padding: 12px 15px;
    margin: 10px 4vw;
    font-size: 0.8rem;
  }
  
  .status-indicator {
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Collapsible fixes */
  .collapsible {
    width: 92%;
    padding: 12px 15px;
    font-size: 0.9rem;
  }
  
  .collapsible::after {
    right: 12px;
    font-size: 1rem;
  }
  
  /* Card fixes */
  .card {
    margin: 0.5rem auto;
    padding: 10px;
    width: 95%;
  }
  
  .card h3 {
    font-size: 1rem;
  }
  
  .card p {
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  /* Content area fixes */
  .content {
    padding: 0 0.5rem;
  }
  
  /* Platform caption */
  .platform-caption {
    font-size: 0.9rem;
    margin: 1rem 4vw;
    line-height: 1.4;
  }
  
  /* Submit section */
  #submitMethodSection {
    margin: 1.5rem 4vw;
    padding: 15px;
  }
  
  #submitMethodSection h2 {
    font-size: 1.1rem;
  }
  
  /* Cursor fixes for mobile */
  #customCursor {
    display: none !important;
  }
  
  body, html {
    cursor: auto !important;
  }

  /* Featured games mobile */
  .game-carousel {
    gap: 15px;
  }
  
  .game-card {
    min-width: 200px;
  }

  /* Event list mobile */
  .event-list {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  /* Extra small screen fixes */
  .brand h1 {
    font-size: 14px;
  }
  
  .brand p {
    font-size: 11px;
  }
  
  .button {
    padding: 6px 10px;
    font-size: 0.8rem;
  }
  
  .theme-switcher {
    flex-wrap: wrap;
  }
  
  .theme-btn {
    flex: 1;
    min-width: 60px;
  }
  
  .status-bar {
    font-size: 0.75rem;
    padding: 10px 12px;
  }
  
  .collapsible {
    font-size: 0.85rem;
    padding: 10px 12px;
  }
  
  .card {
    padding: 8px;
  }
  
  .card h3 {
    font-size: 0.95rem;
  }
  
  .card p {
    font-size: 0.85rem;
  }
  
  /* Fix long text in cards */
  .card a {
    word-break: break-word;
  }
}

/* --- Responsive tweaks --- */
@media (max-width:820px){
  header{ padding:14px; align-items:flex-start; gap:10px; }
  .brand h1{ font-size:16px }
  #customCursor{ width:28px; height:28px }
  .collapsible{ width:94%; }
  #progressContainer{ width:86%; }
}
</style>
</head>
<body>
  <!-- Splash -->
  <div id="splash" role="dialog" aria-modal="true" aria-label="Boot splash">
    <div style="text-align:center;">
      <div style="display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:10px;">
        <div style="width:54px; height:54px; border-radius:10px; background:linear-gradient(135deg,#00e0ff,#ff33cc); box-shadow:0 0 24px rgba(0,224,255,0.12); display:flex; align-items:center; justify-content:center; font-weight:800; color:#010101;">ROM</div>
      </div>
      <h1 id="splashTitle">SYSTEM BOOTING...</h1>
      <p id="bootText">RetroOnlineMatchmaking — Initializing v1.0</p>
      <div id="progressContainer" aria-hidden="true"><div id="progressBar"></div></div>
    </div>
  </div>

  <!-- Theme Switcher - MOVED TO BOTTOM -->
  <div class="theme-switcher">
    <button class="theme-btn active" data-theme="cyberpunk">CYBERPUNK</button>
    <button class="theme-btn" data-theme="matrix">MATRIX</button>
    <button class="theme-btn" data-theme="windows95">WIN95</button>
    <button class="theme-btn" data-theme="sega">SEGA SATURN</button>
  </div>

  <!-- Music Player -->
  <div class="music-player">
    <div class="music-station">
      <span>🎵 Retro Station</span>
      <div class="music-controls">
        <button class="music-btn" id="prevTrack">⏮</button>
        <button class="music-btn" id="playPause">▶️</button>
        <button class="music-btn" id="nextTrack">⏭</button>
        <span id="trackInfo" style="font-size:0.7rem; margin-left:5px;">1/6</span>
      </div>
    </div>
  </div>

  <!-- Decorative backgrounds -->
  <div class="stars" aria-hidden="true"></div>
  <canvas id="retroCanvas" aria-hidden="true"></canvas>
  <div class="crt-overlay" aria-hidden="true"></div>
  <div class="crt-scanline" aria-hidden="true"></div>

  <!-- Main content -->
  <main id="mainContent" style="display:none;">
    <header class="site-header">
      <div class="brand">
        <div class="logo" aria-hidden="true">ROM</div>
        <div>
          <h1>RetroOnlineMatchmaking</h1>
          <p>Play classic games online again</p>
        </div>
      </div>

      <nav class="site-nav" aria-label="primary" style="display:flex; gap:8px; align-items:center;">
        <a class="button" href="https://discord.com/invite/jcRqpmMZdZ" target="_blank" rel="noopener">Join Discord</a>
        <a class="button" href="https://youtube.com/@retroonlinematchmaking?si=JASKyZdqxTyAenLb" target="_blank" rel="noopener">YouTube</a>
        <a class="button" href="https://www.patreon.com/RetroGameMaster?utm_campaign=creatorshare_creator" target="_blank" rel="noopener">Support on Patreon</a>
        <a class="button" id="openSubmitBtn">Submit Method</a>
        <a class="button" href="https://retroonlinematchmaking.flarum.cloud/" target="_blank" rel="noopener">Forum</a>
        <a class="button" id="socialHubBtn">Social Hub</a>
        
        <!-- User Account Section -->
        <div class="user-section" style="display: none;">
          <div class="user-menu">
            <span class="username" id="userDisplayName">Guest</span>
            <div class="user-dropdown">
              <button id="profileBtn">Profile</button>
              <button id="favoritesBtn">My Favorites</button>
              <button id="dataManagementBtn">Data Management</button>
              <button id="logoutBtn">Logout</button>
            </div>
          </div>
        </div>
        <button class="button" id="loginBtn">Login / Register</button>
      </nav>
    </header>

    <!-- Status Bar - UPDATED: Removed Ping -->
    <div class="status-bar">
      <span class="status-indicator">🟢 SYSTEM ONLINE</span>
      <span class="status-indicator live-players">👥 PLAYERS: <span id="playerCount" class="player-count-animation">0</span></span>
      <span class="status-indicator">🕐 <span id="liveClock">--:--:--</span></span>
    </div>

    <!-- Search System -->
    <div class="search-container">
      <input type="text" class="search-bar" placeholder="🔍 Search for platforms, or connection methods..." id="searchInput">
      <div class="search-results" id="searchResults"></div>
    </div>

    <div style="max-width:1100px; margin:1.2rem auto; padding:0 4vw;">
      <div class="platform-caption">Find your Player 2 — choose a platform</div>

      <!-- NEW: Featured Games Section -->
      <section class="featured-games">
        <h2>🔥 Featured Games This Week</h2>
        <div class="game-carousel">
          <div class="game-card">
            <h3>Street Fighter II</h3>
            <p>Classic arcade fighter with active community</p>
            <a class="button" href="#arcade">Play Now</a>
          </div>
          <div class="game-card">
            <h3>Gran Turismo PSP</h3>
            <p>PSP racing game with active community</p>
            <a class="button" href="#psp">Play Now</a>
          </div>
          <div class="game-card">
            <h3>Resident Evil Outbreak</h3>
            <p>PS2 4 player survival horror game with active community</p>
            <a class="button" href="#ps2">Play Now</a>
          </div>
          <div class="game-card">
            <h3>Tekken 3</h3>
            <p>PS1 fighting game with rollback netcode</p>
            <a class="button" href="#ps1">Play Now</a>
          </div>
        </div>
      </section>

      <!-- NEW: Community Events -->
      <section class="community-events">
        <h2>📅 Community Events</h2>
        <div class="event-list">
          <div class="event-card">
            <h3>Resident Evil Outbreak File #2</h3>
            <p>Can you survive a scenerio!?</p>
            <div class="event-date">Friday Oct.24th starting at 8:30 PM EST</div>
          </div>
          <div class="event-card">
            <h3>Gran Turismo PSP</h3>
            <p>Do you have a need for speed?</p>
            <div class="event-date">Oct.25th starting at 1:00PM EST</div>
          </div>
          <div class="event-card">
            <h3>Tekken 6 PSP</h3>
            <p>Are you the king of iron fist tournament?</p>
            <div class="event-date">Oct.25th Starting at 1:00 PM EST</div>
          </div>
            <div class="event-card">
            <h3>Syphon Filter Dark Mirror</h3>
            <p>Keep your friends close and your taser fully charged</p>
            <div class="event-date">Oct.25th Starting at 1:00 PM EST</div>
          </div>
        </div>
      </section>
 <!-- NEW: Clip of the Week Section -->
      <section class="clip-of-week">
        <h2>🎬 Clip of the Week</h2>
        <div class="video-container">
          <iframe 
            src="https://www.youtube.com/embed/rfFrGxlRMj0" 
            title="Gran Turismo PSP Online Multiplayer"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
          </iframe>
        </div>
        <div class="clip-info">
          <h3>This Week's Featured Gameplay</h3>
          <p>Check out this amazing retro gaming moment from our community! Want to be featured next? Share your clips in our Discord!</p>
          <div class="clip-meta">
            <span>📅 Posted:<span id="clipDate"> Oct.18th</span></span>
            <span>👤 By:<span id="clipAuthor"> FlatoutOutAnakin898</span></span>
          </div>
        </div>
      </section>

     <!-- Supporter Hall of Fame -->
<section class="supporter-section">
  <h2>Supporter Hall of Fame</h2>
  <p>Thank you to our amazing supporters who help keep RetroOnlineMatchmaking running!</p>
  <div class="supporter-list">
    <div class="supporter-card">
      <div class="supporter-name">RetroGameMaster</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">Myth Jackson</div>
    </div>
  </div>
</section>

       <!-- Arcade -->
<button class="collapsible" type="button">Arcade Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a> • <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a> • <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>Fightcade</h3>
    <p>Online arcade multiplayer for classic fighters and cabinets.</p>
    <p><a href="https://www.fightcade.com/" target="_blank" rel="noopener">Website/Download</a> • <a href="https://youtu.be/9fpeDgxGTEQ?si=6xqPugYz_t09tbnA" target="_blank" rel="noopener">Video Guide</a> • <a href="https://discord.gg/fightcade-official-160417191743848448" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across various retro systems through RetroArch.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Download</a> • <a href="https://youtu.be/wFE3S5TIawA?si=SzRurCi9KSoR_fbf" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play / streaming for local multiplayer sessions; works for PC hosts.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website</a> • <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
</div>

<!-- PS1 -->
<button class="collapsible" type="button">PS1 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a> • <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a> • <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across various retro systems through RetroArch.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Download</a> • <a href="https://youtu.be/wFE3S5TIawA?si=SzRurCi9KSoR_fbf" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
</div>

<!-- PS2 -->
<button class="collapsible" type="button">PS2 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Jak X: Combat Racing — PS2</h3>
    <p>Multiplayer connection method for Jak X: Combat Racing on PS2.</p>
    <p><strong>DNS:</strong> <span class="copyable">45.7.228.197</span> <button class="copy-btn" data-text="45.7.228.197">📋 Copy</button> • <a href="https://discord.com/invite/jak-x-online-multiplayer-752653132298977330" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>PSRewired — PS2</h3>
    <p>Universal online setup for PS2 games using custom DNS.</p>
    <p><strong>DNS:</strong> <span class="copyable">67.222.156.250</span> <button class="copy-btn" data-text="67.222.156.250">📋 Copy</button> • <a href="https://psrewired.com/guides/pcsx2" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>OBSVR — Resident Evil Outbreak File #2</h3>
    <p>Infrastructure connection method for Resident Evil Outbreak: File #2.</p>
    <p><a href="https://obsrv.org/website" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/88uVwczShn" target="_blank" rel="noopener">Discord</a> • <a href="https://youtu.be/Zv7o--OUQp8" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play and virtual LAN tool for low-latency PS2 emulator multiplayer.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website/Download</a> • <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai</h3>
    <p>LAN tunneling service for PS2 system-link play through PCSX2 and real hardware.</p>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a> • <a href="https://www.teamxlink.co.uk/wiki/PCSX2_XLink_Kai_Setup" target="_blank" rel="noopener">Guide</a></p>
  </div>
</div>

<!-- PS3 -->
<button class="collapsible" type="button">PS3 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>RPCS3</h3>
    <p>PS3 emulator solution — community & guides.</p>
    <p><a href="https://rpcs3.net/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.com/invite/RPCS3" target="_blank" rel="noopener">Discord</a> • <a href="https://www.youtube.com/watch?v=JzaocFeV4po&t=35s" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>PSRewired — PS3</h3>
    <p>Custom DNS & community tooling.</p>
    <p><strong>DNS:</strong> <span class="copyable">67.222.156.250</span> <button class="copy-btn" data-text="67.222.156.250">📋 Copy</button> • <a href="https://psrewired.com/" target="_blank" rel="noopener">Website</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai — PS3</h3>
    <p>Network tunneling for PS3 (hardware & emulator support).</p>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>PSONE (PS3 Revivals)</h3>
    <p>Community revivals & DNS for PS3 games.</p>
    <p><strong>DNS:</strong> <span class="copyable">185.194.142.4</span> <button class="copy-btn" data-text="185.194.142.4">📋 Copy</button> • <a href="https://www.psone.online/getting-started#" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>GT5 & GT6 Revival Server</h3>
    <p>Connection method for Gran Turismo 5 & 6 — works on real hardware, not RPCS3. Tutorial available on their Discord.</p>
    <p><a href="https://discord.gg/gt-online-community-839257361486708816" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>Mod Nation Racers Revival</h3>
    <p>Connection method for Mod Nation Racers on PS3 and RPCS3.</p>
    <p><a href="https://mnrrevival.derole.co.uk/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/HSwP2ket3" target="_blank" rel="noopener">Discord</a></p>
  </div>
</div>

<!-- PSP -->
<button class="collapsible" type="button">PSP Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>EA Nation Hub — PSP</h3>
    <p>Unoffical hub to restore EA PSP multiplayer.</p>
    <p><a href="https://discord.com/invite/fwrQHHxrQQ" target="_blank" rel="noopener">Discord</a> • <a href="https://mohh-revival.pages.dev/#setup" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>Madness Gaming Network</h3>
    <p><a href="https://discord.gg/madness-gaming-network-718348931133603841" target="_blank" rel="noopener">Discord</a> • <a href="https://discord.com/channels/1273100568117641269/1276580987643629578/1294667200434802750" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>Zero Tier</h3>
    <p><a href="https://my.zerotier.com/" target="_blank" rel="noopener">Website</a> • <a href="https://www.youtube.com/watch?v=RdJTc4Kbaig" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>Socom.cc</h3>
    <p><a href="https://discord.gg/SmDJSyZQsb" target="_blank" rel="noopener">Discord</a> • <a href="https://www.socom.cc/status.xml" target="_blank" rel="noopener">Website</a> • <a href="https://github.com/hrydgard/ppsspp/wiki/How-to-play-multiplayer-games-with-PPSSpp" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>OpenSpy</h3>
    <p><a href="https://discord.com/invite/sMaWdbt" target="_blank" rel="noopener">Discord</a> • <a href="https://beta.openspy.net/" target="_blank" rel="noopener">Website</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai</h3>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a> • <a href="https://www.teamxlink.co.uk/wiki/PlayStation_Portable_XLink_Kai_Setup" target="_blank" rel="noopener">Real Hardware Guide</a></p>
    <p><a href="https://www.teamxlink.co.uk/wiki/JPCSP_PSP_Tutorial#:~:text=Now%2C%20as%20of%20Nov%2021st%202020%2C%20the%20PlayStation,and%20real%20PSP%20hardware%20for%20the%20first%20time!" target="_blank" rel="noopener">JPCSP PSP Tutorial</a></p>
  </div>

  <div class="card">
    <h3>Retroverse</h3>
    <p>IP: <span class="copyable">10.42.0.1</span> <button class="copy-btn" data-text="10.42.0.1">📋 Copy</button></p>
    <p><a href="https://retroverze.my.id/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.com/invite/dvspSEXQxa" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>AGRF</h3>
    <p><a href="https://agracingfoundation.org" target="_blank" rel="noopener">Website</a></p>
    <p>DNS: <span class="copyable">147.135.213.57</span> <button class="copy-btn" data-text="147.135.213.57">📋 Copy</button></p>
  </div>
</div>

<!-- Vita -->
<button class="collapsible" type="button">Vita Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Vita3K — PS Vita</h3>
    <p>Ad-hoc revival via Vita3K with XLink and community patches.</p>
    <p><a href="https://discord.gg/aBUTzGnCUS" target="_blank" rel="noopener">Discord</a> • <a href="https://nightly.link/Vita3K/Vita3K/actions/runs/16026361158" target="_blank" rel="noopener">Download</a></p>
  </div>

  <div class="card">
    <h3>Adrenaline (Real Hardware)</h3>
    <p>Ad-hoc and infrastructure multiplayer on modded PS Vita systems using Adrenaline PSP mode.</p>
    <p><a href="https://github.com/TheOfficialFloW/Adrenaline" target="_blank" rel="noopener">GitHub</a> • <a href="https://youtu.be/4ZUxJP0sW_Y" target="_blank" rel="noopener">Setup Guide</a> • <a href="https://discord.gg/aBUTzGnCUS" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- N64 -->
<button class="collapsible" type="button">N64 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Mupen64Plus</h3>
    <p>Netplay and multiplayer support for N64 games via Mupen64Plus emulator.</p>
    <p><a href="https://mupen64plus.org/" target="_blank" rel="noopener">Website/Download</a> • <a href="https://discord.gg/mupen" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- Dreamcast -->
<button class="collapsible" type="button">Dreamcast Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a> • <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a> • <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>DCNet</h3>
    <p>Dreamcast-specific online multiplayer revival service.</p>
    <p><a href="https://dcnet.example.com/" target="_blank" rel="noopener">Website</a> • <a href="https://discord.gg/dcnet" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- PC -->
<button class="collapsible" type="button">PC Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play and virtual LAN tool for low-latency multiplayer sessions.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website/Download</a> • <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
  
  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across many retro systems.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Website</a></p>
  </div>
</div>

      
     
      <!-- Submit -->
      <section id="submitMethodSection">
        <h2>Have a new connection method? Submit it here!</h2>
        <p>Help expand the RetroOnlineMatchmaking network by submitting your own connection methods.</p>
        <a class="button" id="openFormBtn" href="https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform" target="_blank" rel="noopener">Submit New Method</a>
      </section>

      <footer class="site-footer">
        © 2025 RetroOnlineMatchmaking — Built by the community
      </footer>
    </div>
  </main>

  <!-- Google form modal -->
  <div id="formModal" class="modal" aria-hidden="true">
    <span class="close-btn" id="closeModal" role="button" aria-label="Close form">&times;</span>
    <div style="color:#0ff; font-weight:700; margin-bottom:10px;">Have new methods? Submit them here.</div>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform?embedded=true" title="Submission Form">Loading…</iframe>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content" style="background: rgba(0, 30, 60, 0.95); padding: 2rem; border-radius: 12px; max-width: 400px;">
      <span class="close-btn" id="closeLogin">&times;</span>
      <h3 style="color: #00ffff; margin-bottom: 1.5rem;">Retro Login</h3>
      
      <div class="login-tabs">
        <button class="tab-btn active" data-tab="login">Login</button>
        <button class="tab-btn" data-tab="register">Register</button>
      </div>
      
      <form id="loginForm" class="auth-form">
        <input type="text" id="loginUsername" placeholder="Username" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <input type="password" id="loginPassword" placeholder="Password" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Login</button>
      </form>
      
      <form id="registerForm" class="auth-form" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Choose Username" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <input type="password" id="registerPassword" placeholder="Create Password" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <input type="email" id="registerEmail" placeholder="Email (optional)" 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Create Account</button>
      </form>
    </div>
  </div>

  <!-- Social Hub Modal -->
  <div id="socialHubModal" class="modal" style="display: none;">
    <div class="social-hub-content" style="background: rgba(0, 20, 40, 0.95); max-width: 1200px; width: 95%; height: 90vh; border-radius: 12px; display: flex; overflow: hidden;">
      <span class="close-btn" id="closeSocialHub">&times;</span>
      
      <!-- Sidebar -->
      <div class="social-sidebar" style="width: 250px; background: rgba(0, 30, 60, 0.8); padding: 20px; border-right: 1px solid #00ffff;">
        <h3 style="color: #00ffff; margin-bottom: 20px;">Social Hub</h3>
        <nav class="social-nav">
          <button class="social-nav-btn active" data-tab="global-chat">🌐 Global Chat</button>
          <button class="social-nav-btn" data-tab="lobby-chat">🎮 Game Lobbies</button>
          <button class="social-nav-btn" data-tab="my-profile">👤 My Profile</button>
          <button class="social-nav-btn" data-tab="friends">👥 Friends</button>
          <button class="social-nav-btn" data-tab="find-players">🔍 Find Players</button>
          <button class="social-nav-btn" data-tab="recent-activity">📊 Activity</button>
        </nav>
        
        <!-- Online Users -->
        <div class="online-users" style="margin-top: 30px;">
          <h4 style="color: #00ffff; margin-bottom: 10px;">Online Now</h4>
          <div id="onlineUsersList" style="color: #a8dfe8; font-size: 0.9rem;">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Main Content Area -->
      <div class="social-main" style="flex: 1; display: flex; flex-direction: column;">
        <!-- Global Chat Tab -->
        <div id="global-chat" class="social-tab active">
          <div class="chat-header" style="padding: 15px; border-bottom: 1px solid #00ffff; background: rgba(0, 40, 80, 0.6);">
            <h3 style="color: #00ffff; margin: 0;">Global Chat</h3>
            <span id="onlineCount" style="color: #a8dfe8; font-size: 0.9rem;">0 users online</span>
          </div>
          <div id="chatMessages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px;">
            <!-- Messages will appear here -->
          </div>
          <div class="chat-input-container" style="padding: 15px; border-top: 1px solid #00ffff; background: rgba(0, 40, 80, 0.4);">
            <input type="text" id="chatInput" placeholder="Type your message..." 
                   style="width: 100%; padding: 12px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <button id="sendMessage" class="button" style="margin-top: 10px; width: 100%;">Send Message</button>
          </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="my-profile" class="social-tab">
          <div class="profile-header" style="padding: 20px; background: rgba(0, 40, 80, 0.6); border-bottom: 1px solid #00ffff;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div class="profile-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #ff33cc); display: flex; align-items: center; justify-content:center; font-size: 2rem; font-weight: bold;">
                <span id="profileAvatarText">U</span>
              </div>
              <div>
                <h2 id="profileUsername" style="color: #00ffff; margin: 0;">Username</h2>
                <p id="profileJoinDate" style="color: #a8dfe8; margin: 5px 0 0 0;">Joined: Loading...</p>
              </div>
            </div>
          </div>
          
          <div class="profile-content" style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- Profile Customization Section -->
            <div class="profile-customization">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Profile Customization</h3>
              
              <!-- Profile Picture Upload -->
              <div class="profile-pic-container">
                <div class="profile-pic-preview" id="profilePicPreview">
                  <span id="profilePicText">U</span>
                </div>
                <div style="flex: 1;">
                  <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                  <button onclick="document.getElementById('profilePicUpload').click()" class="button" style="margin-bottom: 10px;">Upload Profile Picture</button>
                  <p style="color: #a8dfe8; font-size: 0.8rem; margin: 5px 0;">Max 50KB • JPG/PNG recommended</p>
                </div>
              </div>
              
              <!-- Status Selector -->
              <select class="status-selector" id="userStatus">
                <option value="">Select Status...</option>
                <option value="🎮 Gaming">🎮 Gaming</option>
                <option value="💻 Online">💻 Online</option>
                <option value="🟡 Away">🟡 Away</option>
                <option value="🚫 Do Not Disturb">🚫 Do Not Disturb</option>
                <option value="🤝 Looking to Play">🤝 Looking to Play</option>
                <option value="🎯 Competitive">🎯 Competitive</option>
                <option value="😎 Chilling">😎 Chilling</option>
              </select>
              
              <!-- Signature Input -->
              <textarea class="signature-input" id="userSignature" placeholder="Your custom signature... (Max 140 characters)" maxlength="140"></textarea>
              <div style="text-align: right; color: #a8dfe8; font-size: 0.8rem; margin-top: 5px;">
                <span id="signatureCount">0</span>/140
              </div>
              
              <!-- Storage Info -->
              <div class="storage-info" id="storageInfo">
                📦 Storage: Calculating...
              </div>
            </div>
            
            <!-- User Stats with Clear Labels -->
            <div class="user-stats" style="margin-top: 30px;">
              <h3 style="color: #00ffff; margin-bottom: 15px;">My Stats</h3>
              <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Connection methods you've favorited for quick access">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="favoritesCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;">⭐ Favorites</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Connection Methods</div>
                </div>
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Posts you've made on your profile wall">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="postsCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;">📝 Posts</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Wall Activity</div>
                </div>
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Messages you've sent in global chat">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="messagesCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;">💬 Messages</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Global Chat</div>
                </div>
              </div>
            </div>
            
            <!-- Data Management -->
            <div class="data-management">
              <h4 style="color: #00ffff; margin-bottom: 10px;">Data Management</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="button" onclick="exportProfile()" style="flex: 1; min-width: 120px;">Export Profile</button>
                <button class="button" onclick="document.getElementById('importProfile').click()" style="flex: 1; min-width: 120px;">Import Profile</button>
                <input type="file" id="importProfile" accept=".json" style="display: none;">
                <button class="button muted" onclick="clearProfileData()" style="flex: 1; min-width: 120px;">Clear Data</button>
              </div>
            </div>
            
            <!-- Profile Wall -->
            <div class="profile-wall" style="margin-top: 30px;">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Profile Wall</h3>
              <div class="wall-post-input" style="margin-bottom: 20px;">
                <textarea id="wallPostText" placeholder="Write something on your wall..." 
                          style="width: 100%; height: 80px; padding: 12px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px; resize: vertical;"></textarea>
                <button id="postToWall" class="button" style="margin-top: 10px;">Post to Wall</button>
              </div>
              <div id="wallPosts" class="wall-posts">
                <!-- Wall posts will appear here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Friends Tab -->
        <div id="friends" class="social-tab">
          <div style="padding: 20px;">
            <h3 style="color: #00ffff;">Friends System</h3>
            <div class="friend-requests" style="margin-bottom: 20px;">
              <h4>Friend Requests</h4>
              <div id="friendRequestsList"></div>
            </div>
            <div class="friends-list" style="margin-bottom: 20px;">
              <h4>Your Friends</h4>
              <div id="friendsList"></div>
            </div>
            <div class="find-friends">
              <h4>Find Friends</h4>
              <input type="text" id="searchFriends" placeholder="Search users..." style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
              <div id="searchFriendsResults"></div>
            </div>
          </div>
        </div>
        
        <!-- Game Lobbies Tab -->
        <div id="lobby-chat" class="social-tab">
          <div style="padding: 20px;">
            <h3 style="color: #00ffff;">Game Lobbies</h3>
            <div class="lobby-list">
              <div class="lobby-category">
                <h4>🎮 Active Lobbies</h4>
                <div class="lobby-grid" id="activeLobbies" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                  <!-- Lobbies will be populated here -->
                </div>
              </div>
              <div class="lobby-actions">
                <button class="button" id="createLobbyBtn">Create New Lobby</button>
              </div>
            </div>
          </div>
        </div>
        
       <div id="find-players" class="social-tab">
  <div style="padding: 20px;">
    <h3 style="color: #00ffff; text-align: center; margin-bottom: 20px;">🔍 Find Players</h3>
    
    <!-- Search Filters -->
    <div class="search-filters" style="margin-bottom: 20px; background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div>
          <label style="color: #00ffff; display: block; margin-bottom: 5px;">🎮 Game</label>
          <select id="gameFilter" style="width: 100%; padding: 8px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <option value="">All Games</option>
            <option value="Street Fighter II">Street Fighter II</option>
            <option value="Gran Turismo PSP">Gran Turismo PSP</option>
            <option value="Resident Evil Outbreak">Resident Evil Outbreak</option>
            <option value="Tekken 3">Tekken 3</option>
            <option value="Jak X: Combat Racing">Jak X: Combat Racing</option>
            <option value="Mod Nation Racers">Mod Nation Racers</option>
          </select>
        </div>
        <div>
          <label style="color: #00ffff; display: block; margin-bottom: 5px;">🕹️ Platform</label>
          <select id="platformFilter" style="width: 100%; padding: 8px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <option value="">All Platforms</option>
            <option value="PS1">PS1</option>
            <option value="PS2">PS2</option>
            <option value="PS3">PS3</option>
            <option value="PSP">PSP</option>
            <option value="Arcade">Arcade</option>
            <option value="PC">PC</option>
          </select>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
        <div>
          <label style="color: #00ffff; display: block; margin-bottom: 5px;">👤 Search Players</label>
          <input type="text" id="playerSearchInput" placeholder="Enter username or game..." 
                 style="width: 100%; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        </div>
        <div style="display: flex; align-items: end;">
          <button id="searchPlayersBtn" class="button" style="height: 40px;">Search</button>
        </div>
      </div>
    </div>

    <!-- Search Results -->
    <div class="search-results-container">
      <h4 style="color: #00ffff; margin-bottom: 15px;">🎯 Search Results</h4>
      <div id="playerSearchResults" style="min-height: 200px;">
        <div style="text-align: center; color: #a8dfe8; padding: 40px;">
          <p>Use the filters above to find players</p>
          <p style="font-size: 0.9rem; opacity: 0.7;">Search by game, platform, or username</p>
        </div>
      </div>
    </div>

    <!-- Recently Active Players -->
    <div class="recent-players" style="margin-top: 30px;">
      <h4 style="color: #00ffff; margin-bottom: 15px;">🔥 Recently Active</h4>
      <div id="recentPlayersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>
        
        <div id="recent-activity" class="social-tab">
          <div style="padding: 20px; text-align: center; color: #a8dfe8;">
            <h3 style="color: #00ffff;">Recent Activity</h3>
            <p>See what's happening in the community</p>
            <!-- Activity feed would go here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom cursor -->
  <img id="customCursor" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWZnOXpucnlxdXB5cDNteHJ0ZjJtOGZvOXl1cGoxbms2YTV0Njc4MSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/LrR1cXPmuyYUUMS1W5/giphy.gif" alt="" aria-hidden="true">

<script>
/* ---------- SUPABASE SETUP ---------- */

const SUPABASE_URL = 'https://lapyxhothazalssrbimb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcHl4aG90aGF6YWxzc3JiaW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjg0NDUsImV4cCI6MjA3Njk0NDQ0NX0.isfh75lAbJotctu6dkd_aAYK-2YNyYM4o-jqKFB5tVA';

console.log('✅ Supabase config loaded');

// Initialize Supabase
let supabase;
try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('✅ Supabase client initialized successfully');
} catch (error) {
    console.error('❌ Supabase client creation failed:', error);
    // Fallback to prevent crashes
    supabase = {
        from: () => ({
            select: () => Promise.resolve({ data: [], error: 'Supabase not available' }),
            upsert: () => Promise.resolve({ data: null, error: 'Supabase not available' }),
            eq: () => ({ single: () => Promise.resolve({ data: null, error: 'Supabase not available' }) })
        })
    };
}
// Debug: print current Supabase session
(async () => {
    try {
        const { data } = await supabase.auth.getSession();
        console.log('Supabase session:', data?.session ?? null);
    } catch (e) {
        console.warn('Could not read supabase session', e);
    }
})();
/* ---------- FIXED ACCOUNT SYSTEM ---------- */

function initAccountSystem() {
    console.log('🔄 Initializing account system...');
    initLoginModal();
    initAuthForms();
    initLoginTabs();
    initLogoutHandler();
    initDataManagementHandler();
    checkLoginStatus();
}

function initLoginModal() {
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('loginModal');
    const closeLogin = document.getElementById('closeLogin');
    
    if (loginBtn && loginModal) {
        loginBtn.addEventListener('click', function() {
            loginModal.style.display = 'flex';
        });
    }
    
    if (closeLogin && loginModal) {
        closeLogin.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
    }
    
    // Close modal when clicking outside
    if (loginModal) {
        loginModal.addEventListener('click', function(e) {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
}

function initLoginTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const tab = this.getAttribute('data-tab');
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        });
    });
}

function initAuthForms() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showQuickStatus('Please fill in all fields!', 'error');
                return;
            }
            
            (async () => {
    try {
        // We need an email to sign in — attempt to find a stored email for this username
        const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
        const stored = users[username];
        const signinEmail = stored?.email || `${username}@local.invalid`;

        const { data, error } = await supabase.auth.signInWithPassword({
            email: signinEmail,
            password
        });

        if (error) {
            console.warn('Supabase signIn error:', error);
            // Fall back to local auth for legacy accounts
            if (loginUser(username, password)) {
                document.getElementById('loginModal').style.display = 'none';
                loginForm.reset();
                showQuickStatus(`Welcome back (local), ${username}!`, 'success');
                return;
            }
            showQuickStatus('Login failed: ' + (error.message || JSON.stringify(error)), 'error');
            return;
        }

        // Success: set local session similar to your existing flow
        // Read user profile from localStorage or create minimal local record
        if (!stored) {
            users[username] = {
                password: btoa(password),
                email: signinEmail,
                joined: new Date().toISOString(),
                lastActive: new Date().toISOString(),
                favorites: [],
                profilePic: null,
                signature: '',
                status: '',
                avatarType: 'generated',
                posts: 0,
                messages: 0
            };
            localStorage.setItem('rom-users', JSON.stringify(users));
        }

        // Set rom-current-user to match your existing shape
        const userData = {
            username,
            email: signinEmail,
            joined: users[username].joined,
            favorites: users[username].favorites || []
        };
        localStorage.setItem('rom-current-user', JSON.stringify(userData));
        document.getElementById('loginModal').style.display = 'none';
        loginForm.reset();
        showQuickStatus(`Welcome back, ${username}!`, 'success');
    } catch (err) {
        console.error('Login error:', err);
        showQuickStatus('Login error: ' + (err.message || String(err)), 'error');
    }
})();
        });
    }
    
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value.trim();
            
            if (!username || !password) {
                showQuickStatus('Username and password are required!', 'error');
                return;
            }
            
            if (username.length < 3) {
                showQuickStatus('Username must be at least 3 characters!', 'error');
                return;
            }
            
            if (password.length < 4) {
                showQuickStatus('Password must be at least 4 characters!', 'error');
                return;
            }
            
            (async () => {
    try {
        // Supabase requires an email — if user didn't provide one, synthesize a throwaway
        const signupEmail = email || `${username}@local.invalid`;

        const { data, error } = await supabase.auth.signUp({
            email: signupEmail,
            password
        }, {
            data: { username }
        });

        if (error) {
            console.error('Supabase signUp error:', error);
            showQuickStatus('Registration failed: ' + (error.message || JSON.stringify(error)), 'error');
            return;
        }

        // Note: Email confirmation may be required depending on your Supabase project settings.
        // Create local user entry for offline sessions (keep current local flow)
        registerUser(username, password, signupEmail); // reuse existing local storage registration

        document.getElementById('loginModal').style.display = 'none';
        registerForm.reset();
        showQuickStatus('Account created — check your email to confirm (if required)', 'success');
    } catch (err) {
        console.error('Registration error:', err);
        showQuickStatus('Registration error: ' + (err.message || String(err)), 'error');
    }
})();
        });
    }
}

// FIXED USER MANAGEMENT FUNCTIONS
function loginUser(username, password) {
    console.log('🔐 Attempting login for:', username);
    
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    console.log('Available users:', Object.keys(users));
    
    if (users[username] && users[username].password === btoa(password)) {
        console.log('✅ Login successful for:', username);
        
        // Update last active time
        users[username].lastActive = new Date().toISOString();
        localStorage.setItem('rom-users', JSON.stringify(users));
        
        // Create current user session
        const userData = {
            username: username,
            email: users[username].email,
            joined: users[username].joined,
            favorites: users[username].favorites || [],
            lastActive: users[username].lastActive
        };
        
        localStorage.setItem('rom-current-user', JSON.stringify(userData));
        checkLoginStatus();
        
        // Initialize user systems
        setTimeout(() => {
            initUserFavorites();
            initCustomizationSystems();
        }, 100);
        
        return true;
    }
    
    console.log('❌ Login failed for:', username);
    return false;
}

function registerUser(username, password, email) {
    console.log('📝 Attempting registration for:', username);
    
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    
    if (users[username]) {
        console.log('❌ Username already exists:', username);
        return false;
    }
    
    // Create proper user data with ALL required fields
    const joinDate = new Date().toISOString();
    users[username] = {
        password: btoa(password),
        email: email,
        joined: joinDate,
        lastActive: joinDate,
        favorites: [],
        // Profile customization fields
        profilePic: null,
        signature: '',
        status: '',
        avatarType: 'generated',
        posts: 0,
        messages: 0
    };
    
    localStorage.setItem('rom-users', JSON.stringify(users));
    console.log('✅ User registered:', username);
    
    // Create current user session
    const userData = {
        username: username,
        email: email,
        joined: joinDate,
        favorites: []
    };
    
    localStorage.setItem('rom-current-user', JSON.stringify(userData));
    checkLoginStatus();
    
    // Initialize user systems
    setTimeout(() => {
        initUserFavorites();
        initCustomizationSystems();
    }, 100);
    
    return true;
}

function checkLoginStatus() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    const loginBtn = document.getElementById('loginBtn');
    const userSection = document.querySelector('.user-section');
    const userDisplayName = document.getElementById('userDisplayName');
    
    console.log('🔍 Checking login status:', currentUser);
    
    if (currentUser && currentUser.username) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (userSection) userSection.style.display = 'flex';
        if (userDisplayName) userDisplayName.textContent = currentUser.username;
        console.log('✅ User logged in:', currentUser.username);
    } else {
        if (loginBtn) loginBtn.style.display = 'flex';
        if (userSection) userSection.style.display = 'none';
        console.log('❌ No user logged in');
    }
}

function initLogoutHandler() {
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('rom-current-user');
                checkLoginStatus();
                showQuickStatus('Logged out successfully!', 'info');
                
                // Refresh the page to reset everything
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        });
    }
}

function initDataManagementHandler() {
    // Profile button
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
            
            if (!currentUser) {
                showQuickStatus('Please login first!', 'error');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            // Close login modal if open
            document.getElementById('loginModal').style.display = 'none';
            
            // Open social hub and switch to profile tab
            if (socialModal) {
                socialModal.style.display = 'flex';
                
                // Switch to profile tab
                document.querySelectorAll('.social-nav-btn').forEach(btn => btn.classList.remove('active'));
                const profileNavBtn = document.querySelector('[data-tab="my-profile"]');
                if (profileNavBtn) profileNavBtn.classList.add('active');
                
                document.querySelectorAll('.social-tab').forEach(tab => tab.classList.remove('active'));
                const profileTab = document.getElementById('my-profile');
                if (profileTab) profileTab.classList.add('active');
                
                loadUserProfileForDisplay();
            }
        });
    }
    
    // Favorites button
    const favoritesBtn = document.getElementById('favoritesBtn');
    if (favoritesBtn) {
        favoritesBtn.addEventListener('click', function() {
            const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
            
            if (!currentUser) {
                showQuickStatus('Please login first!', 'error');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            showQuickStatus('Favorites feature coming soon!', 'info');
            // You can implement favorites display here
        });
    }
    
    // Data Management button
    const dataManagementBtn = document.getElementById('dataManagementBtn');
    if (dataManagementBtn) {
        dataManagementBtn.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
            
            if (!currentUser) {
                showQuickStatus('Please login first!', 'error');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            // Close login modal if open
            document.getElementById('loginModal').style.display = 'none';
            
            // Open social hub and switch to profile tab
            if (socialModal) {
                socialModal.style.display = 'flex';
                
                // Switch to profile tab (where data management is)
                document.querySelectorAll('.social-nav-btn').forEach(btn => btn.classList.remove('active'));
                const profileNavBtn = document.querySelector('[data-tab="my-profile"]');
                if (profileNavBtn) profileNavBtn.classList.add('active');
                
                document.querySelectorAll('.social-tab').forEach(tab => tab.classList.remove('active'));
                const profileTab = document.getElementById('my-profile');
                if (profileTab) profileTab.classList.add('active');
                
                loadUserProfileForDisplay();
            }
        });
    }
}
// FIXED Profile Loading
function loadUserProfileForDisplay() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) {
        console.log('No user logged in for profile display');
        return;
    }
    
    console.log('Loading profile for:', currentUser.username);
    
    // Get user data directly from localStorage
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const userData = users[currentUser.username];
    
    if (!userData) {
        console.log('No user data found for:', currentUser.username);
        return;
    }
    
    // Update basic profile info
    const usernameElement = document.getElementById('profileUsername');
    const joinDateElement = document.getElementById('profileJoinDate');
    
    if (usernameElement) usernameElement.textContent = currentUser.username;
    if (joinDateElement) {
        const joinDate = userData.joined ? new Date(userData.joined).toLocaleDateString() : 'Recently';
        joinDateElement.textContent = `Joined: ${joinDate}`;
    }
    
    // Update profile picture in preview
    const preview = document.getElementById('profilePicPreview');
    if (preview) {
        if (userData.profilePic) {
            preview.innerHTML = `<img src="${userData.profilePic}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
            let previewText = document.getElementById('profilePicText');
            if (!previewText) {
                previewText = document.createElement('span');
                previewText.id = 'profilePicText';
                preview.appendChild(previewText);
            }
            previewText.textContent = currentUser.username.charAt(0).toUpperCase();
        }
    }
    
    // Update signature
    const signatureInput = document.getElementById('userSignature');
    const signatureCount = document.getElementById('signatureCount');
    if (signatureInput) {
        signatureInput.value = userData.signature || '';
    }
    if (signatureCount) {
        signatureCount.textContent = (userData.signature || '').length;
    }
    
    // Update status
    const statusSelector = document.getElementById('userStatus');
    if (statusSelector && userData.status) {
        statusSelector.value = userData.status;
    }
    
    // Update profile header avatar
    updateProfileAvatar(currentUser.username, userData);
    
    // Update stats
    updateUserStats();
    updateStorageInfo();
    
    console.log('Profile display fully updated for:', currentUser.username);
}

function updateUserStats() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) return;
    
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const userData = users[currentUser.username];
    
    if (userData) {
        const favoritesCount = userData.favorites ? userData.favorites.length : 0;
        const favoritesElement = document.getElementById('favoritesCount');
        if (favoritesElement) favoritesElement.textContent = favoritesCount;
        
        // You can add more stats here as needed
        console.log('User stats updated - Favorites:', favoritesCount);
    }
}

/* ---------- USER CUSTOMIZATION SYSTEM ---------- */

// Enhanced user profiles with customization - NOW WITH SUPABASE SYNC!
async function saveUserProfile(username, profileData) {
    console.log('Saving profile for:', username, 'Data:', profileData);
    
    // 1. Save to localStorage (immediate, for offline use)
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const existingData = users[username] || {};
    
    users[username] = {
        ...existingData,
        ...profileData,
        lastUpdated: new Date().toISOString()
    };
    
    localStorage.setItem('rom-users', JSON.stringify(users));
    
  // 2. Try to sync to Supabase in background (non-blocking)
setTimeout(async () => {
    try {
        // Get current supabase session and user id if available
        const sessionRes = await supabase.auth.getSession();
        const userId = sessionRes?.data?.session?.user?.id || null;

        const payload = {
            // Prefer UUID from Supabase auth when available
            id: userId || username,
            username: username,
            ...profileData,
            last_updated: new Date().toISOString()
        };

        const { data, error } = await supabase
            .from('users')
            .upsert(payload);

        if (error) {
            console.error('❌ Supabase sync failed (will use localStorage):', error);
            showQuickStatus('Server sync failed: ' + (error.message || JSON.stringify(error)), 'error');
        } else {
            console.log('✅ Profile synced to Supabase!', data);
            showQuickStatus('Profile synced to server', 'success');
        }
    } catch (err) {
        console.error('❌ Supabase sync error (offline?):', err);
        showQuickStatus('Sync error: ' + (err.message || String(err)), 'error');
    }
}, 0);
    
    updateStorageInfo();
    return true;
}

// Function to fix existing users who might have missing data
function fixUserData() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) return;
    
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const userData = users[currentUser.username];
    
    if (userData) {
        // Fix missing join date
        if (!userData.joined) {
            userData.joined = new Date().toISOString();
            console.log('Fixed missing join date for user:', currentUser.username);
        }
        
        // Fix missing profile fields
        const requiredFields = ['profilePic', 'signature', 'status', 'avatarType'];
        let needsFix = false;
        
        requiredFields.forEach(field => {
            if (userData[field] === undefined) {
                userData[field] = field === 'avatarType' ? 'generated' : '';
                needsFix = true;
                console.log('Fixed missing field:', field, 'for user:', currentUser.username);
            }
        });
        
        if (needsFix) {
            localStorage.setItem('rom-users', JSON.stringify(users));
            console.log('User data fixed and saved');
        }
        
        // Also update current-user join date if missing
        if (!currentUser.joined && userData.joined) {
            currentUser.joined = userData.joined;
            localStorage.setItem('rom-current-user', JSON.stringify(currentUser));
            console.log('Fixed current-user join date');
        }
    }
}

// Call this on page load
setTimeout(fixUserData, 1000);

async function loadUserProfile(username) {
    console.log('🔄 Loading profile for:', username);
    
    try {
        // NEW APPROACH: Try different query methods
        
        // Method 1: Try without .single() first
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username);
            
        if (error) {
            console.error('❌ Method 1 failed:', error);
            throw error;
        }
        
        if (!data || data.length === 0) {
            console.log('📭 No user found in Supabase, using localStorage');
            throw new Error('User not found in Supabase');
        }
        
        console.log('✅ Profile loaded from Supabase:', data[0]);
        
        // Update localStorage with fresh data
        const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
        users[username] = { ...users[username], ...data[0] };
        localStorage.setItem('rom-users', JSON.stringify(users));
        
        return data[0];
        
    } catch (error) {
        console.log('📋 Falling back to localStorage due to:', error.message);
        // Fallback to localStorage
        const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
        return users[username] || null;
    }
}
// FIXED Profile Picture System with proper saving
function initProfilePictureSystem() {
  const uploadInput = document.getElementById('profilePicUpload');
  const preview = document.getElementById('profilePicPreview');
  
  if (!uploadInput || !preview) {
    console.log('Profile picture elements not found');
    return;
  }
  
  uploadInput.addEventListener('change', handleProfilePicUpload);
  
  // Load current user's profile pic
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (currentUser) {
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const profile = users[currentUser.username];
    console.log('Loading profile for:', currentUser.username, profile);
    
    if (profile && profile.profilePic) {
      preview.innerHTML = `<img src="${profile.profilePic}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
      console.log('Profile picture loaded from storage');
    } else {
      // Create text element if it doesn't exist
      let previewText = document.getElementById('profilePicText');
      if (!previewText) {
        previewText = document.createElement('span');
        previewText.id = 'profilePicText';
        preview.appendChild(previewText);
      }
      previewText.textContent = currentUser.username.charAt(0).toUpperCase();
      console.log('Using default avatar');
    }
    
    // Also update the profile header avatar
    updateProfileAvatar(currentUser.username, profile);
  }
}

function updateProfileAvatar(username, profile) {
    const avatarLarge = document.querySelector('.profile-avatar-large');
    if (avatarLarge) {
        if (profile && profile.profilePic) {
            avatarLarge.innerHTML = `<img src="${profile.profilePic}" alt="${username}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
            const avatarText = avatarLarge.querySelector('#profileAvatarText');
            if (avatarText) {
                avatarText.textContent = username.charAt(0).toUpperCase();
            }
        }
    }
}

function handleProfilePicUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('File selected:', file.name, file.size);
    
    // Check file size (max 500KB)
    if (file.size > 500 * 1024) {
        showQuickStatus('Image too large! Max 500KB.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        console.log('File read successfully, compressing...');
        
        // Use simpler compression that actually works
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Resize to max 150x150
            let width = img.width;
            let height = img.height;
            const maxDimension = 150;
            
            if (width > height && width > maxDimension) {
                height = (height * maxDimension) / width;
                width = maxDimension;
            } else if (height > maxDimension) {
                width = (width * maxDimension) / height;
                height = maxDimension;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to data URL
            const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
            console.log('Image compressed, size:', Math.round(compressedImage.length / 1024), 'KB');
            
            const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
            
            if (currentUser) {
                console.log('Saving profile picture for:', currentUser.username);
                
                // Get current profile data first
                const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
                const currentProfile = users[currentUser.username] || {};
                
                // Update with new profile pic
                const updatedProfile = {
                    ...currentProfile,
                    profilePic: compressedImage,
                    avatarType: 'custom',
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to users object
                users[currentUser.username] = updatedProfile;
                localStorage.setItem('rom-users', JSON.stringify(users));
                
                console.log('Profile picture saved to localStorage');
                
                // Update preview immediately
                const preview = document.getElementById('profilePicPreview');
                if (preview) {
                    preview.innerHTML = `<img src="${compressedImage}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
                }
                
                // Update profile header avatar
                updateProfileAvatar(currentUser.username, { profilePic: compressedImage });
                
                showQuickStatus('Profile picture saved successfully!', 'success');
                updateStorageInfo();
                
                // Verify it was saved
                setTimeout(() => {
                    const verifyProfile = loadUserProfile(currentUser.username);
                    console.log('Verification - loaded profile:', verifyProfile ? 'Has profilePic:' + !!verifyProfile.profilePic : 'No profile found');
                }, 100);
            }
        };
        img.src = e.target.result;
    };
    
    reader.onerror = function() {
        console.error('Error reading file');
        showQuickStatus('Error reading image file', 'error');
    };
    
    reader.readAsDataURL(file);
}

// Signature System
function initSignatureSystem() {
    const signatureInput = document.getElementById('userSignature');
    const signatureCount = document.getElementById('signatureCount');
    
    signatureInput.addEventListener('input', function() {
        const currentLength = this.value.length;
        signatureCount.textContent = currentLength;
        
        // Update character count color
        if (currentLength > 130) {
            signatureCount.style.color = '#ff3333';
        } else if (currentLength > 110) {
            signatureCount.style.color = '#ffff00';
        } else {
            signatureCount.style.color = '#a8dfe8';
        }
        
        const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
        if (currentUser) {
            saveUserProfile(currentUser.username, {
                signature: this.value
            });
        }
    });
    
    // Load current signature
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (currentUser) {
        const profile = loadUserProfile(currentUser.username);
        if (profile && profile.signature) {
            signatureInput.value = profile.signature;
            signatureCount.textContent = profile.signature.length;
        }
    }
}

// Status System
function initStatusSystem() {
    const statusSelector = document.getElementById('userStatus');
    
    statusSelector.addEventListener('change', function() {
        const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
        if (currentUser) {
            saveUserProfile(currentUser.username, {
                status: this.value,
                statusSince: new Date().toISOString()
            });
            updateOnlineUsers();
            showQuickStatus(`Status updated: ${this.value}`, 'success');
        }
    });
    
    // Load current status
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (currentUser) {
        const profile = loadUserProfile(currentUser.username);
        if (profile && profile.status) {
            statusSelector.value = profile.status;
        }
    }
}

// Storage Management
function updateStorageInfo() {
    const storageInfo = document.getElementById('storageInfo');
    if (!storageInfo) return;
    
    try {
        let totalSize = 0;
        
        // Calculate total storage used
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length * 2; // UTF-16 characters use 2 bytes
            }
        }
        
        const totalSizeKB = Math.round(totalSize / 1024);
        const maxSizeKB = 5120; // 5MB in KB
        
        storageInfo.innerHTML = `📦 Storage: ${totalSizeKB}KB / ${maxSizeKB}KB`;
        
        // Add warning if approaching limit
        if (totalSizeKB > maxSizeKB * 0.8) {
            storageInfo.classList.add('storage-warning');
            storageInfo.style.background = 'rgba(255, 100, 100, 0.2)';
            storageInfo.style.borderColor = '#ff3333';
            storageInfo.innerHTML += ' ⚠️ Storage almost full!';
        } else if (totalSizeKB > maxSizeKB * 0.6) {
            storageInfo.style.background = 'rgba(255, 200, 100, 0.2)';
            storageInfo.style.borderColor = '#ffff00';
        } else {
            storageInfo.classList.remove('storage-warning');
            storageInfo.style.background = 'rgba(0, 255, 255, 0.1)';
            storageInfo.style.borderColor = '#00ffff';
        }
    } catch (e) {
        storageInfo.innerHTML = '📦 Storage: Unable to calculate';
    }
}

// Export/Import Profiles
function exportProfile() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) {
        showQuickStatus('Please login first!', 'error');
        return;
    }
    
    const profile = loadUserProfile(currentUser.username);
    if (!profile) {
        showQuickStatus('No profile data to export!', 'error');
        return;
    }
    
    const dataStr = JSON.stringify(profile, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `rom-profile-${currentUser.username}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showQuickStatus('Profile exported successfully!', 'success');
}

function initImportSystem() {
    const importInput = document.getElementById('importProfile');
    importInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const profileData = JSON.parse(e.target.result);
                const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
                
                if (currentUser) {
                    saveUserProfile(currentUser.username, profileData);
                    updateProfileDisplay();
                    showQuickStatus('Profile imported successfully!', 'success');
                    
                    // Reload all customization
                    initProfilePictureSystem();
                    initSignatureSystem();
                    initStatusSystem();
                }
            } catch (error) {
                showQuickStatus('Invalid profile file!', 'error');
                console.error('Import error:', error);
            }
        };
        reader.readAsText(file);
        
        // Reset input
        event.target.value = '';
    });
}

function clearProfileData() {
    if (!confirm('Are you sure you want to clear all your profile data? This cannot be undone!')) {
        return;
    }
    
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (currentUser) {
        // Keep basic account info, clear customization
        saveUserProfile(currentUser.username, {
            profilePic: null,
            signature: '',
            status: '',
            avatarType: 'generated'
        });
        
        // Reset UI
        const preview = document.getElementById('profilePicPreview');
        const previewText = document.getElementById('profilePicText');
        preview.innerHTML = '';
        previewText.textContent = currentUser.username.charAt(0).toUpperCase();
        preview.appendChild(previewText);
        
        document.getElementById('userSignature').value = '';
        document.getElementById('userStatus').value = '';
        document.getElementById('signatureCount').textContent = '0';
        
        showQuickStatus('Profile data cleared!', 'success');
        updateStorageInfo();
    }
}

// Enhanced Profile Display
function updateProfileDisplay() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) return;
    
    const profile = loadUserProfile(currentUser.username);
    const profileHeader = document.querySelector('.profile-header');
    
    if (profileHeader && profile) {
        // Update profile picture in header
        const avatarContainer = profileHeader.querySelector('.profile-avatar-large');
        if (avatarContainer) {
            if (profile.profilePic) {
                avatarContainer.innerHTML = `<img src="${profile.profilePic}" alt="${currentUser.username}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                const avatarText = avatarContainer.querySelector('#profileAvatarText');
                if (avatarText) {
                    avatarText.textContent = currentUser.username.charAt(0).toUpperCase();
                }
            }
        }
    }
}

// Enhanced User Cards for chat
function createEnhancedUserCard(username, profile) {
    const status = profile.status || '💻 Online';
    const signature = profile.signature || '';
    
    return `
        <div class="user-card">
            <div style="display: flex; align-items: center; gap: 12px;">
                ${profile.profilePic ? 
                    `<img src="${profile.profilePic}" alt="${username}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                    `<div class="user-avatar">${username.charAt(0).toUpperCase()}</div>`
                }
                <div style="flex: 1;">
                    <div style="color: #00ffff; font-weight: bold;">${username}</div>
                    <div style="color: #a8dfe8; font-size: 0.8em;">${status}</div>
                    ${signature ? `<div class="user-signature">${signature}</div>` : ''}
                </div>
            </div>
        </div>
    `;
}

// Enhanced Chat Messages with signatures
function appendEnhancedChatMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${message.username === currentUser.username ? 'message-own' : 'message-other'}`;
    
    const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Get user profile for signature
    const userProfile = loadUserProfile(message.username);
    const signature = userProfile ? userProfile.signature : '';
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-username">${message.username}</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-text">${escapeHtml(message.text)}</div>
        ${signature ? `<div class="user-signature">${signature}</div>` : ''}
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* ---------- INITIALIZE CUSTOMIZATION SYSTEMS ---------- */
function initCustomizationSystems() {
    initProfilePictureSystem();
    initSignatureSystem();
    initStatusSystem();
    initImportSystem();
    updateStorageInfo();
    
    // Update storage info every 30 seconds
    setInterval(updateStorageInfo, 30000);
}

/* ---------- FRIEND SYSTEM ---------- */
function initFriendSystem() {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;

  // Add friend request button to user cards
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-friend-btn')) {
      const username = e.target.dataset.username;
      sendFriendRequest(username);
    }
  });

  // Load friend system in social hub
  loadFriendSystem();
}

function loadFriendSystem() {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;

  const friendsData = JSON.parse(localStorage.getItem(`rom-friends-${currentUser.username}`) || '{}');
  
  // Load friend requests
  loadFriendRequests(friendsData.requests || []);
  
  // Load friends list
  loadFriendsList(friendsData.friends || []);
  
  // Initialize friend search
  initFriendSearch();
}

function sendFriendRequest(username) {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) {
    showQuickStatus('Please login to send friend requests!', 'error');
    return;
  }

  if (username === currentUser.username) {
    showQuickStatus('You cannot add yourself as a friend!', 'error');
    return;
  }

  // Get target user's friend data
  const targetFriends = JSON.parse(localStorage.getItem(`rom-friends-${username}`) || '{}');
  const requests = targetFriends.requests || [];
  
  // Check if request already exists
  if (requests.includes(currentUser.username)) {
    showQuickStatus('Friend request already sent!', 'info');
    return;
  }

  // Add request
  requests.push(currentUser.username);
  targetFriends.requests = requests;
  localStorage.setItem(`rom-friends-${username}`, JSON.stringify(targetFriends));
  
  showQuickStatus(`Friend request sent to ${username}!`, 'success');
}

function loadFriendRequests(requests) {
  const requestsList = document.getElementById('friendRequestsList');
  if (!requestsList) return;

  if (requests.length === 0) {
    requestsList.innerHTML = '<p style="color: #a8dfe8; text-align: center;">No pending requests</p>';
    return;
  }

  requestsList.innerHTML = requests.map(username => `
    <div class="friend-request" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 30, 60, 0.6); border-radius: 6px; margin-bottom: 10px;">
      <span style="color: #00ffff;">${username}</span>
      <div>
        <button class="button accept-friend-btn" data-username="${username}" style="margin-right: 5px;">Accept</button>
        <button class="button muted reject-friend-btn" data-username="${username}">Reject</button>
      </div>
    </div>
  `).join('');

  // Add event listeners
  document.querySelectorAll('.accept-friend-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      acceptFriendRequest(this.dataset.username);
    });
  });

  document.querySelectorAll('.reject-friend-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      rejectFriendRequest(this.dataset.username);
    });
  });
}

function loadFriendsList(friends) {
  const friendsList = document.getElementById('friendsList');
  if (!friendsList) return;

  if (friends.length === 0) {
    friendsList.innerHTML = '<p style="color: #a8dfe8; text-align: center;">No friends yet. Start adding some!</p>';
    return;
  }

  friendsList.innerHTML = friends.map(username => `
    <div class="friend-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 30, 60, 0.6); border-radius: 6px; margin-bottom: 10px;">
      <span style="color: #00ffff;">${username}</span>
      <button class="button muted remove-friend-btn" data-username="${username}">Remove</button>
    </div>
  `).join('');

  // Add event listeners
  document.querySelectorAll('.remove-friend-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      removeFriend(this.dataset.username);
    });
  });
}

function initFriendSearch() {
  const searchInput = document.getElementById('searchFriends');
  if (!searchInput) return;

  searchInput.addEventListener('input', function() {
    const searchTerm = (this.value || '').toLowerCase().trim(); // Add null check
    
    if (searchTerm.length === 0) {
        resetSearch();
        searchResults.textContent = '';
        return;
    }

    // Search through all users
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    const friendsData = JSON.parse(localStorage.getItem(`rom-friends-${currentUser.username}`) || '{}');
    const friends = friendsData.friends || [];
    const pendingRequests = friendsData.requests || [];

    const results = Object.keys(users).filter(username => 
      username.toLowerCase().includes(searchTerm) && 
      username !== currentUser.username &&
      !friends.includes(username)
    );

    const resultsContainer = document.getElementById('searchFriendsResults');
    if (results.length === 0) {
      resultsContainer.innerHTML = '<p style="color: #a8dfe8; text-align: center;">No users found</p>';
      return;
    }

    resultsContainer.innerHTML = results.map(username => {
      const isPending = pendingRequests.includes(username);
      return `
        <div class="search-result" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 30, 60, 0.6); border-radius: 6px; margin-bottom: 10px;">
          <span style="color: #00ffff;">${username}</span>
          <button class="button add-friend-btn" data-username="${username}" ${isPending ? 'disabled' : ''}>
            ${isPending ? 'Request Sent' : 'Add Friend'}
          </button>
        </div>
      `;
    }).join('');

    // Add event listeners to new buttons
    document.querySelectorAll('.add-friend-btn:not([disabled])').forEach(btn => {
      btn.addEventListener('click', function() {
        sendFriendRequest(this.dataset.username);
        this.textContent = 'Request Sent';
        this.disabled = true;
      });
    });
  });
}

function acceptFriendRequest(username) {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;

  // Remove from requests
  const friendsData = JSON.parse(localStorage.getItem(`rom-friends-${currentUser.username}`) || '{}');
  const requests = friendsData.requests || [];
  friendsData.requests = requests.filter(req => req !== username);
  
  // Add to friends
  const friends = friendsData.friends || [];
  if (!friends.includes(username)) {
    friends.push(username);
  }
  friendsData.friends = friends;
  
  localStorage.setItem(`rom-friends-${currentUser.username}`, JSON.stringify(friendsData));
  
  // Also add current user to the other user's friends list
  const otherFriendsData = JSON.parse(localStorage.getItem(`rom-friends-${username}`) || '{}');
  const otherFriends = otherFriendsData.friends || [];
  if (!otherFriends.includes(currentUser.username)) {
    otherFriends.push(currentUser.username);
  }
  otherFriendsData.friends = otherFriends;
  localStorage.setItem(`rom-friends-${username}`, JSON.stringify(otherFriendsData));
  
  showQuickStatus(`Accepted friend request from ${username}!`, 'success');
  loadFriendSystem(); // Reload the friend system
}

function rejectFriendRequest(username) {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;

  const friendsData = JSON.parse(localStorage.getItem(`rom-friends-${currentUser.username}`) || '{}');
  const requests = friendsData.requests || [];
  friendsData.requests = requests.filter(req => req !== username);
  
  localStorage.setItem(`rom-friends-${currentUser.username}`, JSON.stringify(friendsData));
  
  showQuickStatus(`Rejected friend request from ${username}`, 'info');
  loadFriendSystem(); // Reload the friend system
}

function removeFriend(username) {
  if (!confirm(`Are you sure you want to remove ${username} from your friends?`)) {
    return;
  }

  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;

  // Remove from current user's friends
  const friendsData = JSON.parse(localStorage.getItem(`rom-friends-${currentUser.username}`) || '{}');
  const friends = friendsData.friends || [];
  friendsData.friends = friends.filter(friend => friend !== username);
  localStorage.setItem(`rom-friends-${currentUser.username}`, JSON.stringify(friendsData));
  
  // Remove current user from other user's friends
  const otherFriendsData = JSON.parse(localStorage.getItem(`rom-friends-${username}`) || '{}');
  const otherFriends = otherFriendsData.friends || [];
  otherFriendsData.friends = otherFriends.filter(friend => friend !== currentUser.username);
  localStorage.setItem(`rom-friends-${username}`, JSON.stringify(otherFriendsData));
  
  showQuickStatus(`Removed ${username} from friends`, 'info');
  loadFriendSystem(); // Reload the friend system
}

/* ---------- GAME LOBBIES SYSTEM ---------- */
function initGameLobbies() {
  // Add game-specific lobbies with actual functionality
  const lobbyChat = document.getElementById('lobby-chat');
  if (lobbyChat) {
    loadActiveLobbies();
    initLobbyCreation();
  }
}

function loadActiveLobbies() {
  const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
  const activeLobbies = document.getElementById('activeLobbies');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  if (!activeLobbies) return;
  
  if (lobbies.length === 0) {
    activeLobbies.innerHTML = '<p style="color: #a8dfe8; text-align: center; grid-column: 1 / -1;">No active lobbies. Create one!</p>';
    return;
  }

  activeLobbies.innerHTML = lobbies.map(lobby => `
    <div class="lobby-card" style="background: rgba(0, 30, 60, 0.7); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 15px;">
      <div class="lobby-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span class="lobby-game" style="color: #ff33cc; font-weight: bold;">${lobby.game}</span>
        <span class="lobby-players" style="color: #00ffff;">${lobby.players.length}/${lobby.maxPlayers}</span>
      </div>
      <div class="lobby-info" style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9rem;">
        <span class="lobby-host" style="color: #a8dfe8;">Host: ${lobby.host}</span>
        <span class="lobby-status" style="color: #00ff00;">${lobby.status}</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="button join-lobby-btn" data-lobby="${lobby.id}" style="flex: 1;">Join Lobby</button>
        ${currentUser && currentUser.username === lobby.host ? 
          `<button class="button muted close-lobby-btn" data-lobby="${lobby.id}" style="flex: 0 0 auto;">❌</button>` : 
          ''}
      </div>
      ${lobby.players.length > 0 ? `
        <div class="lobby-players-list" style="margin-top: 10px; font-size: 0.8rem; color: #a8dfe8;">
          <strong>Players:</strong> ${lobby.players.join(', ')}
        </div>
      ` : ''}
    </div>
  `).join('');

  // Add event listeners to join buttons
  document.querySelectorAll('.join-lobby-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      joinLobby(this.dataset.lobby);
    });
  });

  // Add event listeners to close buttons
  document.querySelectorAll('.close-lobby-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      closeLobby(this.dataset.lobby);
    });
  });
}

function initLobbyCreation() {
  const createBtn = document.getElementById('createLobbyBtn');
  if (!createBtn) return;

  createBtn.addEventListener('click', function() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (!currentUser) {
      showQuickStatus('Please login to create a lobby!', 'error');
      return;
    }

    // Simple lobby creation - you can expand this with a form
    const game = prompt('Enter game name:');
    if (!game) return;

    const maxPlayers = parseInt(prompt('Maximum players (2-8):', '4')) || 4;
    
    const newLobby = {
      id: Date.now().toString(),
      game: game,
      host: currentUser.username,
      maxPlayers: Math.max(2, Math.min(8, maxPlayers)),
      players: [currentUser.username],
      status: 'Waiting for players',
      created: new Date().toISOString()
    };

    const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
    lobbies.push(newLobby);
    localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
    
    showQuickStatus(`Lobby created for ${game}!`, 'success');
    loadActiveLobbies();
  });
}

function joinLobby(lobbyId) {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) {
    showQuickStatus('Please login to join a lobby!', 'error');
    return;
  }

  const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
  const lobby = lobbies.find(l => l.id === lobbyId);
  
  if (!lobby) {
    showQuickStatus('Lobby not found!', 'error');
    return;
  }

  if (lobby.players.includes(currentUser.username)) {
    showQuickStatus('You are already in this lobby!', 'info');
    return;
  }

  if (lobby.players.length >= lobby.maxPlayers) {
    showQuickStatus('Lobby is full!', 'error');
    return;
  }

  lobby.players.push(currentUser.username);
  localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
  
  showQuickStatus(`Joined ${lobby.game} lobby!`, 'success');
  loadActiveLobbies();
}

function closeLobby(lobbyId) {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) {
    showQuickStatus('Please login to close a lobby!', 'error');
    return;
  }

  const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
  const lobbyIndex = lobbies.findIndex(l => l.id === lobbyId);
  
  if (lobbyIndex === -1) {
    showQuickStatus('Lobby not found!', 'error');
    return;
  }

  const lobby = lobbies[lobbyIndex];
  
  // Only host can close the lobby
  if (lobby.host !== currentUser.username) {
    showQuickStatus('Only the lobby host can close the lobby!', 'error');
    return;
  }

  if (!confirm(`Are you sure you want to close the "${lobby.game}" lobby? This will remove it for all players.`)) {
    return;
  }

  // Remove the lobby
  lobbies.splice(lobbyIndex, 1);
  localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
  
  showQuickStatus('Lobby closed successfully!', 'success');
  loadActiveLobbies();
}
/* ---------- PLAYER SEARCH SYSTEM ---------- */

function initPlayerSearchSystem() {
  const searchBtn = document.getElementById('searchPlayersBtn');
  const searchInput = document.getElementById('playerSearchInput');
  const gameFilter = document.getElementById('gameFilter');
  const platformFilter = document.getElementById('platformFilter');

  if (searchBtn) {
    searchBtn.addEventListener('click', performPlayerSearch);
  }

  if (searchInput) {
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performPlayerSearch();
      }
    });
  }

  // Auto-search when filters change
  if (gameFilter) {
    gameFilter.addEventListener('change', performPlayerSearch);
  }

  if (platformFilter) {
    platformFilter.addEventListener('change', performPlayerSearch);
  }

  // Load recently active players on tab open
  loadRecentlyActivePlayers();
}

function performPlayerSearch() {
  const searchTerm = document.getElementById('playerSearchInput').value.toLowerCase().trim();
  const gameFilter = document.getElementById('gameFilter').value;
  const platformFilter = document.getElementById('platformFilter').value;

  const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  const resultsContainer = document.getElementById('playerSearchResults');

  if (!resultsContainer) return;

  // Get all users except current user
  const allUsers = Object.keys(users)
    .filter(username => username !== (currentUser?.username || ''))
    .map(username => ({
      username,
      ...users[username],
      lastActive: users[username].lastActive || users[username].joined
    }));

  let filteredUsers = allUsers;

  // Apply search term filter
  if (searchTerm) {
    filteredUsers = filteredUsers.filter(user => 
      user.username.toLowerCase().includes(searchTerm) ||
      (user.status && user.status.toLowerCase().includes(searchTerm)) ||
      (user.signature && user.signature.toLowerCase().includes(searchTerm))
    );
  }

  // Apply game filter (simulated - you can enhance this with real game data)
  if (gameFilter) {
    filteredUsers = filteredUsers.filter(user => 
      (user.status && user.status.includes(gameFilter)) ||
      (user.signature && user.signature.includes(gameFilter))
    );
  }

  // Apply platform filter (simulated - you can enhance this with real platform data)
  if (platformFilter) {
    filteredUsers = filteredUsers.filter(user => 
      (user.status && user.status.includes(platformFilter)) ||
      (user.signature && user.signature.includes(platformFilter))
    );
  }

  displaySearchResults(filteredUsers, resultsContainer);
}

function displaySearchResults(users, container) {
  if (users.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; color: #a8dfe8; padding: 40px;">
        <p>No players found matching your criteria</p>
        <p style="font-size: 0.9rem; opacity: 0.7;">Try adjusting your search filters</p>
      </div>
    `;
    return;
  }

  // Sort by last active (most recent first)
  users.sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive));

  container.innerHTML = users.map(user => `
    <div class="player-result-card" style="background: rgba(0, 30, 60, 0.7); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
        ${user.profilePic ? 
          `<img src="${user.profilePic}" alt="${user.username}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` :
          `<div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #ff33cc); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">${user.username.charAt(0).toUpperCase()}</div>`
        }
        <div style="flex: 1;">
          <div style="color: #00ffff; font-weight: bold; font-size: 1.1rem;">${user.username}</div>
          <div style="color: #a8dfe8; font-size: 0.9rem;">${user.status || '💻 Online'}</div>
          ${user.signature ? `<div style="color: #a8dfe8; font-size: 0.8rem; font-style: italic; margin-top: 4px;">"${user.signature}"</div>` : ''}
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #a8dfe8;">
        <span>Last active: ${formatLastActive(user.lastActive)}</span>
        <div style="display: flex; gap: 8px;">
          <button class="button add-friend-btn" data-username="${user.username}" style="padding: 6px 12px; font-size: 0.8rem;">Add Friend</button>
          <button class="button muted send-message-btn" data-username="${user.username}" style="padding: 6px 12px; font-size: 0.8rem;">Message</button>
        </div>
      </div>
    </div>
  `).join('');

  // Add event listeners to new buttons
  container.querySelectorAll('.add-friend-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      sendFriendRequest(this.dataset.username);
    });
  });

  container.querySelectorAll('.send-message-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      startPrivateChat(this.dataset.username);
    });
  });
}

function loadRecentlyActivePlayers() {
  const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  const container = document.getElementById('recentPlayersList');

  if (!container) return;

  // Get recently active users (last 24 hours)
  const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
  
  const recentUsers = Object.keys(users)
    .filter(username => username !== (currentUser?.username || ''))
    .map(username => ({
      username,
      ...users[username],
      lastActive: users[username].lastActive || users[username].joined
    }))
    .filter(user => new Date(user.lastActive) > twentyFourHoursAgo)
    .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
    .slice(0, 6); // Show top 6 most recent

  if (recentUsers.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #a8dfe8; grid-column: 1 / -1;">No recent activity</div>';
    return;
  }

  container.innerHTML = recentUsers.map(user => `
    <div class="recent-player-card" style="background: rgba(0, 30, 60, 0.6); border: 1px solid rgba(0,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
      ${user.profilePic ? 
        `<img src="${user.profilePic}" alt="${user.username}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 8px;">` :
        `<div class="user-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #ff33cc); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.4rem; margin: 0 auto 8px;">${user.username.charAt(0).toUpperCase()}</div>`
      }
      <div style="color: #00ffff; font-weight: bold; margin-bottom: 4px;">${user.username}</div>
      <div style="color: #a8dfe8; font-size: 0.8rem; margin-bottom: 8px;">${user.status || '💻 Online'}</div>
      <button class="button add-friend-btn" data-username="${user.username}" style="padding: 4px 8px; font-size: 0.7rem; width: 100%;">Add Friend</button>
    </div>
  `).join('');

  // Add event listeners
  container.querySelectorAll('.add-friend-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      sendFriendRequest(this.dataset.username);
    });
  });
}

function formatLastActive(timestamp) {
  const now = new Date();
  const lastActive = new Date(timestamp);
  const diffMs = now - lastActive;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return lastActive.toLocaleDateString();
}

function startPrivateChat(username) {
  showQuickStatus(`Private chat with ${username} coming soon!`, 'info');
  // You can implement private messaging here
}
/* ---------- Splash + progress ---------- */
window.addEventListener('load', function onLoad() {
  window.removeEventListener('load', onLoad);
  const splash = document.getElementById('splash');
  const main = document.getElementById('mainContent');
  const progressBar = document.getElementById('progressBar');
  const bootText = document.getElementById('bootText');
  const splashTitle = document.getElementById('splashTitle');
  let progress = 0;
  const messages = [
    "Checking Arcade Servers...",
    "Loading Multiplayer Modules...",
    "Initializing Retro Systems...",
    "Syncing Online Players...",
    "Bringing Up Lobbies..."
  ];
  let idx = 0;
  const interval = setInterval(() => {
    progress += Math.ceil(Math.random()*3);
    if (progress > 100) progress = 100;
    if (progressBar) progressBar.style.width = progress + '%';
    if (progress >= (idx+1)*20 && idx < messages.length) {
      if (bootText) bootText.textContent = messages[idx++];
    }
    if(progress >= 60 && splashTitle && !splashTitle.dataset.switched){
      splashTitle.dataset.switched = '1';
      splashTitle.textContent = "CHECKING CONNECTION...";
    }
    if (progress >= 100) {
      clearInterval(interval);
      if (bootText) bootText.textContent = "ONLINE!";
      setTimeout(() => {
        splash.classList.add('fade');
        setTimeout(()=> {
          try { splash.remove(); } catch(e){ splash.style.display='none'; }
          if (main) { main.style.display = 'block'; main.setAttribute('aria-hidden', 'false'); }
          initAllSystems();
        }, 480);
      }, 420);
    }
  }, 70);
});

/* ---------- NEW: Real User Count System ---------- */
function initLivePlayerCount() {
  const playerCountElement = document.getElementById('playerCount');
  if (!playerCountElement) return;
  
  function updateRealPlayerCount() {
    // Get all registered users
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const userCount = Object.keys(users).length;
    
    // Get currently online users (users who have been active recently)
    const onlineUsers = getOnlineUsers();
    const onlineCount = onlineUsers.length;
    
    // Update display - show online/total format
    playerCountElement.textContent = `${onlineCount}/${userCount}`;
    
    console.log(`📊 User Stats: ${onlineCount} online / ${userCount} total registered`);
  }
  
  function getOnlineUsers() {
    const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
    const onlineUsers = [];
    const now = Date.now();
    const fifteenMinutes = 15 * 60 * 1000; // 15 minutes
    
    // Check each user's last activity
    Object.keys(users).forEach(username => {
      const userData = users[username];
      const lastActive = userData.lastActive || userData.joined || now;
      
      // Consider user online if active in last 15 minutes
      if (now - new Date(lastActive).getTime() < fifteenMinutes) {
        onlineUsers.push(username);
      }
    });
    
    return onlineUsers;
  }
  
  // Update user's last active timestamp
  function updateUserActivity() {
    const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
    if (currentUser && currentUser.username) {
      const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
      if (users[currentUser.username]) {
        users[currentUser.username].lastActive = new Date().toISOString();
        localStorage.setItem('rom-users', JSON.stringify(users));
      }
    }
  }
  
  // Update count every 30 seconds
  setInterval(updateRealPlayerCount, 30000);
  
  // Update on user interactions
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keydown', updateUserActivity);
  
  // Initial update
  updateRealPlayerCount();
  updateUserActivity();
}

/* ---------- NEW: Engagement Features ---------- */
function initEngagementFeatures() {
  // Track user interactions for engagement metrics
  let interactionCount = 0;
  const engagementThreshold = 5;
  
  // Track interactions
  document.addEventListener('click', function() {
    interactionCount++;
    
    // Show engagement message after threshold
    if (interactionCount === engagementThreshold) {
      showQuickStatus('🎮 Active user detected! Thanks for exploring!', 'success');
    }
  });
  
  // Auto-expand first section after delay
  setTimeout(() => {
    const firstCollapsible = document.querySelector('.collapsible');
    if (firstCollapsible && !firstCollapsible.classList.contains('active')) {
      firstCollapsible.click();
    }
  }, 3000);
  
  // Show random tip every 2 minutes
  setInterval(showRandomTip, 120000);
}

function showRandomTip() {
  const tips = [
    "💡 Pro Tip: Use the search bar to quickly find specific games!",
    "💡 Did you know? You can favorite connection methods for quick access!",
    "💡 Join our Discord to find players for your favorite games!",
    "💡 Check out the Social Hub to chat with other retro gamers!",
    "💡 Having issues? Check the video guides linked in each method!"
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  showQuickStatus(randomTip, 'info');
}

/* ---------- Music Player - YOUTUBE RADIO STATION ---------- */
function initMusicPlayer() {
  const playPauseBtn = document.getElementById('playPause');
  const prevTrackBtn = document.getElementById('prevTrack');
  const nextTrackBtn = document.getElementById('nextTrack');
  const trackInfo = document.getElementById('trackInfo');
  
  let isPlaying = false;
  let currentTrack = 0;
  let youtubePlayer = null;
  let userInteracted = false;

  // Ad-free YouTube music streams and playlists
  const musicTracks = [
    {
       id: 'y909GFK2n_c', // Video Game Soundtracks 24/7
    name: '🎮 Video Game OST Radio'
    },
    {
      id: 'jfKfPfyJRdk', // Lofi Girl backup
      name: '💤 Chill Lofi Beats'
    },
    {
      id: '4xDzrJKXOOY', // Synthwave Radio
      name: '🌃 Synthwave Retro Radio'
    },
    {
       id: 'N2UYLx5BGI4', // Final Fantasy & RPG Music
    name: '✨ RPG Music Radio'
    },
    {
      id: '3H6UL3y0K8E', // Pokemon Lofi
    name: '⚡ Pokemon Lofi'
    },
    {
      id: 'rWc0L-NpAzc', // Classic Video Game Music
      name: '🕹️ Classic Game Music'
    }
  ];

  function loadYouTubeAPI() {
    // Load YouTube IFrame API if not already loaded
    if (!window.YT) {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
  }

  function createYouTubePlayer() {
    if (youtubePlayer) {
      youtubePlayer.destroy();
    }

    // Create invisible YouTube player
    const playerDiv = document.createElement('div');
    playerDiv.id = 'youtube-player';
    playerDiv.style.cssText = 'position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px;';
    document.body.appendChild(playerDiv);

    youtubePlayer = new YT.Player('youtube-player', {
      height: '1',
      width: '1',
      videoId: musicTracks[currentTrack].id,
      playerVars: {
        'autoplay': 0,
        'controls': 0,
        'disablekb': 1,
        'fs': 0,
        'iv_load_policy': 3,
        'modestbranding': 1,
        'playsinline': 1,
        'rel': 0,
        'showinfo': 0
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange,
        'onError': onPlayerError
      }
    });
  }

  function onPlayerReady(event) {
    console.log('✅ YouTube Player Ready');
    updateTrackInfo();
  }

  function onPlayerStateChange(event) {
    // Player states: -1=unstarted, 0=ended, 1=playing, 2=paused, 3=buffering, 5=video cued
    if (event.data === YT.PlayerState.ENDED) {
      console.log('🎵 Track ended, playing next');
      nextTrack();
    } else if (event.data === YT.PlayerState.PLAYING) {
      isPlaying = true;
      if (playPauseBtn) playPauseBtn.textContent = '⏸️';
      console.log('🎶 Now playing:', musicTracks[currentTrack].name);
      showQuickStatus(`Now playing: ${musicTracks[currentTrack].name}`, 'success');
    } else if (event.data === YT.PlayerState.PAUSED) {
      isPlaying = false;
      if (playPauseBtn) playPauseBtn.textContent = '▶️';
    }
  }

  function onPlayerError(event) {
    console.log('❌ YouTube error:', event.data);
    showQuickStatus('Stream error, trying next station...', 'error');
    setTimeout(() => nextTrack(), 2000);
  }

  function loadTrack(trackIndex) {
    console.log('🔄 Loading station:', trackIndex + 1, musicTracks[trackIndex].name);
    
    currentTrack = trackIndex;
    
    if (youtubePlayer) {
      youtubePlayer.loadVideoById(musicTracks[trackIndex].id);
    } else {
      createYouTubePlayer();
    }
    
    updateTrackInfo();
  }

  function updateTrackInfo() {
    if (trackInfo) {
      trackInfo.textContent = `${currentTrack + 1}/${musicTracks.length}`;
      trackInfo.title = musicTracks[currentTrack].name;
    }
  }

  function playCurrentTrack() {
    if (!userInteracted) {
      showQuickStatus('⚠️ Click anywhere on the page first!', 'info');
      return;
    }
    
    if (!youtubePlayer) {
      loadTrack(currentTrack);
      return;
    }
    
    console.log('▶️ Playing:', musicTracks[currentTrack].name);
    youtubePlayer.playVideo();
  }

  function pauseCurrentTrack() {
    if (youtubePlayer) {
      youtubePlayer.pauseVideo();
      isPlaying = false;
      if (playPauseBtn) playPauseBtn.textContent = '▶️';
      showQuickStatus('⏸️ Radio paused', 'info');
    }
  }

  function nextTrack() {
    console.log('⏭️ Next station');
    let next = currentTrack + 1;
    if (next >= musicTracks.length) next = 0;
    loadTrack(next);
    
    if (isPlaying) {
      setTimeout(() => playCurrentTrack(), 1000);
    }
  }

  function prevTrack() {
    console.log('⏮️ Previous station');
    let prev = currentTrack - 1;
    if (prev < 0) prev = musicTracks.length - 1;
    loadTrack(prev);
    
    if (isPlaying) {
      setTimeout(() => playCurrentTrack(), 1000);
    }
  }

  // Button event listeners
  if (playPauseBtn) {
    playPauseBtn.addEventListener('click', () => {
      console.log('🎹 Play/Pause clicked');
      userInteracted = true;
      if (!isPlaying) {
        playCurrentTrack();
      } else {
        pauseCurrentTrack();
      }
    });
  }

  if (nextTrackBtn) {
    nextTrackBtn.addEventListener('click', () => {
      console.log('⏭️ Next button clicked');
      userInteracted = true;
      nextTrack();
    });
  }

  if (prevTrackBtn) {
    prevTrackBtn.addEventListener('click', () => {
      console.log('⏮️ Previous button clicked');
      userInteracted = true;
      prevTrack();
    });
  }

  // Initialize
  loadYouTubeAPI();
  
  // Wait for YouTube API to load
  window.onYouTubeIframeAPIReady = function() {
    console.log('📻 YouTube API Ready - Loading first station');
    loadTrack(0);
  };

  // If API takes too long, load directly
  setTimeout(() => {
    if (!youtubePlayer && window.YT) {
      loadTrack(0);
    }
  }, 3000);

  console.log('📻 YouTube Radio initialized with', musicTracks.length, 'stations');
  
  // Enable on any click
  document.addEventListener('click', () => {
    console.log('👆 User interacted');
    userInteracted = true;
  }, { once: true });
}

/* ---------- Sound Effects - FIXED VERSION ---------- */
function initSoundEffects() {
  let soundsEnabled = false;

  // Create a single function to play any sound
  function playSound(type) {
    if (!soundsEnabled) return;
    
    let url, volume;
    
    switch(type) {
      case 'click':
        url = 'https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3';
        volume = 0.3;
        break;
      case 'hover':
        url = 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3';
        volume = 0.2;
        break;
      case 'expand':
        url = 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-changing-tab-206.mp3';
        volume = 0.25;
        break;
      default:
        return;
    }
    
    // Create fresh audio element every time
    const audio = new Audio();
    audio.src = url;
    audio.volume = volume;
    
    // Play and ignore any errors
    audio.play().catch(() => {});
  }

  // Enable sounds on ANY user interaction
  function enableAllSounds() {
    if (soundsEnabled) return;
    soundsEnabled = true;
    console.log('Sounds enabled!');
  }

  // Listen for ANY user interaction
  document.addEventListener('click', enableAllSounds, { once: true });
  document.addEventListener('keydown', enableAllSounds, { once: true });
  document.addEventListener('touchstart', enableAllSounds, { once: true });
  document.addEventListener('mousedown', enableAllSounds, { once: true });

  // Apply to ALL interactive elements
  const allInteractiveElements = document.querySelectorAll(
    'button, .button, .collapsible, .theme-btn, .copy-btn, .music-btn, a, input, textarea'
  );

  allInteractiveElements.forEach(element => {
    // Click sounds
    element.addEventListener('click', (e) => {
      e.stopPropagation();
      playSound('click');
    });
    
    // Hover sounds
    element.addEventListener('mouseenter', () => {
      playSound('hover');
    });
  });

  // Special handling for collapsibles
  document.querySelectorAll('.collapsible').forEach(collapsible => {
    collapsible.addEventListener('click', function() {
      setTimeout(() => {
        if (this.classList.contains('active')) {
          playSound('expand');
        }
      }, 150);
    });
  });

  // Force enable after 2 seconds as fallback
  setTimeout(enableAllSounds, 2000);
}

/* ---------- Live Clock ---------- */
function initLiveClock() {
  function updateClock() {
    const now = new Date();
    document.getElementById('liveClock').textContent = 
      now.toLocaleTimeString([], {hour12: false});
  }
  setInterval(updateClock, 1000);
  updateClock();
}

/* ---------- Typing Effect ---------- */
function initTypingEffect() {
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  
  let typingTimer;
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length > 0) {
      searchResults.style.color = '#ffff00';
      searchResults.textContent = 'Searching...';
      
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        // Existing search logic will handle the actual search
      }, 500);
    }
  });
}

/* ---------- Quick Status Notifications ---------- */
function showQuickStatus(message, type = 'info') {
  const status = document.createElement('div');
  status.textContent = message;
  status.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'error' ? 'rgba(255,0,0,0.9)' : 'rgba(0,255,255,0.9)'};
    color: #000;
    padding: 10px 20px;
    border-radius: 20px;
    z-index: 10000;
    font-weight: bold;
    animation: slideUp 0.3s ease;
    backdrop-filter: blur(10px);
    border: 1px solid #00ffff;
  `;
  
  document.body.appendChild(status);
  
  setTimeout(() => {
    status.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (status.parentNode) {
        status.parentNode.removeChild(status);
      }
    }, 300);
  }, 3000);
}

/* ---------- Enhanced Player Count Animation ---------- */
function animatePlayerCount(newCount, element) {
  const current = parseInt(element.textContent);
  const diff = newCount - current;
  const steps = 10;
  const step = diff / steps;
  
  let currentStep = 0;
  const timer = setInterval(() => {
    currentStep++;
    element.textContent = Math.round(current + (step * currentStep));
    
    if (currentStep >= steps) {
      element.textContent = newCount;
      clearInterval(timer);
    }
  }, 50);
}

/* ---------- Enhanced Easter Eggs ---------- */
function initEasterEggs() {
  const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
  let konamiIndex = 0;
  
  const secretCodes = {
    'iddqd': () => showSecretMessage("GOD MODE ACTIVATED! 🔥\nInvincibility enabled!"),
    'rosebud': () => showSecretMessage("💰 INFINITE MONEY! 💰\nSims reference detected!"),
    'updownleftrightab': () => {
      showSecretMessage("CONTRA CODE!\n+30 Lives unlocked! 🎮");
      createFlyingSprite('💀');
      createFlyingSprite('🔫');
    }
  };
  
  let currentCode = '';
  
  document.addEventListener('keydown', (e) => {
    // Konami Code
    if (e.code === konamiCode[konamiIndex]) {
      konamiIndex++;
      if (konamiIndex === konamiCode.length) {
        activateKonamiEgg();
        konamiIndex = 0;
      }
    } else {
      konamiIndex = 0;
    }
    
    // Secret codes
    currentCode += e.key.toLowerCase();
    
    Object.keys(secretCodes).forEach(code => {
      if (currentCode.includes(code)) {
        secretCodes[code]();
        currentCode = '';
      }
    });
    
    // Reset if too long
    if (currentCode.length > 20) currentCode = '';
  });
}

function activateKonamiEgg() {
  console.log('KONAMI CODE ACTIVATED! 🎮');
  
  const victorySound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-1699.mp3');
  victorySound.volume = 0.5;
  victorySound.play().catch(e => console.log('Audio play prevented'));
  
  const sprites = ['👾', '🕹️', '🎮', '⭐', '🔥', '💎', '🚀', '👑', '🎯', '🏆'];
  for (let i = 0; i < 25; i++) {
    setTimeout(() => {
      createFlyingSprite(sprites[Math.floor(Math.random() * sprites.length)]);
    }, i * 100);
  }
  
  setTimeout(() => {
    showSecretMessage("+30 LIVES UNLOCKED! 🎉\n\nFull power activated!\nRetro mode engaged!");
  }, 500);
  
  const coinSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-coins-2859.mp3');
  for (let i = 0; i < 5; i++) {
    setTimeout(() => {
      coinSound.currentTime = 0;
      coinSound.volume = 0.3;
      coinSound.play().catch(e => console.log('Audio play prevented'));
    }, i * 200);
  }
}

function createFlyingSprite(sprite) {
  const flyingSprite = document.createElement('div');
  flyingSprite.className = 'flying-sprite';
  flyingSprite.textContent = sprite;
  flyingSprite.style.left = '-100px';
  flyingSprite.style.top = Math.random() * window.innerHeight + 'px';
  flyingSprite.style.setProperty('--random-y', (Math.random() - 0.5) * 2);
  flyingSprite.style.fontSize = (Math.random() * 20 + 20) + 'px';
  
  document.body.appendChild(flyingSprite);
  
  setTimeout(() => {
    if (flyingSprite.parentNode) {
      flyingSprite.parentNode.removeChild(flyingSprite);
    }
  }, 3000);
}

function showSecretMessage(message) {
  const secretMessage = document.createElement('div');
  secretMessage.className = 'secret-message';
  secretMessage.textContent = message;
  
  document.body.appendChild(secretMessage);
  
  setTimeout(() => {
    if (secretMessage.parentNode) {
      secretMessage.parentNode.removeChild(secretMessage);
    }
  }, 5000);
}

/* ---------- Collapsibles ---------- */
function initCollapsibles(){
  const coll = document.querySelectorAll('.collapsible');
  coll.forEach(c=>{
    if(c.dataset.bound) return;
    c.dataset.bound = '1';
    c.addEventListener('click', function(){
      this.classList.toggle('active');
      const content = this.nextElementSibling;
      if(!content) return;
      if(content.style.maxHeight){
        content.style.maxHeight = null;
        content.setAttribute('aria-hidden','true');
      } else {
        content.style.maxHeight = content.scrollHeight + 'px';
        content.setAttribute('aria-hidden','false');
      }
    });
  });
}

/* ---------- Form controls ---------- */
function initFormControls(){
  const openBtn = document.getElementById('openSubmitBtn');
  const modal = document.getElementById('formModal');
  const closeModal = document.getElementById('closeModal');
  if(openBtn){
    openBtn.addEventListener('click', function(e){
      const url = "https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform";
      window.open(url, '_blank', 'noopener');
    });
  }
  if(closeModal){
    closeModal.addEventListener('click', ()=> modal.style.display='none');
    window.addEventListener('click', (ev)=> { if(ev.target === modal) modal.style.display='none'; });
  }
}

/* ---------- Live Status Bar - UPDATED: Removed Ping ---------- */
function initStatusBar() {
  const playerCount = document.getElementById('playerCount');
  
  if (!playerCount) return;
  
  // Player count is now handled by initLivePlayerCount()
  // This function is kept for compatibility but the ping functionality has been removed
}

/* ---------- Theme Switcher ---------- */
function initThemeSwitcher() {
  const themeButtons = document.querySelectorAll('.theme-btn');
  const body = document.body;
  
  themeButtons.forEach(button => {
    button.addEventListener('click', function() {
      const theme = this.getAttribute('data-theme');
      
      body.className = body.className.replace(/\b\w+-theme\b/g, '');
      
      if (theme !== 'cyberpunk') {
        body.classList.add(theme + '-theme');
      }
      
      themeButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      showQuickStatus(`Theme: ${theme.toUpperCase()} activated!`, 'info');
    });
  });
}

/* ---------- Search System ---------- */
function initSearchSystem() {
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  const collapsibles = document.querySelectorAll('.collapsible');
  const cards = document.querySelectorAll('.card');
  
  if (!searchInput) return;
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
      resetSearch();
      searchResults.textContent = '';
      return;
    }
    
    let foundResults = false;
    let visibleSections = 0;
    
    collapsibles.forEach(collapsible => {
      const sectionText = collapsible.textContent.toLowerCase();
      const sectionMatches = sectionText.includes(searchTerm);
      
      if (sectionMatches) {
        collapsible.classList.remove('hidden');
        collapsible.innerHTML = collapsible.textContent.replace(
          new RegExp(searchTerm, 'gi'),
          match => `<span class="highlight">${match}</span>`
        );
        const arrow = document.createElement('span');
        arrow.innerHTML = ' &#9654;';
        arrow.style.cssText = 'position:absolute; right:20px; top:50%; transform:translateY(-50%); transition:0.25s;';
        if (collapsible.classList.contains('active')) {
          arrow.style.transform = 'translateY(-50%) rotate(90deg)';
        }
        collapsible.appendChild(arrow);
        visibleSections++;
        foundResults = true;
      } else {
        collapsible.classList.add('hidden');
      }
    });
    
    cards.forEach(card => {
      const cardText = card.textContent.toLowerCase();
      const cardMatches = cardText.includes(searchTerm);
      
      if (cardMatches) {
        card.classList.remove('hidden');
        const parentSection = card.closest('.content');
        if (parentSection) {
          const collapsible = parentSection.previousElementSibling;
          if (collapsible && collapsible.classList.contains('collapsible')) {
            collapsible.classList.remove('hidden');
            if (!collapsible.classList.contains('active')) {
              collapsible.classList.add('active');
              parentSection.style.maxHeight = parentSection.scrollHeight + 'px';
              parentSection.setAttribute('aria-hidden', 'false');
            }
          }
        }
        foundResults = true;
      } else {
        card.classList.add('hidden');
      }
    });
    
    if (foundResults) {
      searchResults.textContent = `Found ${visibleSections} section(s) matching "${searchTerm}"`;
      searchResults.style.color = '#00ffff';
    } else {
      searchResults.textContent = `No results found for "${searchTerm}"`;
      searchResults.style.color = '#ff3366';
    }
  });
  
  function resetSearch() {
    collapsibles.forEach(collapsible => {
      collapsible.classList.remove('hidden');
      const text = collapsible.textContent.replace(/<\/?span[^>]*>/g, '');
      collapsible.innerHTML = text;
      const arrow = document.createElement('span');
      arrow.innerHTML = ' &#9654;';
      arrow.style.cssText = 'position:absolute; right:20px; top:50%; transform:translateY(-50%); transition:0.25s;';
      if (collapsible.classList.contains('active')) {
        arrow.style.transform = 'translateY(-50%) rotate(90deg)';
      }
      collapsible.appendChild(arrow);
    });
    
    cards.forEach(card => {
      card.classList.remove('hidden');
    });
  }
}

/* ---------- Copy DNS Buttons ---------- */
function initCopyButtons() {
  const copyButtons = document.querySelectorAll('.copy-btn');
  
  copyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const textToCopy = this.getAttribute('data-text');
      
      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = this.innerHTML;
        this.innerHTML = '✅ Copied!';
        this.classList.add('copied');
        
        showQuickStatus('DNS copied to clipboard!', 'success');
        
        setTimeout(() => {
          this.innerHTML = originalText;
          this.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        fallbackCopyTextToClipboard(textToCopy, this);
      });
    });
  });
  
  function fallbackCopyTextToClipboard(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        const originalText = button.innerHTML;
        button.innerHTML = '✅ Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }
    } catch (err) {
      console.error('Fallback copy failed: ', err);
      button.innerHTML = '❌ Failed';
      setTimeout(() => {
        button.innerHTML = '📋 Copy';
      }, 2000);
    }
    
    document.body.removeChild(textArea);
  }
}

// Message system
function showMessage(text, type = 'info') {
  const message = document.createElement('div');
  message.className = `message ${type}`;
  message.textContent = text;
  message.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background: ${type === 'error' ? 'rgba(255, 51, 102, 0.9)' : type === 'success' ? 'rgba(0, 255, 0, 0.9)' : 'rgba(0, 255, 255, 0.9)'};
    color: #000;
    border-radius: 6px;
    z-index: 10000;
    backdrop-filter: blur(10px);
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(message);
  
  setTimeout(() => {
    message.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (message.parentNode) {
        message.parentNode.removeChild(message);
      }
    }, 300);
  }, 3000);
}

/* ---------- USER FAVORITES SYSTEM ---------- */
function initUserFavorites() {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  document.querySelectorAll('.card').forEach(card => {
    const favBtn = document.createElement('button');
    favBtn.className = 'favorite-btn';
    favBtn.innerHTML = '☆';
    favBtn.style.cssText = 'position:absolute; top:10px; right:10px; background:none; border:none; color:#ffd700; cursor:pointer; font-size:1.2em; z-index:10;';
    
    const cardId = card.querySelector('h3').textContent.trim();
    
    if (currentUser && currentUser.favorites && currentUser.favorites.includes(cardId)) {
      favBtn.innerHTML = '★';
    }
    
    favBtn.addEventListener('click', function() {
      if (!currentUser) {
        showQuickStatus('Please login to save favorites!', 'error');
        document.getElementById('loginModal').style.display = 'flex';
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
      const userFavorites = users[currentUser.username].favorites || [];
      
      if (userFavorites.includes(cardId)) {
        users[currentUser.username].favorites = userFavorites.filter(fav => fav !== cardId);
        this.innerHTML = '☆';
        showQuickStatus('Removed from favorites', 'info');
      } else {
        users[currentUser.username].favorites.push(cardId);
        this.innerHTML = '★';
        showQuickStatus('Added to favorites!', 'success');
      }
      
      localStorage.setItem('rom-users', JSON.stringify(users));
      
      currentUser.favorites = users[currentUser.username].favorites;
      localStorage.setItem('rom-current-user', JSON.stringify(currentUser));
      
      updateFavoritesDisplay(currentUser.favorites);
    });
    
    card.style.position = 'relative';
    card.appendChild(favBtn);
  });
}

/* ---------- SOCIAL HUB SYSTEM ---------- */
function initSocialHub() {
  const socialBtn = document.getElementById('socialHubBtn');
  const socialModal = document.getElementById('socialHubModal');
  const closeSocial = document.getElementById('closeSocialHub');
  
  if (socialBtn) {
    socialBtn.addEventListener('click', () => {
      const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
      if (!currentUser) {
        showQuickStatus('Please login to access the Social Hub!', 'error');
        document.getElementById('loginModal').style.display = 'flex';
        return;
      }
      
      socialModal.style.display = 'flex';
      loadSocialHub();
    });
  }
  
  if (closeSocial) {
    closeSocial.addEventListener('click', () => {
      socialModal.style.display = 'none';
    });
  }
  
  // Close modal when clicking outside
  socialModal.addEventListener('click', (e) => {
    if (e.target === socialModal) {
      socialModal.style.display = 'none';
    }
  });
  
  initSocialTabs();
  initChatSystem();
  initProfileSystem();
}

function initSocialHubButtons() {
    const socialHubBtn = document.getElementById('socialHubBtn');
    const socialModal = document.getElementById('socialHubModal');
    const closeSocial = document.getElementById('closeSocialHub');
    
    if (socialHubBtn && socialModal) {
        socialHubBtn.addEventListener('click', function() {
            const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
            if (!currentUser) {
                showQuickStatus('Please login to access the Social Hub!', 'error');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            socialModal.style.display = 'flex';
            loadSocialHub();
        });
    }
    
    if (closeSocial) {
        closeSocial.addEventListener('click', function() {
            socialModal.style.display = 'none';
        });
    }
    
    // Close modal when clicking outside
    socialModal.addEventListener('click', function(e) {
        if (e.target === socialModal) {
            socialModal.style.display = 'none';
        }
    });
}

function initSocialTabs() {
  const tabBtns = document.querySelectorAll('.social-nav-btn');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      tabBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const tabId = this.getAttribute('data-tab');
      document.querySelectorAll('.social-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'my-profile') {
        loadUserProfileForDisplay();
      } else {
        loadTabContent(tabId);
      }
    });
  });
}

function loadSocialHub() {
  updateOnlineUsers();
  loadChatMessages();
  loadUserProfileForDisplay();
  updateUserStats();
  loadFriendSystem();
  loadActiveLobbies();
}

// Chat System
function initChatSystem() {
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendMessage');
  
  if (sendBtn) {
    sendBtn.addEventListener('click', sendChatMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });
  }
}

function sendChatMessage() {
  const chatInput = document.getElementById('chatInput');
  const message = chatInput.value.trim();
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  if (!message) return;
  if (!currentUser) {
    showQuickStatus('Please login to chat!', 'error');
    return;
  }
  
  const messageObj = {
    id: Date.now(),
    username: currentUser.username,
    text: message,
    timestamp: new Date().toISOString(),
    type: 'global'
  };
  
  const chatData = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
  chatData.push(messageObj);
  
  if (chatData.length > 100) {
    chatData.splice(0, chatData.length - 100);
  }
  
  localStorage.setItem('rom-chat-messages', JSON.stringify(chatData));
  
  appendEnhancedChatMessage(messageObj);
  chatInput.value = '';
  playChatSound();
}

function loadChatMessages() {
  const chatMessages = document.getElementById('chatMessages');
  const chatData = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
  
  chatMessages.innerHTML = '';
  
  chatData.forEach(msg => {
    appendEnhancedChatMessage(msg);
  });
  
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function appendChatMessage(message) {
  const chatMessages = document.getElementById('chatMessages');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${message.username === currentUser.username ? 'message-own' : 'message-other'}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  messageDiv.innerHTML = `
    <div class="message-header">
      <span class="message-username">${message.username}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-text">${escapeHtml(message.text)}</div>
  `;
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Profile System
function initProfileSystem() {
  const postBtn = document.getElementById('postToWall');
  
  if (postBtn) {
    postBtn.addEventListener('click', postToWall);
  }
}

function postToWall() {
  const postText = document.getElementById('wallPostText').value.trim();
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  if (!postText) return;
  if (!currentUser) {
    showQuickStatus('Please login to post!', 'error');
    return;
  }
  
  const post = {
    id: Date.now(),
    author: currentUser.username,
    content: postText,
    timestamp: new Date().toISOString(),
    likes: 0,
    comments: []
  };
  
  const wallPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
  wallPosts.unshift(post);
  
  localStorage.setItem('rom-wall-posts', JSON.stringify(wallPosts));
  
  appendWallPost(post);
  document.getElementById('wallPostText').value = '';
  updateUserStats();
  showQuickStatus('Posted to your wall!', 'success');
}

function loadWallPosts() {
  const wallPostsContainer = document.getElementById('wallPosts');
  const wallPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  wallPostsContainer.innerHTML = '';
  
  const userPosts = wallPosts.filter(post => post.author === currentUser.username);
  
  userPosts.forEach(post => {
    appendWallPost(post);
  });
}

function appendWallPost(post) {
  const wallPostsContainer = document.getElementById('wallPosts');
  
  const postDiv = document.createElement('div');
  postDiv.className = 'wall-post';
  
  const time = new Date(post.timestamp).toLocaleString();
  
  postDiv.innerHTML = `
    <div class="wall-post-header">
      <span class="wall-post-author">${post.author}</span>
      <span class="wall-post-time">${time}</span>
    </div>
    <div class="wall-post-content">${escapeHtml(post.content)}</div>
    <div class="wall-post-actions" style="margin-top: 10px; display: flex; gap: 15px; font-size: 0.8rem;">
      <button class="like-btn" data-post="${post.id}" style="background: none; border: none; color: #a8dfe8; cursor: pointer;">❤️ ${post.likes}</button>
      <button class="comment-btn" style="background: none; border: none; color: #a8dfe8; cursor: pointer;">💬 Comment</button>
    </div>
  `;
  
  wallPostsContainer.appendChild(postDiv);
}

// FIXED Online Users System - Shows real user data
function updateOnlineUsers() {
  const onlineList = document.getElementById('onlineUsersList');
  const onlineCount = document.getElementById('onlineCount');
  
  if (!onlineList) return;
  
  const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  
  const now = Date.now();
  const fifteenMinutes = 15 * 60 * 1000;
  const onlineUsers = [];
  
  // Get real users who have been active recently
  Object.keys(users).forEach(username => {
    const userData = users[username];
    const lastActive = userData.lastActive || userData.joined || now;
    
    // Consider user online if active in last 15 minutes
    if (now - new Date(lastActive).getTime() < fifteenMinutes) {
      onlineUsers.push({
        username: username,
        profile: userData,
        status: userData.status || '💻 Online'
      });
    }
  });
  
  // Add demo users if no real users online (for testing)
  if (onlineUsers.length <= 1) {
    const demoUsers = [
      { username: 'RetroGamer', status: '🎮 Gaming' },
      { username: 'PixelPusher', status: '💻 Online' },
      { username: 'ArcadeMaster', status: '🤝 Looking to Play' }
    ];
    
    demoUsers.forEach(demoUser => {
      if (!onlineUsers.find(u => u.username === demoUser.username)) {
        onlineUsers.push(demoUser);
      }
    });
  }
  
  onlineList.innerHTML = '';
  onlineUsers.forEach(user => {
    const userDiv = document.createElement('div');
    userDiv.className = 'online-user';
    userDiv.innerHTML = `
      <span class="online-indicator"></span>
      <span style="font-weight: bold; color: #00ffff;">${user.username}</span>  // ← CHANGED to user.username
      <small style="color: #a8dfe8; margin-left: auto;">${user.status}</small>
    `;
    onlineList.appendChild(userDiv);
});
  
  if (onlineCount) {
    onlineCount.textContent = `${onlineUsers.length} users online`;
  }
}

function updateUserStats() {
  const currentUser = JSON.parse(localStorage.getItem('rom-current-user'));
  if (!currentUser) return;
  
  const users = JSON.parse(localStorage.getItem('rom-users') || '{}');
  const userData = users[currentUser.username];
  
  if (userData) {
    const favoritesCount = userData.favorites ? userData.favorites.length : 0;
    document.getElementById('favoritesCount').textContent = favoritesCount;
    
    const wallPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
    const userPosts = wallPosts.filter(post => post.author === currentUser.username).length;
    document.getElementById('postsCount').textContent = userPosts;
    
    const chatMessages = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
    const userMessages = chatMessages.filter(msg => msg.username === currentUser.username).length;
    document.getElementById('messagesCount').textContent = userMessages;
  }
}

function loadTabContent(tabId) {
  switch(tabId) {
    case 'global-chat':
      loadChatMessages();
      break;
    case 'my-profile':
      loadUserProfileForDisplay();
      updateUserStats();
      break;
    case 'friends':
      loadFriendSystem();
      break;
    case 'lobby-chat':
      loadActiveLobbies();
      break;
        case 'find-players':
      initPlayerSearchSystem();
      break;
    case 'recent-activity':
      break;
  }
}

function playChatSound() {
  // Simple direct approach
  try {
    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3');
    audio.volume = 0.2;
    audio.play().catch(() => {});
  } catch (e) {
    // Ignore errors
  }
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Update online users periodically
setInterval(updateOnlineUsers, 30000);

/* ---------- Clip of the Week System ---------- */
function initClipOfWeek() {
  // Load clip data from localStorage or use defaults
  let currentClip = JSON.parse(localStorage.getItem('rom-current-clip'));
  
  if (!currentClip) {
    // Default clip data
    currentClip = {
      videoId: 'rfFrGxlRMj0',
      title: 'This Week\'s Featured Gameplay',
      description: 'Check out this amazing retro gaming moment from our community! Want to be featured next? Share your clips in our Discord!',
      author: 'FlatoutOutAnakin898',
      date: 'Oct.18th',
      game: 'Gran Turismo PSP'
    };
    localStorage.setItem('rom-current-clip', JSON.stringify(currentClip));
  }
  
  // Update the video embed
  const iframe = document.querySelector('.video-container iframe');
  if (iframe && currentClip.videoId) {
    iframe.src = `https://www.youtube.com/embed/${currentClip.videoId}`;
  }
  
  // Update clip info with ACTUAL data from storage
  const clipDate = document.getElementById('clipDate');
  const clipAuthor = document.getElementById('clipAuthor');
  
  if (clipDate) clipDate.textContent = currentClip.date;
  if (clipAuthor) clipAuthor.textContent = currentClip.author;
  
  // Function to update clip (you can call this from console or admin panel)
  window.updateClipOfWeek = function(newClipData) {
    const updatedClip = {
      ...currentClip,
      ...newClipData
    };
    localStorage.setItem('rom-current-clip', JSON.stringify(updatedClip));
    initClipOfWeek();
    showQuickStatus('Clip of the Week updated!', 'success');
  };
  
  // Optional: Auto-update every week
  updateClipWeekly();
}

function updateClipWeekly() {
  // This would automatically rotate clips weekly
  // For now, it's manual via updateClipOfWeek function
  console.log('📹 Clip of the Week system ready - use updateClipOfWeek() to change clips');
}

/* ---------- Cursor & Canvas background ---------- */
function initCursorAndCanvas(){
  const cursor = document.getElementById('customCursor');
  if(cursor && window.innerWidth > 768) {
    cursor.style.display = 'block';
    document.addEventListener('mousemove', function(e){
      cursor.style.left = e.clientX + 'px';
      cursor.style.top = e.clientY + 'px';
    });
  } else if (cursor) {
    cursor.style.display = 'none';
  }
  
  const canvas = document.getElementById('retroCanvas');
  const ctx = canvas.getContext('2d');
  function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const starLayers = [
    {count:80, speed:0.2, sizeRange:[1,2], stars:[]},
    {count:50, speed:0.5, sizeRange:[0.7,1.4], stars:[]},
    {count:25, speed:1.1, sizeRange:[0.6,1.2], stars:[]}
  ];
  starLayers.forEach(layer=>{
    for(let i=0;i<layer.count;i++){
      layer.stars.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        size: Math.random()*(layer.sizeRange[1]-layer.sizeRange[0]) + layer.sizeRange[0],
        col: `rgba(0,255,255,${Math.random()*0.6+0.2})`
      });
    }
  });
  const particles = [];
  for(let i=0;i<40;i++){
    particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.4, vy: (Math.random()-0.5)*0.4, r: Math.random()*1.8+0.6, a: Math.random()*0.6+0.2 });
  }
  const shooting = [];
  function spawnShoot(){ shooting.push({ x: Math.random()*canvas.width, y: -20, vx: Math.random()*3+1.2, vy: Math.random()*2+1.2, len: Math.random()*80+30, a: 1 }); }
  setInterval(spawnShoot, 2600);

  const trail = []; const maxTrail=14;
  if (window.innerWidth > 768) {
    document.addEventListener('mousemove', e => { trail.push({x:e.clientX, y:e.clientY, t:Date.now()}); if(trail.length>maxTrail) trail.shift(); });
  }

  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g = ctx.createRadialGradient(canvas.width/2, canvas.height*0.12, 0, canvas.width/2, canvas.height/1.1, Math.max(canvas.width, canvas.height));
    g.addColorStop(0, 'rgba(0,30,60,0.05)'); g.addColorStop(1, 'rgba(0,0,0,0.6)'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

    starLayers.forEach(layer=>{ layer.stars.forEach(s=>{ s.y += layer.speed; if(s.y>canvas.height) s.y=0; ctx.fillStyle=s.col; ctx.fillRect(s.x,s.y,s.size,s.size); }); });

    ctx.strokeStyle='rgba(0,255,255,0.06)'; ctx.lineWidth=1;
    const spacing=Math.max(60, Math.floor(canvas.width/16)); let offset=(Date.now()/50)%spacing;
    for(let x=0;x<canvas.width;x+=spacing){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
    for(let y=0;y<canvas.height;y+=spacing){ ctx.beginPath(); ctx.moveTo(0,y+offset); ctx.lineTo(canvas.width,y+offset); ctx.stroke(); }

    particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0)p.x=canvas.width; if(p.x>canvas.width)p.x=0; if(p.y<0)p.y=canvas.height; if(p.y>canvas.height)p.y=0; ctx.beginPath(); ctx.fillStyle=`rgba(0,255,255,${p.a})`; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); });

    for(let i=shooting.length-1;i>=0;i--){ const s=shooting[i]; s.x+=s.vx; s.y+=s.vy; s.a-=0.01; ctx.strokeStyle=`rgba(0,255,255,${s.a})`; ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(s.x-s.len,s.y-s.len); ctx.stroke(); if(s.a<=0) shooting.splice(i,1); }

    if (window.innerWidth > 768) {
      for(let i=0;i<trail.length;i++){ const p=trail[i]; const alpha=(i+1)/trail.length*0.9; ctx.fillStyle=`rgba(0,200,255,${alpha*0.5})`; ctx.beginPath(); ctx.arc(p.x,p.y,2+(i/maxTrail)*3,0,Math.PI*2); ctx.fill(); }
    }
    
    requestAnimationFrame(frame);
  }
  frame();
}

/* ---------- DOM stars fallback ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const starContainer = document.querySelector('.stars');
  if(starContainer && starContainer.children.length === 0){
    for(let i=0;i<40;i++){
      const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.opacity=(0.2+Math.random()*0.8).toString();
      starContainer.appendChild(s);
    }
  }
});

/* ---------- Keyboard focus accessibility ---------- */
(function(){
  const body=document.body;
  window.addEventListener('keydown', e=>{ if(e.key==='Tab') body.classList.add('show-focus'); });
  window.addEventListener('mousedown', ()=>{ body.classList.remove('show-focus'); });
})();

// Quick fix 
document.addEventListener('DOMContentLoaded', function() {
    // Fix Social Hub button
    const socialHubBtn = document.getElementById('socialHubBtn');
    if (socialHubBtn) {
        socialHubBtn.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            if (socialModal) {
                socialModal.style.display = 'flex';
            }
        });
    }
    
    // Fix close button
    const closeSocial = document.getElementById('closeSocialHub');
    if (closeSocial) {
        closeSocial.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            if (socialModal) {
                socialModal.style.display = 'none';
            }
        });
    }
});

/* ---------- INITIALIZE ALL SYSTEMS ---------- */
function initAllSystems() {
    console.log('🚀 Initializing all systems...');
    initCursorAndCanvas();
    initCollapsibles();
    initFormControls();
    initStatusBar();
    initSoundEffects();
    initThemeSwitcher();
    initEasterEggs();
    initSearchSystem();
    initCopyButtons();
    initAccountSystem(); // ✅ FIXED ACCOUNT SYSTEM
    initUserFavorites();
    initSocialHub();
    initMusicPlayer();
    initLiveClock();
    initTypingEffect();
    initLivePlayerCount();
    initEngagementFeatures();
    initClipOfWeek();
    initCustomizationSystems();
    initFriendSystem();
    initGameLobbies();
    initPlayerSearchSystem();
  
    console.log('✅ All systems initialized');
}
</script>
</body>
</html>
