<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetroOnlineMatchmaking</title>
  <!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- HTML Editor for Signatures -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  /* Friends System Styles */
.requests-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid #00ffff;
}

.request-tab-btn {
  flex: 1;
  padding: 10px;
  background: none;
  border: none;
  color: #00ffff;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.3s ease;
}

.request-tab-btn.active {
  border-bottom: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.1);
}

.requests-list, .friends-grid, .search-results {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
  padding: 10px;
  background: rgba(0, 30, 60, 0.4);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.friend-request-item, .friend-item, .search-result-item {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0, 255, 255, 0.2);
  border-radius: 8px;
  padding: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s ease;
}

.friend-request-item:hover, .friend-item:hover, .search-result-item:hover {
  border-color: #00ffff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
}

.friend-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.friend-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
}

.friend-details {
  flex: 1;
}

.friend-name {
  color: #00ffff;
  font-weight: bold;
  margin-bottom: 4px;
}

.friend-status {
  color: #a8dfe8;
  font-size: 0.8rem;
}

.request-status {
  color: #ffff00;
  font-size: 0.8rem;
  font-style: italic;
}

.friend-actions {
  display: flex;
  gap: 8px;
}

.friend-btn {
  padding: 6px 12px;
  border: 1px solid;
  border-radius: 6px;
  background: rgba(0, 255, 255, 0.1);
  color: #00ffff;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s ease;
}

.friend-btn.accept {
  background: rgba(0, 255, 0, 0.1);
  border-color: #00ff00;
  color: #00ff00;
}

.friend-btn.decline {
  background: rgba(255, 0, 0, 0.1);
  border-color: #ff3333;
  color: #ff3333;
}

.friend-btn.remove {
  background: rgba(255, 51, 204, 0.1);
  border-color: #ff33cc;
  color: #ff33cc;
}

.friend-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 255, 255, 0.2);
}

.friend-btn.accept:hover {
  background: rgba(0, 255, 0, 0.2);
}

.friend-btn.decline:hover {
  background: rgba(255, 0, 0, 0.2);
}

.friend-btn.remove:hover {
  background: rgba(255, 51, 204, 0.2);
}

.empty-state {
  text-align: center;
  color: #a8dfe8;
  padding: 40px 20px;
  font-style: italic;
}

/* Request item states */
.request-item.received {
  border-left: 4px solid #ff33cc;
}

.request-item.sent {
  border-left: 4px solid #ffff00;
}

.friend-item.online {
  border-left: 4px solid #00ff00;
}

.friend-item.offline {
  border-left: 4px solid #666;
}

.online-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff00;
  margin-right: 8px;
  box-shadow: 0 0 8px #00ff00;
}

.offline-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #666;
  margin-right: 8px;
}
/* --- Base Styling --- */
body, html {
  margin:0; padding:0; font-family:"Orbitron", Arial, sans-serif;
  background:#000; color:#fff; overflow-x:hidden; cursor:none;
}

/* --- Splash Screen --- */
#splash {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:3000; color:#0ff; transition: opacity 0.45s ease, transform 0.45s ease;
}
#splash.fade {
  opacity:0; transform:scale(1.02); pointer-events:none;
}
#splash h1 {
  font-size:clamp(28px,6vw,48px); animation:flicker 1s infinite; margin:0; text-align:center;
  text-shadow: 0 0 12px rgba(0,255,255,0.12);
}
#splash p {
  font-size:clamp(12px,2.4vw,18px); margin:0.5rem 0; animation:flicker 1.5s infinite; text-align:center;
  color: #ff33cc;
}
@keyframes flicker { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* --- Progress --- */
#progressContainer {
  width:70%; max-width:560px; height:12px; background:rgba(0,255,255,0.04); border:2px solid rgba(0,255,255,0.08);
  border-radius:10px; margin-top:18px; overflow:hidden; display:block;
  box-shadow: inset 0 0 18px rgba(0,255,255,0.02);
}
#progressBar { width:0%; height:100%; background:linear-gradient(90deg,#00e0ff,#ff33cc); transition:width 0.12s linear; }

/* --- Starfield container fallback --- */
.stars { position:fixed; width:100%; height:100%; background:transparent; z-index:0; overflow:hidden; pointer-events:none; }

/* --- CRT & overlays --- */
.crt-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  pointer-events:none;
  background-image: repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 3px);
  mix-blend-mode: overlay;
  opacity:0.12; z-index:2000;
}

/* --- CRT Scanline --- */
.crt-scanline {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(to bottom, 
    transparent 0%, 
    rgba(0, 255, 255, 0.15) 50%, 
    transparent 100%);
  animation: scanline 3.5s linear infinite;
  pointer-events: none;
  z-index: 2001;
  mix-blend-mode: overlay;
  opacity: 0.7;
}

@keyframes scanline {
  0% { transform: translateY(-100vh); }
  100% { transform: translateY(100vh); }
}

/* --- Header / layout --- */
header{
  position:relative; z-index:20; padding:clamp(12px,3vw,28px);
  max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding-left:4vw; padding-right:4vw;
}
.brand { display:flex; gap:12px; align-items:center }
.brand .logo { width:48px; height:48px; border-radius:8px; background:linear-gradient(135deg,#00e0ff,#ff33cc);
  display:flex; align-items:center; justify-content:center; font-weight:700; color:#010101; font-size:18px;
  box-shadow:0 0 18px rgba(0,224,255,0.12);
}
.brand h1{ margin:0; font-size:clamp(16px,2.6vw,22px); color:#0ff; text-shadow:0 0 12px rgba(0,224,255,0.12); }
.brand p{ margin:0; font-size:12px; color:#bfeefc; opacity:0.9; }

/* Buttons */
.button {
  display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px;
  background:linear-gradient(180deg,#00d7ff,#00a8bf); color:#001; font-weight:700; border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 6px 20px rgba(0,224,255,0.06);
  text-decoration:none; cursor:pointer; user-select:none;
  transition: transform 0.1s ease;
}
.button.muted{ background:linear-gradient(180deg,#ff33cc,#cc0099); color:#fff; }
.button:hover { transform: translateY(-1px); }

/* --- Theme Switcher - MOVED TO BOTTOM --- */
.theme-switcher {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  gap: 8px;
  background: rgba(0, 20, 40, 0.9);
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #00ffff;
  backdrop-filter: blur(10px);
}

.theme-btn {
  padding: 8px 12px;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.theme-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateY(-2px);
}

.theme-btn.active {
  background: #00ffff;
  color: #000;
  font-weight: bold;
}

/* --- Search System --- */
.search-container {
  max-width: 700px;
  margin: 20px auto;
  padding: 0 4vw;
}

.search-bar {
  width: 100%;
  padding: 12px 20px;
  background: rgba(0, 20, 40, 0.8);
  border: 2px solid #00ffff;
  border-radius: 10px;
  color: #00ffff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 1rem;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
  backdrop-filter: blur(5px);
  transition: all 0.3s ease;
}

.search-bar:focus {
  outline: none;
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
  border-color: #00e0ff;
}

.search-bar::placeholder {
  color: rgba(0, 255, 255, 0.6);
}

.search-results {
  text-align: center;
  color: #00ffff;
  margin: 10px 0;
  font-family: 'Share Tech Mono', monospace;
  min-height: 20px;
}

.no-results {
  color: #ff3366;
  text-align: center;
  padding: 20px;
  font-style: italic;
}

/* Copy Button Styles */
.copy-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 4px;
  color: #00ffff;
  padding: 4px 8px;
  margin-left: 8px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'Share Tech Mono', monospace;
}

.copy-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateY(-1px);
}

.copy-btn.copied {
  background: #00ff00;
  color: #000;
  border-color: #00ff00;
}

.copyable {
  background: rgba(0, 255, 255, 0.05);
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid rgba(0, 255, 255, 0.2);
  font-family: 'Courier New', monospace;
}

/* Server Status Indicators */
.server-status {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}

.status-online {
  background: #00ff00;
  box-shadow: 0 0 8px #00ff00;
}

.status-offline {
  background: #ff3333;
  box-shadow: 0 0 8px #ff3333;
}

.status-checking {
  background: #ffff00;
  box-shadow: 0 0 8px #ffff00;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Easter Egg Elements */
.flying-sprite {
  position: fixed;
  font-size: 24px;
  z-index: 9999;
  pointer-events: none;
  animation: flyAcross 3s linear forwards;
}

@keyframes flyAcross {
  0% {
    transform: translateX(-100px) translateY(0px) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateX(calc(100vw + 100px)) translateY(calc(var(--random-y) * 100px)) rotate(360deg);
    opacity: 0;
  }
}

.secret-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.9);
  color: #00ff00;
  padding: 20px 40px;
  border: 3px solid #00ff00;
  border-radius: 10px;
  font-family: 'Press Start 2P', cursive;
  font-size: 1.2rem;
  text-align: center;
  z-index: 10000;
  animation: messagePulse 2s ease-in-out;
  box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
}

@keyframes messagePulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.1); }
}

/* --- Main Content --- */
#mainContent { display:none; min-height:100vh; position:relative; z-index:10; padding-bottom:4rem; }

/* --- Section top caption --- */
.platform-caption{
  text-align:center; color:#00ffff; font-weight:800; margin:1.2rem 0; font-size:1rem; text-shadow:0 0 8px rgba(0,255,255,0.08);
}

/* --- Collapsible --- */
.collapsible {
  background: rgba(0,0,0,0.6);
  color:#0ff;
  cursor:pointer;
  padding: 1rem;
  width: 90%;
  max-width:1100px;
  border: 2px solid #0ff;
  margin: 1rem auto;
  text-align:left;
  font-weight:800;
  border-radius:10px;
  position:relative;
  transition:0.25s;
}
.collapsible::after{
  content: '\25B6';
  font-size:1.1rem;
  position:absolute; right:20px; top:50%; transform:translateY(-50%);
  transition:0.25s;
}
.collapsible.active::after{ transform:translateY(-50%) rotate(90deg); }
.content { 
  max-height:0; 
  overflow:hidden; 
  transition:max-height .35s ease; 
  padding: 0 1rem;
  background: rgba(0, 20, 40, 0.3);
  border-radius: 0 0 10px 10px;
  margin-top: -2px;
}

/* Hide sections when searching */
.collapsible.hidden, .card.hidden {
  display: none !important;
}

/* Highlight search terms */
.highlight {
  background: rgba(0, 255, 255, 0.3);
  padding: 0 2px;
  border-radius: 2px;
}

/* --- Cards --- */
.card {
  background: rgba(0, 30, 60, 0.7); 
  border:1px solid rgba(0,224,255,0.1); 
  border-radius:8px;
  margin:0.8rem auto; 
  padding:1rem; 
  text-align:left; 
  max-width:1100px;
  box-shadow:0 12px 30px rgba(0,0,0,0.6), 0 0 10px rgba(0,224,255,0.02);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.15);
}
.card h3 { color:#ff33cc; margin:0 0 6px 0; font-size:1.05rem; }
.card p { color:#cfeff6; margin:0.2rem 0; font-size:.95rem; }
.card a { color:#00e0ff; text-decoration:underline; font-weight:700; }

/* --- Supporter Hall of Fame --- */
.supporter-section {
  margin: 2rem auto;
  padding: 18px;
  max-width: 760px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(0,255,255,0.02), rgba(0,0,0,0.18));
  border: 1px solid rgba(0,255,255,0.06);
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  text-align: center;
}

.supporter-section h2 {
  margin: 0 0 8px 0;
  color: #00ffff;
  font-size: 1.3rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.supporter-section p {
  margin: 0 0 12px 0;
  color: #cfeff6;
}

.supporter-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}

.supporter-card {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  min-width: 150px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease;
}

.supporter-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.supporter-name {
  color: #ff33cc;
  font-weight: bold;
  font-size: 1.1rem;
}

/* --- Submit section --- */
#submitMethodSection{
  margin:2rem auto; padding:18px; max-width:760px; border-radius:12px;
  background:linear-gradient(180deg, rgba(0,255,255,0.02), rgba(0,0,0,0.18));
  border:1px solid rgba(0,255,255,0.06);
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  text-align:center;
}
#submitMethodSection h2{ margin:0 0 8px 0; color:#00ffff; font-size:1.3rem; text-shadow:0 0 8px rgba(0,255,255,0.08); }
#submitMethodSection p{ margin:0 0 12px 0; color:#cfeff6; }

/* --- Modal --- */
.modal {
  display:none;
  position:fixed; left:0; top:0; width:100%; height:100%; z-index:4000;
  background:rgba(0,0,0,0.95); justify-content:center; align-items:center; padding:1rem;
}
.modal iframe{ width:90%; max-width:720px; height:85vh; border:none; border-radius:12px; box-shadow:0 0 25px rgba(0,255,255,0.08); }
.close-btn{ position:absolute; top:14px; right:18px; font-size:28px; color:#0ff; cursor:pointer }

/* --- Footer --- */
footer.site-footer { text-align:center; padding:18px 4vw; color:#a8dfe8; font-size:13px; border-top:1px solid rgba(0,224,255,0.04); margin-top:2.2rem }

/* --- Cursor (fixed for correct tracking) --- */
#customCursor{
  position:fixed; width:40px; height:40px; pointer-events:none; z-index:5000; transform:translate(-50%,-50%);
  filter: drop-shadow(0 6px 18px rgba(0,224,255,0.08));
}

/* --- Canvas BG --- */
canvas#retroCanvas{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; }

/* --- Status Bar --- */
.status-bar {
  display: flex;
  justify-content: center;
  gap: 25px;
  margin: 15px auto;
  padding: 10px 20px;
  background: rgba(0, 20, 40, 0.8);
  border: 2px solid #00ffff;
  border-radius: 8px;
  max-width: 700px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.85rem;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
  backdrop-filter: blur(5px);
}

.status-indicator {
  color: #00ffff;
  font-weight: bold;
  white-space: nowrap;
}

/* User Section Styles */
.user-section {
  position: relative;
  display: flex;
  align-items: center;
}

.user-menu {
  position: relative;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
}

.user-menu:hover .user-dropdown {
  display: block;
}

.user-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: rgba(0, 30, 60, 0.95);
  border: 1px solid #00ffff;
  border-radius: 6px;
  padding: 8px;
  min-width: 150px;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.user-dropdown button {
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  color: #00ffff;
  text-align: left;
  cursor: pointer;
  border-radius: 4px;
}

.user-dropdown button:hover {
  background: rgba(0, 255, 255, 0.2);
}

.login-tabs {
  display: flex;
  margin-bottom: 1rem;
  border-bottom: 1px solid #00ffff;
}

.tab-btn {
  flex: 1;
  padding: 10px;
  background: none;
  border: none;
  color: #00ffff;
  cursor: pointer;
  border-bottom: 2px solid transparent;
}

.tab-btn.active {
  border-bottom: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.1);
}

.auth-form {
  transition: all 0.3s ease;
}

/* Profile Badge */
.profile-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 4px 8px;
  background: rgba(0, 255, 255, 0.1);
  border-radius: 20px;
  font-size: 0.8rem;
}

.user-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

/* Message System */
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* Social Hub Styles */
.social-hub-content {
  position: relative;
  backdrop-filter: blur(20px);
  border: 1px solid #00ffff;
  box-shadow: 0 0 40px rgba(0, 255, 255, 0.2);
  /* ADDED: Ensure proper scrolling on desktop */
  overflow: hidden;
}

/* ADDED: Desktop scrolling for social hub */
@media (min-width: 769px) {
  .social-hub-content {
    height: 90vh;
  }
  
  .social-main {
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  .profile-content {
    overflow-y: auto;
    max-height: calc(90vh - 200px);
  }
  
  .wall-posts {
    max-height: 300px;
    overflow-y: auto;
  }
}

.social-nav-btn {
  width: 100%;
  padding: 12px 15px;
  margin: 5px 0;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
  color: #00ffff;
  text-align: left;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', Arial, sans-serif;
}

.social-nav-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: translateX(5px);
}

.social-nav-btn.active {
  background: rgba(0, 255, 255, 0.3);
  border-color: #00ffff;
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

.social-tab {
  display: none;
  flex: 1;
  flex-direction: column;
}

.social-tab.active {
  display: flex;
}

/* Chat Styles */
.chat-messages {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
}

.chat-message {
  padding: 10px 15px;
  border-radius: 8px;
  max-width: 80%;
  word-wrap: break-word;
}

.message-own {
  align-self: flex-end;
  background: rgba(0, 255, 255, 0.2);
  border: 1px solid rgba(0, 255, 255, 0.4);
}

.message-other {
  align-self: flex-start;
  background: rgba(255, 51, 204, 0.2);
  border: 1px solid rgba(255, 51, 204, 0.4);
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 0.8rem;
}

.message-username {
  font-weight: bold;
  color: #00ffff;
}

.message-time {
  color: #a8dfe8;
  opacity: 0.7;
}

.message-text {
  color: #ffffff;
}

/* Wall Post Styles */
.wall-post {
  background: rgba(0, 30, 60, 0.6);
  border: 1px solid rgba(0, 255, 255, 0.2);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.wall-post-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 0.9rem;
}

.wall-post-author {
  color: #00ffff;
  font-weight: bold;
}

.wall-post-time {
  color: #a8dfe8;
  opacity: 0.7;
}

.wall-post-content {
  color: #ffffff;
  line-height: 1.4;
}

/* Online Users */
.online-user {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.online-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff00;
  box-shadow: 0 0 8px #00ff00;
}

/* Status indicators for cards */
.status-pulse {
  width: 8px;
  height: 8px;
  background: #ffff00;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
  display: inline-block;
  margin-right: 5px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
}

.status-dot.online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
.status-dot.offline { background: #ff3333; box-shadow: 0 0 8px #ff3333; }
/* ADDED: Enhanced Lobby Styles */
.lobby-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}

.lobby-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
}

.close-lobby-btn {
  padding: 8px 12px;
  background: rgba(255, 51, 102, 0.2);
  border: 1px solid rgba(255, 51, 102, 0.4);
  border-radius: 6px;
  color: #ff3366;
  cursor: pointer;
  transition: all 0.2s ease;
}

.close-lobby-btn:hover {
  background: rgba(255, 51, 102, 0.3);
  transform: scale(1.05);
}

.lobby-players-list {
  border-top: 1px solid rgba(0, 255, 255, 0.2);
  padding-top: 8px;
  margin-top: 8px;
}
/* Music Player */
.music-player {
  position: fixed;
  bottom: 80px;
  left: 20px;
  background: rgba(0, 20, 40, 0.9);
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #00ffff;
  backdrop-filter: blur(10px);
  z-index: 1000;
}

.music-station {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #00ffff;
  font-size: 0.8rem;
}

.music-controls {
  display: flex;
  gap: 5px;
}

.music-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 4px;
  color: #00ffff;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.7rem;
}

.music-btn:hover {
  background: rgba(0, 255, 255, 0.2);
}

/* NEW: Enhanced animations */
@keyframes pulse-glow {
  0% { box-shadow: 0 0 5px rgba(0,255,255,0.5); }
  50% { box-shadow: 0 0 20px rgba(0,255,255,0.8); }
  100% { box-shadow: 0 0 5px rgba(0,255,255,0.5); }
}

.new-content {
  animation: pulse-glow 2s ease-in-out;
}

@keyframes slideUp {
  from { transform: translateX(-50%) translateY(20px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* NEW: Live Player Count Styles */
.live-players {
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-count-animation {
  display: inline-block;
  animation: countPulse 2s infinite;
}

@keyframes countPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* NEW: Engagement Features */
.featured-games {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.featured-games h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.game-carousel {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding: 10px 0;
  scrollbar-width: thin;
  scrollbar-color: #00ffff #000;
}

.game-carousel::-webkit-scrollbar {
  height: 8px;
}

.game-carousel::-webkit-scrollbar-track {
  background: #000;
  border-radius: 4px;
}

.game-carousel::-webkit-scrollbar-thumb {
  background: #00ffff;
  border-radius: 4px;
}

.game-card {
  min-width: 250px;
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  transition: transform 0.3s ease;
}

.game-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.game-card h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.game-card p {
  color: #cfeff6;
  margin: 0 0 15px 0;
  font-size: 0.9rem;
}

/* NEW: Community Events */
.community-events {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.community-events h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.event-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.event-card {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  transition: transform 0.3s ease;
}

.event-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
}

.event-card h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.event-card p {
  color: #cfeff6;
  margin: 0 0 10px 0;
  font-size: 0.9rem;
}

.event-date {
  color: #00ffff;
  font-weight: bold;
  font-size: 0.8rem;
}
/* --- Clip of the Week Section --- */
.clip-of-week {
  margin: 2rem auto;
  max-width: 1100px;
  padding: 0 4vw;
}

.clip-of-week h2 {
  text-align: center;
  color: #00ffff;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 8px rgba(0,255,255,0.08);
}

.video-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  margin-bottom: 1rem;
  border: 2px solid #00ffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
}

.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.clip-info {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0,224,255,0.1);
  border-radius: 8px;
  padding: 15px;
  margin-top: 1rem;
}

.clip-info h3 {
  color: #ff33cc;
  margin: 0 0 10px 0;
}

.clip-info p {
  color: #cfeff6;
  margin: 0;
  font-size: 0.95rem;
}

.clip-meta {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 0.8rem;
  color: #a8dfe8;
}

/* NEW: User Customization Styles */
.profile-customization {
  margin: 20px 0;
  padding: 15px;
  background: rgba(0, 30, 60, 0.6);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.profile-pic-container {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.profile-pic-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid #00ffff;
  overflow: hidden;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  font-weight: bold;
}

.profile-pic-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.signature-input {
  width: 100%;
  min-height: 60px;
  padding: 10px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
  resize: vertical;
}

.signature-input:focus {
  outline: none;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.status-selector {
  width: 100%;
  padding: 8px 12px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  margin-bottom: 10px;
}

.storage-warning {
  background: rgba(255, 100, 100, 0.2);
  border: 1px solid #ff3333;
  border-radius: 6px;
  padding: 10px;
  margin: 10px 0;
  color: #ff9999;
  font-size: 0.8rem;
}

.storage-info {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 6px;
  padding: 8px;
  margin: 5px 0;
  color: #a8dfe8;
  font-size: 0.8rem;
}

.user-card {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.user-signature {
  font-size: 0.8em;
  color: #a8dfe8;
  font-style: italic;
  margin-top: 5px;
  border-top: 1px solid rgba(0,255,255,0.3);
  padding-top: 5px;
}

.data-management {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid rgba(0, 255, 255, 0.2);
}

/* Stat Card Styles */
.stat-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 1px solid rgba(0, 255, 255, 0.1);
  position: relative;
  cursor: help;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
  border-color: rgba(0, 255, 255, 0.3);
}

/* Tooltip styles */
.stat-card::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
      background: rgba(0, 30, 60, 0.95);
  color: #a8dfe8;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  border: 1px solid #00ffff;
  z-index: 1000;
}

.stat-card:hover::after {
  opacity: 1;
}

/* HTML Editor Styles for Signatures */
.signature-editor-container {
  margin: 15px 0;
  border: 1px solid #00ffff;
  border-radius: 6px;
  overflow: hidden;
}

.signature-editor-toolbar {
  background: rgba(0, 20, 40, 0.9);
  border-bottom: 1px solid #00ffff;
  padding: 8px;
}

.signature-editor {
  background: rgba(0, 10, 20, 0.8);
  min-height: 120px;
  max-height: 200px;
  overflow-y: auto;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
}

/* Signature Preview Styling */
.signature-preview {
  min-height: 40px;
  padding: 15px;
  background: rgba(0, 20, 40, 0.6);
  border: 1px solid rgba(0, 255, 255, 0.3);
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
  overflow: auto;
}

.signature-preview * {
  margin: 0;
  padding: 0;
  line-height: 1.4;
}

.signature-preview div {
  margin-bottom: 5px;
}

.signature-preview div:last-child {
  margin-bottom: 0;
}

/* Individual Profile Page Styles */
.profile-page {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

.profile-header-section {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 20px;
  border: 1px solid rgba(0, 255, 255, 0.2);
  display: flex;
  align-items: center;
  gap: 25px;
}

.profile-avatar-xlarge {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 3px solid #00ffff;
  overflow: hidden;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  font-weight: bold;
  flex-shrink: 0;
}

.profile-avatar-xlarge img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-info-main {
  flex: 1;
}

.profile-username-large {
  color: #00ffff;
  font-size: 2rem;
  margin: 0 0 10px 0;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.profile-status-large {
  color: #ff33cc;
  font-size: 1.1rem;
  margin: 0 0 15px 0;
}

.profile-signature-large {
  color: #a8dfe8;
  font-style: italic;
  font-size: 1rem;
  margin: 10px 0;
  padding: 10px;
  background: rgba(0, 20, 40, 0.4);
  border-radius: 6px;
  border-left: 3px solid #00ffff;
}

.profile-meta {
  display: flex;
  gap: 20px;
  margin-top: 15px;
  color: #a8dfe8;
  font-size: 0.9rem;
}

.profile-content-grid {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 20px;
}

.profile-main-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.profile-sidebar {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.friends-list-mini {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 15px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.friends-list-mini h3 {
  color: #00ffff;
  margin: 0 0 15px 0;
  font-size: 1.1rem;
}

.friend-item-mini {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.friend-item-mini:last-child {
  border-bottom: none;
}

.friend-avatar-mini {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: bold;
  flex-shrink: 0;
}

.friend-avatar-mini img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* NEW: Profile Background Styles */
.profile-background-section {
  margin: 20px 0;
  padding: 15px;
  background: rgba(0, 30, 60, 0.6);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.profile-background-preview {
  width: 100%;
  height: 150px;
  border: 2px solid #00ffff;
  border-radius: 8px;
  margin-bottom: 15px;
  overflow: hidden;
  background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #00ffff;
  font-weight: bold;
}

.profile-background-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-options {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

.background-option {
  height: 80px;
  border: 2px solid rgba(0, 255, 255, 0.3);
  border-radius: 6px;
  cursor: pointer;
  overflow: hidden;
  transition: all 0.3s ease;
}

.background-option:hover {
  border-color: #00ffff;
  transform: scale(1.05);
}

.background-option.active {
  border-color: #00ffff;
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

.background-option img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-option.color {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: bold;
  color: #000;
}

.background-option.custom {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  background: rgba(0, 255, 255, 0.1);
  color: #00ffff;
  font-size: 0.7rem;
  text-align: center;
}

/* NEW: Profile Music Player Styles */
.profile-music-section {
  margin: 20px 0;
  padding: 15px;
  background: rgba(0, 30, 60, 0.6);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.profile-music-preview {
  width: 100%;
  padding: 15px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 8px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.profile-music-info {
  flex: 1;
}

.profile-music-title {
  color: #00ffff;
  font-weight: bold;
  margin-bottom: 5px;
}

.profile-music-artist {
  color: #a8dfe8;
  font-size: 0.9rem;
}

.profile-music-controls {
  display: flex;
  gap: 10px;
}

.profile-music-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid #00ffff;
  border-radius: 4px;
  color: #00ffff;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.8rem;
}

.profile-music-btn:hover {
  background: rgba(0, 255, 255, 0.2);
}

.music-options {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

.music-option {
  padding: 10px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid rgba(0, 255, 255, 0.3);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.music-option:hover {
  border-color: #00ffff;
  background: rgba(0, 255, 255, 0.1);
}

.music-option.active {
  border-color: #00ffff;
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.music-option-title {
  color: #00ffff;
  font-weight: bold;
  margin-bottom: 5px;
}

.music-option-artist {
  color: #a8dfe8;
  font-size: 0.8rem;
}

/* NEW: Profile Bio Section */
.profile-bio-section {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 20px;
  border: 1px solid rgba(0, 255, 255, 0.2);
  margin-bottom: 20px;
}

.profile-bio-section h3 {
  color: #00ffff;
  margin: 0 0 15px 0;
  font-size: 1.2rem;
}

.bio-text {
  color: #a8dfe8;
  line-height: 1.6;
  margin-bottom: 15px;
  min-height: 60px;
}

.bio-text.empty {
  font-style: italic;
  color: #668899;
}

.bio-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.bio-stat-item {
  background: rgba(0, 20, 40, 0.6);
  padding: 10px;
  border-radius: 6px;
  border: 1px solid rgba(0, 255, 255, 0.1);
}

.bio-stat-label {
  color: #00ffff;
  font-size: 0.8rem;
  margin-bottom: 5px;
}

.bio-stat-value {
  color: #a8dfe8;
  font-weight: bold;
}

.bio-edit textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
  resize: vertical;
  margin-bottom: 10px;
}

.bio-char-count {
  text-align: right;
  color: #a8dfe8;
  font-size: 0.8rem;
}

/* NEW: Profile Visitor Counter */
.profile-visitors {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 15px;
  border: 1px solid rgba(0, 255, 255, 0.2);
  margin-bottom: 20px;
}

.profile-visitors h3 {
  color: #00ffff;
  margin: 0 0 10px 0;
  font-size: 1.1rem;
}

.visitor-stats {
  display: flex;
  justify-content: space-between;
  color: #a8dfe8;
  font-size: 0.9rem;
}

/* NEW: Profile Comments Section */
.profile-comments {
  background: rgba(0, 30, 60, 0.7);
  border-radius: 8px;
  padding: 20px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.profile-comments h3 {
  color: #00ffff;
  margin: 0 0 15px 0;
  font-size: 1.2rem;
}

.comment-input {
  margin-bottom: 20px;
}

.comment-input textarea {
  width: 100%;
  height: 80px;
  padding: 12px;
  background: rgba(0, 20, 40, 0.8);
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #00ffff;
  font-family: 'Orbitron', Arial, sans-serif;
  resize: vertical;
  margin-bottom: 10px;
}

.comment-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.comment-item {
  background: rgba(0, 20, 40, 0.6);
  border-radius: 6px;
  padding: 15px;
  border: 1px solid rgba(0, 255, 255, 0.1);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.comment-author {
  color: #00ffff;
  font-weight: bold;
}

.comment-time {
  color: #668899;
  font-size: 0.8rem;
}

.comment-content {
  color: #a8dfe8;
  line-height: 1.4;
}

/* NEW: Profile Route System */
.profile-route-container {
  display: none;
}

.profile-route-container.active {
  display: block;
}

.profile-navigation {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.profile-nav-btn {
  padding: 10px 20px;
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
  border-radius: 6px;
  color: #00ffff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', Arial, sans-serif;
}

.profile-nav-btn:hover {
  background: rgba(0, 255, 255, 0.2);
}

.profile-nav-btn.active {
  background: rgba(0, 255, 255, 0.3);
  border-color: #00ffff;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

/* NEW: Ensure profile route displays properly */
#mainSiteContent[style*="display: none"] {
  display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
  .social-hub-content {
    flex-direction: column;
    height: 95vh;
  }
  
  .social-sidebar {
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid #00ffff;
  }
  
  .social-nav {
    display: flex;
    overflow-x: auto;
    gap: 10px;
  }
  
  .social-nav-btn {
    white-space: nowrap;
    min-width: 120px;
  }

  /* User section mobile */
  .user-dropdown {
    right: -10px;
  }

  /* Theme switcher mobile */
  .theme-switcher {
    bottom: 10px;
    right: 10px;
    flex-wrap: wrap;
    max-width: 200px;
  }

  /* Music player mobile */
  .music-player {
    bottom: 70px;
    left: 10px;
    max-width: 180px;
  }

  /* Status bar mobile */
  .status-bar {
    flex-direction: column;
    gap: 10px;
    padding: 12px 15px;
  }

  .profile-pic-container {
    flex-direction: column;
    text-align: center;
  }

  /* Mobile login fixes */
  .login-modal .modal-content {
    width: 90% !important;
    margin: 10% auto !important;
    padding: 20px !important;
  }
  
  .auth-form input {
    font-size: 16px !important;
    padding: 14px !important;
  }
  
  .tab-btn {
    padding: 12px 8px !important;
    font-size: 14px !important;
  }

  /* Social hub mobile fixes */
  .social-hub-content {
    flex-direction: column !important;
    height: 95vh !important;
  }
  
  .social-sidebar {
    width: 100% !important;
    height: auto !important;
    max-height: 40vh !important;
    overflow-y: auto !important;
  }
  
  .social-main {
    height: 60vh !important;
    overflow-y: auto !important;
  }
  
  .chat-messages {
    max-height: 45vh !important;
  }
  
  /* Profile content mobile scrolling */
  .profile-content {
    overflow-y: auto !important;
    max-height: 50vh !important;
  }
  
  /* Wall posts mobile */
  .wall-posts {
    max-height: 40vh !important;
    overflow-y: auto !important;
  }
  
  /* Profile page mobile */
  .profile-header-section {
    flex-direction: column;
    text-align: center;
    padding: 20px;
  }
  
  .profile-content-grid {
    grid-template-columns: 1fr;
  }
  
  .profile-meta {
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Background options mobile */
  .background-options {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }

  /* Music options mobile */
  .music-options {
    grid-template-columns: 1fr;
  }

  /* Bio stats mobile */
  .bio-stats {
    grid-template-columns: 1fr;
  }

  /* Profile navigation mobile */
  .profile-navigation {
    justify-content: center;
  }

  .profile-nav-btn {
    flex: 1;
    min-width: 120px;
    text-align: center;
  }
}

/* --- Theme Styles --- */

/* Matrix Theme */
body.matrix-theme {
  --primary-color: #00ff00;
  --secondary-color: #003300;
  --accent-color: #00cc00;
}

body.matrix-theme .brand h1,
body.matrix-theme .platform-caption,
body.matrix-theme .collapsible,
body.matrix-theme .status-indicator {
  color: #00ff00 !important;
  text-shadow: 0 0 10px rgba(0, 255, 0, 0.7) !important;
}

body.matrix-theme .brand .logo {
  background: linear-gradient(135deg, #00ff00, #003300);
}

body.matrix-theme .button {
  background: linear-gradient(180deg, #00ff00, #006600);
  color: #000;
}

body.matrix-theme .status-bar,
body.matrix-theme .theme-switcher {
  border-color: #00ff00;
  background: rgba(0, 30, 0, 0.8);
}

body.matrix-theme .card h3 {
  color: #00ff00;
}

body.matrix-theme .card a {
  color: #00ff00;
}

body.matrix-theme .crt-scanline {
  background: linear-gradient(to bottom, transparent 0%, rgba(0, 255, 0, 0.15) 50%, transparent 100%);
}

/* Windows 95 Theme */
body.windows95-theme {
  --primary-color: #c0c0c0;
  --secondary-color: #000080;
  --accent-color: #808080;
  background: #008080 !important;
}

body.windows95-theme .brand h1,
body.windows95-theme .platform-caption,
body.windows95-theme .collapsible,
body.windows95-theme .status-indicator {
  color: #000080 !important;
  text-shadow: none !important;
}

body.windows95-theme .brand .logo {
  background: linear-gradient(135deg, #c0c0c0, #808080);
  color: #000;
  box-shadow: inset -2px -2px 0px #000, inset 2px 2px 0px #fff;
}

body.windows95-theme .button {
  background: #c0c0c0;
  color: #000;
  border: 2px outset #c0c0c0;
  box-shadow: none;
}

body.windows95-theme .button:hover {
  background: #d0d0d0;
}

body.windows95-theme .status-bar,
body.windows95-theme .theme-switcher {
  border: 2px outset #c0c0c0;
  background: #c0c0c0;
  color: #000;
}

body.windows95-theme .status-indicator {
  color: #000 !important;
}

body.windows95-theme .collapsible {
  background: #c0c0c0;
  color: #000;
  border: 2px outset #c0c0c0;
}

body.windows95-theme .card {
  background: #c0c0c0;
  border: 2px inset #c0c0c0;
  color: #000;
}

body.windows95-theme .card h3 {
  color: #000080;
}

body.windows95-theme .card a {
  color: #000080;
}

body.windows95-theme .crt-scanline,
body.windows95-theme .crt-overlay {
  display: none;
}

/* Sega Saturn Theme - Completely reworked with grey, blue, and black */
body.sega-theme {
  --primary-color: #3a6ea5;
  --secondary-color: #1a1a1a;
  --accent-color: #d4d4d4;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%) !important;
  background-attachment: fixed !important;
}

body.sega-theme .brand h1,
body.sega-theme .platform-caption,
body.sega-theme .collapsible,
body.sega-theme .status-indicator {
  color: #d4d4d4 !important;
  text-shadow: 1px 1px 0 #3a6ea5, 2px 2px 0 #1a1a1a !important;
}

body.sega-theme .brand .logo {
  background: linear-gradient(135deg, #3a6ea5, #d4d4d4, #1a1a1a);
  color: #1a1a1a;
  border: 2px solid #d4d4d4;
}

body.sega-theme .button {
  background: linear-gradient(180deg, #3a6ea5, #2a4e75);
  color: #d4d4d4;
  border: 2px solid #d4d4d4;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .button:hover {
  background: linear-gradient(180deg, #4a7eb5, #3a5e85);
}

body.sega-theme .status-bar,
body.sega-theme .theme-switcher {
  border: 2px solid #d4d4d4;
  background: rgba(26, 26, 26, 0.9);
  box-shadow: 2px 2px 0 #1a1a1a;
  color: #d4d4d4;
}

body.sega-theme .status-indicator {
  color: #d4d4d4 !important;
}

body.sega-theme .collapsible {
  background: rgba(58, 110, 165, 0.8);
  color: #d4d4d4;
  border: 2px solid #d4d4d4;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .card {
  background: rgba(212, 212, 212, 0.95);
  border: 2px solid #3a6ea5;
  color: #1a1a1a;
  box-shadow: 2px 2px 0 #1a1a1a;
}

body.sega-theme .card h3 {
  color: #3a6ea5;
  text-shadow: 1px 1px 0 #d4d4d4;
}

body.sega-theme .card p {
  color: #1a1a1a;
}

body.sega-theme .card a {
  color: #3a6ea5;
  font-weight: bold;
}

body.sega-theme .crt-scanline {
  background: linear-gradient(to bottom, transparent 0%, rgba(212, 212, 212, 0.1) 50%, transparent 100%);
}

body.sega-theme .crt-overlay {
  opacity: 0.05;
}

body.sega-theme .search-bar {
  border-color: #3a6ea5;
  background: rgba(26, 26, 26, 0.8);
  color: #d4d4d4;
}

body.sega-theme .search-bar::placeholder {
  color: rgba(212, 212, 212, 0.6);
}

body.sega-theme .copy-btn {
  border-color: #3a6ea5;
  background: rgba(58, 110, 165, 0.1);
  color: #3a6ea5;
}

body.sega-theme .copy-btn:hover {
  background: rgba(58, 110, 165, 0.2);
}

body.sega-theme .copyable {
  background: rgba(58, 110, 165, 0.05);
  border: 1px solid rgba(58, 110, 165, 0.2);
}

body.sega-theme .music-player {
  background: rgba(26, 26, 26, 0.9);
  border: 1px solid #3a6ea5;
}

body.sega-theme .music-station {
  color: #3a6ea5;
}

body.sega-theme .music-btn {
  border-color: #3a6ea5;
  background: rgba(58, 110, 165, 0.1);
  color: #3a6ea5;
}

body.sega-theme .music-btn:hover {
  background: rgba(58, 110, 165, 0.2);
}

/* --- Mobile Optimizations --- */
@media (max-width: 768px) {
  /* Header fixes */
  header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
    padding: 15px 4vw;
  }
  
  .site-nav {
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }
  
  .button {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: auto;
  }
  
  /* Search bar mobile */
  .search-container {
    padding: 0 4vw;
  }
  
  .search-bar {
    font-size: 0.9rem;
    padding: 10px 16px;
  }
  
  /* Status bar fixes */
  .status-bar {
    flex-direction: column;
    gap: 8px;
    padding: 12px 15px;
    margin: 10px 4vw;
    font-size: 0.8rem;
  }
  
  .status-indicator {
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Collapsible fixes */
  .collapsible {
    width: 92%;
    padding: 12px 15px;
    font-size: 0.9rem;
  }
  
  .collapsible::after {
    right: 12px;
    font-size: 1rem;
  }
  
  /* Card fixes */
  .card {
    margin: 0.5rem auto;
    padding: 10px;
    width: 95%;
  }
  
  .card h3 {
    font-size: 1rem;
  }
  
  .card p {
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  /* Content area fixes */
  .content {
    padding: 0 0.5rem;
  }
  
  /* Platform caption */
  .platform-caption {
    font-size: 0.9rem;
    margin: 1rem 4vw;
    line-height: 1.4;
  }
  
  /* Submit section */
  #submitMethodSection {
    margin: 1.5rem 4vw;
    padding: 15px;
  }
  
  #submitMethodSection h2 {
    font-size: 1.1rem;
  }
  
  /* Cursor fixes for mobile */
  #customCursor {
    display: none !important;
  }
  
  body, html {
    cursor: auto !important;
  }

  /* Featured games mobile */
  .game-carousel {
    gap: 15px;
  }
  
  .game-card {
    min-width: 200px;
  }

  /* Event list mobile */
  .event-list {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  /* Extra small screen fixes */
  .brand h1 {
    font-size: 14px;
  }
  
  .brand p {
    font-size: 11px;
  }
  
  .button {
    padding: 6px 10px;
    font-size: 0.8rem;
  }
  
  .theme-switcher {
    flex-wrap: wrap;
  }
  
  .theme-btn {
    flex: 1;
    min-width: 60px;
  }
  
  .status-bar {
    font-size: 0.75rem;
    padding: 10px 12px;
  }
  
  .collapsible {
    font-size: 0.85rem;
    padding: 10px 12px;
  }
  
  .card {
    padding: 8px;
  }
  
  .card h3 {
    font-size: 0.95rem;
  }
  
  .card p {
    font-size: 0.85rem;
  }
  
  /* Fix long text in cards */
  .card a {
    word-break: break-word;
  }
}

/* --- Responsive tweaks --- */
@media (max-width:820px){
  header{ padding:14px; align-items:flex-start; gap:10px; }
  .brand h1{ font-size:16px }
  #customCursor{ width:28px; height:28px }
  .collapsible{ width:94%; }
  #progressContainer{ width:86%; }
}
  }
/* ========== FRIENDS SYSTEM STYLES ========== */
.requests-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid #00ffff;
}

.request-tab-btn {
  flex: 1;
  padding: 10px;
  background: none;
  border: none;
  color: #00ffff;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.3s ease;
  font-family: 'Orbitron', Arial, sans-serif;
}

.request-tab-btn.active {
  border-bottom: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.1);
}

.request-tab-btn:hover {
  background: rgba(0, 255, 255, 0.2);
}

.requests-list, .friends-grid, .search-results {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
  padding: 10px;
  background: rgba(0, 30, 60, 0.4);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.friend-request-item, .friend-item, .search-result-item {
  background: rgba(0, 30, 60, 0.7);
  border: 1px solid rgba(0, 255, 255, 0.2);
  border-radius: 8px;
  padding: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s ease;
}

.friend-request-item:hover, .friend-item:hover, .search-result-item:hover {
  border-color: #00ffff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
}

.friend-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.friend-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #ff33cc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  color: #000;
}

.friend-details {
  flex: 1;
}

.friend-name {
  color: #00ffff;
  font-weight: bold;
  margin-bottom: 4px;
}

.friend-status, .request-status {
  color: #a8dfe8;
  font-size: 0.8rem;
}

.request-status {
  color: #ffff00;
  font-style: italic;
}

.friend-actions {
  display: flex;
  gap: 8px;
}

.friend-btn {
  padding: 6px 12px;
  border: 1px solid;
  border-radius: 6px;
  background: rgba(0, 255, 255, 0.1);
  color: #00ffff;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s ease;
  font-family: 'Orbitron', Arial, sans-serif;
}

.friend-btn.accept {
  background: rgba(0, 255, 0, 0.1);
  border-color: #00ff00;
  color: #00ff00;
}

.friend-btn.decline {
  background: rgba(255, 0, 0, 0.1);
  border-color: #ff3333;
  color: #ff3333;
}

.friend-btn.remove {
  background: rgba(255, 51, 204, 0.1);
  border-color: #ff33cc;
  color: #ff33cc;
}

.friend-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 255, 255, 0.2);
}

.friend-btn.accept:hover {
  background: rgba(0, 255, 0, 0.2);
}

.friend-btn.decline:hover {
  background: rgba(255, 0, 0, 0.2);
}

.friend-btn.remove:hover {
  background: rgba(255, 51, 204, 0.2);
}

.empty-state {
  text-align: center;
  color: #a8dfe8;
  padding: 40px 20px;
  font-style: italic;
}

/* Request item states */
.request-item.received {
  border-left: 4px solid #ff33cc;
}

.request-item.sent {
  border-left: 4px solid #ffff00;
}

.friend-item.online {
  border-left: 4px solid #00ff00;
}

.friend-item.offline {
  border-left: 4px solid #666;
}

.online-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff00;
  margin-right: 8px;
  box-shadow: 0 0 8px #00ff00;
}

.offline-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #666;
  margin-right: 8px;
}
  /* ========== FIXES FOR VISIBILITY ========== */
/* Make sure friend system is visible */
.friend-requests-section,
.friends-list-section,
.find-friends-section {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.requests-container {
    display: block;
}

#received-requests {
    display: block;
}

#sent-requests {
    display: none;
}

/* Make sure friend buttons are visible */
.friend-btn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Make Edit Bio button visible */
#profilePageEditBio {
    display: block !important;
    visibility: visible !important;
}

/* Ensure bio edit section is properly styled */
.bio-edit {
    margin-top: 15px;
    display: none; /* Hidden by default, shown when editing */
}

.bio-edit textarea {
    width: 100%;
    min-height: 100px;
    background: rgba(0, 20, 40, 0.8);
    border: 1px solid #00ffff;
    color: #00ffff;
    padding: 10px;
    border-radius: 6px;
    font-family: 'Orbitron', Arial, sans-serif;
    resize: vertical;
}

.bio-char-count {
    text-align: right;
    color: #a8dfe8;
    font-size: 0.8rem;
    margin-top: 5px;
}
</style>
</style>
</head>
<body>
  <!-- Splash -->
  <div id="splash" role="dialog" aria-modal="true" aria-label="Boot splash">
    <div style="text-align:center;">
      <div style="display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:10px;">
        <div style="width:54px; height:54px; border-radius:10px; background:linear-gradient(135deg,#00e0ff,#ff33cc); box-shadow:0 0 24px rgba(0,224,255,0.12); display:flex; align-items:center; justify-content:center; font-weight:800; color:#010101;">ROM</div>
      </div>
      <h1 id="splashTitle">SYSTEM BOOTING...</h1>
      <p id="bootText">RetroOnlineMatchmaking  Initializing v1.0</p>
      <div id="progressContainer" aria-hidden="true"><div id="progressBar"></div></div>
    </div>
  </div>

  <!-- Theme Switcher - MOVED TO BOTTOM -->
  <div class="theme-switcher">
    <button class="theme-btn active" data-theme="cyberpunk">CYBERPUNK</button>
    <button class="theme-btn" data-theme="matrix">MATRIX</button>
    <button class="theme-btn" data-theme="windows95">WIN95</button>
    <button class="theme-btn" data-theme="sega">SEGA SATURN</button>
  </div>

  <!-- Music Player -->
  <div class="music-player">
    <div class="music-station">
      <span> Retro Station</span>
      <div class="music-controls">
        <button class="music-btn" id="prevTrack"></button>
        <button class="music-btn" id="playPause"></button>
        <button class="music-btn" id="nextTrack"></button>
        <span id="trackInfo" style="font-size:0.7rem; margin-left:5px;">1/6</span>
      </div>
    </div>
  </div>

  <!-- Decorative backgrounds -->
  <div class="stars" aria-hidden="true"></div>
  <canvas id="retroCanvas" aria-hidden="true"></canvas>
  <div class="crt-overlay" aria-hidden="true"></div>
  <div class="crt-scanline" aria-hidden="true"></div>

  <!-- Main content -->
  <main id="mainContent" style="display:none;">
    <!-- Profile Route Container -->
    <div id="profileRouteContainer" class="profile-route-container">
      <div class="profile-page">
        <!-- Profile Navigation -->
        <div class="profile-navigation">
          <button class="profile-nav-btn active" data-section="profile-main"> Profile</button>
          <button class="profile-nav-btn" data-section="profile-friends"> Friends</button>
          <button class="profile-nav-btn" data-section="profile-comments"> Comments</button>
          <button class="button" id="backToMain" style="margin-left: auto;"> Back to Main</button>
        </div>

        <!-- Profile Header -->
        <div class="profile-header-section">
          <div class="profile-avatar-xlarge" id="profilePageAvatar">
            <span id="profilePageAvatarText">U</span>
          </div>
          <div class="profile-info-main">
            <h1 class="profile-username-large" id="profilePageUsername">Username</h1>
            <p class="profile-status-large" id="profilePageStatus"> Online</p>
            <div class="profile-signature-large" id="profilePageSignature">
              This user hasn't set a signature yet.
            </div>
            <div class="profile-meta">
              <span id="profilePageJoinDate">Joined: Loading...</span>
              <span id="profilePageLastActive">Last Active: Now</span>
              <span id="profilePageViews"> Views: 0</span>
              <span id="profilePageFriendsCount"> Friends: 0</span>
            </div>
          </div>
        </div>

        <!-- Profile Content Grid -->
        <div class="profile-content-grid">
          <!-- Main Content -->
          <div class="profile-main-content">
            <!-- Bio Section -->
            <div id="profile-main" class="profile-section active">
              <!-- Profile Background Section -->
              <div class="profile-background-section">
                <h3 style="color: #00ffff; margin-bottom: 15px;"> Profile Background</h3>
                
                <div class="profile-background-preview" id="profilePageBackgroundPreview">
                  <span id="profilePageBackgroundPreviewText">Profile Background Preview</span>
                </div>
                
                <div class="background-options">
                  <div class="background-option color" data-background="linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e)" style="background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);">
                    Cyber Space
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #1e3c72, #2a5298)" style="background: linear-gradient(135deg, #1e3c72, #2a5298);">
                    Deep Blue
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #667eea, #764ba2)" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    Purple Haze
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #f093fb, #f5576c)" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    Pink Dream
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #4facfe, #00f2fe)" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    Ocean Breeze
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #43e97b, #38f9d7)" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                    Green Matrix
                  </div>
                  <div class="background-option custom" id="profilePageCustomBackgroundOption">
                    <span> Custom</span>
                    <small>Upload Image</small>
                  </div>
                </div>
                
                <input type="file" id="profilePageBackgroundImageUpload" accept="image/*" style="display: none;">
                <button onclick="document.getElementById('profilePageBackgroundImageUpload').click()" class="button" style="width: 100%; margin-top: 10px;">Upload Custom Background</button>
                <p style="color: #a8dfe8; font-size: 0.8rem; text-align: center; margin-top: 5px;">Max 100KB  JPG/PNG recommended</p>
              </div>

              <!-- Profile Music Section -->
              <div class="profile-music-section">
                <h3 style="color: #00ffff; margin-bottom: 15px;"> Profile Music</h3>
                
                <div class="profile-music-preview" id="profilePageMusicPreview">
                  <div class="profile-music-info">
                    <div class="profile-music-title" id="profilePageMusicTitle">No music selected</div>
                    <div class="profile-music-artist" id="profilePageMusicArtist">Add a YouTube URL above</div>
                  </div>
                  <div class="profile-music-controls">
                    <button class="profile-music-btn" id="profilePagePlayPause"></button>
                    <button class="profile-music-btn" id="profilePageStopMusic"></button>
                  </div>
                </div>

                <!-- YouTube URL Input -->
                <div class="music-url-input" style="margin-bottom: 15px;">
                  <label style="color: #00ffff; display: block; margin-bottom: 5px;"> YouTube URL</label>
                  <input type="text" id="profilePageYoutubeUrlInput" placeholder="Paste YouTube URL here..." 
                         style="width: 100%; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
                  <button id="profilePageSetMusicUrl" class="button" style="width: 100%; margin-top: 8px;">Set Profile Music</button>
                </div>

                <!-- Music Info Display -->
                <div class="current-music-info" style="background: rgba(0, 30, 60, 0.6); padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none;" id="profilePageCurrentMusicInfo">
                  <div style="color: #00ffff; font-weight: bold;" id="profilePageCurrentMusicTitle">Current Music</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;" id="profilePageCurrentMusicUrl"></div>
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                  <button class="button muted" id="profilePageDisableProfileMusic">Disable Profile Music</button>
                </div>
              </div>

              <!-- Bio Editor Section -->
              <div class="profile-bio-section">
                <h3>About Me</h3>
                <div class="bio-edit" id="profilePageBioEdit" style="display: none;">
                  <textarea id="profilePageBioText" placeholder="Tell us about yourself..."></textarea>
                  <div class="bio-char-count">
                    <span id="profilePageBioCharCount">0</span>/500 characters
                  </div>
                  <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="button" id="profilePageSaveBio">Save Bio</button>
                    <button class="button muted" id="profilePageCancelBio">Cancel</button>
                  </div>
                </div>
                <div class="bio-text empty" id="profilePageBio">
                  This user hasn't written a bio yet.
                </div>
                <div style="margin-top: 10px;">
                  <button class="button" id="profilePageEditBio" style="display: none;"> Edit Bio</button>
                </div>
                <div class="bio-stats">
                  <div class="bio-stat-item">
                    <div class="bio-stat-label"> Favorite Systems</div>
                    <div class="bio-stat-value" id="profileFavoriteSystems">Not set</div>
                  </div>
                  <div class="bio-stat-item">
                    <div class="bio-stat-label"> Gaming Since</div>
                    <div class="bio-stat-value" id="profileGamingSince">Not set</div>
                  </div>
                  <div class="bio-stat-item">
                    <div class="bio-stat-label"> Top Games</div>
                    <div class="bio-stat-value" id="profileTopGames">Not set</div>
                  </div>
                </div>
              </div>

              <!-- Visitor Counter -->
              <div class="profile-visitors">
                <h3>Profile Visitors</h3>
                <div class="visitor-stats">
                  <span>Today: <strong id="visitorsToday">0</strong></span>
                  <span>This Week: <strong id="visitorsWeek">0</strong></span>
                  <span>Total: <strong id="visitorsTotal">0</strong></span>
                </div>
              </div>

              <!-- Wall Posts Section -->
              <div class="profile-wall-section" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 20px; border: 1px solid rgba(0, 255, 255, 0.2);">
                <h3 style="color: #00ffff; margin-bottom: 15px;">Wall Posts</h3>
                <div class="wall-post-input" style="margin-bottom: 20px;">
                  <textarea id="profilePageWallPostText" placeholder="Write something on this user's wall..." 
                            style="width: 100%; height: 80px; padding: 12px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px; resize: vertical;"></textarea>
                  <button id="profilePagePostToWall" class="button" style="margin-top: 10px;">Post to Wall</button>
                </div>
                <div id="profilePageWallPosts" class="wall-posts">
                  <!-- Wall posts will appear here -->
                </div>
              </div>
            </div>

            <!-- Friends Section -->
            <div id="profile-friends" class="profile-section">
              <div class="friends-list-mini" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 20px; border: 1px solid rgba(0, 255, 255, 0.2);">
                <h3 style="color: #00ffff; margin-bottom: 15px;">Friends (<span id="friendsCount">0</span>)</h3>
                <div id="profilePageFriendsList">
                  <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                    No friends yet. Start adding some!
                  </div>
                </div>
                
                <!-- Player Search System -->
                <div style="margin-top: 20px;">
    <h4 style="color: #00ffff; margin-bottom: 10px;"> Find Players</h4>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="profilePlayerSearchInput" placeholder="Search for players..." 
               style="flex: 1; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button id="profilePlayerSearchBtn" class="button">Search</button>
    </div>
                  <div id="playerSearchResults" style="min-height: 100px;">
                    <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                      Use the search above to find players to add as friends
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Comments Section -->
            <div id="profile-comments" class="profile-section">
              <div class="profile-comments">
                <h3>Profile Comments</h3>
                <div class="comment-input">
                  <textarea id="profileCommentText" placeholder="Write a comment on this profile..."></textarea>
                  <button id="postProfileComment" class="button">Post Comment</button>
                </div>
                <div class="comment-list" id="profileCommentsList">
                  <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                    No comments yet. Be the first to comment!
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="profile-sidebar">
            <!-- Profile Actions -->
            <div class="profile-actions" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.2);">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Actions</h3>
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="button" id="profilePageAddFriend">Add Friend</button>
                <button class="button muted" id="profilePageSendMessage">Send Message</button>
                <button class="button" id="profilePageViewInHub">View in Social Hub</button>
                <button class="button" id="profilePageShare">Share Profile</button>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="friends-list-mini" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.2);">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Recent Activity</h3>
              <div id="recentActivityList">
                <div style="color: #a8dfe8; font-size: 0.9rem; text-align: center; padding: 10px;">
                  No recent activity
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Site Content -->
    <div id="mainSiteContent">
      <header class="site-header">
        <div class="brand">
          <div class="logo" aria-hidden="true">ROM</div>
          <div>
            <h1>RetroOnlineMatchmaking</h1>
            <p>Play classic games online again</p>
          </div>
        </div>

        <nav class="site-nav" aria-label="primary" style="display:flex; gap:8px; align-items:center;">
          <a class="button" href="https://discord.com/invite/jcRqpmMZdZ" target="_blank" rel="noopener">Join Discord</a>
          <a class="button" href="https://youtube.com/@retroonlinematchmaking?si=JASKyZdqxTyAenLb" target="_blank" rel="noopener">YouTube</a>
          <a class="button" href="https://www.patreon.com/RetroGameMaster?utm_campaign=creatorshare_creator" target="_blank" rel="noopener">Support on Patreon</a>
          <a class="button" id="openSubmitBtn">Submit Method</a>
          <a class="button" href="https://retroonlinematchmaking.flarum.cloud/" target="_blank" rel="noopener">Forum</a>
          <a class="button" id="socialHubBtn">Social Hub</a>
          
          <!-- User Account Section -->
          <div class="user-section" style="display: none;">
            <div class="user-menu">
              <span class="username" id="userDisplayName">Guest</span>
              <div class="user-dropdown">
                <button id="profileBtn">Profile</button>
                <button id="changeUsernameBtn">Change Username</button>
                <button id="favoritesBtn">My Favorites</button>
                <button id="dataManagementBtn">Data Management</button>
                <button id="logoutBtn">Logout</button>
              </div>
            </div>
          </div>
          <button class="button" id="loginBtn">Login / Register</button>
        </nav>
      </header>

      <!-- Status Bar - UPDATED: Removed Ping -->
      <div class="status-bar">
        <span class="status-indicator"> SYSTEM ONLINE</span>
        <span class="status-indicator live-players"> PLAYERS: <span id="playerCount" class="player-count-animation">0</span></span>
        <span class="status-indicator"> <span id="liveClock">--:--:--</span></span>
      </div>

      <!-- Search System -->
      <div class="search-container">
        <input type="text" class="search-bar" placeholder=" Search for platforms, or connection methods..." id="searchInput">
        <div class="search-results" id="searchResults"></div>
      </div>

      <div style="max-width:1100px; margin:1.2rem auto; padding:0 4vw;">
        <div class="platform-caption">Find your Player 2  choose a platform</div>

        <!-- NEW: Featured Games Section -->
        <section class="featured-games">
          <h2> Featured Games This Week</h2>
          <div class="game-carousel">
            <div class="game-card">
              <h3>Street Fighter II</h3>
              <p>Classic arcade fighter with active community</p>
              <a class="button" href="#arcade">Play Now</a>
            </div>
            <div class="game-card">
              <h3>Gran Turismo PSP</h3>
              <p>PSP racing game with active community</p>
              <a class="button" href="#psp">Play Now</a>
            </div>
            <div class="game-card">
              <h3>Resident Evil Outbreak</h3>
              <p>PS2 4 player survival horror game with active community</p>
              <a class="button" href="#ps2">Play Now</a>
            </div>
            <div class="game-card">
              <h3>Tekken 3</h3>
              <p>PS1 fighting game with rollback netcode</p>
              <a class="button" href="#ps1">Play Now</a>
            </div>
          </div>
        </section>

        <!-- NEW: Community Events -->
        <section class="community-events">
          <h2> Community Events</h2>
          <div class="event-list">
            <div class="event-card">
              <h3>Monster Hunter 3rd PSP/PS3</h3>
              <p>Time for a hunt!</p>
              <div class="event-date">Nov.10th Starting at 4:30 PM EST</div>
            </div>
            <div class="event-card">
              <h3>Medal of Honor Heroes PSP</h3>
              <p>Only one of you leaves with a medal. Good luck.</p>
              <div class="event-date">Nov11th starting at 2:00PM EST</div>
            </div>
            <div class="event-card">
              <h3>Mortal Kombat Unchained PSP</h3>
              <p>One winner. Zero mercy.</p>
              <div class="event-date">Nov.11th Starting at 3:00 PM EST</div>
            </div>
            <div class="event-card">
              <h3>Mario Kart 64</h3>
              <p>Race clean... or just throw stuff.</p>
              <div class="event-date">Nov.12th Starting at 3:00 PM EST</div>
            </div>
              <div class="event-card">
              <h3>Need for Speed: Underground Rivals</h3>
              <p>Keep up or get booked!</p>
              <div class="event-date">Nov.9th Starting at 4:00 PM EST</div>
            </div>
            <div class="event-card">
              <h3>Call of Duty: Roads to Victory</h3>
              <p>Win the war. Or respawn trying.</p>
              <div class="event-date">Nov.14th Starting at 12:00 PM EST</div>
            </div>
          </div>
        </section>
<!-- ENHANCED: Live Discord Matchmaking Dashboard -->
<section class="matchmaking-dashboard" style="margin: 2rem auto; max-width: 1100px; padding: 0 4vw;">
    <h2 style="color: #00ffff; text-align: center; margin-bottom: 1.5rem; text-shadow: 0 0 8px rgba(0,255,255,0.08);"> Live Discord Matchmaking</h2>
    
    <!-- Discord Bot Status Header -->
    <div class="discord-status-header" style="background: rgba(0, 30, 60, 0.8); border: 2px solid #5865F2; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
            <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a6ca814282eca7172c6_icon_clyde_white_RGB.svg" style="width: 24px; height: 24px;" alt="Discord">
            <h3 style="color: #5865F2; margin: 0;">Discord Bot Live Data</h3>
        </div>
        
        <!-- Real-time Discord Stats -->
        <div class="discord-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
            <div class="discord-stat" style="background: rgba(88, 101, 242, 0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="color: #00ffff; font-size: 1.8rem; font-weight: bold;" id="discordActiveLobbies">0</div>
                <div style="color: #a8dfe8; font-size: 0.9rem;">Active Lobbies</div>
            </div>
            <div class="discord-stat" style="background: rgba(88, 101, 242, 0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="color: #ff33cc; font-size: 1.8rem; font-weight: bold;" id="discordOnlineUsers">0</div>
                <div style="color: #a8dfe8; font-size: 0.9rem;">Online Users</div>
            </div>
            <div class="discord-stat" style="background: rgba(88, 101, 242, 0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="color: #00ff00; font-size: 1.8rem; font-weight: bold;" id="discordRecentGames">0</div>
                <div style="color: #a8dfe8; font-size: 0.9rem;">Recent Games</div>
            </div>
            <div class="discord-stat" style="background: rgba(88, 101, 242, 0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="color: #ffff00; font-size: 1.8rem; font-weight: bold;" id="discordTotalUsers">434</div>
                <div style="color: #a8dfe8; font-size: 0.9rem;">Total Users</div>
            </div>
        </div>
        
        <!-- Connection Status -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 0.9rem;">
            <span id="discordConnectionStatus" style="color: #00ff00;"> Connected to Discord Bot</span>
            <span style="color: #a8dfe8;"></span>
            <span id="discordLastUpdate" style="color: #ffff00;">Last: Never</span>
        </div>
    </div>

    <!-- Manual Refresh Button -->
    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="loadDashboardData()" class="button" style="background: linear-gradient(180deg, #5865F2, #4752c4); border: 1px solid #5865F2; padding: 10px 20px;">
             Refresh Discord Data
        </button>
        <button onclick="testDiscordConnection()" class="button" style="background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; padding: 10px 20px; margin-left: 10px;">
             Test Connection
        </button>
    </div>

    <!-- KEEP YOUR EXISTING DASHBOARD STATS - They should already be here -->
    <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div class="stat-card" style="background: rgba(0, 30, 60, 0.7); padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #00ffff;">
            <div class="stat-number" id="activeGamesCount">0</div>
            <div class="stat-label">Active Games</div>
        </div>
        <div class="stat-card" style="background: rgba(0, 30, 60, 0.7); padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #ff33cc;">
            <div class="stat-number" id="activePlayersCount">0</div>
            <div class="stat-label">Players Online</div>
        </div>
        <div class="stat-card" style="background: rgba(0, 30, 60, 0.7); padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #00ff00;">
            <div class="stat-number" id="recentWinsCount">0</div>
            <div class="stat-label">Recent Wins (24h)</div>
        </div>
        <div class="stat-card" style="background: rgba(0, 30, 60, 0.7); padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #ffff00;">
            <div class="stat-number" id="totalUsersCount">434</div>
            <div class="stat-label">Total Users</div>
        </div>
    </div>

    <!-- KEEP YOUR EXISTING PANELS - They should already be here -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Active Games Panel -->
        <div class="dashboard-panel" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.2);">
            <h3 style="color: #00ffff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a6ca814282eca7172c6_icon_clyde_white_RGB.svg" style="width: 20px; height: 20px;">
                Active Discord Games
            </h3>
            <div id="activeGamesList" style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                    Loading Discord games...
                </div>
            </div>
        </div>

        <!-- Leaderboard Panel -->
        <div class="dashboard-panel" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.2);">
            <h3 style="color: #00ffff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                 Discord Leaderboard
            </h3>
            <div id="leaderboardList" style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                    Loading leaderboard...
                </div>
            </div>
        </div>
    </div>

    <!-- KEEP YOUR EXISTING POPULAR GAMES - It should already be here -->
    <div class="dashboard-panel" style="background: rgba(0, 30, 60, 0.7); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.2); margin-top: 20px;">
        <h3 style="color: #00ffff; margin-bottom: 15px;"> Recent Discord Activity</h3>
        <div id="popularGamesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">
            <div style="text-align: center; color: #a8dfe8; padding: 20px; grid-column: 1 / -1;">
                Loading recent Discord activity...
            </div>
        </div>
    </div>

    <!-- ADD THIS NEW DEBUG SECTION AT THE BOTTOM -->
    <details style="margin-top: 20px; background: rgba(0, 20, 40, 0.8); border-radius: 8px; padding: 10px;">
        <summary style="color: #ffff00; cursor: pointer; font-size: 0.9rem;"> Debug Information</summary>
        <div id="debugInfo" style="color: #a8dfe8; font-size: 0.8rem; margin-top: 10px; font-family: monospace;">
            Click "Test Connection" to see debug data...
        </div>
    </details>
</section>
        <!-- NEW: Clip of the Week Section -->
        <section class="clip-of-week">
          <h2> Clip of the Week</h2>
          <div class="video-container">
            <iframe 
              src="https://www.youtube.com/watch?v=62EPffzEC4s" 
              title="Street Fighter EX Plus Alpha"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
            </iframe>
          </div>
          <div class="clip-info">
            <h3>This Week's Featured Gameplay</h3>
            <p>Check out this amazing retro gaming moment from our community! Want to be featured next? Share your clips in our Discord!</p>
            <div class="clip-meta">
              <span> Posted:<span id="clipDate"> Nov.1st</span></span>
              <span> By:<span id="clipAuthor"> RetroOnlineMatchmaking</span></span>
            </div>
          </div>
        </section>

      <!-- Working Salty Bet Hub -->
<section class="salty-bet-hub" style="margin: 2rem auto; max-width: 1200px; padding: 0 4vw;">
    <h2 style="color: #00ffff; text-align: center; margin-bottom: 1.5rem; text-shadow: 0 0 8px rgba(0,255,255,0.08);"> Salty Bet Live</h2>
    
    <div class="hub-container" style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
        <!-- Main Stream Area -->
        <div class="main-stream">
            <!-- Twitch Stream -->
            <div style="border: 2px solid #ff3366; border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                <div id="twitch-embed" style="height: 400px; background: #000;">
                    <!-- Twitch embed will load here -->
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <a href="https://www.saltybet.com" target="_blank" class="button" style="background: linear-gradient(180deg, #ff3366, #cc0066); text-align: center; text-decoration: none;">
                     Bet Now
                </a>
            </div>
        </div>
        
        <!-- Betting Panel -->
<div class="betting-panel">
    <!-- Login First Message -->
    <div style="background: rgba(0, 30, 60, 0.9); border: 2px solid #ff3366; border-radius: 12px; padding: 30px; height: 500px; display: flex; flex-direction: column; justify-content: center; text-align: center; margin-bottom: 15px;">
        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
        <h3 style="color: #ff3366; margin: 0 0 15px 0;">Login Required</h3>
        <p style="color: #a8dfe8; margin: 0 0 25px 0; font-size: 1rem;">
            To place bets, you need to be logged into Salty Bet.<br>
            Click the button below to open SaltyBet.com and login first.
        </p>
        
        <a href="https://www.saltybet.com/authenticate?signin=1" target="_blank" class="button" style="background: linear-gradient(180deg, #ff3366, #cc0066); text-align: center; text-decoration: none; font-size: 1.1rem; padding: 15px; margin-bottom: 15px;">
             Login to Salty Bet
        </a>
        
        <p style="color: #00ffff; font-size: 0.9rem; margin: 0;">
            After logging in, return to this page to watch the stream!
        </p>
    </div>
    
    <!-- Embedded Version (Hidden by default) -->
    <div id="embeddedSaltyBet" style="display: none; border: 2px solid #00ffff; border-radius: 12px; overflow: hidden; height: 500px; margin-bottom: 15px;">
        <iframe 
            src="https://www.saltybet.com" 
            style="width: 100%; height: 100%; border: none;"
            title="Salty Bet"
            id="saltyBetFrame"
            allow="autoplay; encrypted-media">
        </iframe>
    </div>
    
    <!-- Session Helper -->
    <div style="background: rgba(0, 30, 60, 0.8); border-radius: 8px; padding: 15px; border: 1px solid rgba(0, 255, 255, 0.3);">
        <h4 style="color: #00ffff; margin: 0 0 10px 0;"> How This Works</h4>
        <div style="color: #a8dfe8; font-size: 0.9rem;">
            <p style="margin: 0 0 10px 0;"><strong>1.</strong> Click "Login to Salty Bet" above</p>
            <p style="margin: 0 0 10px 0;"><strong>2.</strong> Login on SaltyBet.com in the new tab</p>
            <p style="margin: 0 0 10px 0;"><strong>3.</strong> Return here to watch the stream</p>
            <p style="margin: 0;"><strong>4.</strong> Place bets in the Salty Bet tab while watching here</p>
        </div>
        
        <button class="button" id="showEmbedded" style="background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; color: #00ffff; width: 100%; margin-top: 10px;">
             Try Embedded Version Anyway
        </button>
    </div>
</div>
</section>

       <!-- Supporter Hall of Fame -->
<section class="supporter-section">
  <h2>Supporter Hall of Fame</h2>
  <p>Thank you to our amazing supporters who help keep RetroOnlineMatchmaking running!</p>
  <div class="supporter-list">
    <div class="supporter-card">
      <div class="supporter-name">RetroGameMaster</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">Myth Jackson</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">Andrew4Lyf</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">Mr.Madness</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">Alex Maldine</div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">FlatOutAnakin 898 </div>
    </div>
    <div class="supporter-card">
      <div class="supporter-name">S3V1ET_N1NJA</div>
    </div>
  </div>
</section>

         <!-- Arcade -->
<button class="collapsible" type="button">Arcade Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a>  <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a>  <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>Fightcade</h3>
    <p>Online arcade multiplayer for classic fighters and cabinets.</p>
    <p><a href="https://www.fightcade.com/" target="_blank" rel="noopener">Website/Download</a>  <a href="https://youtu.be/9fpeDgxGTEQ?si=6xqPugYz_t09tbnA" target="_blank" rel="noopener">Video Guide</a>  <a href="https://discord.gg/fightcade-official-160417191743848448" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across various retro systems through RetroArch.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Download</a>  <a href="https://youtu.be/wFE3S5TIawA?si=SzRurCi9KSoR_fbf" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play / streaming for local multiplayer sessions; works for PC hosts.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website</a>  <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
</div>

<!-- PS1 -->
<button class="collapsible" type="button">PS1 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a>  <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a>  <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across various retro systems through RetroArch.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Download</a>  <a href="https://youtu.be/wFE3S5TIawA?si=SzRurCi9KSoR_fbf" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
</div>

<!-- PS2 -->
<button class="collapsible" type="button">PS2 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Jak X: Combat Racing  PS2</h3>
    <p>Multiplayer connection method for Jak X: Combat Racing on PS2.</p>
    <p><strong>DNS:</strong> <span class="copyable">45.7.228.197</span> <button class="copy-btn" data-text="45.7.228.197"> Copy</button>  <a href="https://discord.com/invite/jak-x-online-multiplayer-752653132298977330" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>PSRewired  PS2</h3>
    <p>Universal online setup for PS2 games using custom DNS.</p>
    <p><strong>DNS:</strong> <span class="copyable">67.222.156.250</span> <button class="copy-btn" data-text="67.222.156.250"> Copy</button>  <a href="https://psrewired.com/guides/pcsx2" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>OBSVR  Resident Evil Outbreak File #2</h3>
    <p>Infrastructure connection method for Resident Evil Outbreak: File #2.</p>
    <p><a href="https://obsrv.org/website" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/88uVwczShn" target="_blank" rel="noopener">Discord</a>  <a href="https://youtu.be/Zv7o--OUQp8" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play and virtual LAN tool for low-latency PS2 emulator multiplayer.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website/Download</a>  <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai</h3>
    <p>LAN tunneling service for PS2 system-link play through PCSX2 and real hardware.</p>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a>  <a href="https://www.teamxlink.co.uk/wiki/PCSX2_XLink_Kai_Setup" target="_blank" rel="noopener">Guide</a></p>
  </div>
</div>

<!-- PS3 -->
<button class="collapsible" type="button">PS3 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>RPCS3</h3>
    <p>PS3 emulator solution  community & guides.</p>
    <p><a href="https://rpcs3.net/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.com/invite/RPCS3" target="_blank" rel="noopener">Discord</a>  <a href="https://www.youtube.com/watch?v=JzaocFeV4po&t=35s" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>PSRewired  PS3</h3>
    <p>Custom DNS & community tooling.</p>
    <p><strong>DNS:</strong> <span class="copyable">67.222.156.250</span> <button class="copy-btn" data-text="67.222.156.250"> Copy</button>  <a href="https://psrewired.com/" target="_blank" rel="noopener">Website</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai  PS3</h3>
    <p>Network tunneling for PS3 (hardware & emulator support).</p>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>PSONE (PS3 Revivals)</h3>
    <p>Community revivals & DNS for PS3 games.</p>
    <p><strong>DNS:</strong> <span class="copyable">185.194.142.4</span> <button class="copy-btn" data-text="185.194.142.4"> Copy</button>  <a href="https://www.psone.online/getting-started#" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>GT5 & GT6 Revival Server</h3>
    <p>Connection method for Gran Turismo 5 & 6  works on real hardware, not RPCS3. Tutorial available on their Discord.</p>
    <p><a href="https://discord.gg/gt-online-community-839257361486708816" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>Mod Nation Racers Revival</h3>
    <p>Connection method for Mod Nation Racers on PS3 and RPCS3.</p>
    <p><a href="https://mnrrevival.derole.co.uk/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/HSwP2ket3" target="_blank" rel="noopener">Discord</a></p>
  </div>
</div>

<!-- PSP -->
<button class="collapsible" type="button">PSP Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>EA Nation Hub  PSP</h3>
    <p>Unoffical hub to restore EA PSP multiplayer.</p>
    <p><a href="https://discord.com/invite/fwrQHHxrQQ" target="_blank" rel="noopener">Discord</a>  <a href="https://mohh-revival.pages.dev/#setup" target="_blank" rel="noopener">Setup Guide</a></p>
  </div>

  <div class="card">
    <h3>Madness Gaming Network</h3>
    <p><a href="https://discord.gg/madness-gaming-network-718348931133603841" target="_blank" rel="noopener">Discord</a>  <a href="https://discord.com/channels/1273100568117641269/1276580987643629578/1294667200434802750" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>Zero Tier</h3>
    <p><a href="https://my.zerotier.com/" target="_blank" rel="noopener">Website</a>  <a href="https://www.youtube.com/watch?v=RdJTc4Kbaig" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>Socom.cc</h3>
    <p><a href="https://discord.gg/SmDJSyZQsb" target="_blank" rel="noopener">Discord</a>  <a href="https://www.socom.cc/status.xml" target="_blank" rel="noopener">Website</a>  <a href="https://github.com/hrydgard/ppsspp/wiki/How-to-play-multiplayer-games-with-PPSSpp" target="_blank" rel="noopener">Guide</a></p>
  </div>

  <div class="card">
    <h3>OpenSpy</h3>
    <p><a href="https://discord.com/invite/sMaWdbt" target="_blank" rel="noopener">Discord</a>  <a href="https://beta.openspy.net/" target="_blank" rel="noopener">Website</a></p>
  </div>

  <div class="card">
    <h3>XLink Kai</h3>
    <p><a href="https://www.teamxlink.co.uk/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/team-xlink-official-521915206972997664" target="_blank" rel="noopener">Discord</a>  <a href="https://www.teamxlink.co.uk/wiki/PlayStation_Portable_XLink_Kai_Setup" target="_blank" rel="noopener">Real Hardware Guide</a></p>
    <p><a href="https://www.teamxlink.co.uk/wiki/JPCSP_PSP_Tutorial#:~:text=Now%2C%20as%20of%20Nov%2021st%202020%2C%20the%20PlayStation,and%20real%20PSP%20hardware%20for%20the%20first%20time!" target="_blank" rel="noopener">JPCSP PSP Tutorial</a></p>
  </div>

  <div class="card">
    <h3>Retroverse</h3>
    <p>IP: <span class="copyable">10.42.0.1</span> <button class="copy-btn" data-text="10.42.0.1"> Copy</button></p>
    <p><a href="https://retroverze.my.id/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.com/invite/dvspSEXQxa" target="_blank" rel="noopener">Discord</a></p>
  </div>

  <div class="card">
    <h3>AGRF</h3>
    <p><a href="https://agracingfoundation.org" target="_blank" rel="noopener">Website</a></p>
    <p>DNS: <span class="copyable">147.135.213.57</span> <button class="copy-btn" data-text="147.135.213.57"> Copy</button></p>
  </div>
</div>

<!-- Vita -->
<button class="collapsible" type="button">Vita Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Vita3K  PS Vita</h3>
    <p>Ad-hoc revival via Vita3K with XLink and community patches.</p>
    <p><a href="https://discord.gg/aBUTzGnCUS" target="_blank" rel="noopener">Discord</a>  <a href="https://nightly.link/Vita3K/Vita3K/actions/runs/16026361158" target="_blank" rel="noopener">Download</a></p>
  </div>

  <div class="card">
    <h3>Adrenaline (Real Hardware)</h3>
    <p>Ad-hoc and infrastructure multiplayer on modded PS Vita systems using Adrenaline PSP mode.</p>
    <p><a href="https://github.com/TheOfficialFloW/Adrenaline" target="_blank" rel="noopener">GitHub</a>  <a href="https://youtu.be/4ZUxJP0sW_Y" target="_blank" rel="noopener">Setup Guide</a>  <a href="https://discord.gg/aBUTzGnCUS" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- N64 -->
<button class="collapsible" type="button">N64 Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Mupen64Plus</h3>
    <p>Netplay and multiplayer support for N64 games via Mupen64Plus emulator.</p>
    <p><a href="https://mupen64plus.org/" target="_blank" rel="noopener">Website/Download</a>  <a href="https://discord.gg/mupen" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- Dreamcast -->
<button class="collapsible" type="button">Dreamcast Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Arkadyzja</h3>
    <p>Rollback-powered connection for PSX / Dreamcast / FBNeo / MAME.</p>
    <p><a href="https://github.com/Arkadyzja/ArkadyzjaClient/releases" target="_blank" rel="noopener">GitHub</a>  <a href="https://discord.gg/qBVN2nqAHc" target="_blank" rel="noopener">Discord</a>  <a href="https://youtu.be/9_pGj-tnkJM?si=Zo0DFLljnnLgSk8z" target="_blank" rel="noopener">Video Guide</a></p>
  </div>

  <div class="card">
    <h3>DCNet</h3>
    <p>Dreamcast-specific online multiplayer revival service.</p>
    <p><a href="https://dcnet.example.com/" target="_blank" rel="noopener">Website</a>  <a href="https://discord.gg/dcnet" target="_blank" rel="noopener">Community</a></p>
  </div>
</div>

<!-- PC -->
<button class="collapsible" type="button">PC Connections</button>
<div class="content" aria-hidden="true">
  <div class="card">
    <h3>Parsec</h3>
    <p>Remote play and virtual LAN tool for low-latency multiplayer sessions.</p>
    <p><a href="https://parsec.app/" target="_blank" rel="noopener">Website/Download</a>  <a href="https://youtu.be/ut3Uaj5MFsM?si=bNZ0ecJBZaSU4nym" target="_blank" rel="noopener">Video Guide</a></p>
  </div>
  
  <div class="card">
    <h3>RetroArch Netplay</h3>
    <p>Netplay across many retro systems.</p>
    <p><a href="https://www.retroarch.com/?page=platforms" target="_blank" rel="noopener">Website</a></p>
  </div>
</div>

        
         
        <!-- Submit -->
        <section id="submitMethodSection">
          <h2>Have a new connection method? Submit it here!</h2>
          <p>Help expand the RetroOnlineMatchmaking network by submitting your own connection methods.</p>
          <a class="button" id="openFormBtn" href="https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform" target="_blank" rel="noopener">Submit New Method</a>
        </section>

        <footer class="site-footer">
           2025 RetroOnlineMatchmaking  Built by the community
        </footer>
      </div>
    </div>
  </main>

  <!-- Google form modal -->
  <div id="formModal" class="modal" aria-hidden="true">
    <span class="close-btn" id="closeModal" role="button" aria-label="Close form">&times;</span>
    <div style="color:#0ff; font-weight:700; margin-bottom:10px;">Have new methods? Submit them here.</div>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform?embedded=true" title="Submission Form">Loading</iframe>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content" style="background: rgba(0, 30, 60, 0.95); padding: 2rem; border-radius: 12px; max-width: 400px;">
      <span class="close-btn" id="closeLogin">&times;</span>
      <h3 style="color: #00ffff; margin-bottom: 1.5rem;">Retro Login</h3>
      
      <div class="login-tabs">
        <button class="tab-btn active" data-tab="login">Login</button>
        <button class="tab-btn" data-tab="register">Register</button>
        <button class="tab-btn" data-tab="forgot-password">Forgot Password</button>
      </div>
      
      <form id="loginForm" class="auth-form">
        <input type="text" id="loginUsername" placeholder="Email" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <input type="password" id="loginPassword" placeholder="Password" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Login</button>
      </form>
      
      <form id="registerForm" class="auth-form" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Email" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <input type="password" id="registerPassword" placeholder="Create Password" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Create Account</button>
      </form>
      
      <form id="forgotPasswordForm" class="auth-form" style="display: none;">
        <input type="text" id="forgotPasswordEmail" placeholder="Enter your email" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Reset Password</button>
        <p style="color: #a8dfe8; font-size: 0.8rem; text-align: center; margin-top: 10px;">
          We'll send you a password reset link
        </p>
      </form>
    </div>
  </div>

  <!-- Change Username Modal -->
  <div id="changeUsernameModal" class="modal" style="display: none;">
    <div class="modal-content" style="background: rgba(0, 30, 60, 0.95); padding: 2rem; border-radius: 12px; max-width: 400px;">
      <span class="close-btn" id="closeChangeUsername">&times;</span>
      <h3 style="color: #00ffff; margin-bottom: 1.5rem;">Change Username</h3>
      
      <form id="changeUsernameForm">
        <input type="text" id="newUsername" placeholder="New Username" required 
               style="width: 100%; padding: 12px; margin: 10px 0; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button type="submit" class="button" style="width: 100%; margin-top: 1rem;">Update Username</button>
      </form>
    </div>
  </div>

  <!-- Social Hub Modal -->
  <div id="socialHubModal" class="modal" style="display: none;">
    <div class="social-hub-content" style="background: rgba(0, 20, 40, 0.95); max-width: 1200px; width: 95%; height: 90vh; border-radius: 12px; display: flex; overflow: hidden;">
      <span class="close-btn" id="closeSocialHub">&times;</span>
      
      <!-- Sidebar -->
      <div class="social-sidebar" style="width: 250px; background: rgba(0, 30, 60, 0.8); padding: 20px; border-right: 1px solid #00ffff;">
        <h3 style="color: #00ffff; margin-bottom: 20px;">Social Hub</h3>
        <nav class="social-nav">
          <button class="social-nav-btn active" data-tab="global-chat"> Global Chat</button>
          <button class="social-nav-btn" data-tab="lobby-chat"> Game Lobbies</button>
          <button class="social-nav-btn" data-tab="my-profile"> My Profile</button>
          <button class="social-nav-btn" data-tab="friends"> Friends</button>
          <button class="social-nav-btn" data-tab="find-players"> Find Players</button>
          <button class="social-nav-btn" data-tab="recent-activity"> Activity</button>
        </nav>
        
        <!-- Online Users -->
        <div class="online-users" style="margin-top: 30px;">
          <h4 style="color: #00ffff; margin-bottom: 10px;">Online Now</h4>
          <div id="onlineUsersList" style="color: #a8dfe8; font-size: 0.9rem;">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Main Content Area -->
      <div class="social-main" style="flex: 1; display: flex; flex-direction: column;">
        <!-- Global Chat Tab -->
        <div id="global-chat" class="social-tab active">
          <div class="chat-header" style="padding: 15px; border-bottom: 1px solid #00ffff; background: rgba(0, 40, 80, 0.6);">
            <h3 style="color: #00ffff; margin: 0;">Global Chat</h3>
            <span id="onlineCount" style="color: #a8dfe8; font-size: 0.9rem;">0 users online</span>
          </div>
          <div id="chatMessages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px;">
            <!-- Messages will appear here -->
          </div>
          <div class="chat-input-container" style="padding: 15px; border-top: 1px solid #00ffff; background: rgba(0, 40, 80, 0.4);">
            <input type="text" id="chatInput" placeholder="Type your message..." 
                   style="width: 100%; padding: 12px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <button id="sendMessage" class="button" style="margin-top: 10px; width: 100%;">Send Message</button>
          </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="my-profile" class="social-tab">
          <div class="profile-header" style="padding: 20px; background: rgba(0, 40, 80, 0.6); border-bottom: 1px solid #00ffff;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div class="profile-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #ff33cc); display: flex; align-items: center; justify-content:center; font-size: 2rem; font-weight: bold;">
                <span id="profileAvatarText">U</span>
              </div>
              <div>
                <h2 id="profileUsername" style="color: #00ffff; margin: 0;">Username</h2>
                <p id="profileJoinDate" style="color: #a8dfe8; margin: 5px 0 0 0;">Joined: Loading...</p>
              </div>
            </div>
          </div>
          
          <div class="profile-content" style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- Profile Customization Section -->
            <div class="profile-customization">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Profile Customization</h3>
              
              <!-- Profile Picture Upload -->
              <div class="profile-pic-container">
                <div class="profile-pic-preview" id="profilePicPreview">
                  <span id="profilePicText">U</span>
                </div>
                <div style="flex: 1;">
                  <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                  <button onclick="document.getElementById('profilePicUpload').click()" class="button" style="margin-bottom: 10px;">Upload Profile Picture</button>
                  <p style="color: #a8dfe8; font-size: 0.8rem; margin: 5px 0;">Max 50KB  JPG/PNG recommended</p>
                </div>
              </div>
              
              <!-- Status Selector -->
              <select class="status-selector" id="userStatus">
                <option value="">Select Status...</option>
                <option value=" Gaming"> Gaming</option>
                <option value=" Online"> Online</option>
                <option value=" Away"> Away</option>
                <option value=" Do Not Disturb"> Do Not Disturb</option>
                <option value=" Looking to Play"> Looking to Play</option>
                <option value=" Competitive"> Competitive</option>
                <option value=" Chilling"> Chilling</option>
              </select>
              
              <!-- NEW: Profile Background Section -->
              <div class="profile-background-section">
                <h4 style="color: #00ffff; margin-bottom: 15px;"> Profile Background</h4>
                
                <div class="profile-background-preview" id="profileBackgroundPreview">
                  <span id="backgroundPreviewText">Profile Background Preview</span>
                </div>
                
                <div class="background-options">
                  <div class="background-option color" data-background="linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e)" style="background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);">
                    Cyber Space
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #1e3c72, #2a5298)" style="background: linear-gradient(135deg, #1e3c72, #2a5298);">
                    Deep Blue
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #667eea, #764ba2)" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    Purple Haze
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #f093fb, #f5576c)" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    Pink Dream
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #4facfe, #00f2fe)" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    Ocean Breeze
                  </div>
                  <div class="background-option color" data-background="linear-gradient(135deg, #43e97b, #38f9d7)" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                    Green Matrix
                  </div>
                  <div class="background-option custom" id="customBackgroundOption">
                    <span> Custom</span>
                    <small>Upload Image</small>
                  </div>
                </div>
                
                <input type="file" id="backgroundImageUpload" accept="image/*" style="display: none;">
                <button onclick="document.getElementById('backgroundImageUpload').click()" class="button" style="width: 100%; margin-top: 10px;">Upload Custom Background</button>
                <p style="color: #a8dfe8; font-size: 0.8rem; text-align: center; margin-top: 5px;">Max 100KB  JPG/PNG recommended</p>
              </div>
              
              <!-- NEW: Profile Music Section -->
              <div class="profile-music-section">
                <h4 style="color: #00ffff; margin-bottom: 15px;"> Profile Music</h4>
                
               <div class="profile-music-preview" id="profileMusicPreview">
  <div class="profile-music-info">
    <div class="profile-music-title" id="profileMusicTitle">No music selected</div>
    <div class="profile-music-artist" id="profileMusicArtist">Add a YouTube URL above</div>
  </div>
  <div class="profile-music-controls">
    <button class="profile-music-btn" id="profilePlayPause"></button>
    <button class="profile-music-btn" id="profileStopMusic"></button>
  </div>
</div>

<!-- YouTube Player Container (hidden but functional) -->
<div id="profileMusicPlayerContainer" style="display: none;"></div>
                
               <!-- YouTube URL Input -->
<div class="music-url-input" style="margin-bottom: 15px;">
  <label style="color: #00ffff; display: block; margin-bottom: 5px;"> YouTube URL</label>
  <input type="text" id="youtubeUrlInput" placeholder="Paste YouTube URL here..." 
         style="width: 100%; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
  <button id="setMusicUrl" class="button" style="width: 100%; margin-top: 8px;">Set Profile Music</button>
</div>

<!-- Music Info Display -->
<div class="current-music-info" style="background: rgba(0, 30, 60, 0.6); padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none;" id="currentMusicInfo">
  <div style="color: #00ffff; font-weight: bold;" id="currentMusicTitle">Current Music</div>
  <div style="color: #a8dfe8; font-size: 0.9rem;" id="currentMusicUrl"></div>
}
                
                <div style="text-align: center; margin-top: 10px;">
                  <button class="button muted" id="disableProfileMusic">Disable Profile Music</button>
                </div>
              </div>
              
              <!-- HTML Signature Editor -->
              <div class="signature-editor-container">
                <div class="signature-editor-toolbar" id="signatureToolbar">
                  <!-- Quill toolbar will be inserted here -->
                </div>
                <div class="signature-editor" id="signatureEditor">
                  <!-- Quill editor will be inserted here -->
                </div>
              </div>
              <div style="text-align: right; color: #a8dfe8; font-size: 0.8rem; margin-top: 5px;">
                <span id="signatureCount">0</span>/500 characters
              </div>
              
              <!-- Signature Preview -->
              <div class="signature-preview" id="signaturePreview">
                Your signature preview will appear here...
              </div>
              
              <!-- Storage Info -->
              <div class="storage-info" id="storageInfo">
                 Storage: Calculating...
              </div>
            </div>
            
            <!-- User Stats with Clear Labels -->
            <div class="user-stats" style="margin-top: 30px;">
              <h3 style="color: #00ffff; margin-bottom: 15px;">My Stats</h3>
              <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Connection methods you've favorited for quick access">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="favoritesCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;"> Favorites</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Connection Methods</div>
                </div>
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Posts you've made on your profile wall">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="postsCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;"> Posts</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Wall Activity</div>
                </div>
                <div class="stat-card" style="background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px; text-align: center;" 
                     title="Messages you've sent in global chat">
                  <div style="color: #00ffff; font-size: 1.5rem; font-weight: bold;" id="messagesCount">0</div>
                  <div style="color: #a8dfe8; font-size: 0.9rem;"> Messages</div>
                  <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Global Chat</div>
                </div>
              </div>
            </div>
            
            <!-- Data Management -->
            <div class="data-management">
              <h4 style="color: #00ffff; margin-bottom: 10px;">Data Management</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="button" onclick="exportProfile()" style="flex: 1; min-width: 120px;">Export Profile</button>
                <button class="button" onclick="document.getElementById('importProfile').click()" style="flex: 1; min-width: 120px;">Import Profile</button>
                <input type="file" id="importProfile" accept=".json" style="display: none;">
                <button class="button muted" onclick="clearProfileData()" style="flex: 1; min-width: 120px;">Clear Data</button>
              </div>
            </div>
            
            <!-- Profile Wall -->
            <div class="profile-wall" style="margin-top: 30px;">
              <h3 style="color: #00ffff; margin-bottom: 15px;">Profile Wall</h3>
              <div class="wall-post-input" style="margin-bottom: 20px;">
                <textarea id="wallPostText" placeholder="Write something on your wall..." 
                          style="width: 100%; height: 80px; padding: 12px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px; resize: vertical;"></textarea>
                <button id="postToWall" class="button" style="margin-top: 10px;">Post to Wall</button>
              </div>
              <div id="wallPosts" class="wall-posts">
                <!-- Wall posts will appear here -->
              </div>
            </div>
          </div>
        </div>
        
      <!-- Friends Tab -->
<div id="friends" class="social-tab">
  <div style="padding: 20px;">
    <h3 style="color: #00ffff; text-align: center; margin-bottom: 20px;"> Friends System</h3>
    
    <!-- Friend Requests Section -->
    <div class="friend-requests-section" style="margin-bottom: 30px;">
      <h4 style="color: #ff33cc; border-bottom: 2px solid #ff33cc; padding-bottom: 8px;">
         Friend Requests 
        <span id="requestsCount" style="background: #ff33cc; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
      </h4>
      
      <!-- Requests Tabs -->
      <div class="requests-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #00ffff;">
        <button class="request-tab-btn active" data-tab="received-requests"> Received</button>
        <button class="request-tab-btn" data-tab="sent-requests"> Sent</button>
      </div>
      
      <!-- Received Requests -->
      <div id="received-requests" class="requests-container">
        <div id="receivedRequestsList" class="requests-list">
          <div class="empty-state">No pending friend requests</div>
        </div>
      </div>
      
      <!-- Sent Requests -->
      <div id="sent-requests" class="requests-container" style="display: none;">
        <div id="sentRequestsList" class="requests-list">
          <div class="empty-state">No sent friend requests</div>
        </div>
      </div>
    </div>

    <!-- Friends List Section -->
    <div class="friends-list-section" style="margin-bottom: 30px;">
      <h4 style="color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 8px;">
         Your Friends 
        <span id="friendsCount" style="background: #00ffff; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
      </h4>
      <div id="friendsList" class="friends-grid">
        <div class="empty-state">No friends yet. Start adding some!</div>
      </div>
    </div>

    <!-- Find Friends Section -->
    <div class="find-friends-section">
      <h4 style="color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 8px;"> Find Players</h4>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="searchFriends" placeholder="Search by username..." 
               style="flex: 1; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
        <button id="searchFriendsBtn" class="button">Search</button>
      </div>
      <div id="searchFriendsResults" class="search-results">
        <div class="empty-state">Use the search above to find players</div>
      </div>
    </div>
  </div>
</div>
        
        <!-- Game Lobbies Tab -->
        <div id="lobby-chat" class="social-tab">
          <div style="padding: 20px;">
            <h3 style="color: #00ffff;">Game Lobbies</h3>
            <div class="lobby-list">
              <div class="lobby-category">
                <h4> Active Lobbies</h4>
                <div class="lobby-grid" id="activeLobbies" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                  <!-- Lobbies will be populated here -->
                </div>
              </div>
              <div class="lobby-actions">
                <button class="button" id="createLobbyBtn">Create New Lobby</button>
              </div>
            </div>
          </div>
        </div>
        
       <div id="find-players" class="social-tab">
  <div style="padding: 20px;">
    <h3 style="color: #00ffff; text-align: center; margin-bottom: 20px;"> Find Players</h3>
    
    <!-- Search Filters -->
    <div class="search-filters" style="margin-bottom: 20px; background: rgba(0, 30, 60, 0.6); padding: 15px; border-radius: 8px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div>
          <label style="color: #00ffff; display: block; margin-bottom: 5px;"> Game</label>
          <select id="gameFilter" style="width: 100%; padding: 8px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <option value="">All Games</option>
            <option value="Street Fighter II">Street Fighter II</option>
            <option value="Gran Turismo PSP">Gran Turismo PSP</option>
            <option value="Resident Evil Outbreak">Resident Evil Outbreak</option>
            <option value="Tekken 3">Tekken 3</option>
            <option value="Jak X: Combat Racing">Jak X: Combat Racing</option>
            <option value="Mod Nation Racers">Mod Nation Racers</option>
          </select>
        </div>
        <div>
          <label style="color: #00ffff; display: block; margin-bottom: 5px;"> Platform</label>
          <select id="platformFilter" style="width: 100%; padding: 8px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
            <option value="">All Platforms</option>
            <option value="PS1">PS1</option>
            <option value="PS2">PS2</option>
            <option value="PS3">PS3</option>
            <option value="PSP">PSP</option>
            <option value="Arcade">Arcade</option>
            <option value="PC">PC</option>
          </select>
        </div>
      </div>
      
   <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
    <div>
        <label style="color: #00ffff; display: block; margin-bottom: 5px;"> Search Players</label>
        <input type="text" id="socialPlayerSearchInput" placeholder="Enter username or game..." 
               style="width: 100%; padding: 10px; background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffff; color: #00ffff; border-radius: 6px;">
    </div>
        <div style="display: flex; align-items: end;">
          <button id="searchPlayersBtn" class="button" style="height: 40px;">Search</button>
        </div>
      </div>
    </div>

    <!-- Search Results -->
    <div class="search-results-container">
      <h4 style="color: #00ffff; margin-bottom: 15px;"> Search Results</h4>
      <div id="playerSearchResults" style="min-height: 200px;">
        <div style="text-align: center; color: #a8dfe8; padding: 40px;">
          <p>Use the filters above to find players</p>
          <p style="font-size: 0.9rem; opacity: 0.7;">Search by game, platform, or username</p>
        </div>
      </div>
    </div>

    <!-- Recently Active Players -->
    <div class="recent-players" style="margin-top: 30px;">
      <h4 style="color: #00ffff; margin-bottom: 15px;"> Recently Active</h4>
      <div id="recentPlayersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>
        
        <div id="recent-activity" class="social-tab">
          <div style="padding: 20px; text-align: center; color: #a8dfe8;">
            <h3 style="color: #00ffff;">Recent Activity</h3>
            <p>See what's happening in the community</p>
            <!-- Activity feed would go here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom cursor -->
  <img id="customCursor" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWZnOXpucnlxdXB5cDNteHJ0ZjJtOGZvOXl1cGoxbms2YTV0Njc4MSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/LrR1cXPmuyYUUMS1W5/giphy.gif" alt="" aria-hidden="true">

<script>
/* ---------- SUPABASE SETUP ---------- */

const SUPABASE_URL = 'https://lapyxhothazalssrbimb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcHl4aG90aGF6YWxzc3JiaW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjg0NDUsImV4cCI6MjA3Njk0NDQ0NX0.isfh75lAbJotctu6dkd_aAYK-2YNyYM4o-jqKFB5tVA';

console.log(' Supabase config loaded');

// Initialize Supabase
let supabase;
try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log(' Supabase client initialized successfully');
} catch (error) {
    console.error(' Supabase client creation failed:', error);
    // Fallback to prevent crashes
    supabase = {
        from: () => ({
            select: () => Promise.resolve({ data: [], error: 'Supabase not available' }),
            upsert: () => Promise.resolve({ data: null, error: 'Supabase not available' }),
            eq: () => ({ single: () => Promise.resolve({ data: null, error: 'Supabase not available' }) })
        })
    };
}
/* ---------- ENHANCED MATCHMAKING API CONNECTION ---------- */
const MATCHMAKING_API_URL = 'http://10.60.1.40:5000/api';
let apiRetryCount = 0;
const MAX_RETRIES = 3;

// Enhanced API fetch with better debugging
async function fetchMatchmakingData(endpoint) {
    try {
        console.log(` Fetching: ${MATCHMAKING_API_URL}${endpoint}`);
        
        const cacheBuster = `?_t=${Date.now()}`;
        const response = await fetch(`${MATCHMAKING_API_URL}${endpoint}${cacheBuster}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(` API Response for ${endpoint}:`, data);
        
        apiRetryCount = 0;
        return data;
        
    } catch (error) {
        console.error(` API fetch failed for ${endpoint}:`, error);
        
        if (apiRetryCount < MAX_RETRIES) {
            apiRetryCount++;
            console.log(`Retrying ${endpoint} in ${apiRetryCount * 1000}ms...`);
            await new Promise(resolve => setTimeout(resolve, apiRetryCount * 1000));
            return fetchMatchmakingData(endpoint);
        } else {
            apiRetryCount = 0;
            return null;
        }
    }
}
// ENHANCED: Comprehensive database scanner to find real game data
async function testDiscordConnection() {
    console.log(' SCANNING FOR REAL GAME DATA...');
    
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.innerHTML = '<div style="color: #ffff00;"> Scanning database for game invites and LFG data...</div>';
    }

    try {
        // Get complete debug info to see ALL tables
        const debug = await fetchMatchmakingData('/debug');
        updateDebugInfo(' FULL DATABASE SCAN:', debug);
        
        if (!debug || !debug.table_counts) {
            updateDebugInfo(' No database tables found', null, false);
            return;
        }

        // SCAN EACH TABLE FOR GAME DATA
        let foundGameData = false;
        
        // 1. Check LfgMessages table (Most likely for game invites)
        if (debug.table_counts.LfgMessages > 0) {
            console.log(' Found LfgMessages table! Scanning for game invites...');
            const lfgData = await fetchMatchmakingData('/table/LfgMessages');
            updateDebugInfo(' LFG MESSAGES (Game Invites):', lfgData);
            
            if (lfgData && lfgData.data && lfgData.data.length > 0) {
                foundGameData = true;
                processLfgMessages(lfgData.data);
            }
        }

        // 2. Check ActiveGames table 
        if (debug.table_counts.ActiveGames > 0) {
            console.log(' Found ActiveGames table!');
            const activeGames = await fetchMatchmakingData('/table/ActiveGames');
            updateDebugInfo(' ACTIVE GAMES TABLE:', activeGames);
            
            if (activeGames && activeGames.data && activeGames.data.length > 0) {
                foundGameData = true;
                processActiveGames(activeGames.data);
            }
        }

        // 3. Check ActiveGameRecords table
        if (debug.table_counts.ActiveGameRecords > 0) {
            console.log(' Found ActiveGameRecords table!');
            const gameRecords = await fetchMatchmakingData('/table/ActiveGameRecords');
            updateDebugInfo(' ACTIVE GAME RECORDS:', gameRecords);
            
            if (gameRecords && gameRecords.data && gameRecords.data.length > 0) {
                foundGameData = true;
                processGameRecords(gameRecords.data);
            }
        }

        // 4. Check other potential tables
        const potentialGameTables = ['GameSessions', 'MultiplayerSessions', 'GameLobbies', 'PlayerSessions'];
        for (const table of potentialGameTables) {
            if (debug.table_counts[table] > 0) {
                console.log(` Found ${table} table!`);
                const tableData = await fetchMatchmakingData(`/table/${table}`);
                updateDebugInfo(` ${table.toUpperCase()}:`, tableData);
                
                if (tableData && tableData.data && tableData.data.length > 0) {
                    foundGameData = true;
                    processGenericGameData(tableData.data, table);
                }
            }
        }

        // SUMMARY
        if (foundGameData) {
            updateDebugInfo('<div style="margin-top: 15px; padding: 10px; background: rgba(0, 255, 0, 0.2); border-radius: 6px; color: #00ff00;"> GAME DATA FOUND! Check the Active Games panel above.</div>', null, false);
        } else {
            updateDebugInfo('<div style="margin-top: 15px; padding: 10px; background: rgba(255, 0, 0, 0.2); border-radius: 6px; color: #ff3333;"> No active game data found in any table. The bot might not have active games right now.</div>', null, false);
        }

    } catch (error) {
        console.error(' Database scan failed:', error);
        updateDebugInfo(` SCAN FAILED: ${error.message}`, null, false);
    }
}

// PROCESS LFG MESSAGES (Game Invites)
function processLfgMessages(lfgData) {
    console.log(' Processing LFG Messages:', lfgData);
    
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    // Filter active LFG messages (not expired)
    const activeLfg = lfgData.filter(lfg => {
        // Check if message is not expired
        if (lfg.Expired === 1 || lfg.Expired === true) return false;
        
        // Check if expiration time is in future
        if (lfg.ExpireDateTime) {
            const expireTime = new Date(lfg.ExpireDateTime);
            return expireTime > new Date();
        }
        
        return true; // Assume active if no expiration check
    });

    if (activeLfg.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 30px;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div>No active game invites right now</div>
                <div style="font-size: 0.8rem; color: #ffff00; margin-top: 10px;">
                    Check Discord for new LFG messages
                </div>
            </div>
        `;
        return;
    }

    // Display active LFG messages as games
    activeGamesList.innerHTML = activeLfg.map((lfg, index) => {
        const gameName = lfg.GameName || lfg.ConnectionMethods || 'Unknown Game';
        const playersNeeded = lfg.MinimumPlayersNeeded || '?';
        const userId = lfg.UserId || 'Unknown';
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #00ff00;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">${gameName}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                             User: ${userId} |  Players: ${playersNeeded}
                        </div>
                        ${lfg.ConnectionMethods ? `<div style="color: #ffff00; font-size: 0.8rem; margin-top: 2px;">Method: ${lfg.ConnectionMethods}</div>` : ''}
                        ${lfg.RoleName ? `<div style="color: #ff33cc; font-size: 0.8rem; margin-top: 2px;">Role: ${lfg.RoleName}</div>` : ''}
                        ${lfg.AdditionalNotes ? `<div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 2px;">Notes: ${lfg.AdditionalNotes}</div>` : ''}
                    </div>
                    <span style="color: #00ff00; font-size: 0.8rem;"> LFG</span>
                </div>
                ${lfg.ExpireDateTime ? `
                <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 8px; border-top: 1px solid rgba(0,255,255,0.2); padding-top: 4px;">
                    Expires: ${new Date(lfg.ExpireDateTime).toLocaleString()}
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// PROCESS ACTIVE GAMES TABLE
function processActiveGames(gamesData) {
    console.log(' Processing ActiveGames:', gamesData);
    
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    const activeGames = gamesData.filter(game => 
        game.Status === 'active' || game.Status === 'in_progress' || !game.Status
    );

    if (activeGames.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 30px;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div>No active games in ActiveGames table</div>
            </div>
        `;
        return;
    }

    activeGamesList.innerHTML = activeGames.map((game, index) => {
        const gameId = game.GameId || 'Unknown';
        const players = game.PlayersOnline || game.Players || 1;
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #00ffff;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">Game ID: ${gameId}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                             Players: ${players} | User: ${game.UserId || 'Unknown'}
                        </div>
                        ${game.ConnectionTypeId ? `<div style="color: #ffff00; font-size: 0.8rem; margin-top: 2px;">Connection Type: ${game.ConnectionTypeId}</div>` : ''}
                    </div>
                    <span style="color: #00ff00; font-size: 0.8rem;"> ACTIVE</span>
                </div>
                ${game.StartTime ? `
                <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 8px; border-top: 1px solid rgba(0,255,255,0.2); padding-top: 4px;">
                    Started: ${new Date(game.StartTime).toLocaleString()}
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// PROCESS GAME RECORDS
function processGameRecords(records) {
    console.log(' Processing Game Records:', records);
    
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    // Show recent game records (last 1 hour)
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
    const recentRecords = records.filter(record => {
        if (record.Timestamp) {
            return new Date(record.Timestamp) > oneHourAgo;
        }
        return true; // Show all if no timestamp
    });

    if (recentRecords.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 30px;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div>No recent game records</div>
            </div>
        `;
        return;
    }

    activeGamesList.innerHTML = recentRecords.map((record, index) => {
        const gameName = record.GameName || record.FullGameName || 'Unknown Game';
        const players = record.TotalHostedGames || record.TotalActivePlayers || 1;
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ff33cc;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">${gameName}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                             Players: ${players} | Guild: ${record.GuildId || 'Unknown'}
                        </div>
                    </div>
                    <span style="color: #ff33cc; font-size: 0.8rem;"> RECENT</span>
                </div>
                ${record.Timestamp ? `
                <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 8px; border-top: 1px solid rgba(0,255,255,0.2); padding-top: 4px;">
                    Recorded: ${new Date(record.Timestamp).toLocaleString()}
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// PROCESS GENERIC GAME DATA
function processGenericGameData(gameData, tableName) {
    console.log(` Processing ${tableName}:`, gameData);
    
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    activeGamesList.innerHTML += gameData.map((game, index) => {
        const gameName = game.GameName || game.Name || `Game from ${tableName}`;
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ffff00;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">${gameName}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                            Source: ${tableName} | ID: ${game.Id || 'Unknown'}
                        </div>
                    </div>
                    <span style="color: #ffff00; font-size: 0.8rem;"> ${tableName}</span>
                </div>
            </div>
        `;
    }).join('');
}
// Enhanced debug info display
function updateDebugInfo(message, data = null, isJson = true) {
    const debugInfo = document.getElementById('debugInfo');
    if (!debugInfo) return;

    let content = '';
    
    if (isJson && data) {
        content += `<div style="color: #00ffff; margin-top: 8px;">${message}</div>`;
        content += `<pre style="background: rgba(0, 0, 0, 0.3); padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 0.7rem; margin: 5px 0;">${JSON.stringify(data, null, 2)}</pre>`;
    } else {
        content += message;
    }

    debugInfo.innerHTML += content;
}

// Enhanced Discord data processor
function processDiscordBotData(discordData) {
    console.log(' Processing REAL Discord bot data:', discordData);
    
    // Update Discord-specific display
    const discordLobbies = document.getElementById('discordActiveLobbies');
    const discordUsers = document.getElementById('discordOnlineUsers');
    const discordRecent = document.getElementById('discordRecentGames');
    const discordTotal = document.getElementById('discordTotalUsers');
    const discordStatus = document.getElementById('discordConnectionStatus');
    const discordUpdate = document.getElementById('discordLastUpdate');

    // Update Discord stats
    if (discordLobbies) {
        discordLobbies.textContent = discordData.total_lobbies || 0;
        discordLobbies.style.color = discordData.total_lobbies > 0 ? '#00ff00' : '#ffff00';
    }
    
    if (discordUsers) {
        discordUsers.textContent = discordData.online_users || 0;
        discordUsers.style.color = discordData.online_users > 0 ? '#ff33cc' : '#a8dfe8';
    }
    
    if (discordRecent) {
        discordRecent.textContent = discordData.recent_games ? discordData.recent_games.length : 0;
    }
    
    if (discordTotal) {
        discordTotal.textContent = '434'; // From your API response
    }

    // Update connection status
    if (discordStatus) {
        if (discordData.active_lobbies && discordData.active_lobbies.length > 0) {
            discordStatus.innerHTML = ' Live Discord Data';
            discordStatus.style.color = '#00ff00';
        } else {
            discordStatus.innerHTML = ' Connected (No active games)';
            discordStatus.style.color = '#ffff00';
        }
    }

    if (discordUpdate) {
        discordUpdate.textContent = `Last: ${new Date().toLocaleTimeString()}`;
    }

    // Update main dashboard with Discord data
    updateMainDashboardWithDiscordData(discordData);
    
    // Update games list with real Discord data
    updateActiveGamesWithDiscordData(discordData.active_lobbies || []);
    
    // Update recent games
    updatePopularGamesWithDiscordData(discordData.recent_games || []);
}

// Update main dashboard stats
function updateMainDashboardWithDiscordData(discordData) {
    const activeGamesElement = document.getElementById('activeGamesCount');
    const activePlayersElement = document.getElementById('activePlayersCount');
    const totalUsersElement = document.getElementById('totalUsersCount');

    if (activeGamesElement) {
        activeGamesElement.textContent = discordData.total_lobbies || 0;
        activeGamesElement.style.color = discordData.total_lobbies > 0 ? '#00ffff' : '#a8dfe8';
    }
    
    if (activePlayersElement) {
        activePlayersElement.textContent = discordData.online_users || 0;
        activePlayersElement.style.color = discordData.online_users > 0 ? '#ff33cc' : '#a8dfe8';
    }
    
    if (totalUsersElement) {
        totalUsersElement.textContent = '434'; // From your API
        totalUsersElement.style.color = '#ffff00';
    }
}

// Enhanced games list with Discord data
function updateActiveGamesWithDiscordData(discordLobbies) {
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    const realLobbies = discordLobbies.filter(lobby => lobby && lobby.source);

    if (realLobbies.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 30px;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div>No active Discord games right now</div>
                <div style="font-size: 0.8rem; color: #ffff00; margin-top: 10px;">
                    Games will appear here when players start lobbies
                </div>
            </div>
        `;
        return;
    }

    activeGamesList.innerHTML = realLobbies.map((lobby, index) => {
        const isActive = lobby.Status === 'active' || lobby.Status === 'in_progress';
        const borderColor = isActive ? '#00ff00' : '#ffff00';
        const statusText = isActive ? ' LIVE' : ' OFFLINE';
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${borderColor};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">Discord Lobby #${index + 1}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                            Source: ${lobby.source} | Status: ${lobby.Status}
                        </div>
                        ${lobby.GameId ? `<div style="color: #ffff00; font-size: 0.8rem; margin-top: 2px;">Game ID: ${lobby.GameId}</div>` : ''}
                        ${lobby.UserId ? `<div style="color: #ff33cc; font-size: 0.8rem; margin-top: 2px;">User ID: ${lobby.UserId}</div>` : ''}
                    </div>
                    <span style="color: ${isActive ? '#00ff00' : '#a8dfe8'}; font-size: 0.8rem;">${statusText}</span>
                </div>
                ${lobby.StartTime ? `
                <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 8px; border-top: 1px solid rgba(0,255,255,0.2); padding-top: 4px;">
                    Started: ${new Date(lobby.StartTime).toLocaleString()}
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Enhanced popular games with Discord data
function updatePopularGamesWithDiscordData(recentGames) {
    const popularGamesList = document.getElementById('popularGamesList');
    if (!popularGamesList) return;

    if (!recentGames || recentGames.length === 0) {
        popularGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 30px; grid-column: 1 / -1;">
                <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                <div>No recent Discord activity</div>
                <div style="font-size: 0.8rem; color: #ffff00; margin-top: 10px;">
                    Recent games will appear here as players are active
                </div>
            </div>
        `;
        return;
    }

    popularGamesList.innerHTML = recentGames.map(game => `
        <div class="popular-game-item" style="background: rgba(0, 30, 60, 0.7); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(0, 255, 255, 0.3);">
            <div style="color: #ff33cc; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem;">${game.GameName || 'Recent Game'}</div>
            <div style="color: #00ffff; font-size: 0.9rem;">${game.activity_count || 1} activities</div>
            <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">
                Last: ${new Date(game.last_activity).toLocaleTimeString()}
            </div>
        </div>
    `).join('');
}
// Enhanced player count that combines Supabase + Matchmaking API
async function updateEnhancedPlayerCount() {
    const playerCountElement = document.getElementById('playerCount');
    if (!playerCountElement) return;

    try {
        // Get data from both sources with timeout
        const [apiData, supabaseData] = await Promise.allSettled([
            Promise.race([
                fetchMatchmakingData('/dashboard'),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
            ]),
            supabase.auth.getUser()
        ]);

        let displayCount = '0/0';
        let isLiveData = false;
        
        // Try API first (real-time matchmaking data)
        if (apiData.status === 'fulfilled' && apiData.value) {
            const activeUsers = apiData.value.active_users || 0;
            const totalUsers = apiData.value.total_users || 0;
            displayCount = `${activeUsers}/${totalUsers}`;
            isLiveData = true;
        } 
        // Fallback to Supabase count
        else if (supabaseData.status === 'fulfilled') {
            const { count } = await supabase
                .from('user_profiles')
                .select('*', { count: 'exact', head: true });
            displayCount = `?/${count || 0}`;
        }

        playerCountElement.textContent = displayCount;
        
        // Visual feedback for live vs cached data
        if (isLiveData) {
            playerCountElement.style.color = '#00ffff';
            playerCountElement.title = 'Live matchmaking data';
        } else {
            playerCountElement.style.color = '#ffff00';
            playerCountElement.title = 'Cached data - reconnecting...';
        }
        
        playerCountElement.classList.add('player-count-animation');
        setTimeout(() => {
            playerCountElement.classList.remove('player-count-animation');
        }, 1000);

    } catch (error) {
        console.error('Enhanced player count error:', error);
        playerCountElement.textContent = '?/?';
        playerCountElement.style.color = '#ff3333';
        playerCountElement.title = 'Connection error';
    }
}
  /* ---------- VISIBILITY STATE DETECTION ---------- */
function initVisibilityHandler() {
    console.log(' Initializing visibility state handler...');
    
    // Handle tab visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log(' Page became visible - refreshing all data');
            // Force refresh all data when tab becomes visible
            updateEnhancedPlayerCount();
            if (window.loadDashboardData) {
                loadDashboardData();
            }
            // Refresh chat if social hub is open
            if (document.getElementById('socialHubModal')?.style.display === 'flex') {
                if (window.loadChatMessages) {
                    loadChatMessages();
                }
            }
        }
    });

    // Handle window focus/blur
    window.addEventListener('focus', function() {
        console.log(' Window focused - refreshing data');
        updateEnhancedPlayerCount();
        if (window.loadDashboardData) {
            loadDashboardData();
        }
    });

    // Detect RDP reconnection by checking mouse movement after being hidden
    let wasHidden = document.hidden;
    setInterval(() => {
        const isHidden = document.hidden;
        if (wasHidden && !isHidden) {
            console.log(' RDP reconnection detected - force refreshing');
            setTimeout(() => {
                updateEnhancedPlayerCount();
                if (window.loadDashboardData) {
                    loadDashboardData();
                }
            }, 1000);
        }
        wasHidden = isHidden;
    }, 1000);
}
/* ---------- FIXED PROFILE MUSIC PLAYER GLOBAL VARIABLES ---------- */
// Profile music player variables - MUST be global to avoid conflicts with main music player
let profileMusicPlayer = null;
let currentProfileMusic = null;
let isProfileMusicPlaying = false;

// Debug: print current Supabase session
(async () => {
    try {
        const { data } = await supabase.auth.getSession();
        console.log('Supabase session:', data?.session ?? null);
    } catch (e) {
        console.warn('Could not read supabase session', e);
    }
})();

/* ---------- FIXED PROFILE DATA MANAGEMENT ---------- */

async function saveUserProfile(profileUpdates) {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
        showQuickStatus('Please login to save profile!', 'error');
        return;
    }
    
    console.log(' Saving profile updates:', profileUpdates);
    
    try {
        // First, get the current profile to merge with updates
        const { data: currentProfile, error: fetchError } = await supabase
            .from('user_profiles')
            .select('profile_data')
            .eq('user_id', user.id)
            .single();

        let mergedProfileData = {};
        
        if (!fetchError && currentProfile && currentProfile.profile_data) {
            // Merge existing data with updates
            mergedProfileData = { ...currentProfile.profile_data, ...profileUpdates };
        } else {
            // No existing profile, use updates as new profile
            mergedProfileData = profileUpdates;
        }
        
        // Ensure critical fields are preserved
        if (currentProfile?.profile_data?.profilePic && !profileUpdates.profilePic) {
            mergedProfileData.profilePic = currentProfile.profile_data.profilePic;
        }
        
        console.log(' Merged profile data:', mergedProfileData);

        // Save merged data back to Supabase
        const { data, error } = await supabase
            .from('user_profiles')
            .upsert({
                user_id: user.id,
                username: user.user_metadata?.username || user.email.split('@')[0],
                profile_data: mergedProfileData,
                last_updated: new Date().toISOString()
            }, { 
                onConflict: 'user_id'
            });

        if (error) {
            console.error(' Profile save failed:', error);
            showQuickStatus('Failed to save profile!', 'error');
            return;
        }

        console.log(' Profile saved to Supabase!');
        showQuickStatus('Profile saved!', 'success');
        
        // Update UI immediately
        updateProfileDisplay();
        
    } catch (error) {
        console.error(' Profile save error:', error);
        showQuickStatus('Profile save error!', 'error');
    }
}

/* ---------- FIXED SIGNATURE SYSTEM ---------- */

function saveSignature() {
    if (!signatureEditor) return;
    
    const signature_html = signatureEditor.root.innerHTML;
    const signature = signatureEditor.getText().trim();
    
    // Only save signature-related data
    saveUserProfile({
        signature: signature,
        signature_html: signature_html,
        signature_updated: new Date().toISOString()
    });
}

/* ---------- ENHANCED REAL-TIME PLAYER COUNT SYSTEM ---------- */
function initLivePlayerCount() {
    const playerCountElement = document.getElementById('playerCount');
    if (!playerCountElement) return;
    
    // Update using the enhanced function that combines both data sources
    updateEnhancedPlayerCount();
    
    // Update every 30 seconds
    setInterval(updateEnhancedPlayerCount, 30000);
    
    // Also update when social hub is opened
    const socialBtn = document.getElementById('socialHubBtn');
    if (socialBtn) {
        socialBtn.addEventListener('click', updateEnhancedPlayerCount);
    }
    
    // Cleanup function (keep for compatibility)
    window.cleanupPlayerCount = function() {
        console.log('Player count cleanup called');
    };
}

/* ---------- FIXED CROSS-DEVICE DATA SYNC ---------- */

async function loadUserProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
        console.log('No user logged in');
        return null;
    }
    
    try {
        console.log(' Loading profile from Supabase for user:', user.id);
        
        const { data, error } = await supabase
            .from('user_profiles')
            .select('profile_data, last_updated')
            .eq('user_id', user.id)
            .single();

        if (error) {
            console.log(' No existing profile found, creating new one');
            // Create default profile
            const defaultProfile = {
                profilePic: null,
                signature: '',
                signature_html: '',
                status: '',
                avatarType: 'generated',
                created: new Date().toISOString()
            };
            
            await saveUserProfile(defaultProfile);
            return defaultProfile;
        }
        
        console.log(' Profile loaded from Supabase:', data);
        
        if (data && data.profile_data) {
            // Update all profile elements
            updateProfileUI(user, data.profile_data);
            return data.profile_data;
        }
        
        return null;
        
    } catch (error) {
        console.error(' Profile load error:', error);
        return null;
    }
}

function updateProfileUI(user, profileData) {
    // Update profile picture
    if (profileData.profilePic) {
        const preview = document.getElementById('profilePicPreview');
        if (preview) {
            preview.innerHTML = `<img src="${profileData.profilePic}" alt="${user.email}" style="width:100%;height:100%;object-fit:cover;">`;
        }
        updateProfileAvatar(user, profileData);
    }
    
    // Update signature
    if (window.signatureEditor && profileData.signature_html) {
        signatureEditor.root.innerHTML = profileData.signature_html;
        updateSignaturePreview();
        updateSignatureCount();
    }
    
    // Update status
    const statusSelector = document.getElementById('userStatus');
    if (statusSelector && profileData.status) {
        statusSelector.value = profileData.status;
    }
    
    // Update background
    if (profileData.background) {
        updateProfileBackgroundPreview(profileData.background);
    }
    
    // Update music
    if (profileData.music) {
        updateProfileMusicPreview(profileData.music);
    }
    
    console.log(' UI updated with profile data');
}

/* ---------- PURE SUPABASE AUTHENTICATION SYSTEM ---------- */

function initAccountSystem() {
    console.log(' Initializing account system...');
    initLoginModal();
    initAuthForms();
    initLoginTabs();
    initLogoutHandler();
    initDataManagementHandler();
    initChangeUsernameSystem();
    
    // Check auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event, session);
        checkLoginStatus();
    });
    
    // Initial check
    checkLoginStatus();
}

function initLoginModal() {
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('loginModal');
    const closeLogin = document.getElementById('closeLogin');
    
    if (loginBtn && loginModal) {
        loginBtn.addEventListener('click', function() {
            loginModal.style.display = 'flex';
        });
    }
    
    if (closeLogin && loginModal) {
        closeLogin.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
    }
    
    // Close modal when clicking outside
    if (loginModal) {
        loginModal.addEventListener('click', function(e) {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
}

function initLoginTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const tab = this.getAttribute('data-tab');
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                forgotPasswordForm.style.display = 'none';
            } else if (tab === 'register') {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                forgotPasswordForm.style.display = 'none';
            } else if (tab === 'forgot-password') {
                loginForm.style.display = 'none';
                registerForm.style.display = 'none';
                forgotPasswordForm.style.display = 'block';
            }
        });
    });
}

function initAuthForms() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showQuickStatus('Please fill in all fields!', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showQuickStatus('Login failed: ' + error.message, 'error');
                    return;
                }

                // Success!
                document.getElementById('loginModal').style.display = 'none';
                loginForm.reset();
                showQuickStatus(`Welcome back!`, 'success');
                checkLoginStatus();
                
            } catch (err) {
                showQuickStatus('Login error: ' + err.message, 'error');
            }
        });
    }
    
    if (registerForm) {
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!email || !password) {
                showQuickStatus('Email and password are required!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showQuickStatus('Password must be at least 6 characters!', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: email.split('@')[0] // Use first part of email as username
                        }
                    }
                });

                if (error) {
                    showQuickStatus('Registration failed: ' + error.message, 'error');
                    return;
                }

                document.getElementById('loginModal').style.display = 'none';
                registerForm.reset();
                
                if (data.user && data.user.identities && data.user.identities.length === 0) {
                    showQuickStatus('User already registered!', 'error');
                } else {
                    showQuickStatus('Registration successful! Please check your email to confirm your account.', 'success');
                }
                
            } catch (err) {
                showQuickStatus('Registration error: ' + err.message, 'error');
            }
        });
    }
    
    if (forgotPasswordForm) {
        forgotPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('forgotPasswordEmail').value.trim();
            
            if (!email) {
                showQuickStatus('Please enter your email!', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin,
                });

                if (error) {
                    showQuickStatus('Password reset failed: ' + error.message, 'error');
                    return;
                }

                showQuickStatus('Password reset link sent to your email!', 'success');
                forgotPasswordForm.reset();
                
                // Switch back to login tab
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-tab="login"]').classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('forgotPasswordForm').style.display = 'none';
                
            } catch (err) {
                showQuickStatus('Password reset error: ' + err.message, 'error');
            }
        });
    }
}

function checkLoginStatus() {
    const loginBtn = document.getElementById('loginBtn');
    const userSection = document.querySelector('.user-section');
    const userDisplayName = document.getElementById('userDisplayName');
    
    // Check Supabase session directly
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (userSection) userSection.style.display = 'flex';
            
            // Get username from user metadata or use email prefix
            const username = user.user_metadata?.username || user.email.split('@')[0];
            if (userDisplayName) userDisplayName.textContent = username;
            
            console.log(' User logged in via Supabase:', user.email);
            
            // Initialize user systems
            initUserFavorites();
            initCustomizationSystems();
        } else {
            if (loginBtn) loginBtn.style.display = 'flex';
            if (userSection) userSection.style.display = 'none';
            console.log(' No user logged in');
        }
    });
}

function initLogoutHandler() {
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to logout?')) {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    showQuickStatus('Logout failed: ' + error.message, 'error');
                } else {
                    showQuickStatus('Logged out successfully!', 'info');
                    checkLoginStatus();
                }
            }
        });
    }
}

function initChangeUsernameSystem() {
    const changeUsernameBtn = document.getElementById('changeUsernameBtn');
    const changeUsernameModal = document.getElementById('changeUsernameModal');
    const closeChangeUsername = document.getElementById('closeChangeUsername');
    const changeUsernameForm = document.getElementById('changeUsernameForm');
    
    if (changeUsernameBtn) {
        changeUsernameBtn.addEventListener('click', function() {
            supabase.auth.getUser().then(({ data: { user } }) => {
                if (!user) {
                    showQuickStatus('Please login first!', 'error');
                    return;
                }
                changeUsernameModal.style.display = 'flex';
            });
        });
    }
    
    if (closeChangeUsername) {
        closeChangeUsername.addEventListener('click', function() {
            changeUsernameModal.style.display = 'none';
        });
    }
    
    if (changeUsernameModal) {
        changeUsernameModal.addEventListener('click', function(e) {
            if (e.target === changeUsernameModal) {
                changeUsernameModal.style.display = 'none';
            }
        });
    }
    
    if (changeUsernameForm) {
        changeUsernameForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value.trim();
            
            if (!newUsername) {
                showQuickStatus('Please enter a username!', 'error');
                return;
            }
            
            if (newUsername.length < 3) {
                showQuickStatus('Username must be at least 3 characters!', 'error');
                return;
            }
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showQuickStatus('Please login first!', 'error');
                    return;
                }
                
                // Update user metadata with new username
                const { error } = await supabase.auth.updateUser({
                    data: { username: newUsername }
                });
                
                if (error) {
                    showQuickStatus('Username update failed: ' + error.message, 'error');
                    return;
                }
                
                // Update display
                const userDisplayName = document.getElementById('userDisplayName');
                if (userDisplayName) userDisplayName.textContent = newUsername;
                
                // Update profile display if open
                const profileUsername = document.getElementById('profileUsername');
                if (profileUsername) profileUsername.textContent = newUsername;
                
                showQuickStatus('Username updated successfully!', 'success');
                changeUsernameModal.style.display = 'none';
                changeUsernameForm.reset();
                
            } catch (err) {
                showQuickStatus('Username update error: ' + err.message, 'error');
            }
        });
    }
}

function initDataManagementHandler() {
    // Profile button
const profileBtn = document.getElementById('profileBtn');
if (profileBtn) {
    profileBtn.addEventListener('click', function() {
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (!user) {
                showQuickStatus('Please login first!', 'error');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            // Show profile page with proper URL
            const username = user.user_metadata?.username || user.email.split('@')[0];
            showProfilePage(username);
        });
    });
}
    
    // Favorites button
    const favoritesBtn = document.getElementById('favoritesBtn');
    if (favoritesBtn) {
        favoritesBtn.addEventListener('click', function() {
            supabase.auth.getUser().then(({ data: { user } }) => {
                if (!user) {
                    showQuickStatus('Please login first!', 'error');
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }
                
                showQuickStatus('Favorites feature coming soon!', 'info');
            });
        });
    }
    
    // Data Management button
    const dataManagementBtn = document.getElementById('dataManagementBtn');
    if (dataManagementBtn) {
        dataManagementBtn.addEventListener('click', function() {
            supabase.auth.getUser().then(({ data: { user } }) => {
                if (!user) {
                    showQuickStatus('Please login first!', 'error');
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }
                
                // Show profile page instead of social hub
                showProfilePage();
            });
        });
    }
}

/* ---------- USER CUSTOMIZATION SYSTEM ---------- */

// FIXED Profile Picture System
function initProfilePictureSystem() {
  const uploadInput = document.getElementById('profilePicUpload');
  const preview = document.getElementById('profilePicPreview');
  
  if (!uploadInput || !preview) {
    console.log('Profile picture elements not found');
    return;
  }
  
  uploadInput.addEventListener('change', handleProfilePicUpload);
  
  // Load current user's profile pic
  supabase.auth.getUser().then(({ data: { user } }) => {
    if (user) {
      loadUserProfile().then(profile => {
        if (profile && profile.profilePic) {
          preview.innerHTML = `<img src="${profile.profilePic}" alt="${user.email}" style="width:100%;height:100%;object-fit:cover;">`;
          console.log('Profile picture loaded from storage');
        } else {
          // Create text element if it doesn't exist
          let previewText = document.getElementById('profilePicText');
          if (!previewText) {
            previewText = document.createElement('span');
            previewText.id = 'profilePicText';
            preview.appendChild(previewText);
          }
          previewText.textContent = (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase();
          console.log('Using default avatar');
        }
        
        // Also update the profile header avatar
        updateProfileAvatar(user, profile);
      });
    }
  });
}

function updateProfileAvatar(user, profile) {
    const avatarLarge = document.querySelector('.profile-avatar-large');
    if (avatarLarge) {
        if (profile && profile.profilePic) {
            avatarLarge.innerHTML = `<img src="${profile.profilePic}" alt="${user.email}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
            const avatarText = avatarLarge.querySelector('#profileAvatarText');
            if (avatarText) {
                avatarText.textContent = (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase();
            }
        }
    }
}

function handleProfilePicUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('File selected:', file.name, file.size);
    
    // Check file size (max 500KB)
    if (file.size > 500 * 1024) {
        showQuickStatus('Image too large! Max 500KB.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        console.log('File read successfully, compressing...');
        
        try {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Resize to max 150x150
                let width = img.width;
                let height = img.height;
                const maxDimension = 150;
                
                if (width > height && width > maxDimension) {
                    height = (height * maxDimension) / width;
                    width = maxDimension;
                } else if (height > maxDimension) {
                    width = (width * maxDimension) / height;
                    height = maxDimension;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to data URL
                const compressedImage = canvas.toDataURL('image/jpeg', 0.8);
                console.log('Image compressed, size:', Math.round(compressedImage.length / 1024), 'KB');
                
                supabase.auth.getUser().then(async ({ data: { user } }) => {
                    if (!user) {
                        showQuickStatus('Please login first!', 'error');
                        return;
                    }

                    console.log('Saving profile picture to Supabase for:', user.email);
                    
                    // Save DIRECTLY to Supabase using the fixed function
                    await saveUserProfile({
                        profilePic: compressedImage,
                        avatarType: 'custom',
                        lastUpdated: new Date().toISOString()
                    });

                    console.log(' Profile picture saved to Supabase!');
                    
                    // Update preview immediately
                    const preview = document.getElementById('profilePicPreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${compressedImage}" alt="${user.email}" style="width:100%;height:100%;object-fit:cover;">`;
                    }
                    
                    // Update profile header avatar
                    updateProfileAvatar(user, { profilePic: compressedImage });
                    
                    showQuickStatus('Profile picture saved successfully!', 'success');
                });
            };
            img.src = e.target.result;
        } catch (err) {
            console.error('Error processing image:', err);
            showQuickStatus('Error processing image', 'error');
        }
    };
    
    reader.onerror = function() {
        console.error('Error reading file');
        showQuickStatus('Error reading image file', 'error');
    };
    
    reader.readAsDataURL(file);
}
/* ---------- BIO EDITING SYSTEM ---------- */
function initBioEditing() {
    const editBioBtn = document.getElementById('profilePageEditBio');
    const bioEditSection = document.getElementById('profilePageBioEdit');
    const bioDisplay = document.getElementById('profilePageBio');
    const bioText = document.getElementById('profilePageBioText');
    const saveBioBtn = document.getElementById('profilePageSaveBio');
    const cancelBioBtn = document.getElementById('profilePageCancelBio');
    const charCount = document.getElementById('profilePageBioCharCount');

    if (editBioBtn) {
        editBioBtn.addEventListener('click', function() {
            bioEditSection.style.display = 'block';
            bioDisplay.style.display = 'none';
            this.style.display = 'none';
            
            // Populate with current bio text
            const currentBio = bioDisplay.textContent;
            if (currentBio && !currentBio.includes('hasn\'t written a bio')) {
                bioText.value = currentBio;
            }
            
            updateBioCharCount();
        });
    }

    if (saveBioBtn) {
        saveBioBtn.addEventListener('click', function() {
            const newBio = bioText.value.trim();
            bioDisplay.textContent = newBio || 'This user hasn\'t written a bio yet.';
            bioDisplay.classList.toggle('empty', !newBio);
            
            // Save to profile
            saveUserProfile({ bio: newBio });
            
            // Hide edit section, show display
            bioEditSection.style.display = 'none';
            bioDisplay.style.display = 'block';
            editBioBtn.style.display = 'block';
            
            showQuickStatus('Bio updated!', 'success');
        });
    }

    if (cancelBioBtn) {
        cancelBioBtn.addEventListener('click', function() {
            bioEditSection.style.display = 'none';
            bioDisplay.style.display = 'block';
            editBioBtn.style.display = 'block';
        });
    }

    if (bioText) {
        bioText.addEventListener('input', updateBioCharCount);
    }

    function updateBioCharCount() {
        if (charCount) {
            const length = bioText.value.length;
            charCount.textContent = length;
            charCount.style.color = length > 450 ? '#ff3333' : length > 350 ? '#ffff00' : '#a8dfe8';
        }
    }
    
    console.log(' Bio editing system initialized');
}
/* ---------- NEW: PROFILE BACKGROUND SYSTEM ---------- */
function initProfileBackgroundSystem() {
    const backgroundOptions = document.querySelectorAll('.background-option');
    const backgroundUpload = document.getElementById('backgroundImageUpload');
    const backgroundPreview = document.getElementById('profileBackgroundPreview');
    
    // Load current background
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            loadUserProfile().then(profile => {
                if (profile && profile.background) {
                    updateProfileBackgroundPreview(profile.background);
                    
                    // Mark active option
                    backgroundOptions.forEach(option => {
                        if (option.dataset.background === profile.background) {
                            option.classList.add('active');
                        }
                    });
                }
            });
        }
    });
    
    // Background option click handlers
    backgroundOptions.forEach(option => {
        option.addEventListener('click', function() {
            if (this.id === 'customBackgroundOption') {
                backgroundUpload.click();
                return;
            }
            
            const background = this.dataset.background;
            selectBackgroundOption(this);
            updateProfileBackgroundPreview(background);
            saveUserProfile({ background: background });
            showQuickStatus('Background updated!', 'success');
        });
    });
    
    // Custom background upload
    backgroundUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check file size (max 100KB)
        if (file.size > 100 * 1024) {
            showQuickStatus('Background image too large! Max 100KB.', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const customBackground = e.target.result;
            updateProfileBackgroundPreview(`url(${customBackground})`);
            saveUserProfile({ background: customBackground });
            showQuickStatus('Custom background saved!', 'success');
            
            // Mark custom option as active
            selectBackgroundOption(document.getElementById('customBackgroundOption'));
        };
        reader.readAsDataURL(file);
    });
}

function selectBackgroundOption(selectedOption) {
    // Remove active class from all options
    document.querySelectorAll('.background-option').forEach(option => {
        option.classList.remove('active');
    });
    
    // Add active class to selected option
    selectedOption.classList.add('active');
}

function updateProfileBackgroundPreview(background) {
    const preview = document.getElementById('profileBackgroundPreview');
    if (!preview) return;
    
    if (background.startsWith('url(') || background.startsWith('data:')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else if (background.startsWith('linear-gradient')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else {
        preview.style.backgroundImage = `url(${background})`;
        preview.innerHTML = '';
    }
}
function updateProfileBackgroundPreview(background) {
    const preview = document.getElementById('profileBackgroundPreview');
    if (!preview) return;
    
    if (background.startsWith('url(') || background.startsWith('data:')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else if (background.startsWith('linear-gradient')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else {
        preview.style.backgroundImage = `url(${background})`;
        preview.innerHTML = '';
    }
}

// ========== ADD THIS RIGHT AFTER THE ABOVE FUNCTION ==========
/* ---------- PROFILE PAGE BACKGROUND SYSTEM ---------- */
function initProfilePageBackgroundSystem() {
    const backgroundOptions = document.querySelectorAll('.profile-background-section .background-option');
    const backgroundUpload = document.getElementById('profilePageBackgroundImageUpload');
    const backgroundPreview = document.getElementById('profilePageBackgroundPreview');
    
    backgroundOptions.forEach(option => {
        option.addEventListener('click', function() {
            if (this.id === 'profilePageCustomBackgroundOption') {
                backgroundUpload.click();
                return;
            }
            
            const background = this.dataset.background;
            selectProfilePageBackgroundOption(this);
            updateProfilePageBackgroundPreview(background);
            saveUserProfile({ background: background });
            showQuickStatus('Background updated!', 'success');
        });
    });
    
    backgroundUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 100 * 1024) {
            showQuickStatus('Background image too large! Max 100KB.', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const customBackground = e.target.result;
            updateProfilePageBackgroundPreview(`url(${customBackground})`);
            saveUserProfile({ background: customBackground });
            showQuickStatus('Custom background saved!', 'success');
            
            selectProfilePageBackgroundOption(document.getElementById('profilePageCustomBackgroundOption'));
        };
        reader.readAsDataURL(file);
    });
}

function selectProfilePageBackgroundOption(selectedOption) {
    document.querySelectorAll('.profile-background-section .background-option').forEach(option => {
        option.classList.remove('active');
    });
    selectedOption.classList.add('active');
}

function updateProfilePageBackgroundPreview(background) {
    const preview = document.getElementById('profilePageBackgroundPreview');
    if (!preview) return;
    
    if (background.startsWith('url(') || background.startsWith('data:')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else if (background.startsWith('linear-gradient')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else {
        preview.style.backgroundImage = `url(${background})`;
        preview.innerHTML = '';
    }
}
/* ---------- PROFILE PAGE BACKGROUND SYSTEM ---------- */
function initProfilePageBackgroundSystem() {
    const backgroundOptions = document.querySelectorAll('.profile-background-section .background-option');
    const backgroundUpload = document.getElementById('profilePageBackgroundImageUpload');
    const backgroundPreview = document.getElementById('profilePageBackgroundPreview');
    
    backgroundOptions.forEach(option => {
        option.addEventListener('click', function() {
            if (this.id === 'profilePageCustomBackgroundOption') {
                backgroundUpload.click();
                return;
            }
            
            const background = this.dataset.background;
            selectProfilePageBackgroundOption(this);
            updateProfilePageBackgroundPreview(background);
            saveUserProfile({ background: background });
            showQuickStatus('Background updated!', 'success');
        });
    });
    
    backgroundUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 100 * 1024) {
            showQuickStatus('Background image too large! Max 100KB.', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const customBackground = e.target.result;
            updateProfilePageBackgroundPreview(`url(${customBackground})`);
            saveUserProfile({ background: customBackground });
            showQuickStatus('Custom background saved!', 'success');
            
            selectProfilePageBackgroundOption(document.getElementById('profilePageCustomBackgroundOption'));
        };
        reader.readAsDataURL(file);
    });
}

function selectProfilePageBackgroundOption(selectedOption) {
    document.querySelectorAll('.profile-background-section .background-option').forEach(option => {
        option.classList.remove('active');
    });
    selectedOption.classList.add('active');
}

function updateProfilePageBackgroundPreview(background) {
    const preview = document.getElementById('profilePageBackgroundPreview');
    if (!preview) return;
    
    if (background.startsWith('url(') || background.startsWith('data:')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else if (background.startsWith('linear-gradient')) {
        preview.style.backgroundImage = background;
        preview.innerHTML = '';
    } else {
        preview.style.backgroundImage = `url(${background})`;
        preview.innerHTML = '';
    }
}
/* ---------- FIXED PROFILE MUSIC SYSTEM ---------- */
function initProfileMusicSystem() {
    const youtubeUrlInput = document.getElementById('youtubeUrlInput');
    const setMusicBtn = document.getElementById('setMusicUrl');
    const playPauseBtn = document.getElementById('profilePlayPause');
    const stopBtn = document.getElementById('profileStopMusic');
    const disableBtn = document.getElementById('disableProfileMusic');
    const currentMusicInfo = document.getElementById('currentMusicInfo');
    
    // Ensure YouTube API is loaded for profile music
    ensureYouTubeAPIForProfileMusic();

    // Reset music state when initializing
    if (window.currentProfileMusicPlayer) {
        window.currentProfileMusicPlayer.destroy();
        window.currentProfileMusicPlayer = null;
    }
    window.currentProfileMusic = null;
    window.isProfileMusicPlaying = false;

    // Load current music for the CURRENT USER (not the viewed profile)
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            loadUserProfile().then(profile => {
                if (profile && profile.music) {
                    window.currentProfileMusic = profile.music;
                    updateProfileMusicPreview(profile.music);
                    if (youtubeUrlInput) youtubeUrlInput.value = profile.music.url || '';
                    if (currentMusicInfo) {
                        currentMusicInfo.style.display = 'block';
                        document.getElementById('currentMusicUrl').textContent = profile.music.url;
                    }
                }
            });
        }
    });
    
    // Set music from URL
    if (setMusicBtn) {
        setMusicBtn.addEventListener('click', function() {
            const youtubeUrl = youtubeUrlInput.value.trim();
            
            if (!youtubeUrl) {
                showQuickStatus('Please enter a YouTube URL!', 'error');
                return;
            }
            
            // Extract video ID from various YouTube URL formats
            const videoId = extractYouTubeId(youtubeUrl);
            
            if (!videoId) {
                showQuickStatus('Invalid YouTube URL!', 'error');
                return;
            }
            
            const musicData = {
                id: videoId,
                url: youtubeUrl,
                title: 'Custom YouTube Music',
                type: 'youtube'
            };
            
            window.currentProfileMusic = musicData;
            updateProfileMusicPreview(musicData);
            saveUserProfile({ music: musicData });
            
            if (currentMusicInfo) {
                currentMusicInfo.style.display = 'block';
                document.getElementById('currentMusicUrl').textContent = youtubeUrl;
            }
            
            // Stop current music if playing
            if (window.isProfileMusicPlaying) {
                stopProfileMusic();
            }
            
            showQuickStatus('Profile music set!', 'success');
        });
    }
    
    // Play/Pause button - FIXED
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            console.log(' Profile Play/Pause clicked');
            if (!window.currentProfileMusic) {
                showQuickStatus('No music selected! Add a YouTube URL first.', 'error');
                return;
            }
            
            if (!window.isProfileMusicPlaying) {
                playProfileMusic();
            } else {
                pauseProfileMusic();
            }
        });
    }
    
    // Stop button - FIXED
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            console.log(' Profile Stop clicked');
            stopProfileMusic();
        });
    }
    
    // Disable music button
    if (disableBtn) {
        disableBtn.addEventListener('click', function() {
            window.currentProfileMusic = null;
            stopProfileMusic();
            updateProfileMusicPreview(null);
            saveUserProfile({ music: null });
            
            if (youtubeUrlInput) youtubeUrlInput.value = '';
            if (currentMusicInfo) currentMusicInfo.style.display = 'none';
            
            showQuickStatus('Profile music disabled!', 'info');
        });
    }
}

/* ---------- PROFILE PAGE MUSIC SYSTEM (For viewing other profiles) ---------- */
function initProfilePageMusicSystem() {
    const playPauseBtn = document.getElementById('profilePagePlayPause');
    const stopBtn = document.getElementById('profilePageStopMusic');
    
    // Reset profile page music state
    window.profilePageMusicPlayer = null;
    window.profilePageMusic = null;
    window.isProfilePageMusicPlaying = false;

    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            console.log(' Profile Page Play/Pause clicked');
            if (!window.profilePageMusic) {
                showQuickStatus('This user has no profile music!', 'error');
                return;
            }
            
            if (!window.isProfilePageMusicPlaying) {
                playProfilePageMusic();
            } else {
                pauseProfilePageMusic();
            }
        });
    }
    
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            console.log(' Profile Page Stop clicked');
            stopProfilePageMusic();
        });
    }
}

function playProfilePageMusic() {
    console.log(' Playing profile page music:', window.profilePageMusic);
    if (!window.profilePageMusic || !window.YT) {
        console.log(' Cannot play: no music or YT not loaded');
        return;
    }
    
    const playPauseBtn = document.getElementById('profilePagePlayPause');
    
    if (!window.profilePageMusicPlayer) {
        console.log(' Creating new profile page music player');
        // Create invisible YouTube player for profile page music
        const playerDiv = document.createElement('div');
        playerDiv.id = 'profile-page-music-player';
        playerDiv.style.cssText = 'position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px; opacity: 0;';
        document.body.appendChild(playerDiv);
        
        window.profilePageMusicPlayer = new YT.Player('profile-page-music-player', {
            height: '1',
            width: '1',
            videoId: window.profilePageMusic.id,
            playerVars: {
                'autoplay': 1,
                'controls': 0,
                'disablekb': 1,
                'fs': 0,
                'iv_load_policy': 3,
                'modestbranding': 1,
                'playsinline': 1,
                'rel': 0,
                'showinfo': 0
            },
            events: {
                'onReady': function(event) {
                    console.log(' Profile page music player ready');
                    event.target.playVideo();
                    window.isProfilePageMusicPlaying = true;
                    if (playPauseBtn) playPauseBtn.textContent = '';
                    showQuickStatus('Now playing profile music!', 'success');
                },
                'onStateChange': function(event) {
                    console.log('Profile page music state:', event.data);
                    if (event.data === YT.PlayerState.ENDED) {
                        window.isProfilePageMusicPlaying = false;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    } else if (event.data === YT.PlayerState.PLAYING) {
                        window.isProfilePageMusicPlaying = true;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    } else if (event.data === YT.PlayerState.PAUSED) {
                        window.isProfilePageMusicPlaying = false;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    }
                },
                'onError': function(event) {
                    console.error(' Profile page music player error:', event.data);
                    showQuickStatus('Profile music error!', 'error');
                }
            }
        });
    } else {
        console.log(' Using existing profile page music player');
        window.profilePageMusicPlayer.loadVideoById(window.profilePageMusic.id);
        window.isProfilePageMusicPlaying = true;
        if (playPauseBtn) playPauseBtn.textContent = '';
    }
}

function pauseProfilePageMusic() {
    console.log(' Pausing profile page music');
    if (window.profilePageMusicPlayer && window.isProfilePageMusicPlaying) {
        window.profilePageMusicPlayer.pauseVideo();
        window.isProfilePageMusicPlaying = false;
        const playPauseBtn = document.getElementById('profilePagePlayPause');
        if (playPauseBtn) playPauseBtn.textContent = '';
        showQuickStatus('Profile music paused', 'info');
    }
}

function stopProfilePageMusic() {
    console.log(' Stopping profile page music');
    if (window.profilePageMusicPlayer) {
        window.profilePageMusicPlayer.stopVideo();
        window.isProfilePageMusicPlaying = false;
        const playPauseBtn = document.getElementById('profilePagePlayPause');
        if (playPauseBtn) playPauseBtn.textContent = '';
        showQuickStatus('Profile music stopped', 'info');
    }
}

// Ensure YouTube API is loaded for profile music
function ensureYouTubeAPIForProfileMusic() {
    if (!window.YT) {
        console.log(' Loading YouTube API for profile music...');
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        // Set up callback for when API loads
        window.onYouTubeIframeAPIReady = function() {
            console.log(' YouTube API ready for profile music');
            // If we have existing music and the play button was clicked, auto-play
            if (currentProfileMusic && isProfileMusicPlaying) {
                playProfileMusic();
            }
        };
    } else {
        console.log(' YouTube API already loaded for profile music');
    }
}

function selectMusicOption(selectedOption) {
    // Remove active class from all options
    document.querySelectorAll('.music-option').forEach(option => {
        option.classList.remove('active');
    });
    
    // Add active class to selected option
    selectedOption.classList.add('active');
}

function updateProfileMusicPreview(musicData) {
    const titleElement = document.getElementById('profileMusicTitle');
    const artistElement = document.getElementById('profileMusicArtist');
    const playPauseBtn = document.getElementById('profilePlayPause');
    
    if (!musicData) {
        titleElement.textContent = 'No music selected';
        artistElement.textContent = 'Choose a track below';
        playPauseBtn.textContent = '';
        return;
    }
    
    titleElement.textContent = musicData.title;
    artistElement.textContent = musicData.artist;
}

function playProfileMusic() {
    console.log(' Playing profile music:', currentProfileMusic);
    if (!currentProfileMusic || !window.YT) {
        console.log(' Cannot play: no music or YT not loaded');
        return;
    }
    
    const playPauseBtn = document.getElementById('profilePlayPause');
    
    if (!profileMusicPlayer) {
        console.log(' Creating new profile music player');
        // Create invisible YouTube player for profile music
        const playerDiv = document.createElement('div');
        playerDiv.id = 'profile-music-player';
        playerDiv.style.cssText = 'position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px; opacity: 0;';
        document.body.appendChild(playerDiv);
        
        profileMusicPlayer = new YT.Player('profile-music-player', {
            height: '1',
            width: '1',
            videoId: currentProfileMusic.id,
            playerVars: {
                'autoplay': 1,
                'controls': 0,
                'disablekb': 1,
                'fs': 0,
                'iv_load_policy': 3,
                'modestbranding': 1,
                'playsinline': 1,
                'rel': 0,
                'showinfo': 0
            },
            events: {
                'onReady': function(event) {
                    console.log(' Profile music player ready');
                    event.target.playVideo();
                    isProfileMusicPlaying = true;
                    if (playPauseBtn) playPauseBtn.textContent = '';
                    showQuickStatus('Now playing profile music!', 'success');
                },
                'onStateChange': function(event) {
                    console.log('Profile music state:', event.data);
                    if (event.data === YT.PlayerState.ENDED) {
                        isProfileMusicPlaying = false;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    } else if (event.data === YT.PlayerState.PLAYING) {
                        isProfileMusicPlaying = true;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    } else if (event.data === YT.PlayerState.PAUSED) {
                        isProfileMusicPlaying = false;
                        if (playPauseBtn) playPauseBtn.textContent = '';
                    }
                },
                'onError': function(event) {
                    console.error(' Profile music player error:', event.data);
                    showQuickStatus('Profile music error!', 'error');
                }
            }
        });
    } else {
        console.log(' Using existing profile music player');
        profileMusicPlayer.loadVideoById(currentProfileMusic.id);
        isProfileMusicPlaying = true;
        if (playPauseBtn) playPauseBtn.textContent = '';
    }
}

function pauseProfileMusic() {
    console.log(' Pausing profile music');
    if (profileMusicPlayer && isProfileMusicPlaying) {
        profileMusicPlayer.pauseVideo();
        isProfileMusicPlaying = false;
        const playPauseBtn = document.getElementById('profilePlayPause');
        if (playPauseBtn) playPauseBtn.textContent = '';
        showQuickStatus('Profile music paused', 'info');
    }
}

function stopProfileMusic() {
    console.log(' Stopping profile music');
    if (profileMusicPlayer) {
        profileMusicPlayer.stopVideo();
        isProfileMusicPlaying = false;
        const playPauseBtn = document.getElementById('profilePlayPause');
        if (playPauseBtn) playPauseBtn.textContent = '';
        showQuickStatus('Profile music stopped', 'info');
    }
}

// Helper function to extract YouTube ID from various URL formats
function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}
  /* ---------- PROFILE PAGE MUSIC SYSTEM ---------- */
function initProfilePageMusicSystem() {
    const playPauseBtn = document.getElementById('profilePagePlayPause');
    const stopBtn = document.getElementById('profilePageStopMusic');
    const setMusicBtn = document.getElementById('profilePageSetMusicUrl');
    const disableBtn = document.getElementById('profilePageDisableProfileMusic');
    
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            console.log(' Profile Page Play/Pause clicked');
            if (!currentProfileMusic) {
                showQuickStatus('No music selected! Add a YouTube URL first.', 'error');
                return;
            }
            
            if (!isProfileMusicPlaying) {
                playProfileMusic();
            } else {
                pauseProfileMusic();
            }
        });
    }
    
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            console.log(' Profile Page Stop clicked');
            stopProfileMusic();
        });
    }
    
    if (setMusicBtn) {
        setMusicBtn.addEventListener('click', function() {
            const youtubeUrl = document.getElementById('profilePageYoutubeUrlInput').value.trim();
            
            if (!youtubeUrl) {
                showQuickStatus('Please enter a YouTube URL!', 'error');
                return;
            }
            
            const videoId = extractYouTubeId(youtubeUrl);
            
            if (!videoId) {
                showQuickStatus('Invalid YouTube URL!', 'error');
                return;
            }
            
            const musicData = {
                id: videoId,
                url: youtubeUrl,
                title: 'Custom YouTube Music',
                type: 'youtube'
            };
            
            currentProfileMusic = musicData;
            updateProfilePageMusicPreview(musicData);
            saveUserProfile({ music: musicData });
            
            const currentMusicInfo = document.getElementById('profilePageCurrentMusicInfo');
            if (currentMusicInfo) {
                currentMusicInfo.style.display = 'block';
                document.getElementById('profilePageCurrentMusicUrl').textContent = youtubeUrl;
            }
            
            if (isProfileMusicPlaying) {
                stopProfileMusic();
            }
            
            showQuickStatus('Profile music set!', 'success');
        });
    }
    
    if (disableBtn) {
        disableBtn.addEventListener('click', function() {
            currentProfileMusic = null;
            stopProfileMusic();
            updateProfilePageMusicPreview(null);
            saveUserProfile({ music: null });
            
            const youtubeInput = document.getElementById('profilePageYoutubeUrlInput');
            const currentMusicInfo = document.getElementById('profilePageCurrentMusicInfo');
            if (youtubeInput) youtubeInput.value = '';
            if (currentMusicInfo) currentMusicInfo.style.display = 'none';
            
            showQuickStatus('Profile music disabled!', 'info');
        });
    }
    
    // Load current music for profile page
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            loadUserProfile().then(profile => {
                if (profile && profile.music) {
                    currentProfileMusic = profile.music;
                    updateProfilePageMusicPreview(profile.music);
                    const youtubeInput = document.getElementById('profilePageYoutubeUrlInput');
                    const currentMusicInfo = document.getElementById('profilePageCurrentMusicInfo');
                    if (youtubeInput) youtubeInput.value = profile.music.url || '';
                    if (currentMusicInfo) {
                        currentMusicInfo.style.display = 'block';
                        document.getElementById('profilePageCurrentMusicUrl').textContent = profile.music.url;
                    }
                }
            });
        }
    });
}

function updateProfilePageMusicPreview(musicData) {
    const titleElement = document.getElementById('profilePageMusicTitle');
    const artistElement = document.getElementById('profilePageMusicArtist');
    const playPauseBtn = document.getElementById('profilePagePlayPause');
    
    if (!musicData) {
        if (titleElement) titleElement.textContent = 'No profile music';
        if (artistElement) artistElement.textContent = 'This user has no profile music';
        if (playPauseBtn) playPauseBtn.textContent = '';
        return;
    }
    
    if (titleElement) titleElement.textContent = musicData.title || 'Custom Music';
    if (artistElement) artistElement.textContent = musicData.artist || 'YouTube';
    if (playPauseBtn) playPauseBtn.textContent = window.isProfilePageMusicPlaying ? '' : '';
}

/* ---------- HTML SIGNATURE EDITOR SYSTEM ---------- */
let signatureEditor = null;

function initSignatureEditor() {
    // Initialize Quill editor for signatures
    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],
        ['link', 'image'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'font': [] }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        [{ 'align': [] }],
        ['clean']
    ];
    
    signatureEditor = new Quill('#signatureEditor', {
        modules: {
            toolbar: {
                container: '#signatureToolbar',
                handlers: {
                    // Custom image handler to prevent large images
                    'image': function() {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        
                        input.onchange = function() {
                            const file = input.files[0];
                            if (file) {
                                if (file.size > 100 * 1024) { // 100KB max
                                    showQuickStatus('Image too large! Max 100KB for signatures.', 'error');
                                    return;
                                }
                                
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const range = signatureEditor.getSelection();
                                    signatureEditor.insertEmbed(range.index, 'image', e.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                    }
                }
            }
        },
        theme: 'snow',
        formats: ['bold', 'italic', 'underline', 'strike', 'color', 'background', 'font', 'size', 'link', 'image', 'video', 'align', 'script', 'blockquote', 'code-block', 'indent', 'list', 'direction']
    });
    
    // Fix HTML paste handling for signatures
    signatureEditor.root.addEventListener('paste', function(e) {
        e.preventDefault();
        
        // Get pasted HTML
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text/html') || clipboardData.getData('text/plain');
        
        if (pastedData) {
            // Convert HTML to Quill delta and insert
            const delta = signatureEditor.clipboard.convert(pastedData);
            const range = signatureEditor.getSelection();
            signatureEditor.updateContents(delta, 'user');
            
            // Move cursor to end
            signatureEditor.setSelection(range.index + delta.length(), 0);
        }
    });
    
    // Customize Quill editor styling
    const editorElement = document.querySelector('#signatureEditor .ql-editor');
    if (editorElement) {
        editorElement.style.fontFamily = "'Orbitron', Arial, sans-serif";
        editorElement.style.color = '#00ffff';
        editorElement.style.minHeight = '120px';
        editorElement.style.maxHeight = '200px';
        editorElement.style.overflowY = 'auto';
        editorElement.style.background = 'rgba(0, 10, 20, 0.8)';
    }
    
    // Load current signature
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            loadUserProfile().then(profile => {
                if (profile) {
                    if (profile.signature_html) {
                        signatureEditor.root.innerHTML = profile.signature_html;
                    } else if (profile.signature) {
                        signatureEditor.setText(profile.signature);
                    }
                }
            });
        }
    });
    
    // Update preview on content change
    signatureEditor.on('text-change', function() {
        updateSignaturePreview();
        updateSignatureCount();
        saveSignature();
    });
    
    window.signatureEditor = signatureEditor;
}

function updateSignaturePreview() {
    const preview = document.getElementById('signaturePreview');
    if (!preview || !signatureEditor) return;
    
    const content = signatureEditor.root.innerHTML;
    
    // Create a container that preserves HTML and styling
    preview.innerHTML = content || 'Your signature preview will appear here...';
    
    // Ensure the preview container allows HTML styling
    preview.style.cssText = `
        min-height: 40px;
        padding: 15px;
        background: rgba(0, 20, 40, 0.6);
        border: 1px solid rgba(0, 255, 255, 0.3);
        border-radius: 6px;
        color: #00ffff;
        font-family: 'Orbitron', Arial, sans-serif;
        overflow: auto;
    `;
    
    // If empty, show placeholder with styling
    if (!content || content === '<p><br></p>') {
        preview.innerHTML = '<div style="color: #a8dfe8; font-style: italic; text-align: center;">Your signature preview will appear here...</div>';
    }
}

function updateSignatureCount() {
    const countElement = document.getElementById('signatureCount');
    if (!countElement || !signatureEditor) return;
    
    // Count text characters only (strip HTML tags for counting)
    const text = signatureEditor.getText().trim();
    const length = text.length;
    countElement.textContent = length;
    
    // Update color based on length
    if (length > 450) {
        countElement.style.color = '#ff3333';
    } else if (length > 350) {
        countElement.style.color = '#ffff00';
    } else {
        countElement.style.color = '#a8dfe8';
    }
}

// Status System
function initStatusSystem() {
    const statusSelector = document.getElementById('userStatus');
    
    statusSelector.addEventListener('change', function() {
        saveUserProfile({
            status: this.value,
            statusSince: new Date().toISOString()
        });
        updateOnlineUsers();
        showQuickStatus(`Status updated: ${this.value}`, 'success');
    });
    
    // Load current status
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            loadUserProfile().then(profile => {
                if (profile && profile.status) {
                    statusSelector.value = profile.status;
                }
            });
        }
    });
}

// Storage Management
function updateStorageInfo() {
    const storageInfo = document.getElementById('storageInfo');
    if (!storageInfo) return;
    
    try {
        let totalSize = 0;
        
        // Calculate total storage used
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length * 2; // UTF-16 characters use 2 bytes
            }
        }
        
        const totalSizeKB = Math.round(totalSize / 1024);
        const maxSizeKB = 5120; // 5MB in KB
        
        storageInfo.innerHTML = ` Storage: ${totalSizeKB}KB / ${maxSizeKB}KB`;
        
        // Add warning if approaching limit
        if (totalSizeKB > maxSizeKB * 0.8) {
            storageInfo.classList.add('storage-warning');
            storageInfo.style.background = 'rgba(255, 100, 100, 0.2)';
            storageInfo.style.borderColor = '#ff3333';
            storageInfo.innerHTML += '  Storage almost full!';
        } else if (totalSizeKB > maxSizeKB * 0.6) {
            storageInfo.style.background = 'rgba(255, 200, 100, 0.2)';
            storageInfo.style.borderColor = '#ffff00';
        } else {
            storageInfo.classList.remove('storage-warning');
            storageInfo.style.background = 'rgba(0, 255, 255, 0.1)';
            storageInfo.style.borderColor = '#00ffff';
        }
    } catch (e) {
        storageInfo.innerHTML = ' Storage: Unable to calculate';
    }
}

// Export/Import Profiles
function exportProfile() {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
            showQuickStatus('Please login first!', 'error');
            return;
        }
        
        loadUserProfile().then(profile => {
            if (!profile) {
                showQuickStatus('No profile data to export!', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(profile, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `rom-profile-${user.user_metadata?.username || user.email.split('@')[0]}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showQuickStatus('Profile exported successfully!', 'success');
        });
    });
}

function initImportSystem() {
    const importInput = document.getElementById('importProfile');
    importInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const profileData = JSON.parse(e.target.result);
                
                supabase.auth.getUser().then(({ data: { user } }) => {
                    if (user) {
                        saveUserProfile(profileData);
                        showQuickStatus('Profile imported successfully!', 'success');
                        
                        // Reload all customization
                        initProfilePictureSystem();
                        initSignatureEditor();
                        initStatusSystem();
                        initProfileBackgroundSystem();
                        initProfileMusicSystem();
                    }
                });
            } catch (error) {
                showQuickStatus('Invalid profile file!', 'error');
                console.error('Import error:', error);
            }
        };
        reader.readAsText(file);
        
        // Reset input
        event.target.value = '';
    });
}

function clearProfileData() {
    if (!confirm('Are you sure you want to clear all your profile data? This cannot be undone!')) {
        return;
    }
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            // Keep basic account info, clear customization
            saveUserProfile({
                profilePic: null,
                signature: '',
                signature_html: '',
                status: '',
                avatarType: 'generated',
                background: null,
                music: null
            });
            
            // Reset UI
            const preview = document.getElementById('profilePicPreview');
            const previewText = document.getElementById('profilePicText');
            preview.innerHTML = '';
            previewText.textContent = (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase();
            preview.appendChild(previewText);
            
            if (signatureEditor) {
                signatureEditor.setText('');
            }
            
            document.getElementById('userStatus').value = '';
            document.getElementById('signatureCount').textContent = '0';
            
            // Reset background and music
            updateProfileBackgroundPreview('linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e)');
            updateProfileMusicPreview(null);
            
            // Remove active classes
            document.querySelectorAll('.background-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelectorAll('.music-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Stop music if playing
            if (window.profileMusicPlayer) {
                stopProfileMusic();
            }
            
            showQuickStatus('Profile data cleared!', 'success');
            updateStorageInfo();
        }
    });
}

// Enhanced Profile Display
function updateProfileDisplay() {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) return;
        
        loadUserProfile().then(profile => {
            const profileHeader = document.querySelector('.profile-header');
            
            if (profileHeader && profile) {
                // Update profile picture in header
                const avatarContainer = profileHeader.querySelector('.profile-avatar-large');
                if (avatarContainer) {
                    if (profile.profilePic) {
                        avatarContainer.innerHTML = `<img src="${profile.profilePic}" alt="${user.email}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    } else {
                        const avatarText = avatarContainer.querySelector('#profileAvatarText');
                        if (avatarText) {
                            avatarText.textContent = (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase();
                        }
                    }
                }
            }
        });
    });
}

// Enhanced User Cards for chat
function createEnhancedUserCard(username, profile) {
    const status = profile.status || ' Online';
    const signature = profile.signature || '';
    
    return `
        <div class="user-card">
            <div style="display: flex; align-items: center; gap: 12px;">
                ${profile.profilePic ? 
                    `<img src="${profile.profilePic}" alt="${username}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                    `<div class="user-avatar">${username.charAt(0).toUpperCase()}</div>`
                }
                <div style="flex: 1;">
                    <div style="color: #00ffff; font-weight: bold;">${username}</div>
                    <div style="color: #a8dfe8; font-size: 0.8em;">${status}</div>
                    ${signature ? `<div class="user-signature">${signature}</div>` : ''}
                </div>
            </div>
        </div>
    `;
}

// Enhanced Chat Messages with signatures
function appendEnhancedChatMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${message.isOwn ? 'message-own' : 'message-other'}`;
    
    const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-username">${message.username}</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-text">${escapeHtml(message.text)}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* ---------- FIXED WALL SYSTEM ---------- */

// FIXED: Enhanced wall system for posting on other users' profiles
function initWallSystem() {
    const postBtn = document.getElementById('postToWall');
    
    if (postBtn) {
        // Remove existing listeners and add new one
        postBtn.replaceWith(postBtn.cloneNode(true));
        const newPostBtn = document.getElementById('postToWall');
        newPostBtn.addEventListener('click', postToWall);
    }
    
    // Clear wall post text when switching profiles
    const wallPostText = document.getElementById('wallPostText');
    if (wallPostText) {
        wallPostText.value = '';
    }
}

// FIXED: Post to current user's wall or viewed user's wall
// FIXED: Post to current user's wall or viewed user's wall
async function postToWall() {
    const postText = document.getElementById('wallPostText');
    if (!postText) {
        console.log(' Wall post text element not found');
        return;
    }
    
    const text = postText.value.trim();
    
    if (!text) {
        showQuickStatus('Please enter some text!', 'error');
        return;
    }
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        showQuickStatus('Please login to post!', 'error');
        return;
    }
    
    // Determine which user's wall we're posting on
    const profileUsername = document.getElementById('profilePageUsername')?.textContent;
    if (!profileUsername) {
        showQuickStatus('Cannot determine profile owner!', 'error');
        return;
    }
    
    const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
    const isOwnProfile = (profileUsername === currentUsername);
    
    const post = {
        id: Date.now().toString(),
        author: currentUsername,
        targetUser: profileUsername, // Who's wall this is posted on
        content: text,
        timestamp: new Date().toISOString(),
        likes: 0,
        comments: []
    };
    
    console.log(' Posting to wall:', post);
    
    try {
        // Save to Supabase
        const { data, error } = await supabase
            .from('wall_posts')
            .insert([{
                author: post.author,
                target_user: post.targetUser,
                content: post.content,
                likes: post.likes,
                created_at: post.timestamp
            }]);

        if (error) {
            console.error(' Supabase wall post failed:', error);
            showQuickStatus('Failed to save post!', 'error');
            return;
        }

        console.log(' Wall post saved to Supabase!');
        
        // Clear the input field
        postText.value = '';
        
        // Reload wall posts to show the new post
        const wallPostsContainer = document.getElementById('profilePageWallPosts');
        if (wallPostsContainer) {
            loadWallPostsForUsername(profileUsername, wallPostsContainer);
        }
        
        updateUserStats();
        
        const message = isOwnProfile ? 
            'Posted to your wall!' : 
            `Posted to ${profileUsername}'s wall!`;
        showQuickStatus(message, 'success');
        
    } catch (err) {
        console.error(' Wall post error:', err);
        showQuickStatus('Failed to post!', 'error');
    }
}

// FIXED: Save wall posts to Supabase
async function saveWallPostToSupabase(post) {
    try {
        const { data: sessionData } = await supabase.auth.getSession();
        const session = sessionData?.session;
        
        if (!session) {
            console.log('No session for Supabase wall post');
            return;
        }

        const { data, error } = await supabase
            .from('wall_posts')
            .insert([{
                author: post.author,
                target_user: post.targetUser,
                content: post.content,
                likes: post.likes,
                created_at: post.timestamp
            }]);

        if (error) {
            console.error(' Supabase wall post failed:', error);
        } else {
            console.log(' Wall post saved to Supabase!', data);
        }
    } catch (err) {
        console.error(' Wall post sync error:', err);
    }
}

// FIXED: Load wall posts for the currently viewed user
async function loadWallPostsForUser(userToView = null) {
    const wallPostsContainer = document.getElementById('wallPosts');
    
    if (!wallPostsContainer) return;
    
    // Determine which user's wall we're viewing
    let viewingUsername = userToView;
    
    if (!viewingUsername) {
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (user) {
                viewingUsername = document.getElementById('profileUsername')?.textContent || (user.user_metadata?.username || user.email.split('@')[0]);
                loadWallPostsForUsername(viewingUsername, wallPostsContainer);
            }
        });
    } else {
        loadWallPostsForUsername(viewingUsername, wallPostsContainer);
    }
}

async function loadWallPostsForUsername(viewingUsername, wallPostsContainer) {
    if (!viewingUsername) return;
    
    wallPostsContainer.innerHTML = '<div style="color: #a8dfe8; text-align: center; padding: 20px;">Loading posts...</div>';
    
    try {
        // Try to load from Supabase first
        const { data: supabasePosts, error } = await supabase
            .from('wall_posts')
            .select('*')
            .eq('target_user', viewingUsername)
            .order('created_at', { ascending: false });
        
        let allPosts = [];
        
        if (!error && supabasePosts) {
            // Convert Supabase format to our app format
            allPosts = supabasePosts.map(post => ({
                id: post.id.toString(),
                author: post.author,
                targetUser: post.target_user,
                content: post.content,
                timestamp: post.created_at,
                likes: post.likes || 0,
                comments: post.comments || []
            }));
            console.log(` Loaded ${allPosts.length} posts from Supabase for ${viewingUsername}`);
        } else {
            // Fallback to localStorage
            const localPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
            allPosts = localPosts.filter(post => post.targetUser === viewingUsername);
            console.log(` Loaded ${allPosts.length} posts from localStorage for ${viewingUsername}`);
        }
        
        // Display posts
        wallPostsContainer.innerHTML = '';
        
        if (allPosts.length === 0) {
            wallPostsContainer.innerHTML = `
                <div style="color: #a8dfe8; text-align: center; padding: 20px;">
                    No posts yet. Be the first to write something!
                </div>
            `;
            return;
        }
        
        allPosts.forEach(post => {
            appendWallPost(post);
        });
        
    } catch (err) {
        console.error('Error loading wall posts:', err);
        wallPostsContainer.innerHTML = '<div style="color: #ff3333; text-align: center; padding: 20px;">Error loading posts</div>';
    }
}

// FIXED: Enhanced wall post display
function appendWallPost(post) {
    const wallPostsContainer = document.getElementById('wallPosts');
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        const postDiv = document.createElement('div');
        postDiv.className = 'wall-post';
        postDiv.dataset.postId = post.id;
        
        const time = new Date(post.timestamp).toLocaleString();
        const isOwnPost = post.author === currentUsername;
        
        postDiv.innerHTML = `
            <div class="wall-post-header">
                <span class="wall-post-author" style="color: ${isOwnPost ? '#00ffff' : '#ff33cc'};">${post.author}</span>
                <span class="wall-post-time">${time}</span>
            </div>
            <div class="wall-post-content">${escapeHtml(post.content)}</div>
            <div class="wall-post-actions" style="margin-top: 10px; display: flex; gap: 15px; font-size: 0.8rem;">
                <button class="like-btn" data-post="${post.id}" style="background: none; border: none; color: #a8dfe8; cursor: pointer;">
                     ${post.likes || 0}
                </button>
                ${isOwnPost ? `
                    <button class="delete-post-btn" data-post="${post.id}" style="background: none; border: none; color: #ff3333; cursor: pointer;">
                         Delete
                    </button>
                ` : ''}
            </div>
        `;
        
        wallPostsContainer.appendChild(postDiv);
        
        // Add event listeners
        const likeBtn = postDiv.querySelector('.like-btn');
        const deleteBtn = postDiv.querySelector('.delete-post-btn');
        
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                likeWallPost(post.id);
            });
        }
        
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                deleteWallPost(post.id);
            });
        }
    });
}

function likeWallPost(postId) {
    // Implement like functionality here
    showQuickStatus('Like functionality coming soon!', 'info');
}

function deleteWallPost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) {
        return;
    }
    
    // Remove from localStorage
    const wallPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
    const updatedPosts = wallPosts.filter(post => post.id !== postId);
    localStorage.setItem('rom-wall-posts', JSON.stringify(updatedPosts));
    
    // Remove from display
    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
    if (postElement) {
        postElement.remove();
    }
    
    showQuickStatus('Post deleted!', 'success');
    updateUserStats();
}

/* ---------- INITIALIZE CUSTOMIZATION SYSTEMS ---------- */
function initCustomizationSystems() {
    initProfilePictureSystem();
    initSignatureEditor(); // Updated to use HTML editor
    initStatusSystem();
    initImportSystem();
    initProfileBackgroundSystem(); // NEW: Background system
    initProfileMusicSystem(); // FIXED: Music system
    updateStorageInfo();
    
    // Update storage info every 30 seconds
    setInterval(updateStorageInfo, 30000);
}

/* ---------- FIXED USER PROFILE DISPLAY ---------- */

// FIXED: Better data loading with cross-device support
async function loadUserProfileForDisplay() {
    console.log(' Loading profile for display');
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
            console.log('No user logged in for profile display');
            return;
        }
        
        console.log('Loading profile for:', user.email);
        
        // Update basic profile info
        const usernameElement = document.getElementById('profileUsername');
        const joinDateElement = document.getElementById('profileJoinDate');
        
        if (usernameElement) usernameElement.textContent = user.user_metadata?.username || user.email.split('@')[0];
        if (joinDateElement) {
            const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Recently';
            joinDateElement.textContent = `Joined: ${joinDate}`;
        }
        
        // Load profile data
        loadUserProfile().then(profile => {
            if (!profile) {
                console.log('No profile data found');
                return;
            }
            
            // Update profile picture in preview
            const preview = document.getElementById('profilePicPreview');
            if (preview) {
                if (profile.profilePic) {
                    preview.innerHTML = `<img src="${profile.profilePic}" alt="${user.email}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    let previewText = document.getElementById('profilePicText');
                    if (!previewText) {
                        previewText = document.createElement('span');
                        previewText.id = 'profilePicText';
                        preview.appendChild(previewText);
                    }
                    previewText.textContent = (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase();
                }
            }
            
            // Update signature editor
            if (window.signatureEditor) {
                if (profile.signature_html) {
                    window.signatureEditor.root.innerHTML = profile.signature_html;
                } else if (profile.signature) {
                    window.signatureEditor.setText(profile.signature);
                }
                updateSignaturePreview();
                updateSignatureCount();
            }
            
            // Update status
            const statusSelector = document.getElementById('userStatus');
            if (statusSelector && profile.status) {
                statusSelector.value = profile.status;
            }
            
            // Update background
            if (profile.background) {
                updateProfileBackgroundPreview(profile.background);
                
                // Mark active background option
                document.querySelectorAll('.background-option').forEach(option => {
                    if (option.dataset.background === profile.background) {
                        option.classList.add('active');
                    } else if (profile.background.startsWith('data:') && option.id === 'customBackgroundOption') {
                        option.classList.add('active');
                    }
                });
            }
            
            // Update music
            if (profile.music) {
                updateProfileMusicPreview(profile.music);
                
                // Mark active music option
                document.querySelectorAll('.music-option').forEach(option => {
                    const musicData = JSON.parse(option.dataset.music);
                    if (musicData.id === profile.music.id) {
                        option.classList.add('active');
                    }
                });
            }
            
            // Update profile header avatar
            updateProfileAvatar(user, profile);
            
            // Update stats
            updateUserStats();
            updateStorageInfo();
            
            console.log('Profile display fully updated for:', user.email);
        });
    });
}

function updateUserStats() {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) return;
        
        // Get favorites count from localStorage (you can move this to Supabase too)
        const favorites = JSON.parse(localStorage.getItem(`rom-favorites-${user.id}`) || '[]');
        const favoritesCount = favorites.length;
        const favoritesElement = document.getElementById('favoritesCount');
        if (favoritesElement) favoritesElement.textContent = favoritesCount;
        
        // Get posts count
        const wallPosts = JSON.parse(localStorage.getItem('rom-wall-posts') || '[]');
        const userPosts = wallPosts.filter(post => post.author === (user.user_metadata?.username || user.email.split('@')[0])).length;
        const postsElement = document.getElementById('postsCount');
        if (postsElement) postsElement.textContent = userPosts;
        
        // Get messages count
        const chatMessages = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
        const userMessages = chatMessages.filter(msg => msg.username === (user.user_metadata?.username || user.email.split('@')[0])).length;
        const messagesElement = document.getElementById('messagesCount');
        if (messagesElement) messagesElement.textContent = userMessages;
        
        console.log('User stats updated - Favorites:', favoritesCount, 'Posts:', userPosts, 'Messages:', userMessages);
    });
}

function initProfileSystem() {
    // This is now handled by initWallSystem and initCustomizationSystems
    console.log('Profile system initialized');
}

/* ---------- SOCIAL HUB SYSTEM ---------- */
function initSocialHub() {
    const socialBtn = document.getElementById('socialHubBtn');
    const socialModal = document.getElementById('socialHubModal');
    const closeSocial = document.getElementById('closeSocialHub');
    
    if (socialBtn) {
        socialBtn.addEventListener('click', () => {
            supabase.auth.getUser().then(({ data: { user } }) => {
                if (!user) {
                    showQuickStatus('Please login to access the Social Hub!', 'error');
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }
                
                socialModal.style.display = 'flex';
                loadSocialHub();
            });
        });
    }
    
    if (closeSocial) {
        closeSocial.addEventListener('click', () => {
            socialModal.style.display = 'none';
        });
    }
    
    // Close modal when clicking outside
    socialModal.addEventListener('click', (e) => {
        if (e.target === socialModal) {
            socialModal.style.display = 'none';
        }
    });
    
    initSocialTabs();
    initChatSystem();
    initProfileSystem();
}

function initSocialTabs() {
  const tabBtns = document.querySelectorAll('.social-nav-btn');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      tabBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const tabId = this.getAttribute('data-tab');
      document.querySelectorAll('.social-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'my-profile') {
        loadUserProfileForDisplay();
      } else {
        loadTabContent(tabId);
      }
    });
  });
}

 function loadSocialHub() {
    console.log(' LOADING SOCIAL HUB - FORCE FRIENDS SYSTEM');
    updateOnlineUsers();
    loadChatMessages();
    loadUserProfileForDisplay();
    updateUserStats();
    
    // ULTRA FORCE FRIEND SYSTEM TO LOAD
    setTimeout(() => {
        console.log(' ULTRA FORCING FRIEND SYSTEM LOAD...');
        
        // Make sure friends tab is visible
        const friendsTab = document.getElementById('friends');
        if (friendsTab) {
            friendsTab.style.display = 'flex';
            friendsTab.style.flexDirection = 'column';
            friendsTab.style.visibility = 'visible';
            friendsTab.style.opacity = '1';
            console.log(' Friends tab visibility forced');
        }
        
        // Load friend data - USE EXISTING FUNCTIONS
        loadFriendRequests();
        loadFriendsList();
        
        // Add click handler to friends nav button
        const friendsNavBtn = document.querySelector('[data-tab="friends"]');
        if (friendsNavBtn && !friendsNavBtn.dataset.fixed) {
            friendsNavBtn.dataset.fixed = 'true';
            friendsNavBtn.addEventListener('click', function() {
                console.log(' Friends tab clicked - loading data');
                setTimeout(() => {
                    loadFriendRequests();
                    loadFriendsList();
                    
                    // Force visibility again
                    const ft = document.getElementById('friends');
                    if (ft) {
                        ft.style.display = 'flex';
                        ft.style.visibility = 'visible';
                    }
                }, 100);
            });
        }
        
    }, 1000);
    
    loadActiveLobbies();
}

// Chat System
function initChatSystem() {
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendMessage');
  
  if (sendBtn) {
    sendBtn.addEventListener('click', sendChatMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });
  }
}

async function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        showQuickStatus('Please login to chat!', 'error');
        return;
    }
    
    const username = user.user_metadata?.username || user.email.split('@')[0];
    
    // Save to Supabase for cross-device sync
    const { data, error } = await supabase
        .from('global_chat')
        .insert([{
            username: username,
            message: message
        }]);
    
    if (error) {
        console.error('Failed to save message to Supabase:', error);
        showQuickStatus('Failed to send message!', 'error');
        return;
    }
    
    // Also save locally for immediate display
    const messageObj = {
        id: Date.now(),
        username: username,
        text: message,
        timestamp: new Date().toISOString(),
        type: 'global',
        isOwn: true
    };
    
    const chatData = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
    chatData.push(messageObj);
    
    if (chatData.length > 100) {
        chatData.splice(0, chatData.length - 100);
    }
    
    localStorage.setItem('rom-chat-messages', JSON.stringify(chatData));
    
    appendEnhancedChatMessage(messageObj);
    chatInput.value = '';
    playChatSound();
    
    showQuickStatus('Message sent!', 'success');
}

async function loadChatMessages() {
    const chatMessages = document.getElementById('chatMessages');
    
    // Load messages from Supabase
    const { data: supabaseMessages, error } = await supabase
        .from('global_chat')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(100);
    
    if (error) {
        console.error('Failed to load messages from Supabase:', error);
        // Fallback to localStorage
        loadLocalChatMessages();
        return;
    }
    
    // Convert Supabase format to app format
    const { data: { user } } = await supabase.auth.getUser();
    const currentUsername = user?.user_metadata?.username || user?.email.split('@')[0];
    
    const chatData = supabaseMessages.map(msg => ({
        id: msg.id,
        username: msg.username,
        text: msg.message,
        timestamp: msg.created_at,
        type: 'global',
        isOwn: msg.username === currentUsername
    }));
    
    chatMessages.innerHTML = '';
    
    chatData.forEach(msg => {
        appendEnhancedChatMessage(msg);
    });
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Set up real-time subscription
    setupChatSubscription();
}

function setupChatSubscription() {
    const subscription = supabase
        .channel('global-chat')
        .on('postgres_changes', 
            { event: 'INSERT', schema: 'public', table: 'global_chat' },
            (payload) => {
                // New message received
                supabase.auth.getUser().then(({ data: { user } }) => {
                    const currentUsername = user?.user_metadata?.username || user?.email.split('@')[0];
                    const newMessage = {
                        id: payload.new.id,
                        username: payload.new.username,
                        text: payload.new.message,
                        timestamp: payload.new.created_at,
                        type: 'global',
                        isOwn: payload.new.username === currentUsername
                    };
                    
                    if (!newMessage.isOwn) {
                        appendEnhancedChatMessage(newMessage);
                        playChatSound();
                    }
                });
            }
        )
        .subscribe();
        
    return subscription;
}

function loadLocalChatMessages() {
    const chatMessages = document.getElementById('chatMessages');
    const chatData = JSON.parse(localStorage.getItem('rom-chat-messages') || '[]');
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) {
            const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
            chatData.forEach(msg => {
                msg.isOwn = msg.username === currentUsername;
            });
        }
        
        chatMessages.innerHTML = '';
        
        chatData.forEach(msg => {
            appendEnhancedChatMessage(msg);
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}
// FIXED Online Users System - Shows real user data
function updateOnlineUsers() {
    const onlineList = document.getElementById('onlineUsersList');
    const onlineCount = document.getElementById('onlineCount');
    
    if (!onlineList) return;
    
    // For mobile, show empty state instead of demo users
    if (window.innerWidth <= 768) {
        onlineList.innerHTML = '<div style="color: #a8dfe8; text-align: center; padding: 10px;">No users online</div>';
        if (onlineCount) onlineCount.textContent = '0 users online';
        return;
    }
    
    // For desktop, use demo data - you can implement real online tracking later
    const demoUsers = [
        { username: 'RetroGamer', status: ' Gaming' },
        { username: 'PixelPusher', status: ' Online' },
        { username: 'ArcadeMaster', status: ' Looking to Play' },
        { username: 'GameMaster', status: ' Chilling' }
    ];
    
    onlineList.innerHTML = '';
    demoUsers.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'online-user';
        userDiv.innerHTML = `
            <span class="online-indicator"></span>
            <span style="font-weight: bold; color: #00ffff;">${user.username}</span>
            <small style="color: #a8dfe8; margin-left: auto;">${user.status}</small>
        `;
        onlineList.appendChild(userDiv);
    });
    
    if (onlineCount) {
        onlineCount.textContent = `${demoUsers.length} users online`;
    }
}

function loadTabContent(tabId) {
    switch(tabId) {
        case 'global-chat':
            loadChatMessages();
            break;
        case 'my-profile':
            loadUserProfileForDisplay();
            updateUserStats();
            break;
        case 'friends':
            loadFriendSystem();
            break;
        case 'lobby-chat':
            loadActiveLobbies();
            break;
        case 'find-players':
            initPlayerSearchSystem();
            break;
        case 'recent-activity':
            break;
    }
}

function playChatSound() {
    // Simple direct approach
    try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3');
        audio.volume = 0.2;
        audio.play().catch(() => {});
    } catch (e) {
        // Ignore errors
    }
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Update online users periodically
setInterval(updateOnlineUsers, 30000);

/* ---------- USER FAVORITES SYSTEM ---------- */
function initUserFavorites() {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) return;
        
        document.querySelectorAll('.card').forEach(card => {
            const favBtn = document.createElement('button');
            favBtn.className = 'favorite-btn';
            favBtn.innerHTML = '';
            favBtn.style.cssText = 'position:absolute; top:10px; right:10px; background:none; border:none; color:#ffd700; cursor:pointer; font-size:1.2em; z-index:10;';
            
            const cardId = card.querySelector('h3').textContent.trim();
            
            // Get favorites from localStorage
            const favorites = JSON.parse(localStorage.getItem(`rom-favorites-${user.id}`) || '[]');
            
            if (favorites.includes(cardId)) {
                favBtn.innerHTML = '';
            }
            
            favBtn.addEventListener('click', function() {
                if (!user) {
                    showQuickStatus('Please login to save favorites!', 'error');
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }
                
                const favorites = JSON.parse(localStorage.getItem(`rom-favorites-${user.id}`) || '[]');
                
                if (favorites.includes(cardId)) {
                    const updatedFavorites = favorites.filter(fav => fav !== cardId);
                    localStorage.setItem(`rom-favorites-${user.id}`, JSON.stringify(updatedFavorites));
                    this.innerHTML = '';
                    showQuickStatus('Removed from favorites', 'info');
                } else {
                    favorites.push(cardId);
                    localStorage.setItem(`rom-favorites-${user.id}`, JSON.stringify(favorites));
                    this.innerHTML = '';
                    showQuickStatus('Added to favorites!', 'success');
                }
                
                updateUserStats();
            });
            
            card.style.position = 'relative';
            card.appendChild(favBtn);
        });
    });
}

/* ---------- GAME LOBBIES SYSTEM ---------- */
function initGameLobbies() {
    // Add game-specific lobbies with actual functionality
    const lobbyChat = document.getElementById('lobby-chat');
    if (lobbyChat) {
        loadActiveLobbies();
        initLobbyCreation();
    }
}

function loadActiveLobbies() {
    const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
    const activeLobbies = document.getElementById('activeLobbies');
    
    if (!activeLobbies) return;
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        if (lobbies.length === 0) {
            activeLobbies.innerHTML = '<p style="color: #a8dfe8; text-align: center; grid-column: 1 / -1;">No active lobbies. Create one!</p>';
            return;
        }

        activeLobbies.innerHTML = lobbies.map(lobby => `
            <div class="lobby-card" style="background: rgba(0, 30, 60, 0.7); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 15px;">
                <div class="lobby-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span class="lobby-game" style="color: #ff33cc; font-weight: bold;">${lobby.game}</span>
                    <span class="lobby-players" style="color: #00ffff;">${lobby.players.length}/${lobby.maxPlayers}</span>
                </div>
                <div class="lobby-info" style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9rem;">
                    <span class="lobby-host" style="color: #a8dfe8;">Host: ${lobby.host}</span>
                    <span class="lobby-status" style="color: #00ff00;">${lobby.status}</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="button join-lobby-btn" data-lobby="${lobby.id}" style="flex: 1;">Join Lobby</button>
                    ${currentUsername === lobby.host ? 
                    `<button class="button muted close-lobby-btn" data-lobby="${lobby.id}" style="flex: 0 0 auto;"></button>` : 
                    ''}
                </div>
                ${lobby.players.length > 0 ? `
                    <div class="lobby-players-list" style="margin-top: 10px; font-size: 0.8rem; color: #a8dfe8;">
                        <strong>Players:</strong> ${lobby.players.join(', ')}
                    </div>
                ` : ''}
            </div>
        `).join('');

        // Add event listeners to join buttons
        document.querySelectorAll('.join-lobby-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                joinLobby(this.dataset.lobby);
            });
        });

        // Add event listeners to close buttons
        document.querySelectorAll('.close-lobby-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                closeLobby(this.dataset.lobby);
            });
        });
    });
}

function initLobbyCreation() {
    const createBtn = document.getElementById('createLobbyBtn');
    if (!createBtn) return;

    createBtn.addEventListener('click', function() {
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (!user) {
                showQuickStatus('Please login to create a lobby!', 'error');
                return;
            }

            // Simple lobby creation - you can expand this with a form
            const game = prompt('Enter game name:');
            if (!game) return;

            const maxPlayers = parseInt(prompt('Maximum players (2-8):', '4')) || 4;
            
            const newLobby = {
                id: Date.now().toString(),
                game: game,
                host: user.user_metadata?.username || user.email.split('@')[0],
                maxPlayers: Math.max(2, Math.min(8, maxPlayers)),
                players: [user.user_metadata?.username || user.email.split('@')[0]],
                status: 'Waiting for players',
                created: new Date().toISOString()
            };

            const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
            lobbies.push(newLobby);
            localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
            
            showQuickStatus(`Lobby created for ${game}!`, 'success');
            loadActiveLobbies();
        });
    });
}

function joinLobby(lobbyId) {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
            showQuickStatus('Please login to join a lobby!', 'error');
            return;
        }

        const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
        const lobby = lobbies.find(l => l.id === lobbyId);
        
        if (!lobby) {
            showQuickStatus('Lobby not found!', 'error');
            return;
        }

        if (lobby.players.includes(user.user_metadata?.username || user.email.split('@')[0])) {
            showQuickStatus('You are already in this lobby!', 'info');
            return;
        }

        if (lobby.players.length >= lobby.maxPlayers) {
            showQuickStatus('Lobby is full!', 'error');
            return;
        }

        lobby.players.push(user.user_metadata?.username || user.email.split('@')[0]);
        localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
        
        showQuickStatus(`Joined ${lobby.game} lobby!`, 'success');
        loadActiveLobbies();
    });
}

function closeLobby(lobbyId) {
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
            showQuickStatus('Please login to close a lobby!', 'error');
            return;
        }

        const lobbies = JSON.parse(localStorage.getItem('rom-game-lobbies') || '[]');
        const lobbyIndex = lobbies.findIndex(l => l.id === lobbyId);
        
        if (lobbyIndex === -1) {
            showQuickStatus('Lobby not found!', 'error');
            return;
        }

        const lobby = lobbies[lobbyIndex];
        
        // Only host can close the lobby
        if (lobby.host !== (user.user_metadata?.username || user.email.split('@')[0])) {
            showQuickStatus('Only the lobby host can close the lobby!', 'error');
            return;
        }

        if (!confirm(`Are you sure you want to close the "${lobby.game}" lobby? This will remove it for all players.`)) {
            return;
        }

        // Remove the lobby
        lobbies.splice(lobbyIndex, 1);
        localStorage.setItem('rom-game-lobbies', JSON.stringify(lobbies));
        
        showQuickStatus('Lobby closed successfully!', 'success');
        loadActiveLobbies();
    });
}

/* ---------- FRIEND SYSTEM ---------- */
/* ---------- ENHANCED FRIENDS SYSTEM ---------- */
function initFriendSystem() {
    console.log(' Initializing enhanced friends system...');
    
    // Initialize tabs
    initFriendRequestTabs();
    
    // Load friend data
    loadFriendRequests();
    loadFriendsList();
    
    // Initialize search
    initFriendSearch();
}

function initFriendRequestTabs() {
    const tabBtns = document.querySelectorAll('.request-tab-btn');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active tab
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.requests-container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
        });
    });
}

async function loadFriendRequests() {
    const receivedList = document.getElementById('receivedRequestsList');
    const sentList = document.getElementById('sentRequestsList');
    const requestsCount = document.getElementById('requestsCount');
    
    if (!receivedList || !sentList) {
        console.log(' Friend request elements not found');
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log(' No user logged in');
            return;
        }
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        console.log(' Loading friend requests for:', currentUsername);
        
        // Load received requests (where current user is the target)
        const { data: receivedRequests, error: receivedError } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('to_user', currentUsername)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        // Load sent requests (where current user is the sender)
        const { data: sentRequests, error: sentError } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('from_user', currentUsername)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });
        
        console.log(' Friend requests loaded:', {
            received: receivedRequests?.length || 0,
            sent: sentRequests?.length || 0
        });

        if (receivedError) {
            console.error(' Error loading received requests:', receivedError);
        }
        if (sentError) {
            console.error(' Error loading sent requests:', sentError);
        }
        
        // Display received requests
        displayReceivedRequests(receivedRequests || []);
        
        // Display sent requests
        displaySentRequests(sentRequests || []);
        
        // Update counts
        const totalRequests = (receivedRequests || []).length;
        if (requestsCount) {
            requestsCount.textContent = totalRequests;
            requestsCount.style.display = totalRequests > 0 ? 'inline-block' : 'none';
        }
        
    } catch (error) {
        console.error(' Error loading friend requests:', error);
        receivedList.innerHTML = '<div class="empty-state">Error loading requests</div>';
        sentList.innerHTML = '<div class="empty-state">Error loading requests</div>';
    }
}
function displayReceivedRequests(requests) {
    const receivedList = document.getElementById('receivedRequestsList');
    
    if (!requests || requests.length === 0) {
        receivedList.innerHTML = '<div class="empty-state">No pending friend requests</div>';
        return;
    }
    
    receivedList.innerHTML = requests.map(request => `
        <div class="friend-request-item request-item received">
            <div class="friend-info">
                <div class="friend-avatar">${request.from_user.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${request.from_user}</div>
                    <div class="request-status">Wants to be friends</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn accept" onclick="acceptFriendRequest('${request.from_user}', '${request.id}')">
                     Accept
                </button>
                <button class="friend-btn decline" onclick="declineFriendRequest('${request.from_user}', '${request.id}')">
                     Decline
                </button>
            </div>
        </div>
    `).join('');
}

function displaySentRequests(requests) {
    const sentList = document.getElementById('sentRequestsList');
    
    if (!requests || requests.length === 0) {
        sentList.innerHTML = '<div class="empty-state">No sent friend requests</div>';
        return;
    }
    
    sentList.innerHTML = requests.map(request => `
        <div class="friend-request-item request-item sent">
            <div class="friend-info">
                <div class="friend-avatar">${request.to_user.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${request.to_user}</div>
                    <div class="request-status">Request sent - Pending</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn remove" onclick="cancelFriendRequest('${request.to_user}', '${request.id}')">
                     Cancel
                </button>
            </div>
        </div>
    `).join('');
}

async function loadFriendsList() {
    const friendsList = document.getElementById('friendsList');
    const friendsCount = document.getElementById('friendsCount');
    
    if (!friendsList) return;
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Load accepted friend requests (both directions)
        const { data: friends, error } = await supabase
            .from('friend_requests')
            .select('*')
            .or(`and(from_user.eq.${currentUsername},status.eq.accepted),and(to_user.eq.${currentUsername},status.eq.accepted)`);
        
        if (error) {
            throw error;
        }
        
        // Process friends list
        const friendUsernames = new Set();
        if (friends) {
            friends.forEach(friend => {
                if (friend.from_user === currentUsername) {
                    friendUsernames.add(friend.to_user);
                } else {
                    friendUsernames.add(friend.from_user);
                }
            });
        }
        
        // Display friends
        displayFriendsList(Array.from(friendUsernames));
        
        // Update count
        if (friendsCount) {
            friendsCount.textContent = friendUsernames.size;
        }
        
    } catch (error) {
        console.error('Error loading friends list:', error);
        friendsList.innerHTML = '<div class="empty-state">Error loading friends</div>';
    }
}

function displayFriendsList(friendUsernames) {
    const friendsList = document.getElementById('friendsList');
    
    if (!friendUsernames || friendUsernames.length === 0) {
        friendsList.innerHTML = '<div class="empty-state">No friends yet. Start adding some!</div>';
        return;
    }
    
    // For demo purposes - in real app, you'd fetch actual user data
    friendsList.innerHTML = friendUsernames.map(username => {
        // Demo data - replace with actual user data from your database
        const isOnline = Math.random() > 0.3; // Random online status for demo
        const status = isOnline ? ' Online' : ' Offline';
        const statusClass = isOnline ? 'online' : 'offline';
        
        return `
            <div class="friend-item ${statusClass}">
                <div class="friend-info">
                    <div class="friend-avatar">${username.charAt(0).toUpperCase()}</div>
                    <div class="friend-details">
                        <div class="friend-name">${username}</div>
                        <div class="friend-status">${status}</div>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="friend-btn" onclick="viewFriendProfile('${username}')">
                         View
                    </button>
                    <button class="friend-btn remove" onclick="removeFriend('${username}')">
                         Remove
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function initFriendSearch() {
    const searchBtn = document.getElementById('searchFriendsBtn');
    const searchInput = document.getElementById('searchFriends');
    
    if (searchBtn && searchInput) {
        searchBtn.addEventListener('click', performFriendSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performFriendSearch();
            }
        });
    }
}

async function performFriendSearch() {
    const searchInput = document.getElementById('searchFriends');
    const searchResults = document.getElementById('searchFriendsResults');
    
    if (!searchInput || !searchResults) return;
    
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    if (!searchTerm) {
        showQuickStatus('Please enter a username to search!', 'error');
        return;
    }
    
    searchResults.innerHTML = '<div class="empty-state">Searching...</div>';
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Search users (excluding current user and existing friends)
        const { data: users, error } = await supabase
            .from('user_profiles')
            .select('username')
            .ilike('username', `%${searchTerm}%`)
            .neq('username', currentUsername)
            .limit(10);
        
        if (error) {
            throw error;
        }
        
        // Filter out existing friends and pending requests
        const filteredUsers = await filterOutExistingRelationships(users || [], currentUsername);
        
        displaySearchResults(filteredUsers, searchTerm);
        
    } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="empty-state">Search failed</div>';
    }
}

async function filterOutExistingRelationships(users, currentUsername) {
    // Check existing friend requests
    const { data: existingRequests, error } = await supabase
        .from('friend_requests')
        .select('*')
        .or(`from_user.eq.${currentUsername},to_user.eq.${currentUsername}`);
    
    if (error) return users;
    
    const existingUsernames = new Set();
    existingRequests.forEach(request => {
        if (request.from_user === currentUsername) {
            existingUsernames.add(request.to_user);
        } else {
            existingUsernames.add(request.from_user);
        }
    });
    
    return users.filter(user => !existingUsernames.has(user.username));
}

function displaySearchResults(users, searchTerm) {
    const searchResults = document.getElementById('searchFriendsResults');
    
    if (!users || users.length === 0) {
        searchResults.innerHTML = `
            <div class="empty-state">
                No users found matching "${searchTerm}"
            </div>
        `;
        return;
    }
    
    searchResults.innerHTML = users.map(user => `
        <div class="search-result-item">
            <div class="friend-info">
                <div class="friend-avatar">${user.username.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${user.username}</div>
                    <div class="friend-status">Click to send friend request</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn accept" onclick="sendFriendRequest('${user.username}')">
                     Add Friend
                </button>
            </div>
        </div>
    `).join('');
}

// Friend request actions
async function acceptFriendRequest(fromUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .update({ status: 'accepted' })
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Accepted friend request from ${fromUsername}!`, 'success');
        loadFriendRequests();
        loadFriendsList();
        
    } catch (error) {
        console.error('Error accepting friend request:', error);
        showQuickStatus('Failed to accept friend request', 'error');
    }
}

async function declineFriendRequest(fromUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Declined friend request from ${fromUsername}`, 'info');
        loadFriendRequests();
        
    } catch (error) {
        console.error('Error declining friend request:', error);
        showQuickStatus('Failed to decline friend request', 'error');
    }
}

async function cancelFriendRequest(toUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Cancelled friend request to ${toUsername}`, 'info');
        loadFriendRequests();
        
    } catch (error) {
        console.error('Error cancelling friend request:', error);
        showQuickStatus('Failed to cancel friend request', 'error');
    }
}

async function removeFriend(username) {
    if (!confirm(`Are you sure you want to remove ${username} from your friends?`)) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Delete the friend relationship
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .or(`and(from_user.eq.${currentUsername},to_user.eq.${username}),and(from_user.eq.${username},to_user.eq.${currentUsername})`);
        
        if (error) throw error;
        
        showQuickStatus(`Removed ${username} from friends`, 'info');
        loadFriendsList();
        
    } catch (error) {
        console.error('Error removing friend:', error);
        showQuickStatus('Failed to remove friend', 'error');
    }
}

function viewFriendProfile(username) {
    showQuickStatus(`Opening ${username}'s profile...`, 'info');
    // You can implement profile viewing here
    // For now, just show a message
    setTimeout(() => {
        showQuickStatus(`Profile viewing feature coming soon for ${username}!`, 'info');
    }, 1000);
}

function loadFriendSystem() {
    loadFriendRequests();
    loadFriendsList();
}
/* ---------- PLAYER SEARCH SYSTEM ---------- */
function initPlayerSearchSystem() {
    const searchBtn = document.getElementById('profilePlayerSearchBtn');
    const searchInput = document.getElementById('profilePlayerSearchInput');
    const searchResults = document.getElementById('playerSearchResults');
    
    if (searchBtn && searchInput) {
        searchBtn.addEventListener('click', performPlayerSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performPlayerSearch();
            }
        });
    }
    
    // Also initialize the social hub search
    const socialSearchBtn = document.getElementById('searchPlayersBtn');
    const socialSearchInput = document.getElementById('socialPlayerSearchInput');
    
    if (socialSearchBtn && socialSearchInput) {
        socialSearchBtn.addEventListener('click', performPlayerSearch);
        socialSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performPlayerSearch();
            }
        });
    }
}

async function performPlayerSearch() {
    // Try profile search input first, then social hub input
    let searchInput = document.getElementById('profilePlayerSearchInput');
    let searchResults = document.getElementById('playerSearchResults');
    
    // If profile search doesn't exist, try social hub search
    if (!searchInput) {
        searchInput = document.getElementById('socialPlayerSearchInput');
        searchResults = document.getElementById('playerSearchResults'); // This might be different in social hub
    }
    
    if (!searchInput || !searchResults) {
        showQuickStatus('Search system not available!', 'error');
        return;
    }
    
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    if (!searchTerm) {
        showQuickStatus('Please enter a username to search!', 'error');
        return;
    }
    
    searchResults.innerHTML = '<div style="text-align: center; color: #a8dfe8; padding: 20px;">Searching...</div>';
    
    try {
        // Search in Supabase user_profiles
        const { data: users, error } = await supabase
            .from('user_profiles')
            .select('username, profile_data')
            .ilike('username', `%${searchTerm}%`)
            .limit(10);
        
        if (error) {
            throw error;
        }
        
        displayPlayerSearchResults(users, searchTerm);
        
    } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div style="text-align: center; color: #ff3333; padding: 20px;">Search failed. Please try again.</div>';
    }
}

function displayPlayerSearchResults(users, searchTerm) {
    const searchResults = document.getElementById('playerSearchResults');
    
    // Get current user asynchronously
    let currentUsername = '';
    supabase.auth.getUser().then(({ data: { user } }) => {
        currentUsername = user?.user_metadata?.username || user?.email.split('@')[0] || '';
        
        // Now that we have the username, process the results
        processSearchResults(users, searchTerm, currentUsername, searchResults);
    }).catch(error => {
        console.error('Error getting current user:', error);
        // Process without current username if there's an error
        processSearchResults(users, searchTerm, '', searchResults);
    });
}

function processSearchResults(users, searchTerm, currentUsername, searchResults) {
    if (!users || users.length === 0) {
        searchResults.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                No players found matching "${searchTerm}"
            </div>
        `;
        return;
    }
    
    let html = '';
    users.forEach(user => {
        if (user.username === currentUsername) return; // Skip current user
        
        const status = user.profile_data?.status || ' Online';
        
        html += `
            <div class="user-card" style="margin: 10px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="user-avatar">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="color: #00ffff; font-weight: bold;">${user.username}</div>
                            <div style="color: #a8dfe8; font-size: 0.8rem;">${status}</div>
                        </div>
                    </div>
                    <button class="button add-friend-btn" data-username="${user.username}" 
                            style="padding: 6px 12px; font-size: 0.8rem;">
                        Add Friend
                    </button>
                </div>
            </div>
        `;
    });
    
    // If no users after filtering (only current user in results)
    if (html === '') {
        searchResults.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                No other players found matching "${searchTerm}"
            </div>
        `;
        return;
    }
    
    searchResults.innerHTML = html;
    
    // Add event listeners to add friend buttons
    document.querySelectorAll('.add-friend-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            sendFriendRequest(username);
        });
    });
}
/* ---------- ENHANCED FRIENDS SYSTEM ---------- */
function initEnhancedFriendSystem() {
    console.log(' Initializing enhanced friends system...');
    
    // Initialize tabs
    initFriendRequestTabs();
    
    // Load friend data
    loadFriendRequests();
    loadFriendsList();
    
    // Initialize search
    initFriendSearch();
    
    // Make sure the friends tab content is visible
    setTimeout(() => {
        const friendsTab = document.getElementById('friends');
        if (friendsTab) {
            friendsTab.style.display = 'flex';
            friendsTab.style.flexDirection = 'column';
        }
    }, 100);
    
    console.log(' Enhanced friend system initialized');
}
/* ---------- ADD FRIEND BUTTON STATE MANAGEMENT ---------- */
async function updateAddFriendButtonState() {
    const addFriendBtn = document.getElementById('profilePageAddFriend');
    if (!addFriendBtn) return;
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;
    
    const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
    const profileUsername = document.getElementById('profilePageUsername')?.textContent;
    
    if (!profileUsername || profileUsername === currentUsername) return;
    
    try {
        // Check if already friends - FIXED QUERY
        const { data: existingFriendship, error } = await supabase
            .from('friend_requests')
            .select('*')
            .or(`from_user.eq.${currentUsername},to_user.eq.${currentUsername}`)
            .eq('status', 'accepted');

        if (error) throw error;

        // Check if we're friends with this specific user
        const isFriend = existingFriendship?.some(request => 
            (request.from_user === currentUsername && request.to_user === profileUsername) ||
            (request.from_user === profileUsername && request.to_user === currentUsername)
        );
            
        if (isFriend) {
            addFriendBtn.textContent = ' Friends';
            addFriendBtn.disabled = true;
            addFriendBtn.style.background = 'rgba(0, 255, 0, 0.1)';
            return;
        }
        
        // Check if request already sent - FIXED QUERY
        const { data: existingRequest, error: requestError } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('from_user', currentUsername)
            .eq('to_user', profileUsername)
            .eq('status', 'pending')
            .maybeSingle(); // Use maybeSingle instead of single
            
        if (requestError) throw requestError;
        
        if (existingRequest) {
            addFriendBtn.textContent = ' Request Sent';
            addFriendBtn.disabled = true;
            addFriendBtn.style.background = 'rgba(255, 255, 0, 0.1)';
            return;
        }
        
        // Default state - can send request
        addFriendBtn.textContent = ' Add Friend';
        addFriendBtn.disabled = false;
        addFriendBtn.style.background = '';
        
    } catch (error) {
        console.log('No existing relationship found or query error:', error);
        // Default state if no relationship exists or query fails
        addFriendBtn.textContent = ' Add Friend';
        addFriendBtn.disabled = false;
        addFriendBtn.style.background = '';
    }
}
function initFriendRequestTabs() {
    const tabBtns = document.querySelectorAll('.request-tab-btn');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active tab
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.requests-container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
        });
    });
}

async function loadFriendRequests() {
    const receivedList = document.getElementById('receivedRequestsList');
    const sentList = document.getElementById('sentRequestsList');
    const requestsCount = document.getElementById('requestsCount');
    
    if (!receivedList || !sentList) {
        console.log(' Friend request elements not found');
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log(' No user logged in');
            return;
        }
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        console.log(' Loading friend requests for:', currentUsername);
        
        // Load received requests (where current user is the target) - FIXED QUERY
        const { data: receivedRequests, error: receivedError } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('to_user', currentUsername)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        // Load sent requests (where current user is the sender) - FIXED QUERY
        const { data: sentRequests, error: sentError } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('from_user', currentUsername)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });
        
        console.log(' Friend requests loaded:', {
            received: receivedRequests?.length || 0,
            sent: sentRequests?.length || 0
        });

        if (receivedError) {
            console.error(' Error loading received requests:', receivedError);
        }
        if (sentError) {
            console.error(' Error loading sent requests:', sentError);
        }
        
        // Display received requests
        displayReceivedRequests(receivedRequests || []);
        
        // Display sent requests
        displaySentRequests(sentRequests || []);
        
        // Update counts
        const totalRequests = (receivedRequests || []).length;
        if (requestsCount) {
            requestsCount.textContent = totalRequests;
            requestsCount.style.display = totalRequests > 0 ? 'inline-block' : 'none';
        }
        
    } catch (error) {
        console.error(' Error loading friend requests:', error);
        receivedList.innerHTML = '<div class="empty-state">Error loading requests</div>';
        sentList.innerHTML = '<div class="empty-state">Error loading requests</div>';
    }
}

function displayReceivedRequests(requests) {
    const receivedList = document.getElementById('receivedRequestsList');
    
    if (!requests || requests.length === 0) {
        receivedList.innerHTML = '<div class="empty-state">No pending friend requests</div>';
        return;
    }
    
    receivedList.innerHTML = requests.map(request => `
        <div class="friend-request-item request-item received">
            <div class="friend-info">
                <div class="friend-avatar">${request.from_user.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${request.from_user}</div>
                    <div class="request-status">Wants to be friends</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn accept" onclick="acceptFriendRequest('${request.from_user}', '${request.id}')">
                     Accept
                </button>
                <button class="friend-btn decline" onclick="declineFriendRequest('${request.from_user}', '${request.id}')">
                     Decline
                </button>
            </div>
        </div>
    `).join('');
}

function displaySentRequests(requests) {
    const sentList = document.getElementById('sentRequestsList');
    
    if (!requests || requests.length === 0) {
        sentList.innerHTML = '<div class="empty-state">No sent friend requests</div>';
        return;
    }
    
    sentList.innerHTML = requests.map(request => `
        <div class="friend-request-item request-item sent">
            <div class="friend-info">
                <div class="friend-avatar">${request.to_user.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${request.to_user}</div>
                    <div class="request-status">Request sent - Pending</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn remove" onclick="cancelFriendRequest('${request.to_user}', '${request.id}')">
                     Cancel
                </button>
            </div>
        </div>
    `).join('');
}

async function loadFriendsList() {
    const friendsList = document.getElementById('friendsList');
    const friendsCount = document.getElementById('friendsCount');
    
    if (!friendsList) return;
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Load accepted friend requests (both directions)
        const { data: friends, error } = await supabase
            .from('friend_requests')
            .select('*')
            .or(`and(from_user.eq.${currentUsername},status.eq.accepted),and(to_user.eq.${currentUsername},status.eq.accepted)`);
        
        if (error) {
            throw error;
        }
        
        // Process friends list
        const friendUsernames = new Set();
        if (friends) {
            friends.forEach(friend => {
                if (friend.from_user === currentUsername) {
                    friendUsernames.add(friend.to_user);
                } else {
                    friendUsernames.add(friend.from_user);
                }
            });
        }
        
        // Display friends
        displayFriendsList(Array.from(friendUsernames));
        
        // Update count
        if (friendsCount) {
            friendsCount.textContent = friendUsernames.size;
        }
        
    } catch (error) {
        console.error('Error loading friends list:', error);
        friendsList.innerHTML = '<div class="empty-state">Error loading friends</div>';
    }
}

function displayFriendsList(friendUsernames) {
    const friendsList = document.getElementById('friendsList');
    
    if (!friendUsernames || friendUsernames.length === 0) {
        friendsList.innerHTML = '<div class="empty-state">No friends yet. Start adding some!</div>';
        return;
    }
    
    // For demo purposes - in real app, you'd fetch actual user data
    friendsList.innerHTML = friendUsernames.map(username => {
        // Demo data - replace with actual user data from your database
        const isOnline = Math.random() > 0.3; // Random online status for demo
        const status = isOnline ? ' Online' : ' Offline';
        const statusClass = isOnline ? 'online' : 'offline';
        
        return `
            <div class="friend-item ${statusClass}">
                <div class="friend-info">
                    <div class="friend-avatar">${username.charAt(0).toUpperCase()}</div>
                    <div class="friend-details">
                        <div class="friend-name">${username}</div>
                        <div class="friend-status">${status}</div>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="friend-btn" onclick="viewFriendProfile('${username}')">
                         View
                    </button>
                    <button class="friend-btn remove" onclick="removeFriend('${username}')">
                         Remove
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function initFriendSearch() {
    const searchBtn = document.getElementById('searchFriendsBtn');
    const searchInput = document.getElementById('searchFriends');
    
    if (searchBtn && searchInput) {
        searchBtn.addEventListener('click', performFriendSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performFriendSearch();
            }
        });
    }
}

async function performFriendSearch() {
    const searchInput = document.getElementById('searchFriends');
    const searchResults = document.getElementById('searchFriendsResults');
    
    if (!searchInput || !searchResults) return;
    
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    if (!searchTerm) {
        showQuickStatus('Please enter a username to search!', 'error');
        return;
    }
    
    searchResults.innerHTML = '<div class="empty-state">Searching...</div>';
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Search users (excluding current user and existing friends)
        const { data: users, error } = await supabase
            .from('user_profiles')
            .select('username')
            .ilike('username', `%${searchTerm}%`)
            .neq('username', currentUsername)
            .limit(10);
        
        if (error) {
            throw error;
        }
        
        // Filter out existing friends and pending requests
        const filteredUsers = await filterOutExistingRelationships(users || [], currentUsername);
        
        displaySearchResults(filteredUsers, searchTerm);
        
    } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="empty-state">Search failed</div>';
    }
}

async function filterOutExistingRelationships(users, currentUsername) {
    // Check existing friend requests
    const { data: existingRequests, error } = await supabase
        .from('friend_requests')
        .select('*')
        .or(`from_user.eq.${currentUsername},to_user.eq.${currentUsername}`);
    
    if (error) return users;
    
    const existingUsernames = new Set();
    existingRequests.forEach(request => {
        if (request.from_user === currentUsername) {
            existingUsernames.add(request.to_user);
        } else {
            existingUsernames.add(request.from_user);
        }
    });
    
    return users.filter(user => !existingUsernames.has(user.username));
}

function displaySearchResults(users, searchTerm) {
    const searchResults = document.getElementById('searchFriendsResults');
    
    if (!users || users.length === 0) {
        searchResults.innerHTML = `
            <div class="empty-state">
                No users found matching "${searchTerm}"
            </div>
        `;
        return;
    }
    
    searchResults.innerHTML = users.map(user => `
        <div class="search-result-item">
            <div class="friend-info">
                <div class="friend-avatar">${user.username.charAt(0).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${user.username}</div>
                    <div class="friend-status">Click to send friend request</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-btn accept" onclick="sendFriendRequest('${user.username}')">
                     Add Friend
                </button>
            </div>
        </div>
    `).join('');
}

// Friend request actions
async function acceptFriendRequest(fromUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .update({ status: 'accepted' })
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Accepted friend request from ${fromUsername}!`, 'success');
        loadFriendRequests();
        loadFriendsList();
        
    } catch (error) {
        console.error('Error accepting friend request:', error);
        showQuickStatus('Failed to accept friend request', 'error');
    }
}

async function declineFriendRequest(fromUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Declined friend request from ${fromUsername}`, 'info');
        loadFriendRequests();
        
    } catch (error) {
        console.error('Error declining friend request:', error);
        showQuickStatus('Failed to decline friend request', 'error');
    }
}

async function cancelFriendRequest(toUsername, requestId) {
    try {
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .eq('id', requestId);
        
        if (error) throw error;
        
        showQuickStatus(`Cancelled friend request to ${toUsername}`, 'info');
        loadFriendRequests();
        
    } catch (error) {
        console.error('Error cancelling friend request:', error);
        showQuickStatus('Failed to cancel friend request', 'error');
    }
}

async function removeFriend(username) {
    if (!confirm(`Are you sure you want to remove ${username} from your friends?`)) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
        
        // Delete the friend relationship
        const { error } = await supabase
            .from('friend_requests')
            .delete()
            .or(`and(from_user.eq.${currentUsername},to_user.eq.${username}),and(from_user.eq.${username},to_user.eq.${currentUsername})`);
        
        if (error) throw error;
        
        showQuickStatus(`Removed ${username} from friends`, 'info');
        loadFriendsList();
        
    } catch (error) {
        console.error('Error removing friend:', error);
        showQuickStatus('Failed to remove friend', 'error');
    }
}

function viewFriendProfile(username) {
    showQuickStatus(`Opening ${username}'s profile...`, 'info');
    // You can implement profile viewing here
    // For now, just show a message
    setTimeout(() => {
        showQuickStatus(`Profile viewing feature coming soon for ${username}!`, 'info');
    }, 1000);
}

// Enhanced sendFriendRequest function (update the existing one)
async function sendFriendRequest(targetUsername) {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
        showQuickStatus('Please login to send friend requests!', 'error');
        return;
    }
    
    const fromUsername = user.user_metadata?.username || user.email.split('@')[0];
    
    if (fromUsername === targetUsername) {
        showQuickStatus('You cannot add yourself as a friend!', 'error');
        return;
    }
    
    try {
        // Check if request already exists in either direction - FIXED QUERY
        const { data: existingRequests, error: checkError } = await supabase
            .from('friend_requests')
            .select('*')
            .or(`from_user.eq.${fromUsername},to_user.eq.${fromUsername}`);
        
        if (checkError) throw checkError;
        
        // Check for existing relationship with this specific user
        const existingRelationship = existingRequests?.find(request => 
            (request.from_user === fromUsername && request.to_user === targetUsername) ||
            (request.from_user === targetUsername && request.to_user === fromUsername)
        );
        
        if (existingRelationship) {
            if (existingRelationship.status === 'pending') {
                showQuickStatus('Friend request already exists!', 'info');
                return;
            }
            if (existingRelationship.status === 'accepted') {
                showQuickStatus('You are already friends!', 'info');
                return;
            }
        }
        
        // Send new request
        const { data, error } = await supabase
            .from('friend_requests')
            .insert([{
                from_user: fromUsername,
                to_user: targetUsername,
                status: 'pending',
                created_at: new Date().toISOString()
            }]);
        
        if (error) {
            if (error.code === '23505') { // Unique constraint violation
                showQuickStatus('Friend request already sent!', 'info');
            } else {
                throw error;
            }
        } else {
            showQuickStatus(`Friend request sent to ${targetUsername}!`, 'success');
            // Reload the sent requests tab
            loadFriendRequests();
            // Update the add friend button state
            updateAddFriendButtonState();
        }
        
    } catch (error) {
        console.error('Failed to send friend request:', error);
        showQuickStatus('Failed to send friend request!', 'error');
    }
}
  /* ---------- CLICKABLE PLAYER PROFILES SYSTEM ---------- */
function initClickablePlayerProfiles() {
    console.log(' Initializing clickable player profiles...');
    
    // Make all existing player elements clickable
    makeExistingPlayersClickable();
    
    // Set up observer for dynamically added player elements
    setupPlayerObserver();
    
    // Add click handlers to search results and friends list
    addClickHandlersToContainers();
    
    // Add CSS styles
    addClickablePlayerStyles();
}

function makeExistingPlayersClickable() {
    // Make search result items clickable
    document.querySelectorAll('.search-result-item').forEach(item => {
        makePlayerElementClickable(item);
    });
    
    // Make friend items clickable
    document.querySelectorAll('.friend-item').forEach(item => {
        makePlayerElementClickable(item);
    });
    
    // Make friend request items clickable
    document.querySelectorAll('.friend-request-item').forEach(item => {
        makePlayerElementClickable(item);
    });
    
    // Make online users clickable
    document.querySelectorAll('.online-user').forEach(item => {
        makePlayerElementClickable(item);
    });
    
    // Make user cards clickable
    document.querySelectorAll('.user-card').forEach(item => {
        makePlayerElementClickable(item);
    });
    
    console.log(' Made existing player elements clickable');
}

function makePlayerElementClickable(element) {
    // Add cursor pointer and hover effects
    element.style.cursor = 'pointer';
    element.classList.add('clickable-player');
    
    // Extract username from the element
    const usernameElement = element.querySelector('.friend-name, .message-username, .wall-post-author');
    let username = '';
    
    if (usernameElement) {
        username = usernameElement.textContent.trim();
    } else {
        // Try to extract from text content or data attributes
        const text = element.textContent || '';
        const match = text.match(/(\w+)/);
        if (match) username = match[1];
        
        // Check data attributes
        if (!username && element.dataset.username) {
            username = element.dataset.username;
        }
    }
    
    if (username) {
        element.dataset.username = username;
        element.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons
            if (!e.target.closest('.friend-actions') && 
                !e.target.closest('.friend-btn') &&
                !e.target.closest('.message-time') &&
                !e.target.closest('button') &&
                !e.target.closest('a')) {
                e.preventDefault();
                e.stopPropagation();
                viewPlayerProfile(username);
            }
        });
    }
}

function setupPlayerObserver() {
    // Watch for new player elements being added to the DOM
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    // Check if it's a player element or contains player elements
                    if (node.classList && (
                        node.classList.contains('search-result-item') ||
                        node.classList.contains('friend-item') ||
                        node.classList.contains('friend-request-item') ||
                        node.classList.contains('online-user') ||
                        node.classList.contains('user-card')
                    )) {
                        makePlayerElementClickable(node);
                    }
                    
                    // Check children for player elements
                    if (node.querySelectorAll) {
                        node.querySelectorAll('.search-result-item, .friend-item, .friend-request-item, .online-user, .user-card').forEach(makePlayerElementClickable);
                    }
                }
            });
        });
    });
    
    // Start observing
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}

function addClickHandlersToContainers() {
    // Add to search results container
    const searchResults = document.getElementById('playerSearchResults');
    if (searchResults) {
        searchResults.addEventListener('click', function(e) {
            const playerElement = e.target.closest('.search-result-item, .user-card');
            if (playerElement && playerElement.dataset.username) {
                e.preventDefault();
                e.stopPropagation();
                viewPlayerProfile(playerElement.dataset.username);
            }
        });
    }
    
    // Add to friends list container
    const friendsList = document.getElementById('friendsList');
    if (friendsList) {
        friendsList.addEventListener('click', function(e) {
            const playerElement = e.target.closest('.friend-item');
            if (playerElement && playerElement.dataset.username) {
                e.preventDefault();
                e.stopPropagation();
                viewPlayerProfile(playerElement.dataset.username);
            }
        });
    }
    
    // Add to friend requests container
    const requestsList = document.getElementById('receivedRequestsList');
    if (requestsList) {
        requestsList.addEventListener('click', function(e) {
            const playerElement = e.target.closest('.friend-request-item');
            if (playerElement && playerElement.dataset.username) {
                e.preventDefault();
                e.stopPropagation();
                viewPlayerProfile(playerElement.dataset.username);
            }
        });
    }
}

function viewPlayerProfile(username) {
    console.log(' Opening profile for:', username);
    
    // Close any open modals first
    const socialModal = document.getElementById('socialHubModal');
    if (socialModal) {
        socialModal.style.display = 'none';
    }
    
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.style.display = 'none';
    }
    
    // Show the profile page
    showProfilePage(username);
    
    // Show success message
    showQuickStatus(`Opening ${username}'s profile...`, 'success');
}

// Add CSS for clickable players
function addClickablePlayerStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .clickable-player {
            transition: all 0.2s ease;
        }
        
        .clickable-player:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
            border-color: #00ffff !important;
        }
        
        .friend-name, .message-username, .wall-post-author {
            color: #00ffff;
            font-weight: bold;
        }
        
        .clickable-player .friend-name:hover,
        .clickable-player .message-username:hover,
        .clickable-player .wall-post-author:hover {
            color: #ff33cc;
            text-decoration: underline;
        }
        /* Matchmaking Dashboard Styles */
.matchmaking-dashboard .stat-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.matchmaking-dashboard .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
}

.dashboard-panel {
    transition: all 0.3s ease;
}

.dashboard-panel:hover {
    border-color: rgba(0, 255, 255, 0.4) !important;
}

.active-game-item, .leaderboard-item, .popular-game-item {
    transition: all 0.2s ease;
}

.active-game-item:hover, .leaderboard-item:hover, .popular-game-item:hover {
    transform: translateX(5px);
    border-color: rgba(0, 255, 255, 0.6) !important;
}
    `;
    document.head.appendChild(style);
}

/* ---------- NEW: PROFILE ROUTE SYSTEM ---------- */
function initProfileRouteSystem() {
    console.log(' Initializing profile route system...');
    
    // Back to main button
    const backToMainBtn = document.getElementById('backToMain');
    if (backToMainBtn) {
        backToMainBtn.addEventListener('click', function() {
            showMainSite();
        });
    }
    
    // Profile navigation
    const profileNavBtns = document.querySelectorAll('.profile-nav-btn');
    profileNavBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            
            // Update active nav button
            profileNavBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show selected section
            document.querySelectorAll('.profile-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');
        });
    });
    
    // Profile actions
    const addFriendBtn = document.getElementById('profilePageAddFriend');
    if (addFriendBtn) {
        addFriendBtn.addEventListener('click', function() {
            showQuickStatus('Friend request sent!', 'success');
        });
    }
    
    const sendMessageBtn = document.getElementById('profilePageSendMessage');
    if (sendMessageBtn) {
        sendMessageBtn.addEventListener('click', function() {
            showQuickStatus('Message feature coming soon!', 'info');
        });
    }
    
    const viewInHubBtn = document.getElementById('profilePageViewInHub');
    if (viewInHubBtn) {
        viewInHubBtn.addEventListener('click', function() {
            document.getElementById('socialHubModal').style.display = 'flex';
        });
    }
    
    const shareProfileBtn = document.getElementById('profilePageShare');
    if (shareProfileBtn) {
        shareProfileBtn.addEventListener('click', function() {
            const profileUrl = window.location.href.split('?')[0] + '?profile=' + document.getElementById('profilePageUsername').textContent;
            navigator.clipboard.writeText(profileUrl).then(() => {
                showQuickStatus('Profile URL copied to clipboard!', 'success');
            });
        });
    }
    
    // Profile comment system
    const postCommentBtn = document.getElementById('postProfileComment');
    if (postCommentBtn) {
        postCommentBtn.addEventListener('click', postProfileComment);
    }
    
    // Load profile data when route is active
    loadProfilePageData();
    initProfilePageMusicSystem();
    initProfilePageBackgroundSystem();
}

function showProfilePage(username = null) {
    console.log(' Showing profile page for:', username);
    
    // Hide main site, show profile route
    const mainSite = document.getElementById('mainSiteContent');
    const profileRoute = document.getElementById('profileRouteContainer');
    
    if (mainSite) mainSite.style.display = 'none';
    if (profileRoute) {
        profileRoute.classList.add('active');
        profileRoute.style.display = 'block';
    }
    
    // Update URL hash without page reload
    if (username && username !== 'Guest') {
        window.location.hash = `/user/${encodeURIComponent(username)}`;
    }
    
    // Load profile data
    loadProfilePageData(username);
    
    // Update share button
    updateShareProfileButton();
}

function showMainSite() {
    console.log(' Showing main site');
    
    // Hide profile route, show main site
    const profileRoute = document.getElementById('profileRouteContainer');
    const mainSite = document.getElementById('mainSiteContent');
    
    if (profileRoute) {
        profileRoute.classList.remove('active');
        profileRoute.style.display = 'none';
    }
    if (mainSite) mainSite.style.display = 'block';
    
    // Update URL to main site (clear hash)
    window.location.hash = '';
}

async function loadProfilePageData(username = null) {
    console.log(' Loading profile page data for:', username);
    
    // If no username specified, load current user's profile
    if (!username) {
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (user) {
                username = user.user_metadata?.username || user.email.split('@')[0];
                loadUserProfileData(username, true);
            }
        });
    } else {
        // Load specified user's profile
        loadUserProfileData(username, false);
    }
}

async function loadUserProfileData(username, isOwnProfile = false) {
    console.log(' Loading user profile data:', username, 'isOwn:', isOwnProfile);
    
    // Auto-detect if it's the current user's profile
    if (!isOwnProfile) {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const currentUsername = user.user_metadata?.username || user.email.split('@')[0];
            isOwnProfile = (username === currentUsername);
            console.log(' Auto-detected profile ownership:', isOwnProfile);
        }
    }

    try {
        // Try to load from Supabase first
        const { data: profileData, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('username', username)
            .single();

        if (error) {
            console.log(' Profile not found in Supabase, using demo data');
            loadDemoProfileData(username, isOwnProfile);
            return;
        }

        console.log(' Profile loaded from Supabase:', profileData);
        
        // Update profile page with loaded data
        updateProfilePageDisplay(profileData, isOwnProfile);
        
    } catch (err) {
        console.error('Error loading profile data:', err);
        loadDemoProfileData(username, isOwnProfile);
    }
}

function loadDemoProfileData(username, isOwnProfile) {
    console.log(' Loading demo profile data for:', username);
    
    // Create demo profile data for testing
    const demoProfile = {
        username: username,
        profile_data: {
            profilePic: null,
            signature: isOwnProfile ? 'Welcome to my retro gaming profile! ' : 'This user loves retro gaming!',
            status: ' Online',
            bio: isOwnProfile ? 
                'I\'ve been gaming since the 90s and love everything retro! My favorite systems are PS2 and PSP. Always looking for new players to game with!' :
                'Retro gaming enthusiast with a passion for classic multiplayer games.',
            favoriteSystems: 'PS2, PSP, PS1',
            gamingSince: '1998',
            topGames: 'Gran Turismo, Resident Evil Outbreak, Tekken 3',
            joinDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days ago
            lastActive: new Date().toISOString(),
            profileViews: Math.floor(Math.random() * 100) + 1,
            friendsCount: Math.floor(Math.random() * 50) + 1
        }
    };
    
    // SAFELY update the display
    updateProfilePageDisplay(demoProfile, isOwnProfile);
}

function updateProfilePageDisplay(profileData, isOwnProfile) {
    console.log(' Updating profile page display:', profileData.username, 'isOwn:', isOwnProfile);
    
    // SAFELY update basic info - only update elements that exist
    const usernameElement = document.getElementById('profilePageUsername');
    const statusElement = document.getElementById('profilePageStatus');
    const signatureElement = document.getElementById('profilePageSignature');
    
    if (usernameElement) usernameElement.textContent = profileData.username;
    if (statusElement) statusElement.textContent = profileData.profile_data?.status || ' Online';
    if (signatureElement) signatureElement.innerHTML = profileData.profile_data?.signature || 'This user hasn\'t set a signature yet.';
    
    // SAFELY update avatar
    const avatarElement = document.getElementById('profilePageAvatar');
    if (avatarElement) {
        if (profileData.profile_data?.profilePic) {
            avatarElement.innerHTML = `<img src="${profileData.profile_data.profilePic}" alt="${profileData.username}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
            const avatarText = document.getElementById('profilePageAvatarText');
            if (avatarText) {
                avatarText.textContent = profileData.username.charAt(0).toUpperCase();
            }
        }
    }
    
    // SAFELY update meta info
    const joinDateElement = document.getElementById('profilePageJoinDate');
    const lastActiveElement = document.getElementById('profilePageLastActive');
    const viewsElement = document.getElementById('profilePageViews');
    const friendsCountElement = document.getElementById('profilePageFriendsCount');
    
    if (joinDateElement) {
        const joinDate = profileData.profile_data?.joinDate ? new Date(profileData.profile_data.joinDate).toLocaleDateString() : 'Recently';
        joinDateElement.textContent = `Joined: ${joinDate}`;
    }
    
    if (lastActiveElement) {
        const lastActive = profileData.profile_data?.lastActive ? 
            (new Date().getTime() - new Date(profileData.profile_data.lastActive).getTime() < 5 * 60 * 1000 ? 'Now' : 
            formatRelativeTime(new Date(profileData.profile_data.lastActive))) : 'Now';
        lastActiveElement.textContent = `Last Active: ${lastActive}`;
    }
    
    // SAFELY update stats
    if (viewsElement) viewsElement.textContent = ` Views: ${profileData.profile_data?.profileViews || 0}`;
    if (friendsCountElement) friendsCountElement.textContent = ` Friends: ${profileData.profile_data?.friendsCount || 0}`;
    
    const friendsCountBadge = document.getElementById('friendsCount');
    if (friendsCountBadge) friendsCountBadge.textContent = profileData.profile_data?.friendsCount || 0;
    
    // SAFELY update bio section - only if elements exist
    const bioElement = document.getElementById('profilePageBio');
    if (bioElement) {
        if (profileData.profile_data?.bio) {
            bioElement.textContent = profileData.profile_data.bio;
            bioElement.classList.remove('empty');
        } else {
            bioElement.textContent = 'This user hasn\'t written a bio yet.';
            bioElement.classList.add('empty');
        }
    }
    
    // SAFELY update bio stats - only if elements exist
    const favoriteSystemsElement = document.getElementById('profileFavoriteSystems');
    const gamingSinceElement = document.getElementById('profileGamingSince');
    const topGamesElement = document.getElementById('profileTopGames');
    
    if (favoriteSystemsElement) favoriteSystemsElement.textContent = profileData.profile_data?.favoriteSystems || 'Not set';
    if (gamingSinceElement) gamingSinceElement.textContent = profileData.profile_data?.gamingSince || 'Not set';
    if (topGamesElement) topGamesElement.textContent = profileData.profile_data?.topGames || 'Not set';
    
    // SAFELY update visitor stats - only if elements exist
    const visitorsTodayElement = document.getElementById('visitorsToday');
    const visitorsWeekElement = document.getElementById('visitorsWeek');
    const visitorsTotalElement = document.getElementById('visitorsTotal');
    
    if (visitorsTodayElement && visitorsWeekElement && visitorsTotalElement) {
        const visitorsToday = Math.floor((profileData.profile_data?.profileViews || 0) * 0.1);
        const visitorsWeek = Math.floor((profileData.profile_data?.profileViews || 0) * 0.3);
        visitorsTodayElement.textContent = visitorsToday;
        visitorsWeekElement.textContent = visitorsWeek;
        visitorsTotalElement.textContent = profileData.profile_data?.profileViews || 0;
    }
    
    // Update friend list (demo data) - only if element exists
    const friendsListElement = document.getElementById('profilePageFriendsList');
    if (friendsListElement) {
        updateFriendList(profileData.username);
    }
    
    // Update recent activity (demo data) - only if element exists
    const activityListElement = document.getElementById('recentActivityList');
    if (activityListElement) {
        updateRecentActivity(profileData.username);
    }
    
    // Load wall posts for this user - only if element exists
    const wallPostsElement = document.getElementById('profilePageWallPosts');
    if (wallPostsElement) {
        loadWallPostsForUsername(profileData.username, wallPostsElement);
    }
    
    // Update action buttons based on ownership
    updateProfileActions(isOwnProfile);
    
    // Update friend button state if viewing another user's profile
    if (!isOwnProfile) {
        updateAddFriendButtonState();
    }
   // Load the viewed user's music for profile page
    if (!isOwnProfile && profileData.profile_data?.music) {
        window.profilePageMusic = profileData.profile_data.music;
        updateProfilePageMusicPreview(profileData.profile_data.music);
    } else {
        window.profilePageMusic = null;
        updateProfilePageMusicPreview(null);
    }
    
    // Hide customization sections when viewing other profiles
    const customizationSections = document.querySelectorAll('.profile-customization, .profile-background-section, .profile-music-section');
    if (!isOwnProfile && customizationSections) {
        customizationSections.forEach(section => {
            section.style.display = 'none';
        });
    }
    
    console.log(' Profile page display updated successfully');
}

function updateFriendList(username) {
    const friendsList = document.getElementById('profilePageFriendsList');
    
    // Demo friend data
    const demoFriends = [
        { username: 'RetroGamer88', status: ' Gaming' },
        { username: 'PixelMaster', status: ' Online' },
        { username: 'ArcadeKing', status: ' Chilling' },
        { username: 'GameCollector', status: ' Looking to Play' }
    ];
    
    friendsList.innerHTML = '';
    
    if (demoFriends.length === 0) {
        friendsList.innerHTML = '<div style="text-align: center; color: #a8dfe8; padding: 20px;">No friends yet. Start adding some!</div>';
        return;
    }
    
    demoFriends.forEach(friend => {
        const friendItem = document.createElement('div');
        friendItem.className = 'friend-item-mini';
        friendItem.innerHTML = `
            <div class="friend-avatar-mini">
                ${friend.username.charAt(0).toUpperCase()}
            </div>
            <div style="flex: 1;">
                <div style="color: #00ffff; font-weight: bold; font-size: 0.9rem;">${friend.username}</div>
                <div style="color: #a8dfe8; font-size: 0.7rem;">${friend.status}</div>
            </div>
        `;
        friendsList.appendChild(friendItem);
    });
}

function updateRecentActivity(username) {
    const activityList = document.getElementById('recentActivityList');
    
    // Demo activity data
    const demoActivities = [
        { action: ' Played Gran Turismo PSP', time: '2 hours ago' },
        { action: ' Posted on RetroGamer88\'s wall', time: '5 hours ago' },
        { action: ' Favorited PS2 connection method', time: '1 day ago' },
        { action: ' Added PixelMaster as friend', time: '2 days ago' }
    ];
    
    activityList.innerHTML = '';
    
    demoActivities.forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.style.cssText = 'color: #a8dfe8; font-size: 0.8rem; padding: 8px 0; border-bottom: 1px solid rgba(0,255,255,0.1);';
        activityItem.innerHTML = `
            <div>${activity.action}</div>
            <div style="color: #668899; font-size: 0.7rem;">${activity.time}</div>
        `;
        activityList.appendChild(activityItem);
    });
}

function updateProfileActions(isOwnProfile) {
    const addFriendBtn = document.getElementById('profilePageAddFriend');
    const sendMessageBtn = document.getElementById('profilePageSendMessage');
    const editBioBtn = document.getElementById('profilePageEditBio');
    
    console.log(' Updating profile actions, isOwnProfile:', isOwnProfile);
    
    if (isOwnProfile) {
        // Hide friend actions, show edit actions for own profile
        if (addFriendBtn) addFriendBtn.style.display = 'none';
        if (sendMessageBtn) sendMessageBtn.style.display = 'none';
        if (editBioBtn) editBioBtn.style.display = 'block';
    } else {
        // Show friend actions, hide edit actions for other profiles
        if (addFriendBtn) addFriendBtn.style.display = 'block';
        if (sendMessageBtn) sendMessageBtn.style.display = 'block';
        if (editBioBtn) editBioBtn.style.display = 'none';
        
        // Update add friend button text if already friends or request sent
        updateAddFriendButtonState();
    }
}

function postProfileComment() {
    const commentText = document.getElementById('profileCommentText').value.trim();
    
    if (!commentText) return;
    
    supabase.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
            showQuickStatus('Please login to comment!', 'error');
            return;
        }
        
        const profileUsername = document.getElementById('profilePageUsername').textContent;
        const comment = {
            id: Date.now().toString(),
            author: user.user_metadata?.username || user.email.split('@')[0],
            targetUser: profileUsername,
            content: commentText,
            timestamp: new Date().toISOString()
        };
        
        // Save comment to localStorage (would be Supabase in production)
        const comments = JSON.parse(localStorage.getItem('rom-profile-comments') || '[]');
        comments.unshift(comment);
        localStorage.setItem('rom-profile-comments', JSON.stringify(comments));
        
        appendProfileComment(comment);
        document.getElementById('profileCommentText').value = '';
        showQuickStatus('Comment posted!', 'success');
    });
}

function appendProfileComment(comment) {
    const commentsList = document.getElementById('profileCommentsList');
    
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment-item';
    
    const time = new Date(comment.timestamp).toLocaleString();
    
    commentDiv.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${comment.author}</span>
            <span class="comment-time">${time}</span>
        </div>
        <div class="comment-content">${escapeHtml(comment.content)}</div>
    `;
    
    // Remove "no comments" message if it exists
    const noCommentsMsg = commentsList.querySelector('div');
    if (noCommentsMsg && noCommentsMsg.style.textAlign === 'center') {
        noCommentsMsg.remove();
    }
    
    commentsList.appendChild(commentDiv);
}

function formatRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

/* ---------- FIXED URL ROUTING SYSTEM ---------- */
function initURLRouting() {
    console.log(' Initializing URL routing...');
    
    function handleRoute() {
        const hash = window.location.hash;
        const searchParams = new URLSearchParams(window.location.search);
        
        console.log(' Current route:', { hash, search: window.location.search });
        
        // Handle profile routes via hash: #/user/username
        if (hash.startsWith('#/user/')) {
            const username = hash.replace('#/user/', '').split('/')[0];
            console.log(' Profile route detected via hash, username:', username);
            
            if (username) {
                showProfilePage(username);
                return;
            }
        }
        
        // Handle profile parameter: ?profile=username
        const profileParam = searchParams.get('profile');
        if (profileParam) {
            console.log(' Profile route detected via parameter, username:', profileParam);
            showProfilePage(profileParam);
            return;
        }
        
        // Handle main site
        if (!hash || hash === '#/' || hash === '') {
            showMainSite();
            return;
        }
        
        // Default: show main site
        showMainSite();
    }
    
    // Initial route handling
    handleRoute();
    
    // Handle browser back/forward buttons and hash changes
    window.addEventListener('popstate', handleRoute);
    window.addEventListener('hashchange', handleRoute);
    
    // Override internal link clicks to use hash routing
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href*="/user/"]');
        if (link && link.href) {
            const url = new URL(link.href);
            
            // Only handle same-origin links
            if (url.origin === window.location.origin) {
                // Handle profile links - convert to hash routing
                if (url.pathname.startsWith('/user/')) {
                    e.preventDefault();
                    const username = url.pathname.replace('/user/', '');
                    window.location.hash = `/user/${username}`;
                    return;
                }
            }
        }
    });
}

/* ---------- ENHANCED PROFILE URL GENERATION ---------- */
function getProfileUrl(username) {
    // Use hash-based routing to avoid 404s: #/user/username
    return `#/user/${encodeURIComponent(username)}`;
}

function shareProfile(username) {
    const profileUrl = window.location.origin + window.location.pathname + getProfileUrl(username);
    navigator.clipboard.writeText(profileUrl).then(() => {
        showQuickStatus('Profile URL copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback method
        const tempInput = document.createElement('input');
        tempInput.value = profileUrl;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showQuickStatus('Profile URL copied to clipboard!', 'success');
    });
}

// Update the existing shareProfileBtn event listener
function updateShareProfileButton() {
    const shareProfileBtn = document.getElementById('profilePageShare');
    if (shareProfileBtn) {
        // Remove any existing event listeners
        shareProfileBtn.replaceWith(shareProfileBtn.cloneNode(true));
        
        // Get the new element
        const newShareBtn = document.getElementById('profilePageShare');
        newShareBtn.addEventListener('click', function() {
            const username = document.getElementById('profilePageUsername').textContent;
            shareProfile(username);
        });
    }
}
  /* ---------- PROFILE BACK BUTTON HANDLER ---------- */
function initProfileBackButton() {
    const backBtn = document.getElementById('backToMain');
    if (backBtn) {
        console.log(' Initializing profile back button');
        // Remove any existing event listeners by cloning
        backBtn.replaceWith(backBtn.cloneNode(true));
        
        // Get the new element
        const newBackBtn = document.getElementById('backToMain');
        newBackBtn.addEventListener('click', function() {
            console.log(' Back to main clicked');
            showMainSite();
        });
    } else {
        console.log(' Back button not found');
    }
}
 /* ---------- WORKING SALTY BET INTEGRATION ---------- */
function initWorkingSaltyBet() {
    console.log(' Initializing Working Salty Bet integration...');
    
    // Load Twitch embed
    loadTwitchEmbed();
    
    // Initialize embedded version toggle
    initEmbeddedToggle();
}

function loadTwitchEmbed() {
    // Only load on desktop
    if (window.innerWidth < 768) {
        document.getElementById('twitch-embed').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #a8dfe8; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                <h3 style="color: #00ffff;">Salty Bet Live Stream</h3>
                <p>For best experience on mobile, open directly:</p>
                <a href="https://www.twitch.tv/saltybet" target="_blank" class="button" style="background: linear-gradient(180deg, #9146ff, #6441a5); margin: 10px auto; display: inline-block;">Watch on Twitch</a>
            </div>
        `;
        return;
    }
    
    // Load Twitch Embed Script
    const script = document.createElement('script');
    script.src = 'https://embed.twitch.tv/embed/v1.js';
    script.onload = function() {
        try {
            new Twitch.Embed('twitch-embed', {
                width: '100%',
                height: '400',
                channel: 'saltybet',
                layout: 'video',
                autoplay: false,
                muted: true,
                parent: ['localhost', 'retroonlinematchmaking.com'] // Update with your domain
            });
            console.log(' Twitch embed loaded');
        } catch (error) {
            showFallbackStream();
        }
    };
    script.onerror = showFallbackStream;
    document.head.appendChild(script);
}

function showFallbackStream() {
    document.getElementById('twitch-embed').innerHTML = `
        <div style="padding: 40px; text-align: center; color: #a8dfe8; height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <div style="font-size: 3rem; margin-bottom: 20px;"></div>
            <h3 style="color: #00ffff;">Salty Bet Live Stream</h3>
            <p>Watch the live stream directly on Twitch:</p>
            <a href="https://www.twitch.tv/saltybet" target="_blank" class="button" style="background: linear-gradient(180deg, #9146ff, #6441a5); margin: 10px auto; display: inline-block;">Watch on Twitch</a>
        </div>
    `;
}

function initEmbeddedToggle() {
    const showEmbeddedBtn = document.getElementById('showEmbedded');
    
    if (showEmbeddedBtn) {
        showEmbeddedBtn.addEventListener('click', function() {
            const loginPanel = document.querySelector('.betting-panel > div:first-child');
            const embeddedPanel = document.getElementById('embeddedSaltyBet');
            
            if (loginPanel && embeddedPanel) {
                loginPanel.style.display = 'none';
                embeddedPanel.style.display = 'block';
                this.textContent = ' Back to Instructions';
                this.style.background = 'rgba(255, 51, 102, 0.1)';
                this.style.borderColor = '#ff3366';
                this.style.color = '#ff3366';
                
                showQuickStatus(' Embedded version may have login issues due to browser security', 'info');
            }
        });
    }
    
    // Check if user has visited Salty Bet before
    const hasVisited = localStorage.getItem('saltyBetHelpShown');
    
    if (!hasVisited) {
        // Show helpful tip first time
        setTimeout(() => {
            showQuickStatus(' Click "Login to Salty Bet" to start betting while watching the stream here!', 'info');
            localStorage.setItem('saltyBetHelpShown', 'true');
        }, 3000);
    }
}
    
/* ---------- Splash + progress ---------- */
window.addEventListener('load', function onLoad() {
    window.removeEventListener('load', onLoad);
    const splash = document.getElementById('splash');
    const main = document.getElementById('mainContent');
    const progressBar = document.getElementById('progressBar');
    const bootText = document.getElementById('bootText');
    const splashTitle = document.getElementById('splashTitle');
    let progress = 0;
    const messages = [
        "Checking Arcade Servers...",
        "Loading Multiplayer Modules...",
        "Initializing Retro Systems...",
        "Syncing Online Players...",
        "Bringing Up Lobbies..."
    ];
    let idx = 0;
    const interval = setInterval(() => {
        progress += Math.ceil(Math.random()*3);
        if (progress > 100) progress = 100;
        if (progressBar) progressBar.style.width = progress + '%';
        if (progress >= (idx+1)*20 && idx < messages.length) {
            if (bootText) bootText.textContent = messages[idx++];
        }
        if(progress >= 60 && splashTitle && !splashTitle.dataset.switched){
            splashTitle.dataset.switched = '1';
            splashTitle.textContent = "CHECKING CONNECTION...";
        }
        if (progress >= 100) {
            clearInterval(interval);
            if (bootText) bootText.textContent = "ONLINE!";
            setTimeout(() => {
                splash.classList.add('fade');
                setTimeout(()=> {
                    try { splash.remove(); } catch(e){ splash.style.display='none'; }
                    if (main) { main.style.display = 'block'; main.setAttribute('aria-hidden', 'false'); }
                    initAllSystems();
                }, 480);
            }, 420);
        }
    }, 70);
});

/* ---------- NEW: Engagement Features ---------- */
function initEngagementFeatures() {
    // Track user interactions for engagement metrics
    let interactionCount = 0;
    const engagementThreshold = 5;
    
    // Track interactions
    document.addEventListener('click', function() {
        interactionCount++;
        
        // Show engagement message after threshold
        if (interactionCount === engagementThreshold) {
            showQuickStatus(' Active user detected! Thanks for exploring!', 'success');
        }
    });
    
    // Auto-expand first section after delay
    setTimeout(() => {
        const firstCollapsible = document.querySelector('.collapsible');
        if (firstCollapsible && !firstCollapsible.classList.contains('active')) {
            firstCollapsible.click();
        }
    }, 3000);
    
    // Show random tip every 2 minutes
    setInterval(showRandomTip, 120000);
}

function showRandomTip() {
    const tips = [
        " Pro Tip: Use the search bar to quickly find specific games!",
        " Did you know? You can favorite connection methods for quick access!",
        " Join our Discord to find players for your favorite games!",
        " Check out the Social Hub to chat with other retro gamers!",
        " Having issues? Check the video guides linked in each method!"
    ];
    
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    showQuickStatus(randomTip, 'info');
}

/* ---------- Music Player - YOUTUBE RADIO STATION ---------- */
function initMusicPlayer() {
    const playPauseBtn = document.getElementById('playPause');
    const prevTrackBtn = document.getElementById('prevTrack');
    const nextTrackBtn = document.getElementById('nextTrack');
    const trackInfo = document.getElementById('trackInfo');
    
    let isPlaying = false;
    let currentTrack = 0;
    let youtubePlayer = null;
    let userInteracted = false;

    // Ad-free YouTube music streams and playlists
    const musicTracks = [
        {
            id: 'y909GFK2n_c', // Video Game Soundtracks 24/7
            name: ' Video Game OST Radio'
        },
        {
            id: 'jfKfPfyJRdk', // Lofi Girl backup
            name: ' Chill Lofi Beats'
        },
        {
            id: '4xDzrJKXOOY', // Synthwave Radio
            name: ' Synthwave Retro Radio'
        },
        {
            id: 'N2UYLx5BGI4', // Final Fantasy & RPG Music
            name: ' RPG Music Radio'
        },
        {
            id: '3H6UL3y0K8E', // Pokemon Lofi
            name: ' Pokemon Lofi'
        },
        {
            id: 'rWc0L-NpAzc', // Classic Video Game Music
            name: ' Classic Game Music'
        }
    ];

    function loadYouTubeAPI() {
        // Load YouTube IFrame API if not already loaded
        if (!window.YT) {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
    }

    function createYouTubePlayer() {
        if (youtubePlayer) {
            youtubePlayer.destroy();
        }

        // Create invisible YouTube player
        const playerDiv = document.createElement('div');
        playerDiv.id = 'youtube-player';
        playerDiv.style.cssText = 'position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px;';
        document.body.appendChild(playerDiv);

        youtubePlayer = new YT.Player('youtube-player', {
            height: '1',
            width: '1',
            videoId: musicTracks[currentTrack].id,
            playerVars: {
                'autoplay': 0,
                'controls': 0,
                'disablekb': 1,
                'fs': 0,
                'iv_load_policy': 3,
                'modestbranding': 1,
                'playsinline': 1,
                'rel': 0,
                'showinfo': 0
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        console.log(' YouTube Player Ready');
        updateTrackInfo();
    }

    function onPlayerStateChange(event) {
        // Player states: -1=unstarted, 0=ended, 1=playing, 2=paused, 3=buffering, 5=video cued
        if (event.data === YT.PlayerState.ENDED) {
            console.log(' Track ended, playing next');
            nextTrack();
        } else if (event.data === YT.PlayerState.PLAYING) {
            isPlaying = true;
            if (playPauseBtn) playPauseBtn.textContent = '';
            console.log(' Now playing:', musicTracks[currentTrack].name);
            showQuickStatus(`Now playing: ${musicTracks[currentTrack].name}`, 'success');
        } else if (event.data === YT.PlayerState.PAUSED) {
            isPlaying = false;
            if (playPauseBtn) playPauseBtn.textContent = '';
        }
    }

    function onPlayerError(event) {
        console.log(' YouTube error:', event.data);
        showQuickStatus('Stream error, trying next station...', 'error');
        setTimeout(() => nextTrack(), 2000);
    }

    function loadTrack(trackIndex) {
        console.log(' Loading station:', trackIndex + 1, musicTracks[trackIndex].name);
        
        currentTrack = trackIndex;
        
        if (youtubePlayer) {
            youtubePlayer.loadVideoById(musicTracks[trackIndex].id);
        } else {
            createYouTubePlayer();
        }
        
        updateTrackInfo();
    }

    function updateTrackInfo() {
        if (trackInfo) {
            trackInfo.textContent = `${currentTrack + 1}/${musicTracks.length}`;
            trackInfo.title = musicTracks[currentTrack].name;
        }
    }

    function playCurrentTrack() {
        if (!userInteracted) {
            showQuickStatus(' Click anywhere on the page first!', 'info');
            return;
        }
        
        if (!youtubePlayer) {
            loadTrack(currentTrack);
            return;
        }
        
        console.log(' Playing:', musicTracks[currentTrack].name);
        youtubePlayer.playVideo();
    }

    function pauseCurrentTrack() {
        if (youtubePlayer) {
            youtubePlayer.pauseVideo();
            isPlaying = false;
            if (playPauseBtn) playPauseBtn.textContent = '';
            showQuickStatus(' Radio paused', 'info');
        }
    }

    function nextTrack() {
        console.log(' Next station');
        let next = currentTrack + 1;
        if (next >= musicTracks.length) next = 0;
        loadTrack(next);
        
        if (isPlaying) {
            setTimeout(() => playCurrentTrack(), 1000);
        }
    }

    function prevTrack() {
        console.log(' Previous station');
        let prev = currentTrack - 1;
        if (prev < 0) prev = musicTracks.length - 1;
        loadTrack(prev);
        
        if (isPlaying) {
            setTimeout(() => playCurrentTrack(), 1000);
        }
    }

    // Button event listeners
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', () => {
            console.log(' Play/Pause clicked');
            userInteracted = true;
            if (!isPlaying) {
                playCurrentTrack();
            } else {
                pauseCurrentTrack();
            }
        });
    }

    if (nextTrackBtn) {
        nextTrackBtn.addEventListener('click', () => {
            console.log(' Next button clicked');
            userInteracted = true;
            nextTrack();
        });
    }

    if (prevTrackBtn) {
        prevTrackBtn.addEventListener('click', () => {
            console.log(' Previous button clicked');
            userInteracted = true;
            prevTrack();
        });
    }

    // Initialize
    loadYouTubeAPI();
    
    // Wait for YouTube API to load
    window.onYouTubeIframeAPIReady = function() {
        console.log(' YouTube API Ready - Loading first station');
        loadTrack(0);
    };

    // If API takes too long, load directly
    setTimeout(() => {
        if (!youtubePlayer && window.YT) {
            loadTrack(0);
        }
    }, 3000);

    console.log(' YouTube Radio initialized with', musicTracks.length, 'stations');
    
    // Enable on any click
    document.addEventListener('click', () => {
        console.log(' User interacted');
        userInteracted = true;
    }, { once: true });
}

/* ---------- Sound Effects - FIXED VERSION ---------- */
function initSoundEffects() {
    let soundsEnabled = false;

    // Create a single function to play any sound
    function playSound(type) {
        if (!soundsEnabled) return;
        
        let url, volume;
        
        switch(type) {
            case 'click':
                url = 'https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3';
                volume = 0.3;
                break;
            case 'hover':
                url = 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3';
                volume = 0.2;
                break;
            case 'expand':
                url = 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-changing-tab-206.mp3';
                volume = 0.25;
                break;
            default:
                return;
        }
        
        // Create fresh audio element every time
        const audio = new Audio();
        audio.src = url;
        audio.volume = volume;
        
        // Play and ignore any errors
        audio.play().catch(() => {});
    }

    // Enable sounds on ANY user interaction
    function enableAllSounds() {
        if (soundsEnabled) return;
        soundsEnabled = true;
        console.log('Sounds enabled!');
    }

    // Listen for ANY user interaction
    document.addEventListener('click', enableAllSounds, { once: true });
    document.addEventListener('keydown', enableAllSounds, { once: true });
    document.addEventListener('touchstart', enableAllSounds, { once: true });
    document.addEventListener('mousedown', enableAllSounds, { once: true });

    // Apply to ALL interactive elements
    const allInteractiveElements = document.querySelectorAll(
        'button, .button, .collapsible, .theme-btn, .copy-btn, .music-btn, a, input, textarea'
    );

    allInteractiveElements.forEach(element => {
        // Click sounds
        element.addEventListener('click', (e) => {
            e.stopPropagation();
            playSound('click');
        });
        
        // Hover sounds
        element.addEventListener('mouseenter', () => {
            playSound('hover');
        });
    });

    // Special handling for collapsibles
    document.querySelectorAll('.collapsible').forEach(collapsible => {
        collapsible.addEventListener('click', function() {
            setTimeout(() => {
                if (this.classList.contains('active')) {
                    playSound('expand');
                }
            }, 150);
        });
    });

    // Force enable after 2 seconds as fallback
    setTimeout(enableAllSounds, 2000);
}

/* ---------- Live Clock ---------- */
function initLiveClock() {
    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').textContent = 
            now.toLocaleTimeString([], {hour12: false});
    }
    setInterval(updateClock, 1000);
    updateClock();
}

/* ---------- Typing Effect ---------- */
function initTypingEffect() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    let typingTimer;
    searchInput.addEventListener('input', function() {
        const searchTerm = (this.value || '').toLowerCase().trim();
        
        if (searchTerm.length > 0) {
            searchResults.style.color = '#ffff00';
            searchResults.textContent = 'Searching...';
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                // Existing search logic will handle the actual search
            }, 500);
        }
    });
}

/* ---------- Quick Status Notifications ---------- */
function showQuickStatus(message, type = 'info') {
    const status = document.createElement('div');
    status.textContent = message;
    status.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'error' ? 'rgba(255,0,0,0.9)' : 'rgba(0,255,255,0.9)'};
        color: #000;
        padding: 10px 20px;
        border-radius: 20px;
        z-index: 10000;
        font-weight: bold;
        animation: slideUp 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid #00ffff;
    `;
    
    document.body.appendChild(status);
    
    setTimeout(() => {
        status.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (status.parentNode) {
                status.parentNode.removeChild(status);
            }
        }, 300);
    }, 3000);
}

/* ---------- Enhanced Player Count Animation ---------- */
function animatePlayerCount(newCount, element) {
    const current = parseInt(element.textContent);
    const diff = newCount - current;
    const steps = 10;
    const step = diff / steps;
    
    let currentStep = 0;
    const timer = setInterval(() => {
        currentStep++;
        element.textContent = Math.round(current + (step * currentStep));
        
        if (currentStep >= steps) {
            element.textContent = newCount;
            clearInterval(timer);
        }
    }, 50);
}

/* ---------- Enhanced Easter Eggs ---------- */
function initEasterEggs() {
    const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
    let konamiIndex = 0;
    
    const secretCodes = {
        'iddqd': () => showSecretMessage("GOD MODE ACTIVATED! \nInvincibility enabled!"),
        'rosebud': () => showSecretMessage(" INFINITE MONEY! \nSims reference detected!"),
        'updownleftrightab': () => {
            showSecretMessage("CONTRA CODE!\n+30 Lives unlocked! ");
            createFlyingSprite('');
            createFlyingSprite('');
        }
    };
    
    let currentCode = '';
    
    document.addEventListener('keydown', (e) => {
        // Konami Code
        if (e.code === konamiCode[konamiIndex]) {
            konamiIndex++;
            if (konamiIndex === konamiCode.length) {
                activateKonamiEgg();
                konamiIndex = 0;
            }
        } else {
            konamiIndex = 0;
        }
        
        // Secret codes
        currentCode += e.key.toLowerCase();
        
        Object.keys(secretCodes).forEach(code => {
            if (currentCode.includes(code)) {
                secretCodes[code]();
                currentCode = '';
            }
        });
        
        // Reset if too long
        if (currentCode.length > 20) currentCode = '';
    });
}

function activateKonamiEgg() {
    console.log('KONAMI CODE ACTIVATED! ');
    
    const victorySound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-1699.mp3');
    victorySound.volume = 0.5;
    victorySound.play().catch(e => console.log('Audio play prevented'));
    
    const sprites = ['', '', '', '', '', '', '', '', '', ''];
    for (let i = 0; i < 25; i++) {
        setTimeout(() => {
            createFlyingSprite(sprites[Math.floor(Math.random() * sprites.length)]);
        }, i * 100);
    }
    
    setTimeout(() => {
        showSecretMessage("+30 LIVES UNLOCKED! \n\nFull power activated!\nRetro mode engaged!");
    }, 500);
    
    const coinSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-coins-2859.mp3');
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            coinSound.currentTime = 0;
            coinSound.volume = 0.3;
            coinSound.play().catch(e => console.log('Audio play prevented'));
        }, i * 200);
    }
}

function createFlyingSprite(sprite) {
    const flyingSprite = document.createElement('div');
    flyingSprite.className = 'flying-sprite';
    flyingSprite.textContent = sprite;
    flyingSprite.style.left = '-100px';
    flyingSprite.style.top = Math.random() * window.innerHeight + 'px';
    flyingSprite.style.setProperty('--random-y', (Math.random() - 0.5) * 2);
    flyingSprite.style.fontSize = (Math.random() * 20 + 20) + 'px';
    
    document.body.appendChild(flyingSprite);
    
    setTimeout(() => {
        if (flyingSprite.parentNode) {
            flyingSprite.parentNode.removeChild(flyingSprite);
        }
    }, 3000);
}

function showSecretMessage(message) {
    const secretMessage = document.createElement('div');
    secretMessage.className = 'secret-message';
    secretMessage.textContent = message;
    
    document.body.appendChild(secretMessage);
    
    setTimeout(() => {
        if (secretMessage.parentNode) {
            secretMessage.parentNode.removeChild(secretMessage);
        }
    }, 5000);
}

/* ---------- Collapsibles ---------- */
function initCollapsibles(){
    const coll = document.querySelectorAll('.collapsible');
    coll.forEach(c=>{
        if(c.dataset.bound) return;
        c.dataset.bound = '1';
        c.addEventListener('click', function(){
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if(!content) return;
            if(content.style.maxHeight){
                content.style.maxHeight = null;
                content.setAttribute('aria-hidden','true');
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.setAttribute('aria-hidden','false');
            }
        });
    });
}

/* ---------- Form controls ---------- */
function initFormControls(){
    const openBtn = document.getElementById('openSubmitBtn');
    const modal = document.getElementById('formModal');
    const closeModal = document.getElementById('closeModal');
    if(openBtn){
        openBtn.addEventListener('click', function(e){
            const url = "https://docs.google.com/forms/d/e/1FAIpQLScm5TrARTAVqajDcivjW5kiGGD5nYQYjI6Wph6U3E3P5-sXLg/viewform";
            window.open(url, '_blank', 'noopener');
        });
    }
    if(closeModal){
        closeModal.addEventListener('click', ()=> modal.style.display='none');
        window.addEventListener('click', (ev)=> { if(ev.target === modal) modal.style.display='none'; });
    }
}

/* ---------- Live Status Bar - UPDATED: Removed Ping ---------- */
function initStatusBar() {
    const playerCount = document.getElementById('playerCount');
    
    if (!playerCount) return;
    
    // Player count is now handled by initLivePlayerCount()
    // This function is kept for compatibility but the ping functionality has been removed
}

/* ---------- Theme Switcher ---------- */
function initThemeSwitcher() {
    const themeButtons = document.querySelectorAll('.theme-btn');
    const body = document.body;
    
    themeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const theme = this.getAttribute('data-theme');
            
            body.className = body.className.replace(/\b\w+-theme\b/g, '');
            
            if (theme !== 'cyberpunk') {
                body.classList.add(theme + '-theme');
            }
            
            themeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            showQuickStatus(`Theme: ${theme.toUpperCase()} activated!`, 'info');
        });
    });
}

/* ---------- Search System ---------- */
function initSearchSystem() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const collapsibles = document.querySelectorAll('.collapsible');
    const cards = document.querySelectorAll('.card');
    
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm.length === 0) {
            resetSearch();
            searchResults.textContent = '';
            return;
        }
        
        let foundResults = false;
        let visibleSections = 0;
        
        collapsibles.forEach(collapsible => {
            const sectionText = collapsible.textContent.toLowerCase();
            const sectionMatches = sectionText.includes(searchTerm);
            
            if (sectionMatches) {
                collapsible.classList.remove('hidden');
                collapsible.innerHTML = collapsible.textContent.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="highlight">${match}</span>`
                );
                const arrow = document.createElement('span');
                arrow.innerHTML = ' &#9654;';
                arrow.style.cssText = 'position:absolute; right:20px; top:50%; transform:translateY(-50%); transition:0.25s;';
                if (collapsible.classList.contains('active')) {
                    arrow.style.transform = 'translateY(-50%) rotate(90deg)';
                }
                collapsible.appendChild(arrow);
                visibleSections++;
                foundResults = true;
            } else {
                collapsible.classList.add('hidden');
            }
        });
        
        cards.forEach(card => {
            const cardText = card.textContent.toLowerCase();
            const cardMatches = cardText.includes(searchTerm);
            
            if (cardMatches) {
                card.classList.remove('hidden');
                const parentSection = card.closest('.content');
                if (parentSection) {
                    const collapsible = parentSection.previousElementSibling;
                    if (collapsible && collapsible.classList.contains('collapsible')) {
                        collapsible.classList.remove('hidden');
                        if (!collapsible.classList.contains('active')) {
                            collapsible.classList.add('active');
                            parentSection.style.maxHeight = parentSection.scrollHeight + 'px';
                            parentSection.setAttribute('aria-hidden', 'false');
                        }
                    }
                }
                foundResults = true;
            } else {
                card.classList.add('hidden');
            }
        });
        
        if (foundResults) {
            searchResults.textContent = `Found ${visibleSections} section(s) matching "${searchTerm}"`;
            searchResults.style.color = '#00ffff';
        } else {
            searchResults.textContent = `No results found for "${searchTerm}"`;
            searchResults.style.color = '#ff3366';
        }
    });
    
    function resetSearch() {
        collapsibles.forEach(collapsible => {
            collapsible.classList.remove('hidden');
            const text = collapsible.textContent.replace(/<\/?span[^>]*>/g, '');
            collapsible.innerHTML = text;
            const arrow = document.createElement('span');
            arrow.innerHTML = ' &#9654;';
            arrow.style.cssText = 'position:absolute; right:20px; top:50%; transform:translateY(-50%); transition:0.25s;';
            if (collapsible.classList.contains('active')) {
                arrow.style.transform = 'translateY(-50%) rotate(90deg)';
            }
            collapsible.appendChild(arrow);
        });
        
        cards.forEach(card => {
            card.classList.remove('hidden');
        });
    }
}

/* ---------- Copy DNS Buttons ---------- */
function initCopyButtons() {
    const copyButtons = document.querySelectorAll('.copy-btn');
    
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-text');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = ' Copied!';
                this.classList.add('copied');
                
                showQuickStatus('DNS copied to clipboard!', 'success');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                fallbackCopyTextToClipboard(textToCopy, this);
            });
        });
    });
    
    function fallbackCopyTextToClipboard(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                const originalText = button.innerHTML;
                button.innerHTML = ' Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }
        } catch (err) {
            console.error('Fallback copy failed: ', err);
            button.innerHTML = ' Failed';
            setTimeout(() => {
                button.innerHTML = ' Copy';
            }, 2000);
        }
        
        document.body.removeChild(textArea);
    }
}

// Message system
function showMessage(text, type = 'info') {
    const message = document.createElement('div');
    message.className = `message ${type}`;
    message.textContent = text;
    message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? 'rgba(255, 51, 102, 0.9)' : type === 'success' ? 'rgba(0, 255, 0, 0.9)' : 'rgba(0, 255, 255, 0.9)'};
        color: #000;
        border-radius: 6px;
        z-index: 10000;
        backdrop-filter: blur(10px);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(message);
    
    setTimeout(() => {
        message.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }, 3000);
}

/* ---------- FIXED Clip of the Week System ---------- */
function initClipOfWeek() {
    console.log(' Initializing Clip of the Week...');
    
    // Load clip data from localStorage or use defaults
    let currentClip = JSON.parse(localStorage.getItem('rom-current-clip'));
    
    if (!currentClip) {
        // Default clip data - USING CORRECT EMBED FORMAT
        currentClip = {
            videoId: '62EPffzEC4s',
            title: 'Street Fighter EX Plus Alpha | PS1 Online Multiplayer | Join Our Discord Community',
            description: 'Check out this amazing retro gaming moment from our community! Want to be featured next? Share your clips in our Discord!',
            author: 'RetroOnlineMatchmaking',
            date: 'Nov 7th',
            game: 'Street Fighter EX Plus Alpha'
        };
        localStorage.setItem('rom-current-clip', JSON.stringify(currentClip));
        console.log(' Created default clip data');
    }
    
    // Update the video embed - FIXED: Proper YouTube embed URL
    const iframe = document.querySelector('.video-container iframe');
    if (iframe && currentClip.videoId) {
        // CORRECTED: Use embed format, not watch format
        iframe.src = `https://www.youtube.com/embed/${currentClip.videoId}?rel=0&modestbranding=1&autoplay=0`;
        console.log(' Updated video embed with ID:', currentClip.videoId);
    } else {
        console.error(' Could not find iframe or videoId');
    }
    
    // Update clip info
    const clipTitle = document.querySelector('.clip-info h3');
    const clipDescription = document.querySelector('.clip-info p');
    const clipDate = document.getElementById('clipDate');
    const clipAuthor = document.getElementById('clipAuthor');
    
    if (clipTitle) clipTitle.textContent = currentClip.title;
    if (clipDescription) clipDescription.textContent = currentClip.description;
    if (clipDate) clipDate.textContent = ' ' + currentClip.date;
    if (clipAuthor) clipAuthor.textContent = ' ' + currentClip.author;
    
    // Enhanced update function for Supabase integration
    window.updateClipOfWeek = function(newClipData) {
        console.log(' Updating Clip of the Week:', newClipData);
        
        const updatedClip = {
            ...currentClip,
            ...newClipData,
            lastUpdated: new Date().toISOString()
        };
        
        // Save to localStorage
        localStorage.setItem('rom-current-clip', JSON.stringify(updatedClip));
        
        // If using Supabase, save there too
        saveClipToSupabase(updatedClip);
        
        // Reload the clip
        initClipOfWeek();
        showQuickStatus(' Clip of the Week updated!', 'success');
        
        console.log(' Clip updated:', updatedClip);
    };
    
    console.log(' Clip of the Week loaded:', currentClip);
}

// Save clip to Supabase (optional - for multi-admin support)
async function saveClipToSupabase(clipData) {
    try {
        const { data, error } = await supabase
            .from('site_content') 
            .upsert({
                id: 'clip_of_the_week',
                content: clipData,
                updated_at: new Date().toISOString()
            });

        if (error) {
            console.error(' Supabase save failed:', error);
        } else {
            console.log(' Clip saved to Supabase');
        }
    } catch (err) {
        console.error(' Supabase error:', err);
    }
}

// Easy console command to update clips
window.updateClip = function(videoUrlOrId, title, author, date, description) {
    let videoId;
    
    // Extract video ID from various YouTube URL formats
    if (videoUrlOrId.includes('youtube.com') || videoUrlOrId.includes('youtu.be')) {
        const match = videoUrlOrId.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
        videoId = match ? match[1] : videoUrlOrId;
    } else {
        videoId = videoUrlOrId; // Assume it's already just the ID
    }
    
    const newClipData = {
        videoId: videoId,
        title: title || 'This Week\'s Featured Gameplay',
        author: author || 'Community Member',
        date: date || new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        description: description || 'Check out this amazing retro gaming moment from our community! Want to be featured next? Share your clips in our Discord!'
    };
    
    window.updateClipOfWeek(newClipData);
};

// Load clip from Supabase on startup
async function loadClipFromSupabase() {
    try {
        const { data, error } = await supabase
            .from('site_content')
            .select('content')
            .eq('id', 'clip_of_the_week')
            .single();

        if (!error && data && data.content) {
            console.log(' Loaded clip from Supabase');
            localStorage.setItem('rom-current-clip', JSON.stringify(data.content));
        }
    } catch (err) {
        console.log(' No Supabase clip found, using local storage');
    }
}

/* ---------- Cursor & Canvas background ---------- */
function initCursorAndCanvas(){
    const cursor = document.getElementById('customCursor');
    if(cursor && window.innerWidth > 768) {
        cursor.style.display = 'block';
        document.addEventListener('mousemove', function(e){
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });
    } else if (cursor) {
        cursor.style.display = 'none';
    }
    
    const canvas = document.getElementById('retroCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const starLayers = [
        {count:80, speed:0.2, sizeRange:[1,2], stars:[]},
        {count:50, speed:0.5, sizeRange:[0.7,1.4], stars:[]},
        {count:25, speed:1.1, sizeRange:[0.6,1.2], stars:[]}
    ];
    starLayers.forEach(layer=>{
        for(let i=0;i<layer.count;i++){
            layer.stars.push({
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height,
                size: Math.random()*(layer.sizeRange[1]-layer.sizeRange[0]) + layer.sizeRange[0],
                col: `rgba(0,255,255,${Math.random()*0.6+0.2})`
            });
        }
    });
    const particles = [];
    for(let i=0;i<40;i++){
        particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.4, vy: (Math.random()-0.5)*0.4, r: Math.random()*1.8+0.6, a: Math.random()*0.6+0.2 });
    }
    const shooting = [];
    function spawnShoot(){ shooting.push({ x: Math.random()*canvas.width, y: -20, vx: Math.random()*3+1.2, vy: Math.random()*2+1.2, len: Math.random()*80+30, a: 1 }); }
    setInterval(spawnShoot, 2600);

    const trail = []; const maxTrail=14;
    if (window.innerWidth > 768) {
        document.addEventListener('mousemove', e => { trail.push({x:e.clientX, y:e.clientY, t:Date.now()}); if(trail.length>maxTrail) trail.shift(); });
    }

    function frame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const g = ctx.createRadialGradient(canvas.width/2, canvas.height*0.12, 0, canvas.width/2, canvas.height/1.1, Math.max(canvas.width, canvas.height));
        g.addColorStop(0, 'rgba(0,30,60,0.05)'); g.addColorStop(1, 'rgba(0,0,0,0.6)'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

        starLayers.forEach(layer=>{ layer.stars.forEach(s=>{ s.y += layer.speed; if(s.y>canvas.height) s.y=0; ctx.fillStyle=s.col; ctx.fillRect(s.x,s.y,s.size,s.size); }); });

        ctx.strokeStyle='rgba(0,255,255,0.06)'; ctx.lineWidth=1;
        const spacing=Math.max(60, Math.floor(canvas.width/16)); let offset=(Date.now()/50)%spacing;
        for(let x=0;x<canvas.width;x+=spacing){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=0;y<canvas.height;y+=spacing){ ctx.beginPath(); ctx.moveTo(0,y+offset); ctx.lineTo(canvas.width,y+offset); ctx.stroke(); }

        particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0)p.x=canvas.width; if(p.x>canvas.width)p.x=0; if(p.y<0)p.y=canvas.height; if(p.y>canvas.height)p.y=0; ctx.beginPath(); ctx.fillStyle=`rgba(0,255,255,${p.a})`; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); });

        for(let i=shooting.length-1;i>=0;i--){ const s=shooting[i]; s.x+=s.vx; s.y+=s.vy; s.a-=0.01; ctx.strokeStyle=`rgba(0,255,255,${s.a})`; ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(s.x-s.len,s.y-s.len); ctx.stroke(); if(s.a<=0) shooting.splice(i,1); }

        if (window.innerWidth > 768) {
            for(let i=0;i<trail.length;i++){ const p=trail[i]; const alpha=(i+1)/trail.length*0.9; ctx.fillStyle=`rgba(0,200,255,${alpha*0.5})`; ctx.beginPath(); ctx.arc(p.x,p.y,2+(i/maxTrail)*3,0,Math.PI*2); ctx.fill(); }
        }
        
        requestAnimationFrame(frame);
    }
    frame();
}

/* ---------- DOM stars fallback ---------- */
document.addEventListener('DOMContentLoaded', () => {
    const starContainer = document.querySelector('.stars');
    if(starContainer && starContainer.children.length === 0){
        for(let i=0;i<40;i++){
            const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.opacity=(0.2+Math.random()*0.8).toString();
            starContainer.appendChild(s);
        }
    }
});

/* ---------- Keyboard focus accessibility ---------- */
(function(){
    const body=document.body;
    window.addEventListener('keydown', e=>{ if(e.key==='Tab') body.classList.add('show-focus'); });
    window.addEventListener('mousedown', ()=>{ body.classList.remove('show-focus'); });
})();

// Quick fix 
document.addEventListener('DOMContentLoaded', function() {
    // Fix Social Hub button
    const socialHubBtn = document.getElementById('socialHubBtn');
    if (socialHubBtn) {
        socialHubBtn.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            if (socialModal) {
                socialModal.style.display = 'flex';
            }
        });
    }
    
    // Fix close button
    const closeSocial = document.getElementById('closeSocialHub');
    if (closeSocial) {
        closeSocial.addEventListener('click', function() {
            const socialModal = document.getElementById('socialHubModal');
            if (socialModal) {
                socialModal.style.display = 'none';
            }
        });
    }
});
/* ---------- ENHANCED MATCHMAKING DASHBOARD SYSTEM ---------- */
function initMatchmakingDashboard() {
    console.log(' Initializing Enhanced Matchmaking Dashboard...');
    
    // Add connection status indicator
    addConnectionStatusIndicator();
    
    // Load all dashboard data
    loadDashboardData();
    
    // Enhanced refresh with visibility check
    setInterval(() => {
        if (!document.hidden) {
            loadDashboardData();
        }
    }, 30000);
    
    // Force refresh every 2 minutes regardless of visibility
    setInterval(() => {
        console.log(' Force refresh dashboard data');
        loadDashboardData();
    }, 120000);
}

function addConnectionStatusIndicator() {
    // Add status indicator to the dashboard
    const dashboard = document.querySelector('.matchmaking-dashboard');
    if (dashboard) {
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'apiStatusIndicator';
        statusIndicator.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                <span id="connectionStatus" style="color: #00ff00;"> Live</span>
                <small id="lastUpdate" style="color: #a8dfe8; margin-left: 10px;">Updating...</small>
            </div>
        `;
        dashboard.insertBefore(statusIndicator, dashboard.firstChild);
    }
}

function updateConnectionStatus(isConnected, message = '') {
    const statusElement = document.getElementById('connectionStatus');
    const lastUpdateElement = document.getElementById('lastUpdate');
    
    if (statusElement && lastUpdateElement) {
        if (isConnected) {
            statusElement.innerHTML = ' Connected to 10.60.1.40';
            statusElement.style.color = '#00ff00';
        } else {
            statusElement.innerHTML = ' Disconnected from 10.60.1.40';
            statusElement.style.color = '#ff3333';
        }
        
        lastUpdateElement.textContent = message || `Last: ${new Date().toLocaleTimeString()}`;
    }
}
/* ---------- MISSING DASHBOARD FUNCTIONS ---------- */
function updateDashboardStats(data) {
    console.log(' Updating dashboard stats:', data);
    
    // Update stats cards
    const activeGamesElement = document.getElementById('activeGamesCount');
    const activePlayersElement = document.getElementById('activePlayersCount');
    const recentWinsElement = document.getElementById('recentWinsCount');
    const totalUsersElement = document.getElementById('totalUsersCount');
    
    if (activeGamesElement) activeGamesElement.textContent = data.active_games || 0;
    if (activePlayersElement) activePlayersElement.textContent = data.active_users || 0;
    if (recentWinsElement) recentWinsElement.textContent = data.recent_wins || 0;
    if (totalUsersElement) totalUsersElement.textContent = data.total_users || 0;
    
    // Update popular games
    updatePopularGamesList(data.popular_games || []);
}

function updateActiveGamesList(games) {
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;
    
    if (!games || games.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                No active games right now
            </div>
        `;
        return;
    }
    
    activeGamesList.innerHTML = games.map(game => `
        <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #00ffff;">
            <div style="display: flex; justify-content: between; align-items: center;">
                <div>
                    <strong style="color: #00ffff;">${game.GameName || 'Unknown Game'}</strong>
                    <div style="color: #a8dfe8; font-size: 0.8rem;">Player: ${game.Username || 'Unknown'}</div>
                </div>
                <span style="color: #ffff00; font-size: 0.8rem;">${game.Players || 1} players</span>
            </div>
        </div>
    `).join('');
}

function updateLeaderboardList(leaderboard) {
    const leaderboardList = document.getElementById('leaderboardList');
    if (!leaderboardList) return;
    
    if (!leaderboard || leaderboard.length === 0) {
        leaderboardList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                No leaderboard data available
            </div>
        `;
        return;
    }
    
    leaderboardList.innerHTML = leaderboard.map((player, index) => `
        <div class="leaderboard-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#00ffff'};">
            <div style="display: flex; justify-content: between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #ffff00; font-weight: bold;">#${index + 1}</span>
                    <strong style="color: #00ffff;">${player.Username || 'Unknown Player'}</strong>
                </div>
                <span style="color: #ff33cc; font-weight: bold;">${player.win_count || 0} wins</span>
            </div>
        </div>
    `).join('');
}

function updatePopularGamesList(popularGames) {
    const popularGamesList = document.getElementById('popularGamesList');
    if (!popularGamesList) return;
    
    if (!popularGames || popularGames.length === 0) {
        popularGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px; grid-column: 1 / -1;">
                No popular games data
            </div>
        `;
        return;
    }
    
    popularGamesList.innerHTML = popularGames.map(game => `
        <div class="popular-game-item" style="background: rgba(0, 30, 60, 0.7); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(0, 255, 255, 0.3);">
            <div style="color: #ff33cc; font-weight: bold; margin-bottom: 8px;">${game.Name || 'Unknown Game'}</div>
            <div style="color: #00ffff; font-size: 0.9rem;">${game.active_count || 0} active players</div>
        </div>
    `).join('');
}
/* ---------- FALLBACK DATA HANDLER (EMPTY DATA) ---------- */
function getFallbackData(endpoint) {
    // Return EMPTY data instead of demo data
    const emptyData = {
        '/dashboard': {
            active_games: 0,
            active_users: 0,
            recent_wins: 0,
            total_users: 0,
            popular_games: []
        },
        '/active_games': [],
        '/leaderboard': []
    };
    
    return emptyData[endpoint] || null;
}
// FIXED: Add async keyword to the function
async function loadDashboardData() {
    console.log(' Loading REAL LFG data...');
    
    try {
        // Use .then() instead of async/await to avoid the error
        const lfgData = await fetchMatchmakingData('/live_games');
        
        if (lfgData && lfgData.length > 0) {
            console.log(' Found LFG games:', lfgData.length);
            processLfgGames(lfgData);
            
            // Update Discord stats
            updateDiscordStats({
                total_lobbies: lfgData.length,
                online_users: new Set(lfgData.map(game => game.UserId)).size,
                recent_games: lfgData.slice(0, 5)
            });
            
            showQuickStatus(' LFG data loaded!', 'success');
        } else {
            // Fallback to active games endpoint
            const activeGames = await fetchMatchmakingData('/active_games');
            if (activeGames && activeGames.length > 0) {
                processLfgGames(activeGames);
                updateDiscordStats({
                    total_lobbies: activeGames.length,
                    online_users: new Set(activeGames.map(game => game.UserId)).size,
                    recent_games: activeGames.slice(0, 5)
                });
                showQuickStatus(' LFG data loaded!', 'success');
            } else {
                showNoGamesMessage();
                showQuickStatus(' No active games found', 'info');
            }
        }

        // Load leaderboard and other data
        const [leaderboard, dashboard] = await Promise.allSettled([
            fetchMatchmakingData('/leaderboard'),
            fetchMatchmakingData('/dashboard')
        ]);

        if (leaderboard.status === 'fulfilled' && leaderboard.value) {
            updateLeaderboardList(leaderboard.value);
        }

        showQuickStatus(' Game data refreshed!', 'success');

    } catch (error) {
        console.error('Game data load failed:', error);
        const discordStatus = document.getElementById('discordConnectionStatus');
        if (discordStatus) {
            discordStatus.innerHTML = ' Load failed';
            discordStatus.style.color = '#ff3333';
        }
        showQuickStatus(' Failed to load game data', 'error');
    }
}
// NEW: Process LFG games properly
function processLfgGames(lfgGames) {
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;

    activeGamesList.innerHTML = lfgGames.map(game => {
        const gameName = game.GameName || 'Unknown Game';
        const platform = game.Platform || game.Console || 'Unknown';
        const players = game.Players || game.PlayerCount || 1;
        const connectionInfo = game.ConnectionInfo || game.AdditionalNotes || '';
        const userId = game.UserId || 'Unknown';
        
        return `
            <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #00ff00;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <strong style="color: #00ffff;">${gameName}</strong>
                        <div style="color: #a8dfe8; font-size: 0.8rem; margin-top: 4px;">
                             ${platform} |  User: ${userId} |  Players: ${players}
                        </div>
                        ${connectionInfo ? `<div style="color: #ffff00; font-size: 0.8rem; margin-top: 2px;"> ${connectionInfo}</div>` : ''}
                    </div>
                    <span style="color: #00ff00; font-size: 0.8rem;"> LFG</span>
                </div>
                ${game.ExpireDateTime ? `
                <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 8px; border-top: 1px solid rgba(0,255,255,0.2); padding-top: 4px;">
                    Expires: ${new Date(game.ExpireDateTime).toLocaleString()}
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Helper function for no games message
function showNoGamesMessage() {
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;
    
    activeGamesList.innerHTML = `
        <div style="text-align: center; color: #a8dfe8; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 15px;"></div>
            <div>No active game invites found</div>
            <div style="font-size: 0.8rem; color: #ffff00; margin-top: 10px;">
                Game invites will appear here when players use the !lfg command
            </div>
        </div>
    `;
}

// NEW: Process real Discord bot data
function processDiscordBotData(discordData) {
    console.log(' Processing Discord bot data:', discordData);
    
    // Update stats with REAL Discord numbers
    const activeGamesElement = document.getElementById('activeGamesCount');
    const activePlayersElement = document.getElementById('activePlayersCount');
    const totalUsersElement = document.getElementById('totalUsersCount');
    
    if (activeGamesElement) {
        activeGamesElement.textContent = discordData.total_lobbies || 0;
        activeGamesElement.style.color = '#00ffff';
        activeGamesElement.title = 'Active Discord Lobbies';
    }
    
    if (activePlayersElement) {
        activePlayersElement.textContent = discordData.online_users || 0;
        activePlayersElement.style.color = '#ff33cc';
        activePlayersElement.title = 'Online Discord Users';
    }
    
    // Update active games list with Discord lobbies
    if (discordData.active_lobbies && discordData.active_lobbies.length > 0) {
        updateActiveGamesWithDiscordData(discordData.active_lobbies);
    }
    
    // Update recent games from Discord activity
    if (discordData.recent_games && discordData.recent_games.length > 0) {
        updatePopularGamesWithDiscordData(discordData.recent_games);
    }
}

// NEW: Update games list with Discord data
function updateActiveGamesWithDiscordData(discordLobbies) {
    const activeGamesList = document.getElementById('activeGamesList');
    if (!activeGamesList) return;
    
    const realGames = discordLobbies.filter(lobby => lobby.source && lobby.Status);
    
    if (realGames.length === 0) {
        activeGamesList.innerHTML = `
            <div style="text-align: center; color: #a8dfe8; padding: 20px;">
                No active Discord games right now
            </div>
        `;
        return;
    }
    
    activeGamesList.innerHTML = realGames.map(lobby => `
        <div class="active-game-item" style="background: rgba(0, 30, 60, 0.6); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #00ff00;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: #00ffff;">Discord Lobby</strong>
                    <div style="color: #a8dfe8; font-size: 0.8rem;">
                        Source: ${lobby.source} | Status: ${lobby.Status}
                    </div>
                    ${lobby.GameId ? `<div style="color: #ffff00; font-size: 0.8rem;">Game ID: ${lobby.GameId}</div>` : ''}
                </div>
                <span style="color: #00ff00; font-size: 0.8rem;"> LIVE</span>
            </div>
            ${lobby.StartTime ? `<div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">Started: ${new Date(lobby.StartTime).toLocaleTimeString()}</div>` : ''}
        </div>
    `).join('');
}

// NEW: Update popular games with Discord data
function updatePopularGamesWithDiscordData(recentGames) {
    const popularGamesList = document.getElementById('popularGamesList');
    if (!popularGamesList) return;
    
    popularGamesList.innerHTML = recentGames.map(game => `
        <div class="popular-game-item" style="background: rgba(0, 30, 60, 0.7); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(0, 255, 255, 0.3);">
            <div style="color: #ff33cc; font-weight: bold; margin-bottom: 8px;">${game.GameName || 'Recent Game'}</div>
            <div style="color: #00ffff; font-size: 0.9rem;">${game.activity_count || 1} activities</div>
            <div style="color: #a8dfe8; font-size: 0.7rem; margin-top: 5px;">
                Last: ${new Date(game.last_activity).toLocaleTimeString()}
            </div>
        </div>
    `).join('');
}

// NEW: Debug function to see what data is available
async function showDebugData() {
    try {
        const debugData = await fetchMatchmakingData('/debug');
        console.log(' DEBUG DATA AVAILABLE:', debugData);
        
        // Show debug info in console
        if (debugData && debugData.table_counts) {
            console.log(' Database Table Counts:', debugData.table_counts);
            console.log(' Sample ActiveGames:', debugData.sample_data?.ActiveGames);
            console.log(' Sample Users:', debugData.sample_data?.Users);
        }
    } catch (error) {
        console.error('Debug data load failed:', error);
    }
}
/* ---------- INITIALIZE ALL SYSTEMS ---------- */
function initAllSystems() {
    console.log(' Initializing all systems...');
    initMatchmakingDashboard(); //  Matchmaking API Dashboard
    initCursorAndCanvas();
    initCollapsibles();
    initFormControls();
    initStatusBar();
    initSoundEffects();
    initThemeSwitcher();
    initEasterEggs();
    initSearchSystem();
    initCopyButtons();
    initAccountSystem(); //  PURE SUPABASE AUTH SYSTEM
    initUserFavorites();
    initSocialHub();
    initMusicPlayer();
    initLiveClock();
    initTypingEffect();
    initLivePlayerCount(); //  FIXED: Real-time player count
    initEngagementFeatures();
    initClipOfWeek();
    initCustomizationSystems();
    initProfileMusicSystem(); // For current user's music settings
    initProfilePageMusicSystem(); // For viewing other profiles' music
    initEnhancedFriendSystem();
    initClickablePlayerProfiles();
    initBioEditing();
    initGameLobbies();
    initPlayerSearchSystem();
    initWallSystem(); //  ADDED: Initialize the fixed wall system
    initProfileRouteSystem(); //  NEW: Profile route system
    initURLRouting(); //  NEW: URL routing system
    initProfileBackButton();
    initWorkingSaltyBet();
    console.log(' All systems initialized');
}
</script>
</body>
</html>
